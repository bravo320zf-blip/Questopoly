<!DOCTYPE html>
<html lang="en">
<!-- 
================================================================
   QUESTOPOLY: LEGENDS - POLISHED UI EDITION
   UI Overhaul: Glass & Gold Theme
   Logic: Original (Preserved)
================================================================
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Questopoly: Legends</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@400;700&display=swap');

    :root {
        --bg-dark: #020617;
        --glass-bg: rgba(15, 23, 42, 0.85);
        --glass-border: rgba(255, 255, 255, 0.1);
        --gold-main: #f59e0b;
        --gold-glow: #fbbf24;
        --gold-dim: #78350f;
        --accent-red: #ef4444;
        --accent-green: #10b981;
        --accent-blue: #3b82f6;
        --accent-purple: #a855f7;
        --font-head: 'Cinzel', serif;
        --font-body: 'Lato', sans-serif;
        --radius-main: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #e2e8f0; font-family: var(--font-body); position: fixed; touch-action: none; }
    h1, h2, h3, button, .modal-title { font-family: var(--font-head); text-transform: uppercase; }

    /* --- LAYOUT LAYERS --- */
    #game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 100; pointer-events: none;
        /* REMOVED display: flex; justify-content... */
        /* Now acts as a static canvas for absolute children */
        overflow: hidden; 
    }

    /* THE BLUE BOX (Board Anchor - Keeps Aspect Ratio) */
    #board-anchor {
        position: absolute;
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); /* Keeps it dead center */
        height: 96vh; width: 96vh; 
        max-width: 96vw; max-height: 96vw; 
        pointer-events: none;
    }

    /* THE RED BOX (Inner Play Area) */
    #inner-zone {
        position: absolute;
        top: 14.5%; left: 14.5%;
        width: 71%; height: 77%;
        pointer-events: none;
    }

    /* --- UI COMPONENTS --- */
    .glass-panel, button, .modal-content, .skill-slot, .equip-slot, .inv-slot, .util-btn, #btn-action, #turn-widget, #adventure-log-widget { pointer-events: auto; }

    /* SIDEBARS */
    #p1-sheet { 
        position: absolute;
        top: 10%;
        left: 20px; /* Pinned to left */
        width: 280px; 
        height: 80%; 
        z-index: 20; 
        transition: transform 0.3s ease;
    }
    #leaderboard { 
        position: absolute;
        top: 10%;
        right: 20px; /* Pinned to right */
        width: 240px; 
        height: auto; 
        max-height: 60%; 
        z-index: 20; 
        transition: transform 0.3s ease; 
    }
    
/* HIDE SIDEBARS LOGIC & ACTIVE STATE */
    @media (max-width: 1600px) {
        #p1-sheet, #leaderboard { display: none !important; }
        
        /* When toggled via buttons, show as popup */
        #p1-sheet.active, #leaderboard.active {
            display: flex !important;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80vw; max-width: 400px; height: 70vh;
            
            /* UPDATED: Increased from 2000 to 4000 to sit ABOVE the Skill Bar (3000) */
            z-index: 4000 !important; 
            
            background: rgba(15, 23, 42, 0.98);
            border: 2px solid var(--gold-main);
        }
        
        /* Show the toggle buttons in the utility stack */
        .mobile-toggle-btn { display: flex !important; }
    }

    /* 1. TURN TRACKER */
    #turn-widget {
        position: absolute; 
        top: -8%; 
        left: 50%; 
        transform: translate(-50%, 0); /* Stick to top */
        width: 60%;
        padding-top: 1vmin;
        background: linear-gradient(90deg, transparent, rgba(0,0,0,0.9), transparent); 
        text-align: center;
        z-index: 150; /* Ensure above shadows */
    }
    #turn-banner { 
        font-size: 4.5vmin; /* Scales with screen width on mobile */
        color: #fff; 
        text-shadow: 0 0 10px var(--gold-glow); 
        margin: 0; 
        white-space: nowrap; 
    }
    #day-night-indicator { 
        font-size: 2.5vmin; 
        color: var(--accent-blue); 
        padding: 0.5vmin 2vmin; 
        background: rgba(0,0,0,0.5); 
        border-radius: 10px; 
        display: inline-block; 
        border: 1px solid #333; 
        margin-top: 0.5vmin;
    }

    /* 2. TREASURY */
    #treasury-widget {
        position: absolute; 
        top: -5%; 
        left: -5%; /* Pinned to corner */
        background: radial-gradient(circle, #451a03 0%, #000 100%);
        border: 2px solid var(--gold-main); 
        border-radius: 15px;
        padding: 1vmin 2vmin; 
        box-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        pointer-events: auto;
        z-index: 150;
        min-width: 12vmin;
    }
    .treasury-icon { font-size: 3.5vmin; margin-bottom: 0; line-height: 1; }
    .treasury-amount { 
        font-family: var(--font-head); 
        font-size: 3vmin; 
        color: var(--gold-glow); 
        font-weight: 900; 
        text-shadow: 0 0 5px var(--gold-main); 
    }
    .treasury-amount { font-family: var(--font-head); font-size: 2vh; color: var(--gold-glow); font-weight: 900; text-shadow: 0 0 5px var(--gold-main); }
    .treasury-label { 
        font-size: 1.5vmin; 
        color: #aaa; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
    }

    /* 3. LOG */
    #adventure-log-widget {
        position: absolute;
        top: 8%; left: 50%; transform: translateX(-50%);
        height: 20%; width: 60%;
        
        background: rgba(15, 23, 42, 0.6); 
        border: 1px solid var(--glass-border); 
        border-radius: 10px; padding: 5px 10px;
        
        /* CHANGED: Normal column direction, hidden overflow on widget */
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        
        pointer-events: auto;
    }
	#game-log {
        width: 100%;
        height: 100%;
        overflow-y: auto; /* Scroll inside this inner div */
        display: flex;
        flex-direction: column;
        /* Gradient mask to fade out old text at the top */
        mask-image: linear-gradient(to bottom, transparent, black 15%); 
        -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%);
    }
    .log-entry { 
        font-size: 1.4vh; 
        padding: 2px 0; 
        text-shadow: 1px 1px 2px #000; 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
        flex-shrink: 0; /* Prevent squishing */
    }

    /* 4. SKILL BAR (SCALING FIX) */
    #skill-bar-container {
        position: absolute; 
		bottom: 8%; 
		left: 50%; 
		transform: translateX(-50%);
        width: 85%; height: 15%; /* Percentage based on Red Box */
        display: flex; 
		justify-content: center; 
		align-items: flex-end; 
		z-index: 60;
    }
    #skill-bar {
        background: linear-gradient(to top, #020617, rgba(2,6,23,0.95));
        border: 2px solid var(--gold-dim); border-radius: 15px;
        width: 100%; height: 100%;
        display: flex; gap: 2%; justify-content: space-between; align-items: center;
        padding: 0 2%; box-shadow: 0 0 30px rgba(0,0,0,0.9);
    }

    /* BUTTON SCALING FIX */
    #btn-action-container {
        position: absolute; left: 50%; bottom: 50%; transform: translate(-50%, 50%); z-index: 100;
        width: 25%; height: auto; aspect-ratio: 1; pointer-events: none; /* Container ignores clicks, button accepts */
        display: flex; justify-content: center; align-items: center;
    }
    #btn-action {
        width: 90%; height: 90%; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, var(--gold-glow), var(--gold-main));
        border: 3px solid #fff; box-shadow: 0 0 30px var(--gold-glow), 0 10px 0 #451a03;
        color: #2a1a00; font-family: var(--font-head); font-weight: 900; font-size: 3vmin; /* Scales with viewport */
        cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center;
        pointer-events: auto;
    }
    #btn-action:active { box-shadow: inset 0 0 15px rgba(0,0,0,0.5); transform: scale(0.98); }
    #btn-action:disabled { filter: grayscale(1); cursor: not-allowed; background: #333; border-color:#555; box-shadow:none; color:#888;}
    #btn-action.state-end { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); color: #fff; box-shadow: 0 0 30px #ef4444, 0 10px 0 #450a0a; }

    .skill-slot {
        flex: 1; height: 80%; background: #1e293b; border: 2px solid #475569; border-radius: 8px;
        position: relative; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end;
        background-size: cover; background-position: center; overflow: hidden; transition: transform 0.1s; box-shadow: inset 0 0 10px #000;
    }
    .skill-slot span { font-size: 1.5vmin; padding: 2px; background: rgba(0,0,0,0.8); text-align: center; width: 100%; white-space:nowrap; overflow:hidden;}
    .skill-key { font-size: 1.5vmin; width: 2.5vmin; height: 2.5vmin; position: absolute; top: 2px; left: 2px; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #666; border-radius: 4px; }
    .skill-slot:active { transform: scale(0.95); }
    .spacer-slot { width: 30%; height: 0; pointer-events: none; }

    /* 5. UTILITY BAR */
    #utility-stack {
        position: absolute; bottom: 3%; 
		right: -4%; 
		width: 8%;
        display: flex; 
		flex-direction: column-reverse; 
		gap: 1vh; 
		z-index: 500;
    }
    .util-btn {
        width: 100%; aspect-ratio: 1; border-radius: 50%;
        background: rgba(15, 23, 42, 0.9); border: 2px solid var(--gold-dim);
        color: var(--gold-main); font-size: 2.5vh;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .util-btn:hover { background: var(--gold-main); color: #000; transform: scale(1.1); }
    .mobile-toggle-btn { display: none; }

    /* Shared Styles */
    .glass-panel { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: var(--radius-main); box-shadow: 0 4px 20px rgba(0,0,0,0.5); color: #fff; display: flex; flex-direction: column; overflow: hidden; }
    .gold-border { border: 1px solid var(--gold-dim); box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 10px rgba(0,0,0,0.5); }
    .char-header { padding: 10px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
    .char-portrait { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold-main); background-color: #000; background-size: cover; margin-right: 10px; cursor: pointer; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; }
    .stat-box { background: rgba(0,0,0,0.3); padding: 5px; text-align: center; border-radius: 4px; }
    .stat-val { font-weight: bold; color: #fff; } .stat-lbl { font-size: 0.65rem; color: #aaa; }
    .paper-doll { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 0 10px 10px 10px; }
    .equip-slot { background: rgba(0,0,0,0.4); border: 1px dashed #444; color: #666; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; border-radius: 4px; transition: 0.2s; }
    .equip-slot.filled { border: 1px solid var(--gold-dim); background: rgba(16, 185, 129, 0.2); color: #fff; text-shadow: 0 1px 2px #000; }
    .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 10px; background: rgba(0,0,0,0.2); flex-grow: 1; align-content: flex-start; overflow-y: auto; }
    .inv-slot { aspect-ratio: 1; background: #1e293b; border: 1px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; cursor: pointer; }
    
/* ================================================================
       MODAL & CARD STYLES (MATCHING SCREENSHOT)
       ================================================================ */

    /* 1. Arrival/Encounter Specific Modal Wrapper */
    #arrival-modal {
        background: transparent; /* Remove default background */
        border: none;
        box-shadow: none;
        padding: 0;
        overflow: visible; /* Allow buttons to hang out if needed */
    }

    /* Inner Container for the Visual "Card" Look */
    .card-border {
        background: #111;
        border: 4px solid #fff; /* White border from screenshot */
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 0 50px #000;
        display: flex;
        flex-direction: column;
        max-height: 90vh; /* Don't go off screen */
    }

    /* 2. The Image - Full Width, Natural Height */
    #arrival-image {
        display: block;
        width: 100%;
        height: auto;
        max-height: 50vh; /* Maximum height to keep buttons visible */
        object-fit: contain; /* Shows FULL image, no cropping */
        background: #000;
        border-bottom: 2px solid #fff;
        margin: 0;
    }

    /* 3. The Body Text */
    .card-body {
        padding: 20px;
        background: #111;
        color: #fff;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto; /* Allow text to scroll if image is huge */
    }

    .card-desc { font-style: italic; margin-bottom: 20px; line-height: 1.5; color: #fff; font-size: 1.1rem; }

    /* 4. The "Continue" Button (Yellow/Gold) */
    .card-body button.primary {
        background: linear-gradient(to bottom, #fbbf24, #d97706);
        border: 2px solid #78350f;
        color: #000;
        font-family: 'Cinzel', serif;
        font-weight: 900;
        font-size: 1.5rem;
        padding: 15px 0;
        width: 100%;
        margin-top: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 0 #78350f;
        text-shadow: 0 1px 0 rgba(255,255,255,0.4);
    }
    .card-body button.primary:active { transform: translateY(4px); box-shadow: none; }

    /* Close Button Positioning */
    #arrival-modal .close-x {
        position: absolute;
        top: -15px;
        right: -15px;
        z-index: 200;
        background: #ef4444;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px #000;
        width: 40px; height: 40px;
        font-size: 1.5rem;
    }

    /* --- STANDARD MODALS (Settings, Game Over, etc) --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.85); z-index: 500; 
        display: none; align-items: center; justify-content: center; 
        flex-direction: column; 
    }
    .modal-overlay.active { display: flex; }

    .modal-content, .card-modal { 
        background: #1a1a1a; 
        border: 2px solid var(--gold-dim); 
        border-radius: 16px; 
        box-shadow: 0 0 50px rgba(0,0,0,1); 
        max-width: 600px; width: 95%; max-height: 90vh;
        overflow: hidden; display: flex; flex-direction: column; 
        transform: scale(0.95); transition: transform 0.2s; 
        pointer-events: auto; 
    }
    .modal-overlay.active .modal-content, .modal-overlay.active .card-modal { transform: scale(1); }

    .card-header { padding: 15px; text-align: center; color: #fff; font-size: 1.4rem; font-weight: 900; background: var(--gold-dim); border-bottom: 2px solid #000; text-shadow: 0 2px 0 rgba(0,0,0,0.5); }
    .card-header.skirmish { background: #991b1b; } 
    .card-header.loot { background: #065f46; } 
    .card-header.market { background: #713f12; }

    /* Interactive Elements */
    .choice-btn { 
        background: linear-gradient(to right, #2d3748, #1a202c); 
        border: 1px solid #4a5568; padding: 15px; margin-bottom: 8px; 
        text-align: left; cursor: pointer; border-radius: 8px; 
        display: flex; justify-content: space-between; align-items: center; 
    }
    .choice-btn:hover { border-color: var(--gold-main); transform: translateX(5px); background: #2d3748; }

    .dice-result { display: flex; gap: 10px; justify-content: center; margin-top: 15px; min-height: 40px; }
    .mini-die { width: 36px; height: 36px; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 1.2rem; border: 1px solid #444; }
    .mini-die.win { background: var(--accent-green); border-color: #fff; } 
    .mini-die.lose { background: var(--accent-red); }

    /* Standard Close Button */
    .close-x { 
        position: absolute; top: 10px; right: 10px; 
        width: 30px; height: 30px; 
        background: var(--accent-red); color: white; border: 2px solid #fff; border-radius: 50%; 
        font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 50;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    /* --- TOOLTIP FIXES --- */
    #tooltip { 
        position: absolute; display: none; 
        background: rgba(10,10,15,0.98); 
        border: 2px solid var(--gold-main); 
        padding: 15px; font-size: 0.9rem; 
        z-index: 9999; /* Always on top */
        pointer-events: none; /* IGNORE MOUSE to prevent getting stuck */
        max-width: 250px; border-radius: 8px; 
        box-shadow: 0 5px 20px #000;
    }
    
    /* Fixed Tooltip Image Size */
    .tt-icon {
        width: 40px !important; height: 40px !important; min-width: 40px;
        object-fit: cover; border: 1px solid var(--gold-main); margin-right: 10px; background: #000;
    }

    #context-menu { position: absolute; display: none; flex-direction: column; background: #222; border: 1px solid var(--gold-main); z-index: 1000; border-radius: 4px; }
    .ctx-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #eee; } .ctx-item:hover { background: var(--gold-dim); }
    
    /* PRESERVED STYLES FOR START/CREATE/LOGO */
    #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://static.wixstatic.com/media/b16479_0ce055a502234368915b49af52e0b18d~mv2.jpg'); background-size: cover; background-position: center; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; transition: opacity 1.5s ease-in-out; opacity: 1; }
    #create-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://static.wixstatic.com/media/b16479_564e3eade6b7410785d835af2f340665~mv2.jpg'); background-size: cover; background-position: center; z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 80px 20px 40px 20px; overflow-y: auto; pointer-events: auto; opacity: 0; transition: opacity 1s ease-in-out; }
    #logo-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 400; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1.5s ease-out; pointer-events: auto; }
    #logo-img { width: 60%; max-width: 800px; height: auto; opacity: 0; animation: logoFadeIn 5s forwards; transition: opacity 1s ease-out; }
    #logo-text { margin-top: 20px; color: #fff; font-family: 'Cinzel', serif; font-size: 3vmin; opacity: 0; animation: logoFadeIn 2s forwards 5.5s; transition: opacity 1s ease-out; }
    @keyframes logoFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    #splash-screen h1 { 
        /* Use vw to ensure the width of the word fits the width of the phone */
        font-size: 13vw !important; 
        line-height: 1.1 !important;
        margin-bottom: 20px !important;
        width: 100%;
        padding: 0 10px;
    }
    
    #splash-screen h2 { 
        font-size: 5vw !important; 
        margin-bottom: 40px !important;
    }
	    #splash-screen button {
        font-size: 1.5rem !important;
        padding: 15px 40px !important;
    }
	#create-screen h1 { color: #000; margin-bottom: 20px; text-shadow: 2px 2px 0px #FFF; text-align: center; font-size: 8rem; }
    @media (max-width: 800px) { #splash-screen h1, #create-screen h1 { font-size: 4rem; } }
    #create-screen h3 { 
        color: #fff !important; 
        font-size: 1.5rem; 
        font-weight: 900; 
        margin-top: 15px; 
        margin-bottom: 10px; 
        text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; /* Strong Outline */
        background: rgba(0, 0, 0, 0.4); /* Subtle backing */
        padding: 5px 15px;
        border-radius: 20px;
        display: inline-block;
    }
    .input-group label { 
        display: block; 
        color: #fff; /* Changed to White */
        margin-bottom: 8px; 
        font-size: 2rem; 
        font-weight: 900; 
        font-family: 'Cinzel', serif; 
        text-shadow: 3px 3px 0 #000, -1px -1px 0 #000; /* Strong Shadow */
    }
    .input-group input { 
        padding: 15px; 
        font-size: 1.5rem; 
        border-radius: 5px; 
        border: 3px solid #fbbf24; /* Gold border */
        background: rgba(30, 41, 59, 0.9); 
        color: white; 
        text-align: center; 
        width: 300px; 
        font-weight: bold; 
    }
    .color-grid { display: flex; gap: 15px; justify-content: center; margin-top: 10px; }
    .color-opt { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #000; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); } .color-opt:hover, .color-opt.selected { transform: scale(1.2); border-color: white; box-shadow: 0 0 15px var(--gold-main); }
    .sel-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        margin: 10px 0 20px 0; 
        max-width: 800px; 
        width: 100%; 
    }
    }
    .sel-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        margin: 10px 0 20px 0; 
        max-width: 800px; 
        width: 100%; 
    }
    
    .skill-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 15px; 
        margin-bottom: 30px; 
        width: 100%; 
    }

    /* --- 2. RACE/CLASS BUTTONS (Fixed Backgrounds) --- */
    .sel-opt { 
        background: #1e293b !important; /* Force Dark Background */
        border: 2px solid #475569; /* Add Border definition */
        padding: 15px; 
        cursor: pointer; 
        text-align: center; 
        transition: 0.2s; 
        border-radius: 8px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 80px; /* Ensure consistent height */
    } 
    
    .sel-opt:hover { 
        transform: translateY(-3px); 
        background: #334155 !important; 
        border-color: #fff;
    } 
    
    .sel-opt.selected { 
        border-color: var(--gold-main); 
        background: #0f172a !important; /* Darker when selected */
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); 
    } 
    
    .sel-opt b { color: #fff; display: block; margin-bottom: 5px; font-size: 1.1rem; } 
    .sel-opt small { color: #94a3b8; display: block; line-height: 1.2; font-size: 0.8rem; }

    /* --- 3. SKILL CARDS --- */
    .skill-card { 
        background: #1e293b !important; 
        border: 1px solid #475569; 
        padding: 15px; 
        cursor: pointer; 
        border-radius: 6px; 
        width: 100%; 
        text-align: center; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
    }
    
    .skill-card:hover { border-color: var(--accent-green); } 
    .skill-card.selected { background: #064e3b !important; border-color: var(--accent-green); box-shadow: 0 0 15px var(--accent-green); } 
    .skill-card b { color: #fff; display: block; margin-bottom: 5px; font-size: 1rem; } 
    .skill-card small { color: #ccc; font-size: 0.8rem; }
    .skill-card img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; object-fit: cover; display: block; margin: 0 auto 5px auto; }

    /* --- 4. PORTRAIT FRAME FIX --- */
    #creator-portrait-frame {
        position: fixed;
        right: 5%;
        top: 50%;
        transform: translateY(-50%);
        width: 400px;
        height: 500px;
        border: 4px solid var(--gold-main);
        border-radius: 10px;
        box-shadow: 0 0 30px #000;
        background-color: #000;
        background-size: cover;
        background-position: top center;
        background-repeat: no-repeat;
        display: none; /* JS toggles this */
        z-index: 5000 !important; /* Force On Top */
        pointer-events: auto;
        transition: all 0.3s ease;
    }
	
    /* --- 5. MOBILE ADJUSTMENTS --- */
    @media (max-width: 1000px) {
        .sel-grid { grid-template-columns: repeat(2, 1fr); }
        .skill-grid { grid-template-columns: repeat(2, 1fr); }
        .input-group input { width: 100%; } 
        
        /* On Tablet/Mobile, make portrait smaller and tuck into corner */
        #creator-portrait-frame {
            width: 120px;
            height: 120px;
            right: 10px;
            top: 10px;
            transform: none;
            border-width: 2px;
        }
    }
	
    }
    #creator-portrait-frame { position: fixed; right: 5%; top: 50%; transform: translateY(-50%); width: 400px; height: 500px; border: 4px solid var(--gold-main); border-radius: 10px; box-shadow: 0 0 30px #000; background-color: #000; background-size: cover; background-position: top center; background-repeat: no-repeat; display: none; z-index: 201; pointer-events: auto; transition: all 0.3s ease; }
    #creator-portrait-frame.minimized { width: 80px !important; height: 80px !important; right: 20px !important; top: 20px !important; transform: none !important; border-width: 2px !important; background-position: top center !important; }
    .skill-card img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #555; object-fit: cover; display: block; margin: 0 auto 5px auto; }
	
	/* Fix Tooltip Image Size */
    .tt-icon {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        object-fit: cover;
        border: 1px solid var(--gold-main);
        margin-right: 10px;
        background: #000;
    }
    
    /* Ensure Tooltip ignores mouse interaction */
    #tooltip {
        pointer-events: none !important;
        z-index: 9999; /* Force on top of everything */
    }
	
	/* ================================================================
       [08] CRITICAL MODAL FIX
       Paste this at the very bottom of your CSS to fix the freeze/invisibility
       ================================================================ */

    /* Force specific positioning for the Arrival and Encounter Modals */
    #arrival-modal, #card-modal, #char-detail-modal, #flavor-modal {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) scale(0.9) !important;
        
        /* Ensure visibility states */
        opacity: 0 !important;
        pointer-events: none !important;
        z-index: -1 !important; /* Hide behind everything when inactive */
        display: flex !important;
        
        /* Sizing Constraints */
        max-height: 90vh !important;
        max-width: 600px !important;
        width: 95% !important;
        
        /* Reset styles */
        margin: 0 !important;
        transition: opacity 0.2s ease, transform 0.2s ease !important;
    }

    /* Active State - Brings them to front and center */
    #arrival-modal.active, #card-modal.active, #char-detail-modal.active, #flavor-modal.active {
        opacity: 1 !important;
        pointer-events: auto !important;
        z-index: 2000 !important; /* On top of everything */
        transform: translate(-50%, -50%) scale(1) !important;
    }
    
    /* Ensure content inside is visible */
    #arrival-modal *, #card-modal * {
        visibility: visible !important;
    }

    /* Ensure backgrounds are dark so you can't see through them */
    #card-modal, #char-detail-modal {
        background: #1a1a1a !important;
        border: 2px solid var(--gold-dim) !important;
        box-shadow: 0 0 50px #000 !important;
    }
	
	/* ================================================================
       [09] FINAL VISUAL FIXES (Invisible Container + Z-Index)
       ================================================================ */

    /* 1. Make the Encounter Container Invisible */
    #card-modal {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        pointer-events: none !important; /* Let clicks pass through the empty space */
    }

    /* 2. Style the Content inside so it looks like a card floating */
    #card-modal .card-header,
    #card-modal .card-body {
        pointer-events: auto !important; /* Re-enable clicking on the actual card */
        background: #1a1a1a !important; /* Dark background for text */
        width: 100%;
        box-shadow: 0 10px 40px #000;
        position: relative; /* Ensure z-index works locally */
    }

    /* Restore borders to the inner pieces since the outer box is gone */
    #card-modal .card-header {
        border: 2px solid var(--gold-dim);
        border-bottom: 2px solid #000;
        border-radius: 12px 12px 0 0;
    }

    #card-modal .card-body {
        border: 2px solid var(--gold-dim);
        border-top: none;
        border-radius: 0 0 12px 12px;
    }

    /* 3. Raise Skill Bar & Roll Button ABOVE the modal layer */
    /* Modals are z-index 2000, so we make these 3000 */
    #skill-bar-container,
    #btn-action-container {
        z-index: 3000 !important; 
        pointer-events: auto !important;
    }
	
	/* Ensure Help Modal is always on top */
#help-modal {
    z-index: 2000 !important; /* Higher than UI overlay (130) */
}

/* Fix Help Window Layout */
.help-window { 
    width: 95%; 
    max-width: 700px; 
    height: 85vh; /* Taller on mobile */
    display: flex; 
    flex-direction: column; 
    padding: 0; 
    background: #111; 
    border: 2px solid var(--gold); 
    overflow: hidden; 
    position: relative;
    border-radius: 8px;
}

/* Header & Tabs - Fixed Height */
.help-header-title { 
    background: var(--gold); 
    color: #ffffff; /* CHANGED: White text */
    font-weight: 900; 
    font-size: 1.5rem; 
    text-align: center; 
    padding: 10px; 
    flex-shrink: 0; 
    /* ADDED: Drop shadow for readability on gold */
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}

.help-tabs { 
    display: flex; 
    background: #222; 
    border-bottom: 2px solid #444; 
    flex-shrink: 0; 
    overflow-x: auto; 
}

.help-tab { 
    flex: 1; 
    background: transparent; 
    border: none; 
    color: #888; 
    padding: 15px 5px; 
    font-weight: bold; 
    font-size: 1rem; 
    cursor: pointer; 
    border-bottom: 4px solid transparent; 
}

.help-tab.active { 
    color: var(--gold); 
    border-bottom-color: var(--gold); 
    background: rgba(251, 191, 36, 0.1); 
}

/* Content Section - Scrollable */
.help-section { 
    display: none; 
    padding: 20px; 
    overflow-y: auto; 
    flex-grow: 1; 
    text-align: left; 
    color: #ccc; 
    font-size: 1rem; 
    line-height: 1.5;
    
    /* CRITICAL FOR MOBILE SCROLLING */
    touch-action: pan-y; 
    -webkit-overflow-scrolling: touch;
}

.help-section.active { 
    display: block; 
}

/* --- NEW CLOSE BUTTONS (Inside Panels) --- */
    .panel-close-btn {
        margin-top: auto; /* Pushes to bottom of flex container */
        align-self: center; /* Centers horizontally */
        background: rgba(127, 29, 29, 0.8); /* Dark Red */
        border: 1px solid #ef4444;
        color: #fff;
        font-family: var(--font-head);
        font-size: 0.8rem;
        padding: 8px 0;
        width: 80%;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        margin-bottom: 10px;
        transition: 0.2s;
        text-shadow: 0 1px 2px #000;
    }
    .panel-close-btn:hover { 
        background: #b91c1c; 
        transform: scale(1.05);
        box-shadow: 0 0 15px #ef4444;
    }

    /* Hide close button when panel is minimized to prevent clutter */
    .panel.minimized .panel-close-btn { display: none; }

    /* --- NEW HUD TOGGLES (Open Buttons) --- */
    #hud-toggles {
        position: absolute;
        top: 20%; 
        right: 2%; /* Desktop: Sits to the right of the board */
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: auto;
        z-index: 140;
    }

    .hud-toggle-btn {
        width: 5vmin; height: 5vmin;
        min-width: 40px; min-height: 40px;
        background: rgba(20, 25, 35, 0.9);
        border: 2px solid #555;
        color: var(--gold);
        font-size: 1.5rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 10px #000;
        transition: 0.2s;
    }
    .hud-toggle-btn:hover { 
        border-color: var(--gold); 
        transform: scale(1.1); 
        background: #000;
    }

    @media only screen and (max-width: 768px) {
        
        /* 1. HUD Toggles (Open Buttons) */
        #hud-toggles {
            top: auto;
            bottom: 150px; /* Sits above the bottom controls */
            right: 10px;
        }

        /* 2. Player Stats Widget (Fixed) */
        #mystats-widget {
            /* CHANGED to Positive 2% to bring it INSIDE the screen */
            top: 10% !important;
            right: 10% !important;
            
            /* Reset Desktop "hang" style */
            left: auto !important; 
            
            /* Visual tweaks for mobile */
            padding: 5px 10px !important;
            border-radius: 10px !important;
            background: rgba(15, 23, 42, 0.95) !important; /* Slightly more opaque */
            min-width: auto !important;
            border-width: 1px !important;
        }
        
        /* Scale text down for phone */
        #mystats-widget .ms-icon { font-size: 4vmin !important; }
        #mystats-widget .treasury-amount { font-size: 3.5vmin !important; }
        #mystats-widget .treasury-label { font-size: 2vmin !important; margin-top: 2px !important; }
        
        /* Optional: If Treasury is also off-screen, lock it in too */
        #treasury-widget {
            top: 10% !important;
            left: 10% !important;
            padding: 5px 10px !important;
        }
    }
	
/* --- NEW: PLAYER STATS WIDGET --- */
    #mystats-widget {
        position: absolute; 
        
        top: -5%; 
        right: -5%; 
        
        background: radial-gradient(circle, #0f172a 0%, #000 100%);
        border: 2px solid var(--gold-main); 
        border-radius: 0 0 0 15px; /* Rounded bottom-left */
        padding: 10px 20px; 
        box-shadow: -2px 2px 10px rgba(0,0,0,0.8);
        
        display: flex; 
        flex-direction: column; 
        align-items: flex-end; 
        pointer-events: auto;
        z-index: 150;
    }

    .stat-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 2px;
    }
    
    .ms-icon { font-size: 1.8vh; }

    /* --- DRAGGABLE CURSORS --- */
    /* Only apply on desktop to indicate the header is a handle */
    @media (min-width: 769px) {
        #p1-sheet .char-header, 
        #leaderboard .leader-header { /* UPDATED SELECTOR */
            cursor: move; 
        }
    }
</style>
</head>

<body>

<!-- LOGO SCREEN (Preserved) -->
<div id="logo-screen">
    <img id="logo-img" src="https://static.wixstatic.com/media/b16479_0a56fee31ec34232abc426d0ee72b6b1~mv2.png" alt="Logo">
    <div id="logo-text">Click to Continue</div>
</div>

<div id="game-layer"></div>

<!-- SPLASH SCREEN (Preserved) -->
<div id="splash-screen">
    <h1 style="font-size: 8rem; color: #fff; text-shadow: 0 0 30px var(--gold-main); margin-bottom: 20px;">QUESTOPOLY</h1>
    <h2 style="color: #ddd; font-size: 2rem; margin-top: 0; margin-bottom: 50px; text-shadow: 2px 2px 5px #000;">LEGENDS</h2>
    <button class="primary" style="font-size: 2.5rem; padding: 20px 80px; box-shadow: 0 0 20px #000; background:var(--gold-main); border:none; font-weight:900; cursor:pointer;" onclick="enterCreation()">PLAY</button>
</div>

<!-- CREATE SCREEN (Preserved) -->
<div id="create-screen" style="display:none;">
    <div class="input-group"><label>Name Your Hero</label><input type="text" id="char-name-input" value="Hero" maxlength="12"></div>
    <div class="input-group"><label>Choose Color</label><div class="color-grid" id="color-grid"></div></div>
    <h3 style="color:#888;">Select Race</h3><div class="sel-grid" id="race-grid"></div>
    <h3 style="color:#888;">Select Class</h3><div class="sel-grid" id="class-grid"></div>
    <div id="active-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
        <h3 style="color:#888;">Choose Active Skill</h3><div class="skill-grid" id="active-grid"></div>
    </div>
    <div id="passive-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
        <h3 style="color:#888;">Choose Passive Trait</h3><div class="skill-grid" id="passive-grid"></div>
    </div>
    <button id="btn-start-game" class="primary" style="padding:15px 50px; font-size:1.5rem; background:var(--gold-main); border:none; font-weight:900; cursor:pointer; opacity:0.5;" onclick="startGame()" disabled>Start Adventure</button>
    <div style="height:50px;"></div>
    <div id="creator-portrait-frame"><button id="btn-min-portrait" class="minimize-btn" onclick="toggleCreatorPortrait()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold-main); color: var(--gold-main); z-index: 205; width: 20px; height: 30px; line-height: 28px; padding: 0;">-</button></div>
</div>

<!-- MAIN UI OVERLAY (REPLACED WITH NEW GLASS UI) -->
<div id="ui-layer">

    <!-- LEFT SIDEBAR: PLAYER SHEET -->
    <div id="p1-sheet" class="glass-panel gold-border">
        <div class="char-header">
            <div style="display:flex; align-items:center;">
                <div id="p1-portrait" class="char-portrait" onclick="openCharDetail(0)"></div>
                <div>
                    <div id="p1-name" style="font-weight:bold; cursor:pointer;" onclick="openCharDetail(0)">Hero</div>
                    <div id="p1-class" style="font-size:0.8rem; color:#aaa;">Class</div>
                </div>
            </div>
            <div class="gold-display"><span id="p1-gold">0</span> G</div>
        </div>
        <div class="stat-grid">
            <div class="stat-box"><div id="p1-str" class="stat-val">0</div><div class="stat-lbl">STR</div></div>
            <div class="stat-box"><div id="p1-dex" class="stat-val">0</div><div class="stat-lbl">DEX</div></div>
            <div class="stat-box"><div id="p1-int" class="stat-val">0</div><div class="stat-lbl">INT</div></div>
        </div>
        <div class="paper-doll">
            <div id="slot-head" class="equip-slot" onpointerup="handleEquipTouch('head')">Head</div>
            <div id="slot-body" class="equip-slot" onpointerup="handleEquipTouch('body')">Body</div>
            <div id="slot-main" class="equip-slot" onpointerup="handleEquipTouch('main')">Main</div>
            <div id="slot-off" class="equip-slot" onpointerup="handleEquipTouch('off')">Off</div>
        </div>
        <div style="padding:0 10px; font-size:0.7rem; color:#888; margin-bottom:5px;">INVENTORY</div>
        <div id="p1-inv" class="inv-grid"></div>
        
        <!-- CLOSE BUTTON -->
        <button class="panel-close-btn" onclick="togglePanelVisibility('p1-sheet')">CLOSE</button>
    </div>

    <!-- CENTER BOARD AREA -->
    <div id="board-anchor">
        <div id="inner-zone">
            
            <!-- Turn Tracker -->
            <div id="turn-widget">
                <h2 id="turn-banner">SETUP</h2>
                <div id="day-night-indicator">‚òÄ DAY</div>
            </div>

           <!-- TREASURY WIDGET (Top Left) -->
            <div id="treasury-widget">
                <div class="treasury-icon">üëë</div>
                <div id="treasury-val" class="treasury-amount">0</div>
                <div class="treasury-label">Treasury</div>
            </div>
			
			<!-- NEW: PLAYER STATS WIDGET (Top Right) -->
            <div id="mystats-widget">
                <div class="stat-row">
                    <span class="ms-icon">üí∞</span> <span id="ms-gold" class="treasury-amount">0</span>
                </div>
                <div class="stat-row">
                    <span class="ms-icon">‚õ∫</span> <span id="ms-camps" class="treasury-amount">0</span>
                </div>
                <div class="stat-row">
                    <span class="ms-icon">üç∫</span> <span id="ms-taverns" class="treasury-amount">0</span>
                </div>
            </div>

            <!-- Adventure Log -->
            <div id="adventure-log-widget">
                <div id="game-log">
                    <div class="log-entry" style="text-align:center; color:#aaa;">- Log Start -</div>
                </div>
            </div>

            <!-- Skill Bar -->
            <div id="skill-bar-container">
                <div id="btn-action-container">
                    <button id="btn-action" onclick="handleActionClick()">ROLL</button>
                </div>
                <div id="skill-bar">
                    <div class="skill-slot" id="skill-0" onclick="useSkill(0)"><div class="skill-key">1</div><span id="txt-skill-0">Class</span></div>
                    <div class="skill-slot" id="skill-1" onclick="useSkill(1)"><div class="skill-key">2</div><span id="txt-skill-1">-</span></div>
                    <div class="skill-slot" id="skill-2" onclick="useSkill(2)"><div class="skill-key">3</div><span id="txt-skill-2">-</span></div>
                    <div class="spacer-slot"></div>
                    <div class="skill-slot" id="skill-3" onclick="useSkill(3)"><div class="skill-key">4</div><span id="txt-skill-3">-</span></div>
                    <div class="skill-slot" id="skill-4" onclick="useSkill(4)"><div class="skill-key">5</div><span id="txt-skill-4">-</span></div>
                    <div class="skill-slot" id="skill-5" onclick="useSkill(5)" ondragover="allowDrop(event)" ondrop="handleSkillDrop(event, 0)" style="border-style:dashed; opacity:0.6;"><div class="skill-key">6</div><span id="txt-skill-5">Drag</span></div>
                </div>
            </div>

            <!-- Utility Stack (OPEN BUTTONS) -->
            <div id="utility-stack">
                <div id="btn-help" class="util-btn" onclick="toggleHelpModal()">?</div>
                <div id="btn-settings" class="util-btn" onclick="toggleSettingsModal()">‚öô</div>
                <!-- REMOVED 'mobile-toggle-btn' class so they show on desktop -->
                <div class="util-btn" onclick="togglePanelVisibility('p1-sheet')">üë§</div>
                <div class="util-btn" onclick="togglePanelVisibility('leaderboard')">üìú</div>
            </div>

        </div>
    </div>

<!-- RIGHT SIDEBAR: LEADERBOARD -->
    <div id="leaderboard" class="glass-panel">
        <!-- ADDED class="leader-header" HERE: -->
        <div class="leader-header" style="padding:10px; background:rgba(0,0,0,0.3); border-bottom:1px solid #444; font-weight:bold; font-size:0.9rem; text-align:center;">
            LEADERBOARD
        </div>
        <div id="leader-list"></div>
        
        <!-- CLOSE BUTTON -->
        <button class="panel-close-btn" onclick="togglePanelVisibility('leaderboard')">CLOSE</button>
    </div>

</div>

<!-- TOOLTIP -->
<div id="tooltip"></div>
<div id="context-menu"></div>

<!-- MODALS (Using New Styles but preserving IDs) -->
<div id="card-modal" class="modal-overlay">
    <div class="card-modal" ondragover="allowDrop(event)" ondrop="handleSellDrop(event)">
        <div class="close-x" onclick="closeEnc()">√ó</div>
        <div class="card-header" id="enc-header">Encounter</div>
        <div class="card-body">
            <h2 id="enc-title" style="margin:0 0 10px 0; color:var(--gold-main);">Title</h2>
            <p id="enc-desc" class="card-desc">...</p>
            <div id="market-sell-area" style="display:none; border:1px dashed #666; padding:15px; margin-bottom:15px; border-radius:8px; color:#aaa;">Drag items here to SELL</div>
            <div id="choice-list"></div>
            <div id="dice-result" class="dice-result"></div>
        </div>
    </div>
</div>

<div id="arrival-modal" class="card-modal" style="padding: 0; overflow: visible;">
    <button class="close-x" onclick="continueFromArrival()">√ó</button>
    
    <!-- Wrapper for the visual border style -->
    <div class="card-border">
        <img id="arrival-image" src="" alt="Location Image" style="display:none;">
        <div class="card-body">
            <div id="arrival-flavor" class="flavor-text" style="font-style: italic; color: #fff;">...</div>
            <button class="primary" onclick="continueFromArrival()">CONTINUE</button>
        </div>
    </div>
</div>

<div id="char-detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="close-x" onclick="closeCharDetail()">√ó</div>
        <div class="card-body">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <div id="cd-portrait" class="char-portrait"></div>
                <div style="text-align:left;">
                    <div id="cd-header" style="font-weight:bold; font-size:1.2rem; color:var(--gold-main);">Name</div>
                    <div id="cd-sub" style="font-size:0.9rem; color:#aaa;">Class</div>
                </div>
            </div>
            
            <div style="display:flex; justify-content:space-around; background:#111; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div style="text-align:center;"><b id="cd-str" style="color:#fff; font-size:1.2rem;">0</b><br><small style="color:#666">STR</small></div>
                <div style="text-align:center;"><b id="cd-dex" style="color:#fff; font-size:1.2rem;">0</b><br><small style="color:#666">DEX</small></div>
                <div style="text-align:center;"><b id="cd-int" style="color:#fff; font-size:1.2rem;">0</b><br><small style="color:#666">INT</small></div>
            </div>

            <div style="text-align:left; border-top:1px solid #333; padding-top:10px;">
                <div style="margin-bottom:10px;"><span style="color:var(--gold-main)">Active:</span> <span id="cd-active">-</span><div id="cd-active-desc" style="font-size:0.8rem; color:#666; font-style:italic;"></div></div>
                <div><span style="color:var(--accent-purple)">Passive:</span> <span id="cd-passive">-</span><div id="cd-passive-desc" style="font-size:0.8rem; color:#666; font-style:italic;"></div></div>
            </div>
            
            <!-- Injection point for dynamic stats from JS -->
            
            <div id="cd-inventory-section" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                <div class="paper-doll" style="margin-bottom:10px;">
                    <div id="cd-slot-head" class="equip-slot">Head</div>
                    <div id="cd-slot-body" class="equip-slot">Body</div>
                    <div id="cd-slot-main" class="equip-slot">Main</div>
                    <div id="cd-slot-off" class="equip-slot">Off</div>
                </div>
                <div id="cd-inv-grid" class="inv-grid"></div>
            </div>
            <div id="cd-hidden-msg" style="display:none; margin-top:20px; color:#555;">Inventory Hidden</div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content" style="padding:20px;">
        <div class="close-x" onclick="toggleSettingsModal()">√ó</div>
        <h2 style="color:var(--gold-main); border-bottom:1px solid #333; padding-bottom:10px; margin-top:0;">SETTINGS</h2>
        <div style="margin-bottom:20px;">
            <label style="display:block; color:#aaa; margin-bottom:5px;">Music Volume</label>
            <input type="range" min="0" max="1" step="0.1" value="0.4" style="width:100%" oninput="AUDIO.setBGM(this.value)">
        </div>
        <div style="margin-bottom:20px;">
            <label style="display:block; color:#aaa; margin-bottom:5px;">SFX Volume</label>
            <input type="range" min="0" max="1" step="0.1" value="0.3" style="width:100%" oninput="AUDIO.setSFX(this.value)">
        </div>
        <button class="choice-btn" style="width:100%; justify-content:center;" onclick="toggleSettingsModal()">CLOSE</button>
    </div>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content help-window">
        <button class="close-x" onclick="toggleHelpModal()">√ó</button>
        
        <div class="help-header-title">ADVENTURER'S GUIDE</div>

        <!-- TABS NAVIGATION (Updated with data-tab attributes) -->
        <div class="help-tabs">
            <button class="help-tab active" onclick="switchHelpTab('tab-basics')" data-tab="tab-basics">Basics</button>
            <button class="help-tab" onclick="switchHelpTab('tab-combat')" data-tab="tab-combat">Conquest</button>
            <button class="help-tab" onclick="switchHelpTab('tab-upgrades')" data-tab="tab-upgrades">Upgrades</button>
            <button class="help-tab" onclick="switchHelpTab('tab-loot')" data-tab="tab-loot">Loot & Glory</button>
        </div>

        <!-- TAB 1: BASICS -->
        <div id="tab-basics" class="help-section active">
            <h3><span style="color:var(--gold)">‚ú¶</span> The Objective</h3>
            <p>Be the last Hero standing! Bankrupt your rivals by capturing locations and hoarding Gold. When a player runs out of money and property, they are forgotten by history.</p>
            
            <h3><span style="color:var(--gold)">‚ú¶</span> Movement & The Inn</h3>
            <p>Every journey begins at <b>Old Crooks Inn</b>. Roll <b>2d6</b> to move.</p>
            <ul>
                <li><b>Passing Start:</b> Gain <span style="color:var(--success)">+200 Gold</span> and recharge all abilities.</li>
                <li><b>Landing on Start:</b> Visit the Merchant to buy supplies. Long-press items in your inventory to sell them.</li>
            </ul>

            <h3><span style="color:var(--gold)">‚ú¶</span> Mystery Spaces</h3>
            <p><b>Fairy Ring</b> and <b>Smuggler Cove</b> (Purple) are unstable locations. They cannot be captured.</p>
            <p>When you land here, you must face an Encounter. If you succeed, you are instantly <b>Teleported</b> to a random space on the board!</p>

            <h3><span style="color:var(--gold)">‚ú¶</span> The Dungeon</h3>
            <p>If you land on "Go to Dungeon," you are arrested! You must <b>Skip your next turn</b>. If you land on the Dungeon space itself (Just Visiting), you are safe.</p>
        </div>

        <!-- TAB 2: CONQUEST -->
        <div id="tab-combat" class="help-section">
            <h3><span style="color:var(--gold)">‚ú¶</span> Empty Lands</h3>
            <p>When you discover a new location, you draw an <b>Encounter Card</b>. You must pass a Stat Check (Str, Dex, or Int) to save the town.</p>
            <ul>
                <li><b>Success:</b> You capture the location and set up Camp. You must then assign a <b>Defending Stat</b> (STR, DEX, or INT) to protect the land.</li>
                <li><b>Failure:</b> You pay a fine to the Treasury (Capital City) to repair damages.</li>
            </ul>

            <h3><span style="color:var(--gold)">‚ú¶</span> Enemy Lands</h3>
            <p>If you land on a space owned by a rival, you have two choices:</p>
            <ol>
                <li><b>Pay Rent:</b> Pay the fee directly to the owner.</li>
                <li><b>Siege (Attack):</b> Attempt to steal the land! You must roll against the location's assigned <b>Defending Stat</b>.
                    <ul>
                        <li><b>Win Siege:</b> You take the land (or kill a guard).</li>
                        <li><b>Lose Siege:</b> You pay <b>DOUBLE</b> the rent to the owner.</li>
                    </ul>
                </li>
            </ol>
        </div>

        <!-- TAB 3: UPGRADES -->
        <div id="tab-upgrades" class="help-section">
            <h3><span style="color:var(--gold)">‚ú¶</span> Building Taverns</h3>
            <p>If you land on a location you already own, you can upgrade your Camp into a <b>Tavern</b>.</p>
            <p>Taverns force enemies to draw harder <b>Skirmish Cards</b> when attacking.</p>

            <h3><span style="color:var(--gold)">‚ú¶</span> Guards</h3>
            <p>Owners of a Tavern can hire <b>Bodyguards</b> for <span style="color:var(--gold)">50G</span> each.</p>
            <p>If an enemy successfully Sieges your land, a Guard dies to protect the property. You only lose the property if there are no Guards left.</p>
        </div>

        <!-- TAB 4: LOOT -->
        <div id="tab-loot" class="help-section">
            <h3><span style="color:var(--gold)">‚ú¶</span> Treasure</h3>
            <p>Items range from <span style="color:#fff">Common</span>, <span style="color:var(--rare)">Magic</span>, <span style="color:var(--epic)">Rare</span>, to <span style="color:var(--legend)">Legendary</span>.</p>
            <p>Some items grant passive stat bonuses, while others provide active skills. <b>Scrolls</b> (like Town Portals) are one-time use.</p>

            <h3><span style="color:var(--gold)">‚ú¶</span> Capital City</h3>
            <p>Taxes collected from the Tax spaces and fines from failed captures are stored in the Kingdom's Treasury.</p>
            <p><b>Landing on Capital City</b> awards you the entire contents of the Treasury!</p>
        </div>

        <div style="text-align: center; margin-top: auto; padding: 15px; border-top: 1px solid #444; background: #111;">
            <button class="primary" onclick="toggleHelpModal()">Return to Game</button>
        </div>
    </div>
</div>

<div id="game-over-modal" class="modal-overlay">
    <div class="modal-content">
        <h1 id="go-title" style="font-size:3rem; margin:20px 0; text-shadow:0 0 10px #000;">GAME OVER</h1>
        <p id="go-msg" style="color:#ccc;">...</p>
        <div id="go-stats" style="text-align:left; padding:20px; background:#111; margin:20px 0; border-radius:8px;"></div>
        <div id="graph-legend" style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;"></div>
        <div id="graph-container" style="display:none; width:100%; height:200px; background:#222; border:1px solid #444;">
            <canvas id="game-chart"></canvas>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="choice-btn" onclick="toggleGraph()">View Graph</button>
            <button class="choice-btn" style="background:var(--gold-dim);" onclick="resetGame()">PLAY AGAIN</button>
        </div>
        <div style="display:none;"><input type="checkbox" id="chk-gold" checked><input type="checkbox" id="chk-props" checked></div>
    </div>
</div>

<div id="bankruptcy-modal" class="modal-overlay">
    <div class="modal-content" style="border-color:var(--accent-red);">
        <h1 style="color:var(--accent-red); margin:20px 0;">DEBT!</h1>
        <p>You owe <span id="debt-amount" style="color:#fff; font-weight:bold;">0</span> G</p>
        <div id="debt-prop-list" style="padding:10px; background:#111; max-height:200px; overflow-y:auto; margin-bottom:20px;"></div>
        <button id="btn-debt-done" class="choice-btn" style="width:100%; justify-content:center;" onclick="checkDebtCleared()" disabled>Pay & Continue</button>
    </div>
</div>

<!-- ================================================================
   [06] JAVASCRIPT
   ================================================================ -->
<script>
// --- REGION 1: GLOBALS & INIT ---
let scene, camera, renderer;
let tiles=[], players=[], turnIndex=0, gameState='SETUP', treasuryGold=0;
let normalDeck, skirmishDeck, treasureDeck;
let turnCount = 0, isNight = false;
let selRace=null, selClass=null, selColor="#ef4444", selActiveId=null, selPassiveId=null;
let nightBoard = null; 
let fogGroup = null;
let turnProcessing = false;

// --- CAMERA & ANIMATION GLOBALS ---
let isZoomed = false;
let cameraTarget = null;

const PLAYER_COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#FFFFFF"];
const EQUIP_ORDER = ['head', 'body', 'main', 'off'];

// --- REGION 2: DATA (Names, Races, Classes) ---
const NPC_NAMES = [
    "Aaelin", "Adran", "Aelar", "Aeron", "Alaric", "Aldric", "Amara", "Arin", "Asher", "Astrid", 
    "Balthazar", "Bard", "Bran", "Caelum", "Caius", "Caspian", "Cedric", "Corin", "Cyrus", "Darian", 
    "Eamon", "Elander", "Elara", "Eldrin", "Elric", "Emrys", "Faen", "Fenris", "Finn", "Galen", 
    "Gideon", "Gorim", "Griffin", "Hadrian", "Haldor", "Ignis", "Imara", "Ion", "Jareth", "Jax", 
    "Kael", "Kaiden", "Kian", "Kyra", "Leander", "Leo", "Lucian", "Magnus", "Marek", "Mathis",
    "Nael", "Nyx", "Orion", "Orin", "Osric", "Perrin", "Quinn", "Raen", "Ragnar", "Ravyn", 
    "Remus", "Rian", "Roan", "Rurik", "Ryker", "Silas", "Soren", "Stig", "Storm", "Talis", 
    "Thorne", "Torin", "Tristan", "Tybalt", "Uric", "Valen", "Varis", "Vesper", "Xander", "Zane"
];

const RACES = [ 
    {id:'human', name:'Human', stats:{str:2, dex:2, int:2}}, 
    {id:'elf', name:'Elf', stats:{str:1, dex:3, int:2}}, 
    {id:'dwarf', name:'Dwarf', stats:{str:3, dex:1, int:2}}, 
    {id:'orc', name:'Orc', stats:{str:4, dex:1, int:1}}, 
    {id:'gnome', name:'Gnome', stats:{str:1, dex:2, int:3}}, 
    {id:'tiefling', name:'Tiefling', stats:{str:1, dex:1, int:4}}, 
    {id:'dragonborn', name:'Dragonborn', stats:{str:3, dex:2, int:1}}, 
    {id:'halfling', name:'Halfling', stats:{str:1, dex:4, int:1}} 
];

const CLASSES = [
    { id: 'fighter', name: 'Fighter', color: 0x8B0000, 
      actives: ['second_wind', 'power_strike', 'intimidate'], 
      passives: ['veteran', 'iron_skin', 'executioner'] },
    { id: 'wizard', name: 'Wizard', color: 0x4B0082, 
      actives: ['fireball', 'transmute_gold', 'blink'], 
      passives: ['scholar', 'court_mage', 'alchemist_pas'] }, 
    { id: 'rogue', name: 'Rogue', color: 0x2F4F4F, 
      actives: ['pickpocket', 'sprint_act', 'smoke_bomb'], 
      passives: ['shadow_step', 'greedy', 'fence'] },
    { id: 'cleric', name: 'Cleric', color: 0xFFD700, 
      actives: ['heal_light', 'smite', 'bless'], 
      passives: ['devotion', 'medic', 'holy_aura'] }
];

const CHAR_PORTRAITS = {
    human_fighter: "https://static.wixstatic.com/media/b16479_85518cf9c4d646c2994697b826b54bff~mv2.jpg",
    human_wizard: "https://static.wixstatic.com/media/b16479_67634ea082d04f388af02accc2e0a2bc~mv2.jpg",
    human_rogue: "https://static.wixstatic.com/media/b16479_7f27982f60994088b1740631284815b3~mv2.jpg",
    human_cleric: "https://static.wixstatic.com/media/b16479_0293976216c3443187ebcc00fcb1e071~mv2.jpg",
    elf_fighter: "https://static.wixstatic.com/media/b16479_97dd792642d444f59cb3b21842131c6a~mv2.jpg",
    elf_wizard: "https://static.wixstatic.com/media/b16479_19a126df94694355b2381756b2ad35da~mv2.jpg",
    elf_rogue: "https://static.wixstatic.com/media/b16479_ffdbe8eb72214036a2f95e2f5a9e6f48~mv2.jpg",
    elf_cleric: "https://static.wixstatic.com/media/b16479_82514ff810324b4ca9c6218b6d4e2da6~mv2.jpg",
    dwarf_fighter: "https://static.wixstatic.com/media/b16479_15e678031c824dfaa6ff4b851c470c39~mv2.jpg",
    dwarf_wizard: "https://static.wixstatic.com/media/b16479_f84ec5deac214cd3b570517773edd83e~mv2.jpg",
    dwarf_rogue: "https://static.wixstatic.com/media/b16479_81d5ee7fd64c4d1a911252797b8b34bd~mv2.jpg",
    dwarf_cleric: "https://static.wixstatic.com/media/b16479_67a5b13eb3654884b520fcff34f7af0e~mv2.jpg",
    orc_fighter: "https://static.wixstatic.com/media/b16479_733a0e4ffb554734a58229af907bb5e5~mv2.jpg",
    orc_wizard: "https://static.wixstatic.com/media/b16479_a99213a85fa74dc7925dc1fb2d26987f~mv2.jpg",
    orc_rogue: "https://static.wixstatic.com/media/b16479_a0df2ed1b7b3412ba4694f474bf0846b~mv2.jpg",
    orc_cleric: "https://static.wixstatic.com/media/b16479_881698035b3b41c6932393d2b0975359~mv2.jpg",
    gnome_fighter: "https://static.wixstatic.com/media/b16479_7d856dc2c71e4b60aff24ef59172897b~mv2.jpg",
    gnome_wizard: "https://static.wixstatic.com/media/b16479_7466d1b684c04c459bb588da3225158d~mv2.jpg",
    gnome_rogue: "https://static.wixstatic.com/media/b16479_3c67ae62970347d5a96a83248d7680f2~mv2.jpg",
    gnome_cleric: "https://static.wixstatic.com/media/b16479_36767d44051346c49f9e4c0995ece904~mv2.jpg",
    tiefling_fighter: "https://static.wixstatic.com/media/b16479_a5e3e133b61f463a8bcc0ce93b582d25~mv2.jpg",
    tiefling_wizard: "https://static.wixstatic.com/media/b16479_afd36e1dcbc2485cac93ae49155eae58~mv2.jpg",
    tiefling_rogue: "https://static.wixstatic.com/media/b16479_9168e6f8da2e48659f4ced1d8c7aad8c~mv2.jpg",
    tiefling_cleric: "https://static.wixstatic.com/media/b16479_689c4a94dbb6418681634d65878c8022~mv2.jpg",
    dragonborn_fighter: "https://static.wixstatic.com/media/b16479_d5e785f4d11e4d8288a3e963c6902b2c~mv2.jpg",
    dragonborn_wizard: "https://static.wixstatic.com/media/b16479_8e63663f55f142fa81a3958b3a2b0d7b~mv2.jpg",
    dragonborn_rogue: "https://static.wixstatic.com/media/b16479_d4f401dc822b421ca753799e82879c99~mv2.jpg",
    dragonborn_cleric: "https://static.wixstatic.com/media/b16479_dab195d558d94074a19bb86b45972311~mv2.jpg",
    halfling_fighter: "https://static.wixstatic.com/media/b16479_1692c0cb049249a1b5d49ac4f8901b97~mv2.jpg",
    halfling_wizard: "https://static.wixstatic.com/media/b16479_0dcf3d49ab0b4dd7b0ca03d0ed6c09f8~mv2.jpg",
    halfling_rogue: "https://static.wixstatic.com/media/b16479_b031efc88dfe49899f2e2b4f619c788e~mv2.jpg",
    halfling_cleric: "https://static.wixstatic.com/media/b16479_ffa702bd84c141fca8fa7cbfd86f581d~mv2.jpg"
};

const ABILITY_LIBRARY = {
    // --- MODIFIED SKILLS ---
    shadow_step: { 
        name: "Shadow Step", desc: "Permanent +1 DEX. +1 to all Movement rolls.", type:'passive', 
        effect:(s)=>s.dex+=1,
        onRoll: (p) => { 
            const r = Math.floor(Math.random() * 11) + 2 + 1; 
            addLog(`${p.name} Shadow Steps (+1 Move)!`, "log-rare"); 
            return r; 
        },
        img: "https://static.wixstatic.com/media/b16479_923e7271de194ba69a6d2243650e2c41~mv2.jpg" 
    },
    midas: { 
        name: "Midas Touch", desc: "Passive: Double Gold from 'Pouch of Gold' and 'Lucky Coin' items.", type:'passive', 
        img: "https://static.wixstatic.com/media/b16479_869668d07a5f47fe804e17ab6c6306e1~mv2.jpg"
    },
    heal: { 
        name: "Well Made", desc: "Passive: This item sells for 3x its normal value.", type:'passive', 
        img: "https://static.wixstatic.com/media/b16479_6fbb98ea84a9479b98dd0441fd7152b6~mv2.jpg" 
    },
    freeze: { 
        name: "Ice Blast", desc: "A random player skips their next turn.", 
        fn: (p) => { 
            const targets = players.filter(t => t.id !== p.id && !t.isDead);
            if(targets.length > 0) {
                const t = targets[Math.floor(Math.random() * targets.length)];
                t.isSkipping = true; 
                addLog(`Ice Blast froze ${t.name}!`, "log-epic"); 
                return true; 
            } else {
                addLog("No targets to freeze.", "log-fail");
                return false;
            }
        }, 
        img: "https://static.wixstatic.com/media/b16479_4449fff43db746d2962beedde6da3ba6~mv2.jpg" 
    },
    scavenge: { 
        name: "Scavenge", desc: "Gain 10G each time you capture a space from an enemy.", type:'passive',
        onCapture: (p, t) => {
            p.gold += 10;
            addLog("Scavenge: +10G", "log-gold");
            updateHUD();
        },
        img: "https://static.wixstatic.com/media/b16479_4d3e9a05134247fab12617463bdca1ef~mv2.jpg" 
    },

    // --- EXISTING SKILLS ---
    executioner: { name: "Executioner", desc: "Rolling a 6 in combat counts as 2 Successes.", type:'passive', img: "https://static.wixstatic.com/media/b16479_cee24d678cfa47568f5f632c40743626~mv2.jpeg" },
    iron_skin: { name: "Iron Skin", desc: "Reduce all fail penalties by 20G.", type:'passive', img: "https://static.wixstatic.com/media/b16479_c3d88e0d6986494d914fd12047d258ca~mv2.jpeg" },
    intimidate: { name: "Intimidate", desc: "Force a target to pay you 50G.", fn: (p) => { let target = null; for(let i=1; i<players.length; i++) { const t = players[(p.id + i) % players.length]; if(!t.isDead) { target = t; break; } } if(target) { addLog(`${p.name} intimidates ${target.name}!`, "log-accent"); pay(target, 50, p); return true; } else { addLog("No valid targets.", "log-fail"); return false; } }, img: "https://static.wixstatic.com/media/b16479_29cbfcb090ef4fc782dcf43faa34fcc4~mv2.jpeg" },
    veteran: { name: "Veteran", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1, img: "https://static.wixstatic.com/media/b16479_9418e25969754a69a13b825cc2e70bbf~mv2.jpeg" },
    power_strike: { name: "Power Strike", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str+=5; addLog("Power Strike prepared!", "log-success"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_3599509de5064815a86ecbae3f9979da~mv2.jpeg" },
    ghost_hand: { name: "Ghost Hand", desc: "Steal 100G from a random player.", fn: (p) => { const targets = players.filter(t => t.id !== p.id && !t.isDead && t.gold >= 1); if(targets.length > 0) { const t = targets[Math.floor(Math.random() * targets.length)]; addLog(`${p.name} uses Ghost Hand on ${t.name}!`, "log-accent"); pay(t, 100, p); return true; } else { addLog("No valid targets.", "log-fail"); return false; }}, img: "https://static.wixstatic.com/media/b16479_e67cc7aa00584c0a8e146b97246b65f4~mv2.jpeg" },
    second_wind: { name: "Second Wind", desc: "Gain 100 Gold immediately.", fn: (p) => { p.gold+=100; addLog("Second Wind: +100G", "log-gold"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_3a036a923c5945778d3b8393634892b1~mv2.jpeg" },
    dash: { name: "Dash", desc: "Move 3 spaces immediately.", fn: (p) => { addLog("Dashed forward!", "log-success"); animateMove(p, 3); return true; }, img: "https://static.wixstatic.com/media/b16479_41cfe447b8eb4376a3b8d87b7adc1fbe~mv2.jpeg" },

    // --- NEW RANDOM ABILITIES ---
    haggler: { name: "Haggler", desc: "Passive: All Shop items cost 25% less.", type:'passive', img: "https://static.wixstatic.com/media/b16479_2ba70fe3c905462aba90a1c434163f08~mv2.jpeg" },
    gold_rush: { name: "Gold Rush", desc: "Passive: Gain +50G immediately whenever you land on a Chest tile.", type:'passive', onLanding: (p) => { if(tiles[p.pos].userData.info.type === 'chest') { p.gold += 50; addLog("Gold Rush: +50G!", "log-gold"); updateHUD(); } }, img: "https://static.wixstatic.com/media/b16479_a16b936431f54cb9b0c14fc110db0363~mv2.jpeg" },
    escape_artist: { name: "Escape Artist", desc: "Passive: Fleeing awards the gold reward without fighting.", type:'passive', img: "https://static.wixstatic.com/media/b16479_6c7a5d29595e42cdbc625397ad4a9a7d~mv2.jpeg" },
    divine_shield: { name: "Divine Shield", desc: "Active: Ignore the next penalty/damage you would take.", fn: (p) => { addLog("Divine Shield activated!", "log-epic"); return true; }, img: "https://static.wixstatic.com/media/b16479_c8fb1f2502ce472bb9fb6d19d463285c~mv2.jpeg" },
    landlord: { name: "Landlord", desc: "Passive: Enemies pay +20% Rent when landing on your properties.", type:'passive', img: "https://static.wixstatic.com/media/b16479_8d16ceb9c83448528c0309942f785c8a~mv2.jpeg" },
    vampirism: { name: "Vampirism", desc: "Passive: Gain 10G for every successful die roll in combat.", type:'passive', img: "https://static.wixstatic.com/media/b16479_6a42b45b920a4bc6bd8f92bc8fc51ad1~mv2.jpeg" },
    gamblers_luck: { name: "Gambler's Luck", desc: "Passive: Prompt to reroll 1s on Move or Combat.", type: 'active', fn: (p) => { addLog("Passively triggers when you roll a 1.", "log-rare"); return false; }, img: "https://static.wixstatic.com/media/b16479_613c6b72c1984c8d93398e7f00ae2ee0~mv2.jpeg" },
    ambush_master: { name: "Ambush", desc: "Passive: Start every combat with 1 automatic Success.", type:'passive', img: "https://static.wixstatic.com/media/b16479_6274cb33103f496d958019147a605599~mv2.jpeg" },

    // --- OTHER EXISTING SKILLS ---
    teleport: { 
        name: "Town Portal", 
        desc: "Teleport to Old Crooks Inn.", 
        fn: (p) => { 
            p.pos = 0; 
            const target = tiles[0];
            
            // Use new helper
            animateTeleport(p, target, () => {
                resolveLanding(p);
            });
            
            addLog("Teleported to Inn.", "log-rare"); 
            return true; 
        }, 
        img: "https://static.wixstatic.com/media/b16479_e2653f032408459ea8d64eb87faf86fb~mv2.jpeg" 
    },
    backtrack: { name: "Recall", desc: "Move backwards 3 spaces.", fn: (p) => { p.pos = (p.pos - 3 + 40) % 40; const t = tiles[p.pos]; new TWEEN.Tween(p.mesh.position).to({x:t.position.x, z:t.position.z}, 500).onComplete(()=>resolveLanding(p)).start(); addLog("Rewound time.", "log-epic"); return true; }, img: "https://static.wixstatic.com/media/b16479_40db1c3f8b6b4c11bc8a509c62133e48~mv2.jpeg" },
    bribe: { 
        name: "Silver Tongue", desc: "Pay 100G: Steal ownership of current enemy tile.", type: 'active', img: "https://static.wixstatic.com/media/b16479_4eea8ba2071047a1bdc17eb37b648db3~mv2.jpeg", 
        fn: (p) => { 
            const t = tiles[p.pos];
            if (t.userData.owner === null || t.userData.owner === p.id) { addLog("Can only bribe on Enemy Land.", "log-fail"); return false; }
            if (p.gold < 100) { addLog("Need 100 Gold.", "log-fail"); return false; }
            p.gold -= 100;
            const prevOwner = players[t.userData.owner];
            t.userData.owner = p.id;
            if (t.userData.prop) { t.userData.prop.children.forEach(mesh => { if(mesh.material) mesh.material.color.setHex(parseInt(p.color.replace('#','0x'))); }); }
            addLog(`Bribed officials! Stole land from ${prevOwner.name}.`, "log-epic");
            updateHUD(); closeEnc(); return true; 
        } 
    },
    swap: { name: "Chaos Swap", desc: "Swap positions with random player.", fn: (p) => { const targets = players.filter(t => t.id !== p.id && !t.isDead); if(targets.length > 0) { const t = targets[Math.floor(Math.random() * targets.length)]; const tempPos = p.pos; p.pos = t.pos; t.pos = tempPos; p.mesh.position.copy(tiles[p.pos].position); t.mesh.position.copy(tiles[t.pos].position); addLog(`Swapped with ${t.name}!`, "log-epic"); return true; } return false; }, img: "https://static.wixstatic.com/media/b16479_981b877ce6714658adb31c29d8e69685~mv2.jpeg" },
    might: { name: "Giant's Str", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str += 5; addLog("Strength surged!", "log-success"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_966a061562c2433bbcefaec1ecf83776~mv2.jpeg" },
    focus: { name: "Mind's Eye", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int += 5; addLog("Focus sharpened!", "log-success"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_1066eb1edb9b4611b0513793cbbfacbf~mv2.jpeg" },
    agility: { name: "Cat's Grace", desc: "Gain +5 DEX until end of turn.", fn: (p) => { p.stats.dex += 5; addLog("Reflexes heightened!", "log-success"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_dff1cef153fd46f48cf12f64ba7217fd~mv2.jpeg" },
    transmute: { name: "Alchemy", desc: "Destroy a random inventory item for 300G.", fn: (p) => { if(p.inventory.length > 0) { const idx = Math.floor(Math.random()*p.inventory.length); const it = p.inventory.splice(idx, 1)[0]; p.gold += 300; addLog(`Transmuted ${it.name} to 300G.`, "log-gold"); updateHUD(); return true; } else { addLog("No items to transmute.", "log-fail"); return false; }}, img: "https://static.wixstatic.com/media/b16479_6c7a5d29595e42cdbc625397ad4a9a7d~mv2.jpeg" },
    tax_evade: { name: "Tax Dodge", desc: "Gain immunity to Tax tiles (Passive).", type:'passive', img: "https://static.wixstatic.com/media/b16479_faa8ed7823a34bcab4aa949ddde8ea08~mv2.jpeg" },
    bounty: { name: "Bounty Hunter", desc: "Gain 50G when winning a fight.", type: 'passive', onCombatVictory: (p) => { p.gold += 50; addLog("Bounty Hunter Reward: +50G", "log-gold"); updateHUD(); }, img: "https://static.wixstatic.com/media/b16479_e5a29d46970543149ab7224376250d34~mv2.jpeg" },
    lucky: { name: "Lucky Charm", desc: "Prompt to Reroll movement dice once per turn.", type: 'active', fn: (p) => { addLog("This skill triggers automatically when you roll.", "log-rare"); return false; }, img: "https://static.wixstatic.com/media/b16479_c5e3924f36c94d2793f1f3fd2ee349ad~mv2.jpeg" },
    anchor: { name: "Iron Anchor", desc: "You cannot be moved by enemy effects (Passive).", type:'passive', img: "https://static.wixstatic.com/media/b16479_1771400b778146b4871aad58992050b5~mv2.jpeg" },
    
    // --- UPDATED COMPLEX SKILLS ---
    fireball: { 
        name: "Fireball", desc: "Pay 100G. Destroy a random enemy property.", 
        img: "https://static.wixstatic.com/media/b16479_29ff412f99834658ac8d32d32e16849a~mv2.jpg",
        fn: (p) => { 
            if(p.gold < 100) { addLog("Need 100G.", "log-fail"); return false; }
            const enemyTiles = tiles.filter(t => t.userData.owner !== null && t.userData.owner !== p.id);
            if(enemyTiles.length === 0) { addLog("No enemy lands to burn.", "log-fail"); return false; }
            
            p.gold -= 100;
            const t = enemyTiles[Math.floor(Math.random() * enemyTiles.length)];
            const victim = players[t.userData.owner];
            
            addLog(`Fireball hit ${t.userData.info.name}!`, "log-epic");
            
            if(t.userData.buildingLevel > 1) {
                t.userData.buildingLevel = 1;
                addLog(`Tavern burned down!`, "log-fail");
                // Refresh visual
                if(t.userData.prop) { t.remove(t.userData.prop); }
                const g = new THREE.Group();
                const m = new THREE.Mesh(new THREE.ConeGeometry(1, 1.5, 4), new THREE.MeshStandardMaterial({ color: parseInt(victim.color.replace('#','0x')) })); 
                m.position.set(0, 0.5, 0); g.add(m);
                t.add(g); t.userData.prop = g;
            } else {
                t.userData.owner = null;
                t.userData.buildingLevel = 0;
                t.userData.guardCount = 0;
                if(t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; }
                addLog(`Property destroyed!`, "log-fail");
            }
            updateHUD();
            return true;
        } 
    },
    
transmute_gold: { 
        name: "Transmute", desc: "Pay 50G. Destroy 1 Item -> Draw Treasure.", img: "https://static.wixstatic.com/media/b16479_765369c1c1bd4a8abb1b752a2245f56c~mv2.jpg",
        fn: (p) => {
            // --- AI LOGIC FIX ---
            if (p.isAi) {
                if (p.gold < 50) return false;
                if (p.inventory.length === 0) return false;
                
                // Find item with lowest cost
                let cheapestIdx = 0;
                let minCost = 9999;
                p.inventory.forEach((item, idx) => {
                    let cost = item.cost || 0;
                    if(cost < minCost) { minCost = cost; cheapestIdx = idx; }
                });

                p.gold -= 50;
                const removed = p.inventory.splice(cheapestIdx, 1)[0];
                addLog(`${p.name} transmuted ${removed.name}!`, "log-epic");
                
                const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
                p.inventory.push({...card}); 
                addLog(`${p.name} gained ${card.name}`, "log-success");
                
                return true;
            }
            // --------------------

            // HUMAN LOGIC (Existing)
            if (p.gold < 50) { addLog("Need 50G.", "log-fail"); return false; }
            if (p.inventory.length === 0) { addLog("Inventory empty.", "log-fail"); return false; }
            let opts = p.inventory.map((item, idx) => ({
                txt: `Destroy ${item.name}`,
                act: () => {
                    p.gold -= 50; const removed = p.inventory.splice(idx, 1)[0]; 
                    addLog(`Transmuted ${removed.name}!`, "log-gold");
                    drawCardAnim('treasure', () => { 
                        const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
                        p.inventory.push({...card}); addLog("Gained " + card.name, "log-success"); updateHUD(); closeEnc(); 
                    });
                }
            }));
            opts.push({txt: "Cancel", act: () => {}}); 
            showModal("Transmute", "Select an item to sacrifice.", opts);
            return true;
        } 
    },
    
    blink: { name: "Blink", desc: "Move 1-6 spaces immediately.", fn: (p) => { const dist = Math.floor(Math.random()*6)+1; addLog(`Blinked ${dist} spaces!`, "log-rare"); animateMove(p, dist); return true; }, img: "https://static.wixstatic.com/media/b16479_ead02548bf264a2eb097464789b65b11~mv2.jpg" },
    scholar: { name: "Scholar", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1, img: "https://static.wixstatic.com/media/b16479_dde7a886c214487e9142449b77ae86f0~mv2.jpg" },
    court_mage: { name: "Court Mage", desc: "Immune to Tax. Gain 10G whenever others pay Tax.", type:'passive', img: "https://static.wixstatic.com/media/b16479_60838e488fae4e7e896c8cfe64f5bc03~mv2.jpg" },
    alchemist_pas: { name: "Alchemist", desc: "Drawing 'Pouch of Gold' triggers an extra Treasure draw.", type:'passive', img: "https://static.wixstatic.com/media/b16479_e0bd1a01c0b344f086778fea802be2ca~mv2.jpg" },
    
    pickpocket: { 
        name: "Pickpocket", desc: "Steal 10G per property from a random player.", img: "https://static.wixstatic.com/media/b16479_13ee3ae3151c40f58f7152857c4d97ff~mv2.jpg",
        fn: (p) => { 
            const targets = players.filter(t => t.id !== p.id && !t.isDead);
            if(targets.length === 0) { addLog("No targets.", "log-fail"); return false; }
            const t = targets[Math.floor(Math.random() * targets.length)];
            const propCount = tiles.filter(tile => tile.userData.owner === t.id).length;
            if(propCount === 0) { addLog(`${t.name} has no pockets to pick.`, "log-fail"); return false; }
            const stealAmt = Math.min(propCount * 10, t.gold);
            if(stealAmt > 0) {
                t.gold -= stealAmt; p.gold += stealAmt;
                addLog(`Pickpocket: Stole ${stealAmt}G from ${t.name}!`, "log-success"); updateHUD(); return true;
            }
            addLog(`${t.name} is broke.`, "log-fail"); return false;
        } 
    },
    
    sprint_act: { name: "Sprint", desc: "Move 3 spaces.", fn: (p) => { animateMove(p, 3); return true; }, img: "https://static.wixstatic.com/media/b16479_2a97d38d75f14a7c96eb980178f1bdf6~mv2.jpg" },
    smoke_bomb: { 
        name: "Skeleton Key", desc: "Passive: Immunity to Dungeon. Trap: Steal 50G if enemy lands on you.", type: 'passive', img: "https://static.wixstatic.com/media/b16479_6c10e5ce01164b79bb957d07613143ae~mv2.jpg",
        onEnemyLanding: (victim, owner) => {
            if(victim.gold >= 50) {
                victim.gold -= 50; owner.gold += 50;
                addLog(`${owner.name}'s Trap caught ${victim.name}! (-50G)`, "log-accent"); updateHUD();
            }
        }
    },
    
    shadow_step: { name: "Shadow Step", desc: "Permanent +1 DEX and Movement.", type:'passive', effect:(s)=>s.dex+=1, img: "https://static.wixstatic.com/media/b16479_923e7271de194ba69a6d2243650e2c41~mv2.jpg" },
    greedy: { name: "Greedy", desc: "Start with +200G.", type:'passive', effect:(s)=>s.gold+=200, img: "https://static.wixstatic.com/media/b16479_9555d2fe87f74320a96619cdb7f057a4~mv2.jpg" },
    fence: { name: "Fence", desc: "Sell items for 80% value (usually 50%).", type:'passive', img: "https://static.wixstatic.com/media/b16479_7f7f664290b14d51a9aa304396c46d67~mv2.jpg" },
    
    heal_light: { 
        name: "Spirit Tithe", desc: "Passive: Gain 5G on enemy land, +10G on owned land.", type: 'active', 
        fn: (p) => { addLog("Spirit Tithe is always active.", "log-success"); return false; }, 
        onLanding: (p) => { const t = tiles[p.pos]; if (t.userData.owner === p.id) { p.gold += 10; addLog("Spirit Tithe: +10G", "log-gold"); } else if (t.userData.owner !== null) { p.gold += 5; addLog("Spirit Tithe: +5G", "log-gold"); } updateHUD(); }, img: "https://static.wixstatic.com/media/b16479_73cb0754c25246689fbe4db244b98da1~mv2.jpg" 
    },
    
    smite: { 
        name: "Smite", desc: "Instant Capture/Upgrade/Guard. Cooldown: Move 1d6.", type: 'active', img: "https://static.wixstatic.com/media/b16479_de48e0494048408dbd67d6c2008aee28~mv2.jpg",
        onRoll: (p) => { if(p.classSkillDepleted) { addLog("Smite Exhaustion: Movement halved (1d6).", "log-fail"); return Math.floor(Math.random() * 6) + 1; } return null; },
        fn: (p) => { 
            const t = tiles[p.pos]; const i = t.userData.info;
            if (!i.cost || i.cost === 0 || i.type === 'start' || i.type === 'goto' || i.type === 'jail' || i.type === 'tax') { addLog("Cannot Smite this location.", "log-fail"); return false; }
            addLog("Smite invoked!", "log-epic");
            const modal = document.getElementById('card-modal'); if(modal) modal.classList.remove('active');
            let lvl = 1;
            if (t.userData.owner === p.id) {
                if (t.userData.buildingLevel === 1) lvl = 2; 
                else { t.userData.guardCount = (t.userData.guardCount || 0) + 1; addLog("Smite: Guard Summoned!", "log-success"); return true; }
            }
            capture(t, p, lvl, () => { updateHUD(); endStep(); }); return true; 
        } 
    },
    bless: { name: "Bless", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int+=5; addLog("Blessed!", "log-success"); updateHUD(); return true; }, img: "https://static.wixstatic.com/media/b16479_75752aecbee444ada136a1d9c923b8f8~mv2.jpg" },
    devotion: { name: "Devotion", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1, img: "https://static.wixstatic.com/media/b16479_4ad91e74342448b08fd19799f492d69b~mv2.jpg" },
    medic: { name: "Medic", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1, img: "https://static.wixstatic.com/media/b16479_e222db131e6e4e2180c5bd4dcd0dd6f4~mv2.jpg" },
    holy_aura: { 
        name: "Holy Aura", desc: "Gain 20G when landing on a space with another hero.", type: 'passive', img: "https://static.wixstatic.com/media/b16479_967b2ee34245413a8b04aa43b0fe04b8~mv2.jpg",
        onLanding: (p) => { 
            let metHero = false; players.forEach(other => { if(other.id !== p.id && !other.isDead && other.pos === p.pos) metHero = true; });
            if(metHero) { p.gold += 20; addLog("Holy Aura: +20G (Met Hero)", "log-gold"); updateHUD(); }
        }
    },
};

function generateTreasureDeck() {
    const deck = [];
    const itemNames = ["Sword", "Shield", "Helm", "Armor", "Wand", "Staff", "Bow", "Dagger", "Boots", "Gloves", "Ring", "Amulet", "Cloak", "Belt"];
    const slots = ['main', 'off', 'head', 'body', 'main', 'main', 'main', 'main', 'body', 'body', 'off', 'head', 'body', 'body'];
    const stats = ['str', 'str', 'str', 'str', 'int', 'int', 'dex', 'dex', 'dex', 'dex', 'int', 'int', 'dex', 'str'];
    const abilities = Object.keys(ABILITY_LIBRARY);
    
    // Updated Pouch of Gold with Sound
    for(let i=0; i<20; i++) deck.push({ 
        id: `g${i}`, name: "Pouch of Gold", type: 'scroll', rarity: 'common', cost: 0, desc: "Gain 50 Gold", 
        fn: (p) => { 
            let amt = 50;
            if (p.activeSkillId === 'midas' || p.passiveSkillId === 'midas' || ['head','body','main','off'].some(s => p.equipment[s] && p.equipment[s].ability && p.equipment[s].ability.name === "Midas Touch")) {
                amt *= 2; 
                addLog("Midas Touch! Gold doubled.", "log-gold");
            }
            p.gold += amt; 
            
            // --- AUDIO ---
            if(p.id === 0) AUDIO.playSound('sfx_gold');
            
            addLog(`+${amt} Gold`, "log-gold"); 
            updateHUD(); 
        } 
    });

    for(let i=0; i<20; i++) { const idx = i % itemNames.length; deck.push({ id: `c${i}`, name: `Old ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: {}, rarity: 'common', cost: 50 }); }
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=1; deck.push({ id: `m${i}`, name: `Magic ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'rare', cost: 200 }); }
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=2; const abil = ABILITY_LIBRARY[abilities[i % abilities.length]]; deck.push({ id: `r${i}`, name: `Ancient ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'epic', cost: 500, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } }); }
    for(let i=0; i<10; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=3; const abil = ABILITY_LIBRARY[abilities[(i+10) % abilities.length]]; deck.push({ id: `l${i}`, name: `Legendary ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'legendary', cost: 1200, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } }); }
    
    deck.push({ id: 's1', name: "Town Portal", type: 'scroll', rarity: 'rare', cost: 100, desc: "Teleport to Inn", fn: ABILITY_LIBRARY.teleport.fn });
    deck.push({ id: 's2', name: "Potion of Healing", type: 'scroll', rarity: 'common', cost: 50, desc: "Cure status", fn: ABILITY_LIBRARY.heal.fn });
    deck.push({ id: 's3', name: "Sprint Scroll", type: 'scroll', rarity: 'common', cost: 50, desc: "Dash 3 spaces", fn: ABILITY_LIBRARY.dash.fn });
    deck.push({ id: 's4', name: "Transmute Scroll", type: 'scroll', rarity: 'epic', cost: 300, desc: "Item to Gold", fn: ABILITY_LIBRARY.transmute.fn });
    
    // Updated Lucky Coin with Sound
    for(let i=4; i<10; i++) deck.push({ 
        id: `s${i}`, name: "Lucky Coin", type: 'scroll', rarity: 'common', cost: 50, desc: "Gain 20-100G", 
        fn: (p) => { 
            let r = Math.floor(Math.random()*6)+1; 
            let amt = 0;
            if(r > 3){ amt = 200; } else { amt = -50; } 
            
            if (amt > 0 && (p.activeSkillId === 'midas' || p.passiveSkillId === 'midas' || ['head','body','main','off'].some(s => p.equipment[s] && p.equipment[s].ability && p.equipment[s].ability.name === "Midas Touch"))) {
                amt *= 2;
                addLog("Midas Touch! Winnings doubled.", "log-gold");
            }

            if(amt > 0) { 
                p.gold += amt; 
                if(p.id === 0) AUDIO.playSound('sfx_gold'); 
                addLog(`Rolled ${r}: Won ${amt}G!`, "log-gold"); 
            }
            else { 
                pay(p, 50); // pay() already handles sfx_gold logic
                addLog(`Rolled ${r}: Lost 50G.`, "log-fail"); 
            }
            updateHUD(); 
        } 
    });
    return deck;
}

const DECK_TREASURE = generateTreasureDeck();
const DECK_ENCOUNTER = [
    // STR/DEX
    {name:"Goblin Ambush", type:'combat', desc:"Goblins jump from the trees!", choices:[{txt:"Power Through (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Dodge & Counter (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bar Fight", type:'combat', desc:"A drunk patron swings a stool at you.", choices:[{txt:"Punch Back (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Weave Away (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Wolf Pack", type:'combat', desc:"Hungry wolves circle you.", choices:[{txt:"Intimidate (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:20}, {txt:"Quick Strikes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Rogue Duelist", type:'combat', desc:"He challenges you to a duel.", choices:[{txt:"Overpower (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80}, {txt:"Parry (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Rocks", type:'check', desc:"A landslide! React fast!", choices:[{txt:"Hold it up (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Dive (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40}]},
    {name:"Mud Pit", type:'check', desc:"You are stuck in thick mud.", choices:[{txt:"Pull Out (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture', val:30},{txt:"Balance Out (DEX 5+)", stat:'dex', tn:5, fail:40, mode:'capture', val:80}]},
    {name:"Giant Spider", type:'combat', desc:"It descends on a silk thread.", choices:[{txt:"Smash It (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture'},{txt:"Roll Away (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bear Trap", type:'check', desc:"SNAP! Your leg is caught.", choices:[{txt:"Pry Open (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:50},{txt:"Pick Lock (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Wild Boar", type:'combat', desc:"It charges from the brush.", choices:[{txt:"Wrestle (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Matador Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Chandelier", type:'check', desc:"The chain snaps above you!", choices:[{txt:"Catch It (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Jump Away (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20}]},
    {name:"Runaway Cart", type:'check', desc:"It's rolling down the hill towards town.", choices:[{txt:"Stop it (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Jump on & Steer (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Training Dummy", type:'combat', desc:"A magically animated sparring partner.", choices:[{txt:"Heavy Hit (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture'},{txt:"Precision (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture'}]},
    {name:"Bee Swarm", type:'combat', desc:"Not the bees! They are everywhere!", choices:[{txt:"Swat Wildly (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Outrun (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:30}]},
    {name:"Arm Wrestling", type:'check', desc:"A dwarf challenges you.", choices:[{txt:"Brute Force (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Technique (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Bandit Toll", type:'check', desc:"They block the bridge.", choices:[{txt:"Shove Aside (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Slip Past (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Greased Pig", type:'check', desc:"Catch the prize pig at the fair.", choices:[{txt:"Tackle (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:60},{txt:"Snatch (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:90}]},
    {name:"Crumbling Floor", type:'check', desc:"The wood gives way beneath you.", choices:[{txt:"Hang on (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture', val:20},{txt:"Leap (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50}]},

    // DEX/INT
    {name:"Arcane Trap", type:'check', desc:"Runes glow on the floor.", choices:[{txt:"Disarm (DEX 5+)", stat:'dex', tn:5, fail:60, mode:'capture', val:100},{txt:"Dispel (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:50}]},
    {name:"Pickpocket", type:'check', desc:"A thief bumps into you.", choices:[{txt:"Grab Him (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Predict Path (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Locked Gate", type:'check', desc:"An ancient mechanism blocks the way.", choices:[{txt:"Climb Over (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Solve Puzzle (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Illusionist", type:'combat', desc:"Copies of the wizard surround you.", choices:[{txt:"Strike True (DEX 5+)", stat:'dex', tn:5, fail:50, mode:'capture', val:80},{txt:"See Truth (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Arrow Storm", type:'combat', desc:"Arrows fly from the bushes.", choices:[{txt:"Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'},{txt:"Shield Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Card Game", type:'check', desc:"A high stakes game at a tavern.", choices:[{txt:"Sleight of Hand (DEX 5+)", stat:'dex', tn:5, fail:100, mode:'capture', val:200},{txt:"Count Cards (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:100}]},
    {name:"Poison Gas", type:'check', desc:"Green mist fills the room.", choices:[{txt:"Hold Breath & Run (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Identify Antidote (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:120}]},
    {name:"Sphinx", type:'combat', desc:"It demands an answer or your life.", choices:[{txt:"Run Past (DEX 5+)", stat:'dex', tn:5, fail:80, mode:'capture'},{txt:"Answer Riddle (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Shell Game", type:'check', desc:"A street scammer challenges you.", choices:[{txt:"Fast Eyes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80},{txt:"Calculate (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Mimic", type:'combat', desc:"The chest has teeth!", choices:[{txt:"Reflex Stab (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Identify (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Singing Contest", type:'check', desc:"Perform for the crowd.", choices:[{txt:"Dance (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture', val:60},{txt:"Compose Lyrics (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Flying Book", type:'check', desc:"A spellbook flutters away.", choices:[{txt:"Catch It (DEX 4+)", stat:'dex', tn:4, fail:20, mode:'capture', val:50},{txt:"Summon It (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:50}]},
    {name:"Tripwire", type:'check', desc:"A thin wire spans the path.", choices:[{txt:"Cut Carefully (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:30},{txt:"Analyze Mechanism (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:30}]},
    {name:"Fey Prank", type:'combat', desc:"A pixie steals your boots.", choices:[{txt:"Chase (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:40},{txt:"Trick It Back (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Lost in Woods", type:'check', desc:"The path has vanished.", choices:[{txt:"Climb Tree (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20},{txt:"Navigate Stars (INT 4+)", stat:'int', tn:4, fail:20, mode:'capture', val:40}]},
    {name:"Clockwork Toy", type:'combat', desc:"A mechanical soldier malfunctions.", choices:[{txt:"Disable (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture'},{txt:"Reprogram (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},
    {name:"Alchemy Accident", type:'check', desc:"A potion is about to explode.", choices:[{txt:"Throw it (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:40},{txt:"Neutralize (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:100}]},

    // STR/INT
    {name:"Stone Golem", type:'combat', desc:"Slow but incredibly tough.", choices:[{txt:"Shatter (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Find Weakness (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Cursed Armor", type:'combat', desc:"An animated suit of armor attacks.", choices:[{txt:"Bash (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Banish Spirit (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Rusted Portcullis", type:'check', desc:"The gate is heavy and stuck.", choices:[{txt:"Lift (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:50},{txt:"Leverage (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:40}]},
    {name:"Orc Shaman", type:'combat', desc:"He channels lightning.", choices:[{txt:"Rush Him (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:30},{txt:"Counterspell (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:80}]},
    {name:"Magic Sword", type:'check', desc:"A sword stuck in a stone.", choices:[{txt:"Pull (STR 6+)", stat:'str', tn:6, fail:50, mode:'capture', val:200},{txt:"Arcane Release (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:150}]},
    {name:"Drunken Giant", type:'combat', desc:"He creates a mess in the tavern.", choices:[{txt:"Wrestle (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Outsmart (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Haunted House", type:'combat', desc:"Furniture is flying everywhere.", choices:[{txt:"Smash Furniture (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Exorcise (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Collapsed Mine", type:'check', desc:"Rubble blocks the gold vein.", choices:[{txt:"Dig (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:60},{txt:"Engineer Support (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:60}]},
    {name:"Crystal Guardian", type:'combat', desc:"Made of resonating crystal.", choices:[{txt:"Smash (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Sonic Resonance (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Frozen Door", type:'check', desc:"Ice seals the vault.", choices:[{txt:"Kick Open (STR 5+)", stat:'str', tn:5, fail:40, mode:'capture', val:60},{txt:"Melt Spell (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:30}]},
    {name:"Possessed Bear", type:'combat', desc:"Glowing purple eyes stare at you.", choices:[{txt:"Subdue (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture'},{txt:"Cleansing Ritual (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Sinking Boat", type:'check', desc:"Taking on water fast!", choices:[{txt:"Bail Water (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:30},{txt:"Repair Hull (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:50}]},
    {name:"Statue Puzzle", type:'check', desc:"Heavy statues must be arranged.", choices:[{txt:"Push Them (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:60},{txt:"Solve Order (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Magical Barrier", type:'check', desc:"A forcefield blocks the loot.", choices:[{txt:"Hit Hard (STR 6+)", stat:'str', tn:6, fail:80, mode:'capture', val:150},{txt:"Counter-Frequency (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:80}]},
    {name:"Entangled Roots", type:'combat', desc:"Vines grab your legs.", choices:[{txt:"Rip Free (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture'},{txt:"Wither Spell (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Library Fire", type:'check', desc:"Save the ancient scrolls!", choices:[{txt:"Carry Water (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:70},{txt:"Frost Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Gargoyle", type:'combat', desc:"Stone turns to flesh.", choices:[{txt:"Break Wings (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture'},{txt:"Command Word (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},

    // SHOPS/PAY
    {name:"Merchant", type:'shop', desc:"A traveling merchant appears."},
    {name:"Tax Collector", type:'pay', cost:50, desc:"Pay your taxes."},
    {name:"Toll Bridge", type:'pay', cost:30, desc:"Pay the toll."},
    {name:"Peddler", type:'shop', desc:"Cheap wares for sale."},
    {name:"Pickpocket", type:'pay', cost:60, desc:"Your purse is lighter."},
    {name:"Charity", type:'pay', cost:20, desc:"Alms for the poor."}
];

const DECK_SKIRMISH = [
    // STR/DEX (Bosses)
    {name:"Assassin Lord", type:'combat', desc:"Fast and deadly.", choices:[{txt:"Crush Him (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Match Speed (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Hydra", type:'combat', desc:"Heads regrow as you cut them.", choices:[{txt:"Sever Heads (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Dance Around (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Blade Gauntlet", type:'check', desc:"A hallway of swinging scythes.", choices:[{txt:"Block & Move (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:150},{txt:"Acrobatics (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:150}]},
    {name:"Dragon Turtle", type:'combat', desc:"An armored beast of the deep.", choices:[{txt:"Crack Shell (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:100},{txt:"Aim for Eyes (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Chimera", type:'combat', desc:"Lion, Goat, and Snake heads attack.", choices:[{txt:"Hold Heads (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Dodge Breath (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Collapsing Temple", type:'check', desc:"The roof is coming down!", choices:[{txt:"Hold Pillar (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Parkour Out (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Dragon Rider", type:'combat', desc:"An elite knight on a drake.", choices:[{txt:"Knock Off (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Aerial Battle (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Sandworm", type:'combat', desc:"It bursts from the ground.", choices:[{txt:"Wrestle Maw (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Ride It (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:300}]},
    {name:"Blade Master", type:'combat', desc:"He wields six swords.", choices:[{txt:"Parry All (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Riposte (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Tsunami", type:'check', desc:"A massive wave approaches.", choices:[{txt:"Anchor Self (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Climb High (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Juggernaut", type:'combat', desc:"An unstoppable armored charger.", choices:[{txt:"Stop Momentum (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Trip Him (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Invisible Stalker", type:'combat', desc:"You can hear it breathing.", choices:[{txt:"Flail Wildly (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture'},{txt:"React to Sound (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Gladiator Pit", type:'combat', desc:"You are thrown into the arena.", choices:[{txt:"Survive (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flourish (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:250}]},

    // DEX/INT (Bosses)
    {name:"Lich King", type:'combat', desc:"Master of death magic.", choices:[{txt:"Dodge Spells (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Duel Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Mirror Maze", type:'check', desc:"Reflections confuse you.", choices:[{txt:"Wall Jump (DEX 6+)", stat:'dex', tn:6, req:1, fail:100, mode:'capture', val:200},{txt:"Deduce Path (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Void Stalker", type:'combat', desc:"It phases out of reality.", choices:[{txt:"Reaction Shot (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Predict Phase (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:80}]},
    {name:"Ancient Vault", type:'check', desc:"The lock of the gods.", choices:[{txt:"Legendary Pick (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:300},{txt:"Dispel Ward (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Time Loop", type:'check', desc:"You are reliving this moment.", choices:[{txt:"Break Cycle (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:200},{txt:"Unravel Spell (INT 6+)", stat:'int', tn:6, req:2, fail:100, mode:'capture', val:300}]},
    {name:"Lich's Phylactery", type:'check', desc:"The source of his power.", choices:[{txt:"Steal It (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Disenchant (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Psychic Storm", type:'check', desc:"Bolts of mental energy rain down.", choices:[{txt:"Dodge Bolts (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Mental Shield (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:100}]},
    {name:"Laser Grid", type:'check', desc:"Deadly beams block the treasure.", choices:[{txt:"Gymnastics (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Hack Terminal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Doppelganger", type:'combat', desc:"It knows your every move.", choices:[{txt:"Reflex Duel (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Logic Paradox (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Clockwork Dragon", type:'combat', desc:"A masterpiece of destruction.", choices:[{txt:"Jam Gears (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:120},{txt:"Override Code (INT 6+)", stat:'int', tn:6, req:2, fail:120, mode:'capture', val:220}]},
    {name:"Poisoned Banquet", type:'check', desc:"The King is dying!", choices:[{txt:"Sleight of Hand (DEX 6+)", stat:'dex', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Mix Antidote (INT 5+)", stat:'int', tn:5, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Floating Island", type:'check', desc:"The bridge has crumbled away.", choices:[{txt:"Parkour Gaps (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flight Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Shadow Master", type:'combat', desc:"He attacks from the dark.", choices:[{txt:"Counter-Strike (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Light Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:120}]},

    // STR/INT (Bosses)
    {name:"Demon Gate", type:'check', desc:"Demons pour from the portal.", choices:[{txt:"Bar the Gate (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Close Portal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Iron Golem", type:'combat', desc:"Impervious to normal weapons.", choices:[{txt:"Topple (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Rust Spell (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Vampire Lord", type:'combat', desc:"Ancient and powerful.", choices:[{txt:"Drive Stake (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Holy Light (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Obelisk", type:'check', desc:"A fallen monument blocks the road.", choices:[{txt:"Heave (STR 6+)", stat:'str', tn:6, req:1, fail:100, mode:'capture', val:150},{txt:"Levitate (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Volcano Eruption", type:'check', desc:"Lava flows towards the village.", choices:[{txt:"Divert Flow (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Freeze Magma (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"Titan", type:'combat', desc:"A giant as tall as a mountain.", choices:[{txt:"Leg Sweep (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Banishment (INT 6+)", stat:'int', tn:6, req:2, fail:200, mode:'capture', val:300}]},
    {name:"Necropolis Gate", type:'check', desc:"Sealed by blood magic.", choices:[{txt:"Break It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Holy Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Living Wall", type:'combat', desc:"The bricks try to crush you.", choices:[{txt:"Smash Bricks (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Command Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Storm Giant", type:'combat', desc:"He throws lightning bolts.", choices:[{txt:"Arm Wrestle (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Lightning Rod (INT 5+)", stat:'int', tn:5, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Void Rift", type:'check', desc:"Reality is tearing apart.", choices:[{txt:"Force Closed (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Seal Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:300}]},
    {name:"Cursed Tree", type:'combat', desc:"It drains life from the land.", choices:[{txt:"Uproot (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Purify Root (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Meat Grinder", type:'check', desc:"A room of spinning blades.", choices:[{txt:"Jam Gears (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Shutdown (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Abyssal Horror", type:'combat', desc:"Madness given form.", choices:[{txt:"Crush It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Mind Blast (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"King of the Hill", type:'combat', desc:"An Orc Warlord challenges you.", choices:[{txt:"Throw Off (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Tactics (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},

    // Rare Shops
    {name:"Black Market", type:'shop', rare:true, desc:"Forbidden goods."},
    {name:"Void Trader", type:'shop', rare:true, desc:"Items from beyond."},
    {name:"Dragon Hoard", type:'shop', rare:true, desc:"Ancient treasures."}
];

const LOCATIONS = [
    {name:"Old Crooks Inn",type:"start",cost:0,color:"#4ade80",img:"https://static.wixstatic.com/media/b16479_b4d35a4270574b5380497c6eb27146bd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a353cedcf17c4b618027f64190b6be73~mv2.jpg",flavor:"A warm hearth greets you, smelling of roasted meat and ale. Rough laughter fills the air as adventurers swap stories of their latest conquests."},
    {name:"Rat Cellar",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_7981e4bf2a9f42fca2ba9335a79b6315~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1f9645c758e8451c90e7d733f2bc5057~mv2.jpg",flavor:"Squeaking echoes from the damp shadows of this musty basement. Red eyes watch you from the cracks."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_2a0e4f70b29e4611927b65c33fce86f4~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"The dirt here has been recently disturbed. You spot the corner of a wooden box protruding from the mud."},
    {name:"Wolf Den",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_4318c9bb74dd48ddbe8702ec17a059dd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e2baedb53b944da923cc49f6dcce0ff~mv2.jpg",flavor:"Gnawed bones litter the entrance to this dark cave. A low growl reverberates from the shadows."},
    {name:"Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_b2ff79acb9db40c1b8e230e2b43f2a53~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3671f830191345c1b8a315017da72a5b~mv2.jpg",flavor:"The King's tax collectors block the road with their armored carriage. Pay up or face the dungeon."},
    {name:"Stable",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_63e31ea7ac144c2c8086342125a30877~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_f660a75ab6284f56b2c90f4f221f53a3~mv2.jpg",flavor:"The smell of hay and horses is strong here. A merchant offers fresh mounts to speed your journey."},
    {name:"Goblin Camp",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_1d0dc90e90e04783a2cd04823ccf9255~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c48e6fdf163d4dd68b411d5674de6b4b~mv2.jpg",flavor:"Crude tents made of animal skins dot the clearing. You hear the chaotic chatter of goblins."},
    {name:"Fairy Ring",type:"mystery",cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_1437cc54895e4595a43f461ed959c5ce~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_65c314c4ef784a58b9b162d4d30b1698~mv2.jpg",flavor:"A circle of mushrooms glows with a soft, unnatural light. The air hums with chaotic magic."},
    {name:"Bandit Road",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_5101a6720f074efcb628b70b85bcdac6~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_6364e428d9504a139a2c56e1e168eb3d~mv2.jpg",flavor:"This stretch of road is suspiciously quiet. Broken wagon wheels suggest travelers often meet a grim fate here."},
    {name:"Ogre Cave",type:"combat",cost:120,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_778f6cf396474b47835aa4e8c103bffd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d5dcf031b6c24893b00b8fa6d0145eca~mv2.jpg",flavor:"A massive boulder blocks the wind, but not the smell of rotting meat. Something very large calls this home."},
    {name:"Dungeon",type:"jail",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_a259ef3e7d8c4c09a88aea824537e57b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_117e17f3d5b84577beb01fcca1cddad9~mv2.jpg",flavor:"Cold iron bars and damp stone walls surround you. It is a place of despair and lost time."},
    {name:"Crypt",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_c230f43aefe64d898b4d2dfe91ad0ba0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_eb64132a865f440c97f6652e340cbb05~mv2.jpg",flavor:"The air is stale and smells of dust and decay. Ancient sarcophagi line the walls. The dead do not sleep easily here."},
    {name:"Mana Well",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_e2c1dbc5f8f64a988893a00b0cd6f066~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_90031776e646488c93f69cc6461d9333~mv2.jpg",flavor:"Pure arcane energy bubbles up from the earth in a glowing blue spring. Wizards travel miles just to glimpse it."},
    {name:"Witch Hut",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_6d223ad95ed04eea8a963cf5b3596e35~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b095b71e60ff4619833aa4b45bc7795d~mv2.jpg",flavor:"A crooked shack stands on chicken legs in the swamp. Green smoke billows from the chimney."},
    {name:"Graveyard",type:"combat",cost:160,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_d7da23aa207b4549b9cd245959d69e6e~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8ae524f80b344def99ec6833ea717083~mv2.jpg",flavor:"Fog clings to the tilted headstones of this forgotten cemetery. The ground feels soft, as if something is trying to claw its way out."},
    {name:"Port",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_bc4d708aeb394233b697b148d0d33dc7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7403c140a66345be8cb9a8eb5b0ebc99~mv2.jpg",flavor:"The cry of seagulls and the crash of waves welcome you. Ships from distant lands unload exotic cargo on the docks."},
    {name:"Orc Fort",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_c529b3b0e6c7410989ac654ae3f8cac7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_dc2c9a5dfd124ef6b8320451e5359218~mv2.jpg",flavor:"Jagged wooden spikes surround a fortified encampment. War drums beat a steady rhythm that shakes the ground."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_9bfca911c8764f158b066493eae2bc81~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"An ornate iron-bound chest sits half-buried in the dirt. The lock looks rusty but the wood is sound."},
    {name:"Troll Bridge",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_249a86b0e4f4415ba0a9be35119eb43a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e9e3392a6a44f8291b357aacf04aef8~mv2.jpg",flavor:"A massive stone bridge spans the rushing river below. A hulking figure demands a toll from anyone wishing to cross."},
    {name:"Wyvern Peak",type:"combat",cost:200,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_f91826c1558c493ba71c3a2c0a05ff71~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d3f9c5b8ba2c4ef2998dd9bd6d2ac062~mv2.jpg",flavor:"The air is thin and cold up on this jagged mountain spire. Screeches echo from the clouds as winged shadows circle above."},
    {name:"Capital City",type:"park",cost:0,color:"#e2e8f0",img:"https://static.wixstatic.com/media/b16479_e5d51e21d1d84a009b8845a522bb5d23~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_909eefa9a23646b2825e2f3819031b90~mv2.jpg",flavor:"The white walls of the capital gleam in the sunlight. Guards in polished armor patrol the streets. Here, the King's law is absolute."},
    {name:"Lava Pits",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_799f54f3baaf47d3a6917ae7c8efb12a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7672054ca2e14a6c95d9151543aaba1d~mv2.jpg",flavor:"The heat is unbearable as magma bubbles to the surface. Sulfurous fumes burn your lungs and obscure your vision."},
    {name:"Dark Altar",type:"combat",cost:200,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_3616e7911ae547e8aaf64dd76e7610b8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_333c76fdd88842199ab18801646ddbbe~mv2.jpg",flavor:"Bloodstains mar the surface of this obsidian slab. Whispers in an unknown tongue fill your mind with dread."},
    {name:"Demon Gate",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_0738c43cfb574de79bdf4dd84c0a663b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_cf022d5d1c264836aade5ffa21a5e77c~mv2.jpg",flavor:"A tear in reality reveals a landscape of fire and torment. Horrors try to claw their way through the barrier."},
    {name:"Dragon Tooth",type:"combat",cost:240,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_aadde8877c854d8fa78d286c00699f7c~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_e373bec825124ac98094938d17fcf71b~mv2.jpg",flavor:"This jagged rock formation looks like the maw of a beast. Legends say an ancient dragon died here, cursing the land."},
    {name:"Airship",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_be49c909366540c8a0b017661cc63e51~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b79ed0dec9104e64a3180a7683ea3fce~mv2.jpg",flavor:"A massive vessel floats tethered to a high tower. The crew shouts orders as they prepare for departure. The sky is the limit."},
    {name:"Lich Tower",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_7bf555b6dc624c4f9523e3faab71a7c8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e1c7a754fa84bfd8523c85fd1d415f8~mv2.jpg",flavor:"A spire of black stone pierces the sky, radiating necromantic energy. The master of this tower conquered death long ago."},
    {name:"Vampire Manor",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_20a15d19b6424e22bc444a5e1ee7a994~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c3cc7bb80938445bb99b8f38f2c91ca1~mv2.jpg",flavor:"An elegant gothic mansion sits atop a lonely hill. The windows are dark, but you feel eyes watching you."},
    {name:"Shrine",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_b4682e4fcd6f4dc0b127326528fe97a8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c90b252d420f4e84ac0340d4555fbdc8~mv2.jpg",flavor:"A humble statue stands covered in vines and offerings. A sense of peace washes over you, healing your spirit."},
    {name:"Giant's Keep",type:"combat",cost:280,tn:6,req:2,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_eb69b5762c8043cc827fd2c0bad0e45a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1e0fcc1de9b844359e778231ea7cc1a3~mv2.jpg",flavor:"Massive stone blocks form a fortress that reaches the clouds. You feel like an ant in this place."},
    {name:"Go To Dungeon",type:"goto",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_33036f2decd74835b1a323a8bfd08ef3~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a212ee172c0c4df5a2cb3ccc22653f50~mv2.jpg",flavor:"The city guards have caught you red-handed! You are shackled and dragged away without trial."},
    {name:"Cloud Castle",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_1d74349092e741eda4d34f735125ce72~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_ddb8d1cc6af442348847805aaf261ae5~mv2.jpg",flavor:"A fortress floats effortlessly among the clouds. Harps play soft music, and the air tastes sweet."},
    {name:"Titan's Grip",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_0b5cf76a120a45c8b5da8d2d6da2fa62~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a091ec8e8f164723b44457bc878dedeb~mv2.jpg",flavor:"Two massive stone hands rise from the earth, clutching a valley. The pressure here is immense."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_5624f6d69ac6404e9aede7d4dd5f4d47~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"A grand chest reinforced with steel bands sits in the open. The latch is broken, inviting you to look inside."},
    {name:"Void Edge",type:"combat",cost:320,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_9eb9e98ea6084dccbe4e57fdcc525324~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3e59b7d985d84b9688c33ea51322875c~mv2.jpg",flavor:"The world seems to end here, dropping off into nothingness. Stars shine brightly below you in the abyss."},
    {name:"Portal",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_062be0c2c7a3459b87645b4f86c8bfd0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_aa482a0a26e94d6a9754eee718278aa1~mv2.jpg",flavor:"A swirling vortex of purple energy stands before you. It promises travel to distant lands in the blink of an eye."},
    {name:"Smuggler Cove",type:"mystery",cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_70c52b2f88864f7ca3f568cf44a3ad70~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_401a126718a64763924ed8ad5314899d~mv2.jpg",flavor:"A hidden cave by the sea. Thieves use secret tunnels here to vanish without a trace."},
    {name:"Royal Palace",type:"combat",cost:350,tn:6,req:3,color:"#fbbf24",img:"https://static.wixstatic.com/media/b16479_6434230067414f34a341a95383fe7896~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8d01f5e2e59a4244a4101efb92c77487~mv2.jpg",flavor:"The seat of power in the realm, draped in gold and velvet. Nobles scheme in the corridors while the King sits upon his throne."},
    {name:"Luxury Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_9b58c85963434fb3abe9ecfb4b114c67~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2513d4cb760246f69570e8f7eb040a39~mv2.jpg",flavor:"The Crown demands a tribute for your continued prosperity. Jewelry and fine clothes make you a target for the taxman."},
    {name:"Ancient Vault",type:"combat",cost:400,tn:6,req:3,color:"#000000",img:"https://static.wixstatic.com/media/b16479_b8a71205363745b7ad11f72ca6ca30b2~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e78493512ad4e559cd6392a9341ddad~mv2.jpg",flavor:"Massive steel doors guard the greatest treasure in the realm. Traps and guardians wait for the foolish."}
];

// ---Audio Manager ---
const AUDIO = {
    // --- MUSIC TRACKS ---
    bgm_start: new Audio('https://static.wixstatic.com/mp3/b16479_c60fba3015874266934a6c546fa40969.mp3'),
    bgm_day: new Audio('https://static.wixstatic.com/mp3/b16479_c597397512544410bd146fd4ac8db680.mp3'),
    bgm_night: new Audio('https://static.wixstatic.com/mp3/b16479_bcf6ce4574284c0e980537782ef4994b.mp3'),
	sfx_equip: new Audio('https://static.wixstatic.com/mp3/b16479_491cb15103f549cb87f770d84ede0c26.mp3'),
	sfx_click: new Audio('https://static.wixstatic.com/mp3/b16479_ba81d5de617146f8bcda766900080f5d.mp3'),
	sfx_fail: new Audio('https://static.wixstatic.com/mp3/b16479_68b7d8f2d0214569b00ad55a90de74a5.mp3'),
    sfx_transition: new Audio('https://static.wixstatic.com/mp3/b16479_37e7a5db0768438985fdc0f17578f394.mp3'),
    sfx_roll: new Audio('https://static.wixstatic.com/mp3/b16479_f1d9c34c2197472aaae5ed91301149a7.mp3'),
    sfx_gold: new Audio('https://static.wixstatic.com/mp3/b16479_e793cc62b89f4111a1b2820828b452be.mp3'),
    sfx_win: new Audio('https://static.wixstatic.com/mp3/b16479_ad96420ff6db49278fcf1fc13e9b816c.mp3'),
    sfx_hit: new Audio('https://static.wixstatic.com/mp3/b16479_7a157bee526d4555a123e97160fceef7.mp3'),
     
    currentTrack: null,
    bgmVolume: 0.4, 
    sfxVolume: 0.3, 
    allowStartMusic: true, 

    init: function() {
        this.bgm_start.loop = true;
        this.bgm_day.loop = true;
        this.bgm_night.loop = true;
        
        // Initial volume setting
        this.bgm_night.volume = 0.2; 
    },
    
    tryPlayStart: function() {
        if (!this.allowStartMusic) return;
        if (this.currentTrack === this.bgm_start) return;

        this.bgm_start.volume = this.bgmVolume;
        const playPromise = this.bgm_start.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                if (!this.allowStartMusic) {
                    this.bgm_start.pause();
                    this.bgm_start.currentTime = 0;
                } else {
                    this.currentTrack = this.bgm_start;
                }
            }).catch(e => {});
        }
    },

    setBGM: function(val) {
        this.bgmVolume = parseFloat(val);
        if(this.currentTrack) {
            // FIX: Updated logic here too
            if(this.currentTrack === this.bgm_night) this.currentTrack.volume = this.bgmVolume * 0.8;
            else this.currentTrack.volume = this.bgmVolume;
        }
    },

    setSFX: function(val) { this.sfxVolume = parseFloat(val); },

    playMusic: function(isNight) {
        const target = isNight ? this.bgm_night : this.bgm_day;
        
        // FIX: Increased from 0.5 to 0.8 (80% of master volume)
        const targetVol = isNight ? (this.bgmVolume * 0.8) : this.bgmVolume;

        if (this.currentTrack === target) {
            target.volume = targetVol;
            return; 
        }

        if (this.currentTrack) {
            const old = this.currentTrack;
            new TWEEN.Tween({v: old.volume})
                .to({v: 0}, 2000)
                .onUpdate(o => old.volume = o.v)
                .onComplete(() => { old.pause(); old.currentTime = 0; })
                .start();
        }

        target.volume = 0;
        target.play().catch(e => console.log("Audio blocked", e));
        this.currentTrack = target;
        
        new TWEEN.Tween({v: 0})
            .to({v: targetVol}, 2000)
            .onUpdate(o => target.volume = o.v)
            .start();
    },
    
    stopStartMusic: function() {
        this.allowStartMusic = false; 
        if (this.currentTrack === this.bgm_start) {
            const old = this.bgm_start;
            new TWEEN.Tween({v: old.volume})
                .to({v: 0}, 1500)
                .onUpdate(o => old.volume = o.v)
                .onComplete(() => { old.pause(); old.currentTime = 0; })
                .start();
        } else {
            this.bgm_start.pause();
            this.bgm_start.currentTime = 0;
        }
    },

    playSound: function(name) {
        if (this.sfxVolume <= 0) return;
        let src = this[name];
        if(src) {
            let sound = src.cloneNode();
            sound.volume = (name === 'sfx_click') ? Math.min(this.sfxVolume, 0.6) : this.sfxVolume;
            sound.play().catch(e => {});
        }
    }
};
function updateCamera() {
    const width = window.innerWidth;
    const isMobileMode = document.body.classList.contains('force-mobile') || width <= 768;

    // --- DESKTOP VIEW ---
    if (!isMobileMode) {
        camera.position.set(0, 55, 0.1);
        camera.lookAt(0, 0, 0);
        return;
    }

    // --- MOBILE VIEW (Dynamic Zoom) ---
    const boardSize = 55; 
    const fovRad = (45 * Math.PI) / 360; 
    
    const height = window.innerHeight * 0.82; 
    const aspect = width / height;

    let dist;
    if (aspect > 1) {
        dist = (boardSize / 2) / Math.tan(fovRad);
    } else {
        dist = ((boardSize / aspect) / 2) / Math.tan(fovRad);
    }

    camera.position.set(0, dist, 0.1); 
    camera.lookAt(0, 0, 0);
}

function animate(){ 
    requestAnimationFrame(animate); 
    TWEEN.update(); 
    renderer.render(scene,camera); 
    
    // SMOOTH FOLLOW FIX
    // Instead of looking at the jumping piece (y), look at the floor (y=0) at the piece's X/Z
    if(isZoomed && cameraTarget) {
        camera.lookAt(cameraTarget.position.x, 0, cameraTarget.position.z);
    }

    if(fogGroup) {
        fogGroup.children.forEach((cloud, idx) => {
            cloud.rotation.z += 0.001 * (idx % 2 === 0 ? 1 : -1);
            if(isNight) {
                cloud.position.x += Math.sin(Date.now() * 0.0005 + idx) * 0.005;
            }
        });
    }
}

//Camera Functions

function zoomToPiece(p) {
    isZoomed = true;
    cameraTarget = p.mesh;
    
    // Zoom closer (Higher Y means further up, lower Y means closer)
    const offset = { x: 0, y: 15, z: 12 }; 
    
    new TWEEN.Tween(camera.position)
        .to({
            x: p.mesh.position.x + offset.x,
            y: p.mesh.position.y + offset.y,
            z: p.mesh.position.z + offset.z
        }, 800)
        .easing(TWEEN.Easing.Quadratic.Out)
        .start();
}

// Moves Player and Camera together to a specific tile
function animateTeleport(p, targetTile, onComplete) {
    // 1. Lock Camera Tracking
    isZoomed = true;
    cameraTarget = p.mesh;

    // 2. Move Player Mesh
    new TWEEN.Tween(p.mesh.position)
        .to({ x: targetTile.position.x, z: targetTile.position.z }, 1500) // 1.5 seconds travel
        .easing(TWEEN.Easing.Quadratic.InOut)
        .onComplete(() => {
            if (onComplete) onComplete();
        })
        .start();

    // 3. Move Camera (Maintain offset relative to destination)
    // We calculate where the camera SHOULD be when the player arrives
    const width = window.innerWidth;
    const isMobileMode = document.body.classList.contains('force-mobile') || width <= 768;
    
    // Use the Zoom offset
    const offset = { x: 0, y: 15, z: 12 };

    new TWEEN.Tween(camera.position)
        .to({
            x: targetTile.position.x + offset.x,
            y: p.mesh.position.y + offset.y, 
            z: targetTile.position.z + offset.z
        }, 1500)
        .easing(TWEEN.Easing.Quadratic.InOut)
        .onUpdate(() => {
            // Force look at player during flight
            camera.lookAt(p.mesh.position.x, 0, p.mesh.position.z);
        })
        .start();
}

function resetCamera() {
    isZoomed = false;
    cameraTarget = null;
    
    // Default overhead view
    const width = window.innerWidth;
    const isMobileMode = document.body.classList.contains('force-mobile') || width <= 768;
    let dist = 55;
    if (isMobileMode) {
       const boardSize = 55; 
       const fovRad = (45 * Math.PI) / 360; 
       const height = window.innerHeight * 0.82; 
       const aspect = width / height;
       if (aspect > 1) dist = (boardSize / 2) / Math.tan(fovRad);
       else dist = ((boardSize / aspect) / 2) / Math.tan(fovRad);
    }

    new TWEEN.Tween(camera.position)
        .to({ x: 0, y: dist, z: 0.1 }, 1200)
        .easing(TWEEN.Easing.Cubic.Out)
        .onUpdate(() => camera.lookAt(0, 0, 0))
        .start();
}

// Handles the logic for the single big circle button
function handleActionClick() {
    // If it's the Roll Phase, Roll.
    if (gameState === 'ROLL') {
        rollMove();
    } 
    // If it's the End Phase, End Turn.
    else if (gameState === 'END') {
        endTurn();
    }
    // Otherwise, button shouldn't be clickable, but just in case:
    else {
        console.log("Not a valid phase for action button");
    }
}

function onWindowResize() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    camera.aspect = width / height; 
    camera.updateProjectionMatrix();
    renderer.setSize(width, height); 
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
    
    updateCamera(); // Recalculate zoom on resize
}

function transitionDayNight(toNight) {
    // 1. Board Transition
    new TWEEN.Tween(nightBoard.material)
        .to({ opacity: toNight ? 1 : 0 }, 5000)
        .start();

    // 2. Play Transition SFX (Only when going Day -> Night)
    if(toNight) {
        AUDIO.playSound('sfx_transition');
    }

    // 3. Fog Transition
    if (toNight) {
        // Fog Fades In
        if(fogGroup) {
            fogGroup.children.forEach(cloud => {
                cloud.position.x = cloud.userData.initialX;
                cloud.position.z = cloud.userData.initialZ;
                new TWEEN.Tween(cloud.material).to({ opacity: 0.5 + Math.random() * 0.3 }, 5000).start();
            });
        }
        new TWEEN.Tween(scene.background).to({r:0.02, g:0.02, b:0.06}, 5000).start();
    } else {
        // Fog Moves Out
        if(fogGroup) {
            fogGroup.children.forEach(cloud => {
                const destX = cloud.position.x > 0 ? 60 : -60;
                new TWEEN.Tween(cloud.position).to({ x: destX }, 5000).start();
                new TWEEN.Tween(cloud.material).to({ opacity: 0 }, 5000).start();
            });
        }
        new TWEEN.Tween(scene.background).to({r:0.8, g:0.8, b:0.8}, 5000).start();
    }
}

function init() {
    scene = new THREE.Scene(); 
    const fogColor = 0xcccccc; 
    scene.background = new THREE.Color(fogColor); 
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000); 
    
    renderer = new THREE.WebGLRenderer({antialias:true}); 
    renderer.setSize(window.innerWidth, window.innerHeight); 
    renderer.shadowMap.enabled = true;
    document.getElementById('game-layer').appendChild(renderer.domElement);
    
    const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffd700, 0.8); dir.position.set(30,40,20); dir.castShadow = true; scene.add(dir);
    
    updateCamera(); 

    window.addEventListener('resize', onWindowResize, false);
    createEnvironment(); 
    createBoard(); 
    createDecks(); 
    createFog(); 
    
    // --- AUDIO INIT ---
    AUDIO.init();
    
    // --- LOGO SCREEN LOGIC ---
    const logoScreen = document.getElementById('logo-screen');
    const logoImg = document.getElementById('logo-img');
    const logoText = document.getElementById('logo-text');

    // Listener for the first interaction
    logoScreen.addEventListener('click', function() {
        // 1. Fade out Logo and Text first (Takes 1 second via CSS)
        logoImg.style.opacity = '0';
        logoText.style.opacity = '0';

        // 2. WAIT 2 SECONDS
        // (1 second for the logo to fade out + 1 second pause)
        setTimeout(() => {
            
            // 3. Fade out the Black Screen (Takes 1.5 seconds via CSS)
            logoScreen.style.opacity = '0';
            
            // 4. Start Music immediately as the screen starts revealing
            AUDIO.tryPlayStart(); 

            // 5. Cleanup DOM after fade finishes
            setTimeout(() => {
                logoScreen.style.display = 'none';
            }, 1500); 
            
        }, 2000); // <--- Changed from 1000 to 2000
        
    }, { once: true });
    // -------------------------
    
    setupCreationUI(); 
    setupEquipDragDrop();
    animate();
    
    // Global Button Sound Listener
    document.addEventListener('click', function(e) {
        if (e.target.closest('button, .choice-btn, .sel-opt, .skill-card, .color-opt, .help-tab, .skill-slot, .equip-slot, .inv-slot, .close-x, #btn-help, #btn-settings')) {
            AUDIO.playSound('sfx_click');
        }
    });
    
    // FIX SCROLL ON APP SWITCH
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            window.scrollTo(0, 0);
            setTimeout(() => window.scrollTo(0, 0), 100);
        }
    });
	document.addEventListener('touchstart', function() {
    const tt = document.getElementById('tooltip');
    if (tt) tt.style.display = 'none';
}, { passive: true });

    // --- ACTIVATE DRAGGABLE WINDOWS ---
    makeDraggable(document.getElementById("p1-sheet"));
    makeDraggable(document.getElementById("leaderboard"));
}

function createTileTexture(name, cStr, cost) {
    const c = document.createElement('canvas'); c.width = 256; c.height = 256; const ctx = c.getContext('2d');
    ctx.fillStyle = cStr; ctx.fillRect(0, 0, 256, 256);
    ctx.fillStyle = "rgba(0,0,0,0.1)"; for(let i=0; i<50; i++) ctx.fillRect(Math.random()*256, Math.random()*256, 10, 10);
    ctx.fillStyle = "#fff"; ctx.fillRect(10, 10, 236, 40); ctx.strokeRect(10, 10, 236, 40);
    ctx.fillStyle = "#000"; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(name, 128, 30);
    if(cost > 0) { ctx.fillStyle = "#fbbf24"; ctx.fillRect(80, 210, 96, 30); ctx.strokeRect(80, 210, 96, 30); ctx.fillStyle = "#000"; ctx.fillText(cost + " G", 128, 225); }
    return new THREE.CanvasTexture(c);
}
function createGrassTexture() { const c=document.createElement('canvas'); c.width=512; c.height=512; const ctx=c.getContext('2d'); ctx.fillStyle="#14532d"; ctx.fillRect(0,0,512,512); for(let i=0;i<2000;i++){ctx.fillStyle=Math.random()>0.5?"#166534":"#15803d";ctx.fillRect(Math.random()*512,Math.random()*512,3,3);} const t=new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(8,8); return t; }
function createEnvironment() { const g = new THREE.Mesh(new THREE.PlaneGeometry(600, 600), new THREE.MeshStandardMaterial({map:createGrassTexture()})); g.rotation.x = -Math.PI/2; g.position.y = -0.6; g.receiveShadow = true; scene.add(g); for(let i=0; i<400; i++) { const rad = 45 + Math.random() * 250; const ang = Math.random() * Math.PI * 2; const x = Math.cos(ang) * rad; const z = Math.sin(ang) * rad; if(z > 30 && x > -20 && x < 20) continue; const t = new THREE.Group(); const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.8, 2), new THREE.MeshStandardMaterial({color:0x3e2723})); tr.position.y = 1; const lv = new THREE.Mesh(new THREE.ConeGeometry(3, 6, 8), new THREE.MeshStandardMaterial({color:0x15803d})); lv.position.y = 4; t.add(tr); t.add(lv); t.position.set(x, -0.6, z); t.scale.setScalar(0.8 + Math.random()); scene.add(t); } }
function createBoard() {
    const loader = new THREE.TextureLoader(); 
    const boardTex = loader.load('https://static.wixstatic.com/media/b16479_5caac3525f59406d8ff175695ef11cb1~mv2.jpg');
    const board = new THREE.Mesh(new THREE.PlaneGeometry(45, 45), new THREE.MeshStandardMaterial({ map: boardTex }));
    board.rotation.x = -Math.PI / 2; board.position.y = -0.55; board.receiveShadow = true; scene.add(board);

    // --- NEW: NIGHT BOARD OVERLAY ---
    const nightTex = loader.load('https://static.wixstatic.com/media/b16479_2458008184884e2986ee9e7c6dc37fc8~mv2.jpg');
    // Transparent, Opacity 0 to start. Sits slightly higher (-0.54) to avoid glitching
    nightBoard = new THREE.Mesh(new THREE.PlaneGeometry(45, 45), new THREE.MeshStandardMaterial({ map: nightTex, transparent: true, opacity: 0 }));
    nightBoard.rotation.x = -Math.PI / 2; 
    nightBoard.position.y = -0.54; 
    nightBoard.receiveShadow = true;
    scene.add(nightBoard);
    // --------------------------------

    for(let i=0; i<40; i++) {
        const info = LOCATIONS[i]; let mapTex = (info.img && info.img.length > 0) ? loader.load(info.img) : createTileTexture(info.name, info.color, info.cost);
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(3.8, 0.5, 3.8), new THREE.MeshStandardMaterial({ map: mapTex }));
        const side = Math.floor(i/10); const pos = i%10; let x=0, z=0, rot=0; const off = 20; const spa = 4;
        if(side===0) { x = off - (pos*spa); z = off; rot=0; } else if(side===1) { x = -off; z = off - (pos*spa); rot=-Math.PI/2; } else if(side===2) { x = -off + (pos*spa); z = -off; rot=Math.PI; } else { x = off; z = -off + (pos*spa); rot=Math.PI/2; }
        if(i===0){x=off;z=off;} mesh.position.set(x, 0, z); mesh.rotation.y = rot; mesh.receiveShadow = true; mesh.userData = {id:i, info:info, owner:null, buildingLevel:0}; scene.add(mesh); tiles.push(mesh);
    }
}
function createFog() {
    fogGroup = new THREE.Group();
    
    // Create a procedural "Cloud" texture using Canvas (no external image needed)
    const c = document.createElement('canvas'); c.width = 128; c.height = 128;
    const ctx = c.getContext('2d');
    const grd = ctx.createRadialGradient(64,64,0, 64,64,64);
    grd.addColorStop(0, 'rgba(255,255,255,0.3)'); // Light white center
    grd.addColorStop(1, 'rgba(255,255,255,0)');   // Transparent edges
    ctx.fillStyle = grd; ctx.fillRect(0,0,128,128);
    const fogTex = new THREE.CanvasTexture(c);

    // Create 40 fog clouds
    for(let i=0; i<40; i++) {
        const mat = new THREE.MeshBasicMaterial({
            map: fogTex, 
            transparent: true, 
            opacity: 0, // Invisible at start
            depthWrite: false,
            blending: THREE.AdditiveBlending 
        });
        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(15, 15), mat);
        
        // Random placement over the board
        mesh.position.set(Math.random()*60 - 30, 3 + Math.random()*2, Math.random()*60 - 30);
        mesh.rotation.x = -Math.PI/2;
        mesh.rotation.z = Math.random() * Math.PI * 2;
        
        // Save initial X pos for resetting later
        mesh.userData = { initialX: mesh.position.x, initialZ: mesh.position.z };
        
        fogGroup.add(mesh);
    }
    scene.add(fogGroup);
}
function transitionDayNight(toNight) {
    // 1. Board Transition (5 Seconds)
    // Fade NightBoard IN (1) or OUT (0)
    new TWEEN.Tween(nightBoard.material)
        .to({ opacity: toNight ? 1 : 0 }, 5000)
        .start();

    // 2. Fog Transition
    if (toNight) {
        // --- DAY TO NIGHT: Fog Fades In ---
        if(fogGroup) {
            fogGroup.children.forEach(cloud => {
                // Reset positions to random over board
                cloud.position.x = cloud.userData.initialX;
                cloud.position.z = cloud.userData.initialZ;
                
                // Fade In
                new TWEEN.Tween(cloud.material)
                    .to({ opacity: 0.5 + Math.random() * 0.3 }, 5000) // Varied opacity
                    .start();
            });
        }
        // Darken Background
        new TWEEN.Tween(scene.background).to({r:0.02, g:0.02, b:0.06}, 5000).start();
    } else {
        // --- NIGHT TO DAY: Fog Moves Out & Fades Out ---
        if(fogGroup) {
            fogGroup.children.forEach(cloud => {
                // Determine direction: Left or Right based on position
                const destX = cloud.position.x > 0 ? 60 : -60;
                
                // Move Out
                new TWEEN.Tween(cloud.position)
                    .to({ x: destX }, 5000) // Move off screen over 5s
                    .start();

                // Fade Out
                new TWEEN.Tween(cloud.material)
                    .to({ opacity: 0 }, 5000)
                    .start();
            });
        }
        // Lighten Background
        new TWEEN.Tween(scene.background).to({r:0.8, g:0.8, b:0.8}, 5000).start();
    }
}
function createDecks() {
    const geo = new THREE.BoxGeometry(7.5, 0.15, 10.5); const loader = new THREE.TextureLoader(); const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff});
    function createMaterials(texture) { return [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: texture}), whiteMat, whiteMat, whiteMat]; }
    normalDeck = new THREE.Group(); const nMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, nMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; normalDeck.add(c); } normalDeck.position.set(-10, 0, -2); scene.add(normalDeck);
    skirmishDeck = new THREE.Group(); const sMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, sMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; skirmishDeck.add(c); } skirmishDeck.position.set(10, 0, -2); scene.add(skirmishDeck);
    treasureDeck = new THREE.Group(); const tMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, tMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; treasureDeck.add(c); } treasureDeck.position.set(0, 0, -2); scene.add(treasureDeck);
}

// --- REGION 4: PLAYER & AI (WAS MISSING) ---
function spawnPlayer(id, n, r, c, actId, pasId, ai, col) {
    const stats = { str: r.stats.str, dex: r.stats.dex, int: r.stats.int, gold: 1000 };
    const passiveDef = ABILITY_LIBRARY[pasId];
    if (passiveDef && passiveDef.effect) passiveDef.effect(stats);
    let archetype = 'str';
    if(c.id === 'wizard' || c.id === 'cleric' || r.stats.int > r.stats.str) archetype = 'int';
    else if(c.id === 'rogue' || r.stats.dex > r.stats.str) archetype = 'dex';
    const g = new THREE.Group();
    const m = new THREE.MeshStandardMaterial({ color: col });
    const cone = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.5, 16), m); cone.position.y = 0.75;
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), m); head.position.y = 1.6;
    g.add(cone); g.add(head);
    g.position.copy(tiles[0].position);
    if (id > 0) { g.position.x += Math.random() - 0.5; g.position.z += Math.random() - 0.5; }
    scene.add(g);
    const portraitUrl = CHAR_PORTRAITS[`${r.id}_${c.id}`] || "";
    players.push({
        id: id, name: n, race: r, class: c, portrait: portraitUrl,
        activeSkillId: actId, passiveSkillId: pasId,
        stats: stats, gold: stats.gold, pos: 0, mesh: g, color: col, isAi: ai,
        archetype: archetype, equipment: { main: null, off: null, head: null, body: null },
        inventory: [], quickSlots: [null, null], isSkipping: false, abilityUsed: false,
        
        // --- NEW STAT TRACKING ---
        metrics: {
            spacesMoved: 0,
            successfulSieges: 0,
            guardsHired: 0
        },
        history: [{ turn: 0, gold: 1000, props: 0 }] 
        // -------------------------
    });
}

function recalcStats(p) {
    p.stats.str = p.race.stats.str; p.stats.dex = p.race.stats.dex; p.stats.int = p.race.stats.int;
    const pas = ABILITY_LIBRARY[p.passiveSkillId]; if(pas && pas.effect) pas.effect(p.stats);
    ['head', 'body', 'main', 'off'].forEach(slot => { const item = p.equipment[slot]; if(item && item.bonus) { const k = Object.keys(item.bonus)[0]; p.stats[k] += item.bonus[k]; } });
}

function processTax(victim, amount) {
    // 1. Check Immunity (Self)
    if (victim.passiveSkillId === 'court_mage' || victim.activeSkillId === 'court_mage') {
        addLog(`${victim.name} (Court Mage) is Tax Exempt!`, "log-rare");
        return; // Pay nothing
    }

    // 2. Check for Court Mage to siphon gold (Other players)
    // Find a living player who has Court Mage and isn't the victim
    const mage = players.find(p => 
        !p.isDead && 
        p.id !== victim.id && 
        (p.passiveSkillId === 'court_mage' || p.activeSkillId === 'court_mage')
    );

    let taxAmount = amount;

    if (mage) {
        // Divert 10G to the Mage
        const siphon = Math.min(10, taxAmount); // Can't take more than the tax itself
        taxAmount -= siphon;
        mage.gold += siphon;
        addLog(`Court Mage (${mage.name}) took ${siphon}G tax cut.`, "log-epic");
    }

    // 3. Pay the rest to Treasury
    if (taxAmount > 0) {
        pay(victim, taxAmount); // This sends money to Treasury automatically
    }
}

function manageAiInventory(p) {
    for (let i = p.inventory.length - 1; i >= 0; i--) {
        const item = p.inventory[i];
        if (item.type === 'equip') {
            const current = p.equipment[item.slot]; let shouldEquip = false;
            if (!current) shouldEquip = true;
            else {
                const currentVal = (current.bonus[p.archetype] || 0) + (Object.values(current.bonus)[0] || 0);
                const newVal = (item.bonus[p.archetype] || 0) + (Object.values(item.bonus)[0] || 0);
                if (newVal > currentVal) shouldEquip = true;
            }
            if (shouldEquip) { addLog(`${p.name} equips ${item.name}.`, "log-rare"); equipItem(p.id, i); }
        }
    }
}

function attemptAiAbilities(p, phase) {
    if (phase === 'pre-roll') {
        if (p.isSkipping) { if (p.activeSkillId === 'heal_light' && !p.classSkillDepleted) useSkillAi(p, 0); checkItemSkills(p, ['heal', 'teleport']); }
        if (!p.classSkillDepleted && Math.random() > 0.6) useSkillAi(p, 0); 
    }
    if (phase === 'combat') { checkItemSkills(p, ['might', 'focus', 'agility', 'fireball', 'smite']); }
}

function checkItemSkills(p, skillKeys) {
    ['head', 'body', 'main', 'off'].forEach(slot => {
        const item = p.equipment[slot];
        if (item && item.ability && !item.isDepleted) {
            const key = Object.keys(ABILITY_LIBRARY).find(k => ABILITY_LIBRARY[k].name === item.ability.name);
            if (skillKeys.includes(key) || Math.random() > 0.7) { item.ability.fn(p); item.isDepleted = true; updateHUD(); }
        }
    });
}

function useSkillAi(p, slotIdx) {
    if(slotIdx === 0 && !p.classSkillDepleted) { const skill = ABILITY_LIBRARY[p.activeSkillId]; if(skill && skill.fn) { skill.fn(p); p.classSkillDepleted = true; updateHUD(); } }
}

// --- REGION 5: LOGIC (Turns, Move, Combat) ---
function rollMove() { 
    if(gameState!=='ROLL') return; 
    
    const p=players[turnIndex]; 
    if(p.isDead) { endTurn(); return; }

    if(turnIndex === 0) {
        turnCount++;
        if(turnCount % 10 === 0) { 
            isNight = !isNight; 
            addLog(isNight ? "Night falls... Fog rolls in." : "Sunrise. The fog clears.", isNight ? "log-fail":"log-success");
            transitionDayNight(isNight); 
            AUDIO.playMusic(isNight);
        }
    }
    
    p.abilityUsed=false; 
    if(p.isSkipping){ p.isSkipping=false; addLog(p.name+" skips turn.","log-fail"); endStep(); return; } 
    
    // --- 1. ACTIVE SKILL ROLL OVERRIDE (e.g. Smite Debuff) ---
    const active = ABILITY_LIBRARY[p.activeSkillId];
    if (active && active.onRoll) {
        const override = active.onRoll(p);
        if (override !== null) {
            // If Smite returns a value, use it and skip 2d6/Gambler logic
            addLog(`${p.name} rolled ${override} (Debuff).`);
            if (p.id === 0) AUDIO.playSound('sfx_roll');
            finishRollLogic(p, override);
            return;
        }
    }
    // ---------------------------------------------------------

    // 2. Roll 2d6 individually to detect 1s
    let d1 = Math.floor(Math.random() * 6) + 1;
    let d2 = Math.floor(Math.random() * 6) + 1;

    // --- GAMBLER'S LUCK CHECK (Human Only) ---
    if (p.id === 0 && (d1 === 1 || d2 === 1)) {
        let skillSource = null;
        let skillType = '';

        if (ABILITY_LIBRARY[p.activeSkillId].name === "Gambler's Luck" && !p.classSkillDepleted) {
            skillSource = ABILITY_LIBRARY[p.activeSkillId]; skillType = 'class';
        } else {
            ['head','body','main','off'].forEach(slot => {
                const it = p.equipment[slot];
                if (it && it.ability && it.ability.name === "Gambler's Luck" && !it.isDepleted) {
                    skillSource = it; skillType = 'equip';
                }
            });
        }

        if (skillSource) {
            showModal(`Rolled: ${d1} & ${d2}`, "Use Gambler's Luck to reroll 1s?", [
                { txt: "Keep Roll", act: () => { 
                    document.getElementById('card-modal').classList.remove('active');
                    finishRollLogic(p, d1 + d2);
                }},
                { txt: "Reroll 1s", act: () => { 
                    document.getElementById('card-modal').classList.remove('active');
                    if(skillType === 'class') p.classSkillDepleted = true;
                    else if(skillType === 'equip') skillSource.isDepleted = true;
                    updateHUD();

                    let logMsg = `Gambler's Luck: `;
                    if(d1 === 1) { d1 = Math.floor(Math.random() * 6) + 1; logMsg += "d1 rerolled. "; }
                    if(d2 === 1) { d2 = Math.floor(Math.random() * 6) + 1; logMsg += "d2 rerolled. "; }
                    addLog(logMsg, "log-gold");
                    finishRollLogic(p, d1 + d2);
                }}
            ]);
            return; 
        }
    }

    addLog(`${p.name} rolled ${d1+d2}.`);
    if (p.id === 0) AUDIO.playSound('sfx_roll');
    finishRollLogic(p, d1 + d2);
}
function finishRollLogic(p, r) {
    // Shadow Step Logic (Passive +1)
    const passive = ABILITY_LIBRARY[p.passiveSkillId];
    if (passive && passive.name === "Shadow Step") { 
        r += 1; 
        addLog("Shadow Step: +1 Move"); 
    }
    gameState='MOVING'; 
    animateMove(p,r); 
}

function animateMove(p, s) { 
    // Start Zoom on first step of move
    if (!isZoomed && s > 0) {
        zoomToPiece(p);
    }

    if (s <= 0) { 
        // Movement done, reset camera after a brief moment
        setTimeout(() => {
            // Only reset if it's the end of turn or an interaction that doesn't need zoom
            // But usually we wait for endStep to reset
            resolveLanding(p); 
        }, 300);
        return; 
    } 
    
    p.pos = (p.pos + 1) % 40; 
    p.metrics.spacesMoved++;

    if (p.pos === 0) {
        p.gold += 200; addLog("Passed Inn (+200G)", "log-success");
        let recharged = false;
        if(p.classSkillDepleted) { p.classSkillDepleted = false; recharged = true; }
        ['head', 'body', 'main', 'off'].forEach(slot => { 
            const item = p.equipment[slot]; 
            if (item && item.isDepleted) { item.isDepleted = false; recharged = true; } 
        });
        if(recharged) addLog("All Abilities Recharged!", "log-epic");
        updateHUD();
    } 

    const t = tiles[p.pos].position.clone(); 
    if (p.id > 0) { t.x += Math.random() - 0.5; t.z += Math.random() - 0.5; } 
    
    // Move Piece
    new TWEEN.Tween(p.mesh.position).to({x: t.x, z: t.z}, 250).start(); 
    
    // If Zoomed, move camera along with piece
    if(isZoomed) {
        const offset = { x: 0, y: 15, z: 12 };
        new TWEEN.Tween(camera.position)
            .to({
                x: t.x + offset.x,
                y: 1.5 + offset.y, // 1.5 is player height
                z: t.z + offset.z
            }, 250)
            .start();
    }

    new TWEEN.Tween(p.mesh.position)
        .to({y: 1.5}, 125).yoyo(true).repeat(1)
        .onComplete(() => animateMove(p, s - 1))
        .start(); 
}
function endStep(){ 
    gameState = 'END'; 
    updateHUD(); 
    
    // Zoom out when player is done moving/acting
    if(isZoomed) {
        resetCamera();
    }

    if(players[turnIndex].isAi) { 
        // Small buffer before AI decides to end turn
        setTimeout(() => {
            endTurn();
        }, 500); 
    }
}

function endTurn(){
    // 1. Safety Check: If we are already switching turns, stop.
    if (turnProcessing) return;
    turnProcessing = true;

    // 2. Lock UI immediately
    const btnAction = document.getElementById('btn-action');
    if(btnAction) {
        btnAction.disabled = true;
        btnAction.innerText = "...";
    }

    // 3. Process Previous Player Stats
    const prevP = players[turnIndex]; 
    recalcStats(prevP);
    if(prevP.isAi) manageAiInventory(prevP); 
    
    // Record History
    const props = tiles.filter(t => t.userData.owner === prevP.id).length;
    prevP.history.push({ turn: turnCount, gold: prevP.gold, props: props });

    // 4. THE DELAY (1 Second Break)
    setTimeout(() => {
        // Calculate Next Player
        let nextIndex = (turnIndex + 1) % players.length;
        let safetyCount = 0;
        
        // Find next living player
        while(players[nextIndex].isDead && safetyCount < players.length) {
            nextIndex = (nextIndex + 1) % players.length;
            safetyCount++;
        }
        
        // Apply Switch
        turnIndex = nextIndex;
        gameState = 'ROLL'; 
        updateHUD();
        
        // Release Lock
        turnProcessing = false;

        const curP = players[turnIndex];
        if(curP.isDead) return;

        // Start Next Turn Logic
        if(curP.isAi) { 
            attemptAiAbilities(curP, 'pre-roll'); 
            
            // Zoom to AI before they roll
            zoomToPiece(curP);
            
            // Roll after visual setup
            setTimeout(rollMove, 1000); 
        } else {
            // Human Turn
            addLog("Your Turn!");
            
            // Optionally auto-zoom to human, or let them look around
            // zoomToPiece(curP); 
        }
    }, 1000); // 1000ms = 1 second break
}
function resolveLanding(p) {
    // 1. SELF PASSIVE TRIGGER (Class)
    const passive = ABILITY_LIBRARY[p.passiveSkillId];
    if (passive && passive.onLanding) passive.onLanding(p);

    // 2. SELF ACTIVE TRIGGER (Class)
    const active = ABILITY_LIBRARY[p.activeSkillId];
    if (active && active.onLanding) active.onLanding(p);

    // --- FIX: CHECK EQUIPMENT TRIGGERS (Gold Rush, etc) ---
    ['head', 'body', 'main', 'off'].forEach(slot => {
        const item = p.equipment[slot];
        if (item && item.ability) {
            // We must look up the original library entry because item.ability only contains the name/desc/fn copies
            const libAbil = Object.values(ABILITY_LIBRARY).find(a => a.name === item.ability.name);
            if (libAbil && libAbil.onLanding) {
                libAbil.onLanding(p);
            }
        }
    });
    // ------------------------------------------------------

    // 3. TRAP TRIGGER (Skeleton Key)
    players.forEach(other => {
        if (other.id !== p.id && !other.isDead && other.pos === p.pos) {
            const trapPassive = ABILITY_LIBRARY[other.passiveSkillId];
            if (trapPassive && trapPassive.onEnemyLanding) {
                trapPassive.onEnemyLanding(p, other);
            }
        }
    });

    const t = tiles[p.pos]; const i = t.userData.info;
    if(p.isAi) { processAiTurn(p, t, i); return; }
    
    const m = document.getElementById('arrival-modal');
    if(m) {
        const imgEl = document.getElementById('arrival-image');
        if(imgEl) { if(i.cardImg) { imgEl.src = i.cardImg; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; } }
        const flavorEl = document.getElementById('arrival-flavor');
        if(flavorEl) flavorEl.innerText = i.flavor || "You arrive at " + i.name + ".";
        m.classList.add('active');
    }
	AUDIO.playSound('sfx_gold');
}

function continueFromArrival() {
    document.getElementById('arrival-modal').classList.remove('active');
    const p = players[turnIndex]; const t = tiles[p.pos]; const i = t.userData.info;
    
    if(i.type === 'start') { if(p.id === 0) showEncounter(p, i, t, 'shop'); else endStep(); return; }
    if(i.type === 'mystery') {
        const deckType = isNight ? 'skirmish' : 'normal';
        drawCardAnim(deckType, () => showEncounter(p, i, t, 'mystery_event'));
        return;
    }
    if(i.type === 'park') { 
        if(treasuryGold > 0){ p.gold += treasuryGold; addLog(`Won ${treasuryGold}G!`, "log-success"); treasuryGold = 0; updateHUD(); } 
        else { addLog("Treasury empty."); } 
        endStep(); return; 
    }
    if(i.type === 'tax') { processTax(p, 50); endStep(); return; } 
    if(i.type === 'goto') { 
        if (p.passiveSkillId === 'smoke_bomb' || p.activeSkillId === 'smoke_bomb') { addLog("Skeleton Key: Evaded Dungeon!", "log-epic"); endStep(); } 
        else { p.pos = 10; p.mesh.position.copy(tiles[10].position); addLog("Jailed!", "log-fail"); p.isSkipping = true; endStep(); }
        return; 
    } 
    if(i.type === 'jail') { endStep(); return; }
    if(i.type === 'chest') { drawCardAnim('treasure', () => showEncounter(p, i, t, "loot")); return; }

    const deckType = isNight ? 'skirmish' : 'normal'; const modeType = isNight ? 'wild_skirmish' : 'wild'; const owner = t.userData.owner;
    
    if(owner === p.id) { 
        if(t.userData.buildingLevel === 1) { 
            showModal("Upgrade?", `Build Tavern ${i.cost*2}G? (Skirmish)`, [ 
                { txt: "Upgrade", act: () => { 
                    if(p.gold >= i.cost*2) { 
                        p.gold -= i.cost*2; 
                        drawCardAnim('skirmish', () => showEncounter(p, i, t, "upgrade")); 
                    } else { addLog("No Gold"); endStep(); } 
                }}, 
                { txt: "Skip", act: endStep } 
            ]); 
        } else { 
            let guards = t.userData.guardCount || 0; 
            showModal("Manage Tavern", `Current Guards: ${guards}. Hire Bodyguard for 50G?`, [ 
                { txt: "Hire Guard (50G)", act: () => { 
                    if(p.gold >= 50) { 
                        p.gold -= 50; 
                        t.userData.guardCount = (t.userData.guardCount || 0) + 1; 
                        // --- TRACK GUARD ---
                        p.metrics.guardsHired++;
                        addLog("Guard Hired!", "log-gold"); updateHUD(); endStep(); 
                    } else { addLog("Not enough Gold"); endStep(); } 
                }}, 
                { txt: "Rest (Skip)", act: endStep } 
            ]); 
        } 
    } else if(owner !== null) { 
        drawCardAnim('normal', () => showEncounter(p, i, t, "enemy")); 
    } else { 
        drawCardAnim(deckType, () => showEncounter(p, i, t, modeType)); 
    }
}

function processAiTurn(p, t, i) {
    // 1. Handle Instant Events
    if(i.type === 'tax') { processTax(p, 50); endStep(); return; } 
    if(i.type === 'park') { 
        if(treasuryGold > 0){ p.gold += treasuryGold; addLog(`${p.name} wins the Treasury!`, "log-gold"); treasuryGold = 0; } 
        endStep(); return; 
    } 
    if(i.type === 'goto') { 
        if (p.passiveSkillId === 'smoke_bomb' || p.activeSkillId === 'smoke_bomb') { addLog(`${p.name} uses Skeleton Key to evade Dungeon!`, "log-epic"); } 
        else { p.pos=10; p.mesh.position.copy(tiles[10].position); addLog(`${p.name} jailed.`, "log-fail"); p.isSkipping = true; } 
        endStep(); return; 
    } 
    if(i.type === 'chest') { 
        const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
        p.inventory.push({...card}); 
        addLog(`${p.name} found ${card.name}.`, "log-success"); 
        if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') { 
            const extra = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
            p.inventory.push({...extra}); 
            addLog(`Alchemist Bonus: Found ${extra.name}!`, "log-epic"); 
        } 
        endStep(); return; 
    }

    // 2. Handle Mystery / Teleport (NEW FIXED SECTION)
    if (i.type === 'mystery') {
        addLog(`${p.name} explores the ${i.name}...`, "log-rare");
        
        // Pick a card based on Day/Night
        const deck = isNight ? DECK_SKIRMISH : DECK_ENCOUNTER;
        const card = deck[Math.floor(Math.random() * deck.length)];
        
        // If card has choices, pick the one the AI is best at
        if (card.choices) {
            let best = card.choices[0];
            // Compare stats: If option 2 stat > option 1 stat, pick option 2
            if (card.choices[1]) {
                const stat1 = p.stats[best.stat] || 0;
                const stat2 = p.stats[card.choices[1].stat] || 0;
                if (stat2 > stat1) best = card.choices[1];
            }

            // Trigger Combat -> Teleport on Success
            // We use a small timeout to simulate "reading" the card
            setTimeout(() => {
                rollCombat(p, best.stat, best.tn, best.req || 1, t, 'teleport', false, best.val || 0, best.fail || 50, false);
            }, 1000);
            return;
        } else {
            // Fallback for non-choice cards (rare in this context)
            endStep();
            return;
        }
    }

    // 3. Buy Empty Land
    if(i.cost > 0 && t.userData.owner === null) { 
        const safetyRatio = (p.class.id === 'rogue' || p.race.id === 'dragonborn') ? 1.2 : 2.0; 
        if (p.gold >= i.cost * safetyRatio) { 
            capture(t, p, 1, () => { checkForBonusLoot(p); endStep(); }); 
            return; 
        } 
        else { addLog(`${p.name} passes on ${i.name}.`); } 
        endStep(); return; 
    } 

    // 4. Enemy Land (Pay or Attack)
    if(t.userData.owner !== null && t.userData.owner !== p.id) {
        const enemyDefStat = t.userData.defendingStat || 'str'; 
        const tn = i.tn || 3; 
        const aiDicePool = p.stats[enemyDefStat] || 1; 
        const chancePerDie = (7 - tn) / 6; 
        const expectedWins = aiDicePool * chancePerDie; 
        const requiredWins = (i.req || 1) + (t.userData.guardCount || 0);
        let willSiege = false; 
        const failCost = (i.cost * 2) + ((t.userData.guardCount || 0) * 10);
        
        if (expectedWins >= requiredWins) willSiege = true; 
        if (p.gold < i.cost) willSiege = true; // Desperation
        if (failCost > p.gold && expectedWins < requiredWins + 0.5) willSiege = false; // Too risky

        if (willSiege) { 
            attemptAiAbilities(p, 'combat'); 
            addLog(`${p.name} attacks ${players[t.userData.owner].name}'s tile!`, "log-accent"); 
            setTimeout(() => { rollCombat(p, enemyDefStat, tn, requiredWins, t, 'capture', false, 0, failCost, true); }, 500); 
            return; 
        } else { 
            pay(p, i.cost, players[t.userData.owner]); endStep(); return; 
        }
    }

    // 5. Own Land (Upgrade or Guard)
    if (t.userData.owner === p.id) { 
        if (t.userData.buildingLevel === 1 && p.gold > i.cost * 3) { 
            addLog(`${p.name} attempts to upgrade...`); 
            const card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)]; 
            const bestChoice = card.choices[0].tn < card.choices[1].tn ? card.choices[0] : card.choices[1]; 
            rollCombat(p, bestChoice.stat, bestChoice.tn, bestChoice.req, t, 'upgrade', false, 0, 50, false); 
            return; 
        } else if (t.userData.buildingLevel > 1 && p.gold > 200 && (t.userData.guardCount || 0) < 2) { 
            p.gold -= 50; 
            t.userData.guardCount = (t.userData.guardCount || 0) + 1; 
            p.metrics.guardsHired++;
            addLog(`${p.name} hired a guard.`, "log-gold"); 
            updateHUD(); 
        } 
    }
    
    endStep();
}

function showEncounter(p, i, t, mode) {
    const originalMode = mode;
    const m = document.getElementById('card-modal'); 
    const l = document.getElementById('choice-list'); 
    l.innerHTML = ''; 
    document.getElementById('dice-result').innerHTML = ''; 
    document.getElementById('market-sell-area').style.display = 'none';
    
    // 2. Draw Card based on Mode
    let card;
    if (mode === 'loot') {
        card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
    }
    else if (mode === 'mystery_event') {
        if (isNight) {
            card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)];
        } else {
            card = DECK_ENCOUNTER[Math.floor(Math.random() * DECK_ENCOUNTER.length)];
        }
    }
    else if (mode === 'skirmish' || mode === 'wild_skirmish' || mode === 'upgrade') {
        card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)]; 
    }
    else {
        card = DECK_ENCOUNTER[Math.floor(Math.random() * DECK_ENCOUNTER.length)];
    }
    
    // 3. Handle Card Types Overriding Mode
    if (card.type === 'shop') mode = 'shop'; 
    if (card.type === 'loot') { 
        mode = 'loot'; 
        if(!card.cost) card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
    }
    
    // 4. Set Visual Header
    let title = card.name; 
    let cls = 'card-header'; 
    
    if (mode.includes('skirmish') || mode === 'upgrade' || (mode === 'mystery_event' && isNight)) { 
        cls += ' skirmish'; title += " (SKIRMISH)"; 
    } 
    else if (mode === 'loot') { cls += ' loot'; } 
    else if (mode === 'shop') { cls += ' market'; }
    
    setT('enc-title', title); 
    document.getElementById('enc-header').className = cls;
    
    let desc = card.desc || "Event occurs."; 
    let opts = [];

    // --- LOGIC BLOCKS ---

    // A. LOOT
    if (mode === 'loot') { 
        desc = `You found: ${card.name} (${card.rarity || 'Common'})`; 
        opts = [{ txt: "Keep", act: () => { 
            p.inventory.push({...card}); 
            addLog("Gained " + card.name, "log-success"); 
            if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') {
                addLog("Alchemist: Transmuting extra loot...", "log-epic");
                updateHUD(); 
                setTimeout(() => { drawCardAnim('treasure', () => showEncounter(p, null, null, 'loot')); }, 500);
                return; 
            }
            updateHUD(); closeEnc(); 
        }}]; 
    } 
    // B. SHOP
    else if (mode === 'shop' || i.type === 'start') { 
        desc = card.desc || "The merchant displays their wares."; 
        document.getElementById('market-sell-area').style.display = 'flex'; 
        let pool = DECK_TREASURE.filter(item => item.name !== "Pouch of Gold"); 
        if(card.rare) pool = pool.filter(x => x.rarity === 'legendary'); 
        let items = []; 
        if(pool.length > 0) { for(let k=0; k<3; k++) items.push(pool[Math.floor(Math.random() * pool.length)]); } 
        items.forEach(it => opts.push({ txt: `Buy ${it.name} (${it.cost}G)`, act: (btn) => { 
            if (p.gold >= it.cost) { 
                if(p.inventory.length >= 12) { addLog("Inventory Full", "log-fail"); return; } 
                p.gold -= it.cost; p.inventory.push({...it}); 
                addLog(`Bought ${it.name}`, "log-success"); updateHUD(); if(btn) btn.remove(); 
            } else { addLog("No Gold", "log-fail"); } 
        } })); 
        opts.push({ txt: "Leave", act: () => { 
            const isCombatMode = (originalMode === 'wild' || originalMode === 'wild_skirmish' || originalMode === 'skirmish' || originalMode === 'upgrade' || originalMode === 'mystery_event');
            if (isCombatMode) {
                addLog("Merchant departs. The challenge approaches...", "log-rare");
                let deckName;
                if (originalMode === 'mystery_event') {
                     deckName = isNight ? 'skirmish' : 'normal';
                } else {
                     deckName = (originalMode.includes('skirmish') || originalMode === 'upgrade') ? 'skirmish' : 'normal';
                }
                drawCardAnim(deckName, () => showEncounter(p, i, t, originalMode));
            } else { closeEnc(); }
        }}); 
    } 
    // C. COMBAT / EVENTS
    else if (mode === 'wild' || mode === 'wild_skirmish' || mode === 'skirmish' || mode === 'upgrade' || mode === 'mystery_event') { 
        if (card.choices) { 
            card.choices.forEach(c => { 
                let btnTxt = c.txt; 
                if(c.fail) btnTxt += ` | Fail: -${c.fail}G`; 
                let useMode = (originalMode === 'mystery_event') ? 'teleport' : (originalMode === 'upgrade' ? 'upgrade' : c.mode);
                opts.push({ txt: btnTxt, stat: c.stat, tn: c.tn, req: c.req || 1, mode: useMode, val: c.val || 0, failCost: c.fail || 50 }); 
            }); 
            
            // Escape Artist Logic
            let hasEscapeArtist = (p.passiveSkillId === 'escape_artist');
            if(!hasEscapeArtist) {
                ['head','body','main','off'].forEach(s => {
                    if(p.equipment[s] && p.equipment[s].ability && p.equipment[s].ability.name === "Escape Artist") hasEscapeArtist = true;
                });
            }

            if (hasEscapeArtist) {
                opts.push({ txt: "‚òÖ Escape Artist (Flee & Loot)", act: () => {
                    let maxVal = 0;
                    card.choices.forEach(ch => { if(ch.val && ch.val > maxVal) maxVal = ch.val; });
                    if (maxVal > 0) {
                        p.gold += maxVal;
                        addLog(`Escape Artist: Snagged ${maxVal}G!`, "log-success");
                        updateHUD();
                    } else {
                        addLog("Escape Artist: Escaped safely.", "log-success");
                    }
                    closeEnc();
                }});
            } else {
                opts.push({ txt: "Leave / Flee", act: closeEnc }); 
            }
        } 
        else if (card.type === 'pay') { 
            opts = [{ txt: `Pay ${card.cost}G`, act: () => { processTax(p, card.cost); closeEnc(); }}]; 
        } 
    } 
    // D. ENEMY LAND
    else if (mode === 'enemy') { 
        let guards = t.userData.guardCount || 0; 
        let defStat = t.userData.defendingStat || 'str'; 
        let tn = i.tn || 3; let req = i.req || 1; 
        
        // --- FIX START: RENT CALCULATION ---
        // 1. Check Upgrade Status (Level 2 = Tavern = 2x multiplier)
        let rentMultiplier = (t.userData.buildingLevel > 1) ? 2 : 1;
        
        // 2. Calculate Rent: (Base * Multiplier) + (Guards * 20)
        let rentCost = (i.cost * rentMultiplier) + (guards * 20);

        // Calculate Siege Risk (Failure Cost)
        let failCost = (i.cost * 2) + (guards * 10); 
        // --- FIX END ---

        desc = `Owned by ${players[t.userData.owner].name}. Defending Stat: ${defStat.toUpperCase()}. Guards: ${guards}.`; 
        
        opts = [ 
            { txt: `Pay Rent ${rentCost}G`, act: () => { pay(p, rentCost, players[t.userData.owner]); closeEnc(); } }, 
            { txt: `Siege (${defStat.toUpperCase()} ${tn}+) | Risk: -${failCost}G`, stat: defStat, tn: tn, req: req, mode: 'capture', penalty: false, failCost: failCost, isSiege: true } 
        ]; 
    } else { 
        opts = [{ txt: "Continue", act: closeEnc }]; 
    }
    
    // E. SILVER TONGUE
    const silverTongueItem = ['head','body','main','off'].map(s => p.equipment[s]).find(i => i && i.ability && i.ability.name === "Silver Tongue" && !i.isDepleted);
    if (silverTongueItem && (mode === 'wild' || mode === 'wild_skirmish' || mode === 'enemy' || mode === 'upgrade' || mode === 'mystery_event')) { 
        opts.unshift({ txt: `‚òÖ Use Silver Tongue (INT 6+)`, act: () => { 
            silverTongueItem.isDepleted = true; updateHUD(); addLog("Used Silver Tongue!", "log-epic"); 
            let useMode = (originalMode === 'mystery_event') ? 'teleport' : (originalMode === 'upgrade' ? 'upgrade' : 'capture');
            rollCombat(p, 'int', 6, 1, t, useMode, false, 0, 50, false); 
        } }); 
    }
    
    const descEl = document.getElementById('enc-desc'); if(descEl) descEl.innerText = desc;
    opts.forEach(o => { 
        let b = document.createElement('div'); b.className = 'choice-btn'; b.innerText = o.txt; 
        b.onclick = () => { if (o.act) o.act(b); else rollCombat(p, o.stat, o.tn, o.req, t, o.mode, o.penalty, o.val, o.failCost, o.isSiege); }; 
        l.appendChild(b); 
    }); 
    m.classList.add('active');
}
function closeEnc(){document.getElementById('card-modal').classList.remove('active');endStep();}
function closeFlavor() { document.getElementById('flavor-modal').classList.remove('active'); continueFromArrival(); }
function drawCardAnim(type, cb) {
    let deck, texUrl; 
    if(type === 'treasure') { deck = treasureDeck; texUrl = 'https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg'; } 
    else if(type === 'skirmish') { deck = skirmishDeck; texUrl = 'https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg'; } 
    else { deck = normalDeck; texUrl = 'https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg'; }
    
    const loader = new THREE.TextureLoader(); 
    const tex = loader.load(texUrl); 
    const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff}); 
    const mats = [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: tex}), whiteMat, whiteMat, whiteMat];
    const c = new THREE.Mesh(new THREE.BoxGeometry(7.5, 0.15, 10.5), mats); 
    c.position.copy(deck.position); 
    c.position.y += 2; 
    scene.add(c);
    
    // --- FIX: Ensure Callback Runs Exactly Once ---
    let hasRun = false;
    const finish = () => {
        if(!hasRun) {
            hasRun = true;
            scene.remove(c); 
            if(cb) cb();
        }
    };
    // ----------------------------------------------

    new TWEEN.Tween(c.position).to({x: camera.position.x * 0.8, y: camera.position.y - 20, z: camera.position.z * 0.8}, 600).start();
    new TWEEN.Tween(c.rotation).to({x: Math.PI / 2, y: Math.PI, z: 0}, 600).onComplete(finish).start();
    
    // Safety fallback
    setTimeout(finish, 800);
}

function rollCombat(p, stat, tn, req, t, mode, penalty, rewardVal, failCost, isSiege) {
    const d = document.getElementById('dice-result'); 
    d.innerHTML = ''; 
    let poolSize = p.stats[stat] || 1; 
    if (penalty) poolSize = Math.floor(poolSize / 2); 
    if (poolSize < 1) poolSize = 1;

    let results = [];
    for(let i=0; i<poolSize; i++) {
        const active = ABILITY_LIBRARY[p.activeSkillId];
        let r = null;
        if (active && active.onRoll) r = active.onRoll(p); 
        if (r === null) r = Math.floor(Math.random()*6)+1;
        results.push(r);
    }

    const finalizeCombat = (finalResults) => {
        let wins = 0;
        d.innerHTML = ''; 
        finalResults.forEach(r => {
            let b = document.createElement('div'); b.className = 'mini-die ' + (r >= tn ? 'win' : 'lose'); b.innerText = r; d.appendChild(b);
            if(r >= tn) { 
                wins++; 
                if (r === 6 && p.passiveSkillId === 'executioner') { wins++; b.style.boxShadow = "0 0 10px #ef4444"; b.style.borderColor = "#ef4444"; } 
            }
        });

        setTimeout(() => {
            let autoClose = true;
            
            // --- SUCCESS LOGIC ---
            if(wins >= req) { 
                addLog(`Success! (${wins} wins)`, "log-success"); 
                if (p.id === 0) AUDIO.playSound('sfx_win');
                
                if (mode === 'capture' || mode === 'upgrade' || isSiege) { 
                    const passive = ABILITY_LIBRARY[p.passiveSkillId]; 
                    if (passive && passive.onCombatVictory) passive.onCombatVictory(p); 
                }
                const lootCallback = () => checkForBonusLoot(p);

                // Track Siege Stat
                if (isSiege) p.metrics.successfulSieges++;

                if (mode === 'teleport') {
                    addLog("The portal opens... Teleporting!", "log-epic");
                    const newPos = Math.floor(Math.random() * 40);
                    p.pos = newPos;
                    const targetTile = tiles[newPos];
                    animateTeleport(p, targetTile, () => { resolveLanding(p); });
                    if(p.id === 0) autoClose = false; 
                }
                else if(isSiege) { 
                    let guards = t.userData.guardCount || 0; 
                    if (guards > 0) { t.userData.guardCount--; addLog(`Guard Defeated! (${t.userData.guardCount} remaining)`, "log-success"); } 
                    else { capture(t, p, 1, lootCallback); if(p.id === 0) autoClose = false; } 
                } 
                else if(mode === 'capture') { 
                    capture(t, p, 1, lootCallback); 
                    if(rewardVal > 0) { p.gold += rewardVal; addLog(`Bonus: +${rewardVal}G`, "log-gold"); } 
                    if(p.id === 0) autoClose = false; 
                }
                else if(mode === 'upgrade') { 
                    capture(t, p, 2, lootCallback); 
                    if(p.id === 0) autoClose = false; 
                }

            } 
            // --- FAILURE LOGIC (Updated to fix AI Freeze) ---
            else { 
                addLog("Failure!", "log-fail"); 
                if (p.id === 0) AUDIO.playSound('sfx_fail');
                
                // Pay penalties
                if(isSiege) { pay(p, failCost, players[t.userData.owner]); } 
                else { pay(p, failCost); } 
            }
            
            updateHUD(); 
            
            // --- CRITICAL FIX: Ensure AI turn ends after combat ---
            if(autoClose) {
                setTimeout(() => {
                    // For Human: Close modal which triggers endStep
                    if(!p.isAi) {
                        closeEnc();
                    } 
                    // For AI: Manually trigger endStep if the loop halted here
                    else {
                        document.getElementById('card-modal').classList.remove('active');
                        endStep();
                    }
                }, 1000);
            }

        }, 600);
    };

    // Gambler's Luck Logic (Human Only)
    const hasOnes = results.includes(1);
    if (p.id === 0 && hasOnes) {
        let skillSource = null; let skillType = '';
        if (ABILITY_LIBRARY[p.activeSkillId].name === "Gambler's Luck" && !p.classSkillDepleted) { skillSource = ABILITY_LIBRARY[p.activeSkillId]; skillType = 'class'; } 
        else { ['head','body','main','off'].forEach(slot => { const it = p.equipment[slot]; if (it && it.ability && it.ability.name === "Gambler's Luck" && !it.isDepleted) { skillSource = it; skillType = 'equip'; } }); }

        if (skillSource) {
            d.innerHTML = '<div style="width:100%; text-align:center; margin-bottom:10px; font-size:0.9rem; color:#aaa;">Rolled: ' + results.join(', ') + '</div>';
            showModal("Combat Roll: " + results.join(', '), "Use Gambler's Luck to reroll 1s?", [
                { txt: "Keep Roll", act: () => { document.getElementById('card-modal').classList.add('active'); finalizeCombat(results); }},
                { txt: "Reroll 1s", act: () => { document.getElementById('card-modal').classList.add('active'); if(skillType === 'class') p.classSkillDepleted = true; else if(skillType === 'equip') skillSource.isDepleted = true; updateHUD(); results = results.map(r => (r === 1 ? Math.floor(Math.random()*6)+1 : r)); addLog("Gambler's Luck: Rerolled 1s!", "log-gold"); finalizeCombat(results); }}
            ]);
            return;
        }
    }
    
    if (p.id === 0) AUDIO.playSound('sfx_roll');
    finalizeCombat(results);
}

function checkForBonusLoot(p) { 
    const roll = Math.floor(Math.random() * 6) + 1; 
    
    if (roll === 6) { 
        addLog(`Bonus Loot Roll: ${roll} (TREASURE!)`, "log-gold"); 
        
        // --- AI LOGIC: Instant Get ---
        if (p.isAi) {
            const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
            p.inventory.push({...card});
            addLog(`${p.name} found ${card.name}`, "log-success");
            // Check Alchemist for AI
            if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') {
                const extra = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
                p.inventory.push({...extra});
                addLog(`Alchemist Bonus: Found ${extra.name}!`, "log-epic");
            }
            return; // AI doesn't need to close windows or end turns here usually
        }
        // -----------------------------

        // Human Logic: Animation
        setTimeout(() => { 
            drawCardAnim('treasure', () => showEncounter(p, null, null, 'loot')); 
        }, 500); 
    } else { 
        addLog(`Bonus Loot Roll: ${roll} (No Item)`, "log-fail"); 
        
        // End the turn if it's the human player
        if (p.id === 0) endStep(); 
    } 
}
function capture(t, p, lvl, callback) {
    const previousOwner = t.userData.owner;
    const wasEnemy = (previousOwner !== null && previousOwner !== p.id);

    t.userData.owner = p.id; 
    t.userData.buildingLevel = lvl; 
    t.userData.guardCount = 0; 
    if (t.userData.prop) t.remove(t.userData.prop);
    
    // --- STEP 1: HIDE UI ONLY (Do NOT call closeEnc) ---
    // removing 'active' hides the visual but keeps the game logic paused/zoomed
    document.getElementById('card-modal').classList.remove('active');

    // Visuals (Building)
    const g = new THREE.Group();
    if (lvl === 1) { 
        const m = new THREE.Mesh(new THREE.ConeGeometry(1, 1.5, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); 
        m.position.set(0, 0.5, 0); g.add(m); 
    } else { 
        const b = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0x5c4033 })); b.position.set(0, 0.5, 0); 
        const r = new THREE.Mesh(new THREE.ConeGeometry(1.5, 1, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); r.position.set(0, 1.5, 0); r.rotation.y = Math.PI / 4; 
        g.add(b); g.add(r); 
    }
    
    // --- SLOWER ANIMATION (4 Seconds) ---
    g.position.y = -5; // Start lower underground
    t.add(g); t.userData.prop = g;
    
    // Rise up
    new TWEEN.Tween(g.position)
        .to({y: 0}, 4000) 
        .easing(TWEEN.Easing.Elastic.Out) 
        .start();
    
    // --- VICTORY DANCE ---
    // Spin
    new TWEEN.Tween(p.mesh.rotation)
        .to({ y: p.mesh.rotation.y + Math.PI * 4 }, 2000) 
        .easing(TWEEN.Easing.Cubic.Out)
        .start();
        
    // Hop
    new TWEEN.Tween(p.mesh.position)
        .to({ y: 2.5 }, 500)
        .yoyo(true)
        .repeat(3) 
        .start();
    
    addLog(lvl === 1 ? "Captured!" : "Upgraded!", "log-success");

    if (wasEnemy) {
        const pass = ABILITY_LIBRARY[p.passiveSkillId];
        if (pass && pass.onCapture) pass.onCapture(p, t);
    }

    if (p.id === 0) {
        if (lvl === 1) {
            // Wait 4s for animation, then show Defense Picker
            // Camera is STILL ZOOMED here
            setTimeout(() => chooseDefense(t, callback), 4000); 
        } else {
            // Upgrade (Level 2) - No defense pick needed, just end
            if (callback) setTimeout(callback, 4000);
            else setTimeout(endStep, 4000);
        }
    } else {
        // AI Logic
        const s = p.stats; 
        if (s.str >= s.dex && s.str >= s.int) t.userData.defendingStat = 'str'; 
        else if (s.dex >= s.str && s.dex >= s.int) t.userData.defendingStat = 'dex'; 
        else t.userData.defendingStat = 'int';
        
        if (callback) setTimeout(callback, 2000);
        else setTimeout(endStep, 2000);
    }
}
function chooseDefense(t, callback) { 
    // This function runs while camera is still zoomed in
    
    const next = () => { 
        if (callback) callback(); 
        else endStep(); // This triggers resetCamera()
    };
    
    showModal("Tactics", "Choose a stat to defend this location.", [ 
        { txt: "Strength (STR)", act: () => { t.userData.defendingStat = 'str'; addLog("Defense set to STR", "log-success"); next(); } }, 
        { txt: "Dexterity (DEX)", act: () => { t.userData.defendingStat = 'dex'; addLog("Defense set to DEX", "log-success"); next(); } }, 
        { txt: "Intelligence (INT)", act: () => { t.userData.defendingStat = 'int'; addLog("Defense set to INT", "log-success"); next(); } } 
    ]); 
}
function pay(p, amount, recipient) {
    let finalAmount = amount; if (p.passiveSkillId === 'iron_skin' && finalAmount > 0) { const oldAmt = finalAmount; finalAmount = Math.max(0, finalAmount - 20); addLog(`Iron Skin reduced loss by ${oldAmt - finalAmount}G`, "log-rare"); }
    p.gold -= finalAmount;
    if (p.gold < 0) { handleDebt(p, Math.abs(p.gold), recipient); } else { if (recipient) recipient.gold += finalAmount; else treasuryGold += finalAmount; if(finalAmount > 0) addLog(`Paid ${finalAmount}G`, "log-fail"); updateHUD(); }
	AUDIO.playSound('sfx_gold');
}
function handleDebt(p, debt, recipient) {
    const ownedTiles = tiles.filter(t => t.userData.owner === p.id);
    if (p.isAi) {
        while (p.gold < 0 && ownedTiles.length > 0) { const t = ownedTiles.splice(Math.floor(Math.random() * ownedTiles.length), 1)[0]; const val = Math.floor(t.userData.info.cost / 2); sellPropertyLogic(t, p, val); }
        if (p.gold < 0) { eliminatePlayer(p); } else { addLog(`${p.name} sold properties to pay debt.`, "log-fail"); if (recipient && debt > 0) recipient.gold += Math.min(debt, debt + p.gold); updateHUD(); }
    } else { if (ownedTiles.length === 0) { eliminatePlayer(p); } else { showBankruptcyModal(p, debt, recipient, ownedTiles); } }
}
function sellPropertyLogic(t, p, val) { p.gold += val; t.userData.owner = null; t.userData.buildingLevel = 0; t.userData.guardCount = 0; t.userData.defendingStat = null; if (t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; } }
function showBankruptcyModal(p, debt, recipient, ownedTiles) {
    const m = document.getElementById('bankruptcy-modal'); const list = document.getElementById('debt-prop-list'); const debtLabel = document.getElementById('debt-amount'); const btn = document.getElementById('btn-debt-done'); m.style.display = 'flex';
    const refreshList = () => {
        debtLabel.innerText = Math.abs(p.gold); list.innerHTML = ''; const currentOwned = tiles.filter(t => t.userData.owner === p.id);
        if (p.gold >= 0) { btn.disabled = false; btn.innerText = "Debt Cleared - Continue"; btn.onclick = () => { m.style.display = 'none'; if(recipient) recipient.gold += debt; else treasuryGold += debt; updateHUD(); }; } else if (currentOwned.length === 0) { btn.disabled = false; btn.innerText = "Accept Fate (Game Over)"; btn.onclick = () => { m.style.display = 'none'; eliminatePlayer(p); }; } else { btn.disabled = true; btn.innerText = `Sell more! (${Math.abs(p.gold)}G needed)`; }
        currentOwned.forEach(t => { const val = Math.floor(t.userData.info.cost / 2); const row = document.createElement('div'); row.className = 'choice-btn'; row.innerHTML = `<span>${t.userData.info.name}</span> <span style="color:var(--gold)">+${val}G</span>`; row.onclick = () => { sellPropertyLogic(t, p, val); refreshList(); updateHUD(); }; list.appendChild(row); });
    }; refreshList();
}
function eliminatePlayer(p) { p.isDead = true; p.gold = 0; scene.remove(p.mesh); tiles.forEach(t => { if(t.userData.owner === p.id) { t.userData.owner = null; t.userData.buildingLevel = 0; if(t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; } } }); addLog(`${p.name} has been ELIMINATED!`, "log-fail"); updateHUD(); if (!p.isAi) { showGameOver(false); } else { checkWinCondition(); } }
function checkWinCondition() { const livingAi = players.filter(pl => pl.isAi && !pl.isDead); const human = players[0]; if (livingAi.length === 0 && !human.isDead) { showGameOver(true); } }
function showGameOver(victory) { 
    const m = document.getElementById('game-over-modal'); 
    const t = document.getElementById('go-title'); 
    const msg = document.getElementById('go-msg'); 
    const statsDiv = document.getElementById('go-stats');
    const legend = document.getElementById('graph-legend');
    
    m.style.display = 'flex'; 
    
    if(victory) { 
        t.innerText = "VICTORY!"; t.style.color = "var(--gold)"; 
        msg.innerText = "You have defeated all rivals and conquered the realm!"; 
        AUDIO.playSound('sfx_win');
    } else { 
        t.innerText = "DEFEAT"; t.style.color = "var(--accent)"; 
        msg.innerText = "You have lost everything. Your legend ends here."; 
        AUDIO.playSound('sfx_fail');
    } 
    
    // Populate Stats & Legend
    statsDiv.innerHTML = '';
    legend.innerHTML = '';
    
    players.forEach(p => {
        const camps = tiles.filter(tile => tile.userData.owner === p.id && tile.userData.buildingLevel === 1).length;
        const taverns = tiles.filter(tile => tile.userData.owner === p.id && tile.userData.buildingLevel === 2).length;
        
        // Stats Row
        const row = document.createElement('div');
        row.className = 'stat-row';
        row.innerHTML = `
            <span style="color:${p.color}; font-weight:bold;">${p.name}</span>
            <span>üí∞${p.gold} | ‚õ∫${camps} | üç∫${taverns} | ‚öîÔ∏è${p.metrics.successfulSieges}</span>
        `;
        statsDiv.appendChild(row);
        
        // Legend Item
        const li = document.createElement('div');
        li.className = 'legend-item';
        li.innerHTML = `<div class="legend-box" style="background:${p.color}"></div> ${p.name}`;
        legend.appendChild(li);
    });
}
function resetGame() {
    // Hide Modals
    document.getElementById('game-over-modal').style.display = 'none';
    document.getElementById('bankruptcy-modal').style.display = 'none';

    // Remove Player Meshes
    players.forEach(p => scene.remove(p.mesh));
    players = [];

    // Reset Board Tiles
    tiles.forEach(t => {
        t.userData.owner = null;
        t.userData.buildingLevel = 0;
        t.userData.guardCount = 0;
        t.userData.defendingStat = null; // Clear defense stat
        if (t.userData.prop) {
            t.remove(t.userData.prop);
            t.userData.prop = null;
        }
    });

    // Reset Global Variables
    turnIndex = 0;
    turnCount = 0;
    isNight = false;
    treasuryGold = 0;
    gameState = 'SETUP';

    // Reset Environment
    const fogColor = 0xcccccc;
    scene.background = new THREE.Color(fogColor);

    // --- FIX: Clear Game Log ---
    const log = document.getElementById('game-log');
    if (log) log.innerHTML = '';
    // ---------------------------

    // Show Character Creation
    document.getElementById('create-screen').style.display = 'flex';
}

// --- REGION 6: UI UPDATES & INTERACTION ---
// SAFE UPDATE FUNCTION (CRASH FIX)

// Add this to your script section
function switchHelpTab(tabId) {
    // 1. Hide all Content Sections
    const sections = document.querySelectorAll('.help-section');
    sections.forEach(s => s.classList.remove('active'));
    
    // 2. Show the Target Section
    const target = document.getElementById(tabId);
    if(target) target.classList.add('active');
    
    // 3. Update Tab Buttons (Visual State)
    const buttons = document.querySelectorAll('.help-tab');
    buttons.forEach(b => {
        b.classList.remove('active');
        // Check data-tab attribute for robust matching
        if(b.getAttribute('data-tab') === tabId) {
            b.classList.add('active');
        }
    });
}

function addLog(m, c) {
    const l = document.getElementById('game-log');
    if (!l) return;
    
    let d = document.createElement('div');
    d.className = 'log-entry ' + (c || '');
    d.innerText = '> ' + m;
    
    // CHANGED: Append to bottom instead of insertBefore
    l.appendChild(d);
    
    // CHANGED: Auto-scroll to the bottom to show new message
    l.scrollTop = l.scrollHeight;
}

// --- NEW HELPER: LONG PRESS TO SELL ---
function setupLongPressSell(element, identifier, source) {
    let pressTimer;

    element.addEventListener('touchstart', (e) => {
        // Start a timer when touch begins
        pressTimer = setTimeout(() => {
            const sellArea = document.getElementById('market-sell-area');
            const modal = document.getElementById('card-modal');
            
            // Only trigger if Modal is Active AND Sell Area is visible (Merchant)
            if (modal.classList.contains('active') && sellArea && sellArea.style.display !== 'none') {
                sellItem(identifier, source);
                if (navigator.vibrate) navigator.vibrate(50); // Little vibration for feedback
            }
        }, 600); // 600ms hold time
		    hideTooltip(); 
    }, { passive: true });

    // Cancel timer if finger moves (scrolling) or lifts up
    const clearTimer = () => clearTimeout(pressTimer);
    element.addEventListener('touchend', clearTimer);
    element.addEventListener('touchmove', clearTimer);
    element.addEventListener('touchcancel', clearTimer);
}

function updateHUD() {
    if(players.length===0) return;
    const p = players[0];
    setT('p1-name', p.name); setT('p1-gold', p.gold); setT('p1-str', p.stats.str); setT('p1-dex', p.stats.dex); setT('p1-int', p.stats.int); 
    
    // UPDATE TREASURY WIDGET
    setT('treasury-val', treasuryGold);
    
    const elPortrait = document.getElementById('p1-portrait'); if(elPortrait) elPortrait.style.backgroundImage = `url('${p.portrait}')`;
    
    setT('day-night-indicator', isNight ? "‚òæ NIGHT" : "‚òÄ DAY");
    const elDayNight = document.getElementById('day-night-indicator'); if(elDayNight) { elDayNight.style.color = isNight ? "#a855f7" : "#87ceeb"; }
    
    const cur = players[turnIndex]; setT('turn-banner', cur.id === 0 ? "YOUR TURN" : `${cur.name}'S TURN`);
    
    // ACTION BUTTON LOGIC
    const btnAction = document.getElementById('btn-action');
    if (btnAction) {
        btnAction.disabled = true;
        btnAction.classList.remove('state-end');
        btnAction.innerText = "...";
        if (cur.id === 0) {
            if (gameState === 'ROLL') { btnAction.disabled = false; btnAction.innerText = "ROLL"; }
            else if (gameState === 'END') { btnAction.disabled = false; btnAction.classList.add('state-end'); btnAction.innerText = "END"; }
            else { btnAction.innerText = "WAIT"; }
        } else { btnAction.innerText = "AI"; }
    }
    
    const invDiv = document.getElementById('p1-inv'); 
    if(invDiv){ 
        invDiv.innerHTML = ''; 
        for(let i=0; i<12; i++){ 
            let d = document.createElement('div'); d.className = 'inv-slot'; d.dataset.idx = i; d.draggable = true; 
            d.ondragstart = (e) => { if(document.getElementById('context-menu').style.display === 'flex') { e.preventDefault(); return; } dragStart(e, i); }; 
            d.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, i, 'inv'); }; 
            d.onclick = () => { 
				if(document.getElementById('context-menu').style.display !== 'flex') {
				hideTooltip(); // <--- ADD THIS LINE
				equipItem(0, i); 
			}
};
            if(p.inventory[i]){ d.innerText = p.inventory[i].name; d.classList.add('rarity-' + p.inventory[i].rarity); d.onmouseenter = () => showTooltip(p.inventory[i]); d.onmouseleave = hideTooltip; setupLongPressSell(d, i, 'inv'); } 
            invDiv.appendChild(d); 
        } 
    }
    
    // UPDATED LEADERBOARD RENDER
    const lb = document.getElementById('leader-list'); 
    if(lb){ 
        lb.innerHTML = ''; 
        players.forEach(pl => { 
            let d = document.createElement('div'); d.className = 'leader-row' + (pl.isDead ? ' dead' : ''); 
            const camps = tiles.filter(t => t.userData.owner === pl.id && t.userData.buildingLevel === 1).length;
            const taverns = tiles.filter(t => t.userData.owner === pl.id && t.userData.buildingLevel === 2).length;
            
            // Name Section
            let nameSpan = document.createElement('div'); 
            nameSpan.className = "leader-name"; 
            nameSpan.style.color = pl.color; 
            nameSpan.innerText = pl.name; 
            nameSpan.style.fontWeight = "bold";
            nameSpan.style.cursor = "pointer"; 
            nameSpan.style.fontSize = "1rem";
            if(!pl.isDead) { nameSpan.onclick = function() { openCharDetail(pl.id); }; } 
            
            // Info Section (Stacked for better visibility on small screens)
            let infoSpan = document.createElement('div'); 
            infoSpan.style.display = 'flex'; 
            infoSpan.style.justifyContent = 'space-between';
            infoSpan.style.width = '100%';
            infoSpan.style.color = '#ccc';
            infoSpan.style.fontSize = '0.85rem';
            infoSpan.innerHTML = `<span>‚õ∫${camps} üç∫${taverns}</span><span>${pl.isDead ? "DEAD" : pl.gold + "G"}</span>`;
            
            // Row Layout container
            let rowContent = document.createElement('div');
            rowContent.style.display = 'flex';
            rowContent.style.flexDirection = 'column';
            rowContent.style.width = '100%';
            
            rowContent.appendChild(nameSpan);
            rowContent.appendChild(infoSpan);
            
            d.appendChild(rowContent); 
            lb.appendChild(d); 
        }); 
    }
    
    // UPDATE SKILL 0 (Class)
    const s0 = document.getElementById('skill-0'); const txt0 = document.getElementById('txt-skill-0'); const actSkill = ABILITY_LIBRARY[p.activeSkillId]; 
    if(actSkill && s0 && txt0) { 
        if(p.classSkillDepleted) { s0.className="skill-slot"; s0.style.opacity="0.5"; txt0.innerText="Recharge"; } 
        else { s0.className="skill-slot filled"; s0.style.opacity="1"; txt0.innerText=actSkill.name; } 
        s0.style.backgroundImage = actSkill.img ? `url('${actSkill.img}')` : 'none';
        s0.onmouseenter = () => showTooltip(p.activeSkillId, true); s0.onmouseleave = hideTooltip; 
    }

    // UPDATE EQUIPPED (Slots 1-4)
    EQUIP_ORDER.forEach((slotName, i) => { 
        const idx = i + 1; const el = document.getElementById(`skill-${idx}`); const txt = document.getElementById(`txt-skill-${idx}`); 
        const item = p.equipment[slotName]; const dollEl = document.getElementById('slot-'+slotName); 
        if(dollEl) { 
            dollEl.innerHTML = item ? item.name : slotName.toUpperCase(); dollEl.className = 'equip-slot' + (item ? ' filled' : ''); 
            dollEl.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, slotName, 'equip'); }; 
            if(item) { dollEl.onmouseenter = () => showTooltip(item); dollEl.onmouseleave = hideTooltip; setupLongPressSell(dollEl, slotName, 'equip'); } else { dollEl.onmouseenter = null; dollEl.onmouseleave = null; } 
        } 
        if(el && txt) { 
            el.style.backgroundImage = 'none'; 
            if (item) {
                if (item.ability) { const libSkill = Object.values(ABILITY_LIBRARY).find(s => s.name === item.ability.name); if(libSkill && libSkill.img) el.style.backgroundImage = `url('${libSkill.img}')`; }
                if (item.ability && item.ability.type === 'active') { if(item.isDepleted) { el.className = "skill-slot"; el.style.opacity="0.5"; txt.innerText = "Recharge"; } else { el.className = "skill-slot filled"; el.style.opacity="1"; txt.innerText = item.ability.name; } } else { el.className = "skill-slot"; el.style.opacity="1"; txt.innerText = item.ability ? item.ability.name : "(Passive)"; }
                el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; 
            } else { el.className = "skill-slot"; el.style.opacity="1"; txt.innerText = "Empty"; el.onmouseenter = null; el.onmouseleave = null; }
        } 
    });
    
    // UPDATE SINGLE DRAG SLOT (Slot 5)
    const item = p.quickSlots[0]; const el = document.getElementById('skill-5'); const txt = document.getElementById('txt-skill-5'); 
    if(el && txt) { 
        el.style.backgroundImage = 'none'; 
        if (item && p.inventory.includes(item)) { 
            el.className = "skill-slot consumable"; txt.innerText = item.name; 
            const libSkill = Object.values(ABILITY_LIBRARY).find(s => s.name === item.name);
            if(libSkill && libSkill.img) el.style.backgroundImage = `url('${libSkill.img}')`;
            el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; 
        } else { p.quickSlots[0] = null; el.className = "skill-slot"; txt.innerText = "Drag Item"; el.onmouseenter = null; el.onmouseleave = null; } 
    } 
	
	    // --- UPDATE MY STATS WIDGET ---
    const myTiles = tiles.filter(t => t.userData.owner === 0);
    const myCamps = myTiles.filter(t => t.userData.buildingLevel === 1).length;
    const myTaverns = myTiles.filter(t => t.userData.buildingLevel === 2).length;

    setT('ms-gold', p.gold);
    setT('ms-camps', myCamps);
    setT('ms-taverns', myTaverns);
}

function makeDraggable(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    // UPDATED: Now looks for .char-header (P1) OR .leader-header (Leaderboard) OR h3 (Mobile fallback)
    const header = elmnt.querySelector('.char-header') || elmnt.querySelector('.leader-header') || elmnt.querySelector('h3');
    
    if (header) {
        header.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // Get the mouse cursor position at startup:
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // call a function whenever the cursor moves:
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // calculate the new cursor position:
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // set the element's new position:
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        
        // IMPORTANT: Unset 'right' so the 'left' property takes priority allows movement
        elmnt.style.right = 'auto'; 
    }

    function closeDragElement() {
        // stop moving when mouse button is released:
        document.onmouseup = null;
        document.onmousemove = null;
    }
}
function setT(id,t){ let e=document.getElementById(id); if(e) e.innerText=t; }
function handleContextOpen(e, identifier, source='inv') {
    const p = players[0]; let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier]; if (!item) return; 
    const menu = document.getElementById('context-menu'); menu.style.pointerEvents = 'auto'; menu.innerHTML = ''; 
    const sellArea = document.getElementById('market-sell-area'); const canSell = document.getElementById('card-modal').classList.contains('active') && sellArea && sellArea.style.display !== 'none'; const sellPrice = Math.floor((item.cost || 0) / 2);
    const createItem = (text, onClick, disabled=false) => { const div = document.createElement('div'); div.className = 'ctx-item' + (disabled ? ' disabled' : ''); div.innerText = text; if(!disabled) { div.onclick = (ev) => { ev.stopPropagation(); onClick(); closeCtx(); }; } menu.appendChild(div); };
    if (source === 'equip') createItem('Unequip Item', () => unequipItem(identifier)); else createItem(item.type === 'scroll' ? 'Use Scroll' : 'Equip Item', () => equipItem(0, identifier));
    createItem(`Sell (${sellPrice}G)`, () => sellItem(identifier, source), !canSell); createItem('Cancel', () => {});
    let x = e.touches ? e.touches[0].clientX : e.clientX; let y = e.touches ? e.touches[0].clientY : e.clientY; if (x + 150 > window.innerWidth) x = window.innerWidth - 160; if (y + 150 > window.innerHeight) y = window.innerHeight - 160; menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex';
}
function closeCtx() { document.getElementById('context-menu').style.display = 'none'; }
function togglePanel(id) { const panel = document.getElementById(id); if(!panel) return; panel.classList.toggle('minimized'); const btn = panel.querySelector('.minimize-btn'); if(btn) btn.innerText = panel.classList.contains('minimized') ? "+" : "-"; }
function toggleCreatorPortrait() { const el = document.getElementById('creator-portrait-frame'); const btn = document.getElementById('btn-min-portrait'); if(!el || !btn) return; el.classList.toggle('minimized'); btn.innerText = el.classList.contains('minimized') ? "+" : "-"; }
function showModal(t,d,o){ const m=document.getElementById('card-modal'); setT('enc-title',t); setT('card-desc',d); const l=document.getElementById('choice-list'); l.innerHTML=''; document.getElementById('dice-result').innerHTML=''; o.forEach(x=>{ let b=document.createElement('div'); b.className='choice-btn'; b.innerText=x.txt; b.onclick=()=>{m.classList.remove('active');x.act();}; l.appendChild(b); }); m.classList.add('active'); }
function openCharDetail(id) { 
    const p = players[id]; 
    if(!p) return; 
    
    setT('cd-header', p.name); 
    setT('cd-sub', p.race.name + " " + p.class.name); 
    setT('cd-str', p.stats.str); 
    setT('cd-dex', p.stats.dex); 
    setT('cd-int', p.stats.int); 
    
    // --- NEW STATS INJECTION ---
    const camps = tiles.filter(t => t.userData.owner === p.id && t.userData.buildingLevel === 1).length;
    const taverns = tiles.filter(t => t.userData.owner === p.id && t.userData.buildingLevel === 2).length;
    const totalGuards = tiles.filter(t => t.userData.owner === p.id).reduce((sum, t) => sum + (t.userData.guardCount || 0), 0);
    
    let statsHtml = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; font-size:0.9rem; color:#ccc;">
            <div class="stat-row"><span>‚õ∫ Campsites:</span> <b style="color:#fff">${camps}</b></div>
            <div class="stat-row"><span>üç∫ Taverns:</span> <b style="color:#fff">${taverns}</b></div>
            <div class="stat-row"><span>üõ°Ô∏è Guards Active:</span> <b style="color:#fff">${totalGuards}</b></div>
            <div class="stat-row"><span>üõ°Ô∏è Total Hired:</span> <b style="color:#fff">${p.metrics.guardsHired}</b></div>
            <div class="stat-row"><span>‚öîÔ∏è Sieges Won:</span> <b style="color:#fff">${p.metrics.successfulSieges}</b></div>
            <div class="stat-row"><span>üë£ Spaces Moved:</span> <b style="color:#fff">${p.metrics.spacesMoved}</b></div>
        </div>
    `;
    
    const body = document.querySelector('#char-detail-modal .card-body');
    const existingStats = document.getElementById('cd-extra-stats');
    if(existingStats) existingStats.remove();
    
    const statDiv = document.createElement('div');
    statDiv.id = 'cd-extra-stats';
    statDiv.innerHTML = statsHtml;
    
    const attrGrid = body.querySelector('div[style*="display:flex; justify-content:space-around"]');
    attrGrid.insertAdjacentElement('afterend', statDiv);
    // ----------------------------

    const portraitEl = document.getElementById('cd-portrait'); 
    if(portraitEl) portraitEl.style.backgroundImage = `url('${p.portrait}')`; 
    
    const act = ABILITY_LIBRARY[p.activeSkillId]; 
    const pas = ABILITY_LIBRARY[p.passiveSkillId]; 
    
    const buildAbilityHTML = (skill) => {
        if (!skill) return '-';
        const imgTag = (skill.img && skill.img !== "") ? `<img src="${skill.img}" style="width:40px;height:40px;border:1px solid #666;margin-right:10px;vertical-align:middle;border-radius:4px;object-fit:cover;background:#000;">` : '';
        return `<div style="display:flex;align-items:center;">${imgTag}<span style="font-weight:bold;font-size:1.1rem;">${skill.name}</span></div>`;
    };

    const actEl = document.getElementById('cd-active'); if(actEl) actEl.innerHTML = buildAbilityHTML(act); setT('cd-active-desc', act ? act.desc : ''); 
    const pasEl = document.getElementById('cd-passive'); if(pasEl) pasEl.innerHTML = buildAbilityHTML(pas); setT('cd-passive-desc', pas ? pas.desc : ''); 
    
    const invSection = document.getElementById('cd-inventory-section'); 
    const hiddenMsg = document.getElementById('cd-hidden-msg'); 
    
    if (id === 0) { 
        if(invSection) invSection.style.display = 'block'; 
        if(hiddenMsg) hiddenMsg.style.display = 'none'; 
        ['head','body','main','off'].forEach(slot => { 
            const item = p.equipment[slot]; 
            const el = document.getElementById('cd-slot-'+slot); 
            if(el) { 
                el.innerHTML = item ? item.name : slot.toUpperCase(); 
                el.className = 'equip-slot' + (item ? ' filled' : ''); 
                if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { el.onmouseenter = null; } 
            } 
        }); 
        const grid = document.getElementById('cd-inv-grid'); 
        if(grid) { 
            grid.innerHTML = ''; 
            p.inventory.forEach(item => { 
                let d = document.createElement('div'); d.className = 'inv-slot'; d.innerText = item.name; d.classList.add('rarity-' + item.rarity); 
                d.onmouseenter = () => showTooltip(item); d.onmouseleave = hideTooltip; grid.appendChild(d); 
            }); 
            for(let i=p.inventory.length; i<12; i++) { let d = document.createElement('div'); d.className = 'inv-slot'; grid.appendChild(d); } 
        } 
    } else { 
        if(invSection) invSection.style.display = 'none'; 
        if(hiddenMsg) hiddenMsg.style.display = 'block'; 
    } 
    const modal = document.getElementById('char-detail-modal'); 
    if(modal) modal.classList.add('active'); 
}
//if(invSection) invSection.style.display = 'block'; if(hiddenMsg) hiddenMsg.style.display = 'none'; ['head','body','main','off'].forEach(slot => { const item = p.equipment[slot]; const el = document.getElementById('cd-slot-'+slot); if(el) { el.innerHTML = item ? item.name : slot.toUpperCase(); el.className = 'equip-slot' + (item ? ' filled' : ''); if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { el.onmouseenter = null; } } }); const grid = document.getElementById('cd-inv-grid'); if(grid) { grid.innerHTML = ''; p.inventory.forEach(item => { let d = document.createElement('div'); d.className = 'inv-slot'; d.innerText = item.name; d.classList.add('rarity-' + item.rarity); d.onmouseenter = () => showTooltip(item); d.onmouseleave = hideTooltip; grid.appendChild(d); }); for(let i=p.inventory.length; i<12; i++) { let d = document.createElement('div'); d.className = 'inv-slot'; grid.appendChild(d); } } } else { if(invSection) invSection.style.display = 'none'; if(hiddenMsg) hiddenMsg.style.display = 'block'; } const modal = document.getElementById('char-detail-modal'); if(modal) modal.classList.add('active'); }
function closeCharDetail() { document.getElementById('char-detail-modal').classList.remove('active'); hideTooltip(); }
function getRarityColor(r) { if(r==='common')return '#fff'; if(r==='rare')return '#3b82f6'; if(r==='epic')return '#a855f7'; return '#f59e0b'; }
function showTooltip(data, isSkillId = false) { 
    if (!data) return; 
    const tt = document.getElementById('tooltip'); 
    let html = ''; 
    let imgSrc = '';

    if (isSkillId) { 
        const s = ABILITY_LIBRARY[data]; 
        if(!s) return; 
        if(s.img) imgSrc = `<img src="${s.img}" class="tt-icon">`;
        html = `<div class="tt-header" style="display:flex; align-items:center;">${imgSrc}<div><span class="tt-name">${s.name}</span><br><span class="tt-rarity">${s.type || 'Active'}</span></div></div><div class="tt-abil" style="border:none;">${s.desc}</div>`; 
    } else { 
        const col = getRarityColor(data.rarity || 'common'); 
        // Check if item has an ability with an image in the library
        if(data.ability) {
             const libSkill = Object.values(ABILITY_LIBRARY).find(s => s.name === data.ability.name);
             if(libSkill && libSkill.img) imgSrc = `<img src="${libSkill.img}" class="tt-icon">`;
        }
        // Fallback: Check if item NAME matches a skill (e.g. scrolls)
        else if (Object.values(ABILITY_LIBRARY).some(s => s.name === data.name)) {
             const libSkill = Object.values(ABILITY_LIBRARY).find(s => s.name === data.name);
             if(libSkill && libSkill.img) imgSrc = `<img src="${libSkill.img}" class="tt-icon">`;
        }
        
        html = `<div class="tt-header" style="display:flex; align-items:center;">${imgSrc}<div><span class="tt-name" style="color:${col}">${data.name}</span><br><span class="tt-rarity">${data.rarity || 'Common'}</span></div></div>`; 
        if (data.bonus) Object.keys(data.bonus).forEach(k => { html += `<span class="tt-stat">+${data.bonus[k]} ${k.toUpperCase()}</span>`; }); 
        if(data.desc) html += `<span class="tt-stat" style="color:#aaa; font-style:italic; margin-bottom:5px;">${data.desc}</span>`; 
        if(data.ability) html += `<div class="tt-abil">${data.ability.name}: ${data.ability.desc}</div>`; 
    } 
    tt.innerHTML = html; 
    tt.style.display = 'block'; 
}
function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
// --- UPDATED TOOLTIP FOLLOWER ---
document.addEventListener('mousemove', (e) => { 
    const tt = document.getElementById('tooltip'); 
    if (tt && tt.style.display === 'block') { 
        const pad = 20; // Increased padding to prevent cursor overlap
        
        let left = e.clientX + pad; 
        let top = e.clientY + pad; 
        
        // Prevent going off right screen edge
        if (left + tt.offsetWidth > window.innerWidth) {
            left = e.clientX - tt.offsetWidth - pad; 
        }
        
        // Prevent going off bottom screen edge
        if (top + tt.offsetHeight > window.innerHeight) {
            top = e.clientY - tt.offsetHeight - pad; 
        }
        
        tt.style.left = left + 'px'; 
        tt.style.top = top + 'px'; 
    } 
});
document.addEventListener('click', (e) => { const menu = document.getElementById('context-menu'); if (menu && !e.target.classList.contains('inv-slot') && !e.target.classList.contains('ctx-item')) menu.style.display = 'none'; });
let lastTouchTime = 0; let lastTouchSlot = "";
function toggleHelpModal() { 
    const m = document.getElementById('help-modal'); 
    if (m.style.display === 'flex') {
        m.style.display = 'none';
    } else {
        m.style.display = 'flex';
        // Reset to first tab when opening
        switchHelpTab('tab-basics');
    }
}
function toggleSettingsModal() { 
    const m = document.getElementById('settings-modal'); 
    // Toggle between Flex and None
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; 
}
function toggleUIMode(isForced) {
    if (isForced) {
        document.body.classList.add('force-mobile');
    } else {
        document.body.classList.remove('force-mobile');
    }
    // Recalculate camera because viewport size/logic effectively changed
    updateCamera();
}
function handleEquipTouch(slot) { const currentTime = new Date().getTime(); const tapLength = currentTime - lastTouchTime; if (lastTouchSlot === slot && tapLength < 500 && tapLength > 0) { unequipItem(slot); lastTouchTime = 0; } else { useEquipped(slot); lastTouchTime = currentTime; lastTouchSlot = slot; } }
function allowDrop(ev){ev.preventDefault();}
function dragStart(ev, i){ev.dataTransfer.setData("idx",i);}
function handleSellDrop(ev){ ev.preventDefault(); if(document.getElementById('market-sell-area').style.display!=='none'){const idx=ev.dataTransfer.getData("idx"); if(idx!==null) sellItem(idx); }}
function handleSkillDrop(ev, slotIdx) { ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0]; if (invIdx !== null && p.inventory[invIdx]) { const item = p.inventory[invIdx]; if (item.type === 'scroll' || (item.ability && item.ability.type === 'active')) { p.quickSlots[slotIdx] = item; updateHUD(); } else { addLog("Cannot assign passive item.", "log-fail"); } } }
function setupEquipDragDrop() { ['head', 'body', 'main', 'off'].forEach(slot => { const el = document.getElementById('slot-' + slot); if(el) { el.ondragover = allowDrop; el.ondrop = (e) => handleEquipDrop(e, slot); } }); }
function handleEquipDrop(ev, slotName) { ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0]; if (invIdx !== null && p.inventory[invIdx]) { const item = p.inventory[invIdx]; if(item.slot === slotName) equipItem(0, invIdx); else addLog(`Cannot equip ${item.name} to ${slotName.toUpperCase()}`, "log-fail"); } }
function unequipItem(slot) { 
    const p=players[0]; 
    if(p.equipment[slot] && p.inventory.length < 12) { 
        const it = p.equipment[slot]; 
        p.stats[Object.keys(it.bonus)[0]] -= Object.values(it.bonus)[0]; 
        p.equipment[slot] = null; 
        p.inventory.push(it); 
        
        // --- AUDIO ---
        AUDIO.playSound('sfx_equip');
        
        updateHUD(); 
    } 
}

function equipItem(pId, invIdx) { 
    const p=players[pId]; 
    const item=p.inventory[invIdx]; 
    
    if(item.type==='scroll'){ 
        // Scrolls don't play equip sound, they trigger their effect
        item.fn(p); 
        p.inventory.splice(invIdx,1); 
    } else { 
        const slot=item.slot; 
        const cur=p.equipment[slot]; 
        if(cur){
            p.stats[Object.keys(cur.bonus)[0]]-=Object.values(cur.bonus)[0]; 
            p.inventory[invIdx]=cur;
        } else {
            p.inventory.splice(invIdx,1);
        } 
        p.equipment[slot]=item; 
        p.stats[Object.keys(item.bonus)[0]]+=Object.values(item.bonus)[0]; 
        
        // --- AUDIO ---
        if(pId === 0) AUDIO.playSound('sfx_equip');
    } 
    updateHUD(); 
}
function equipItem(pId, invIdx) { const p=players[pId]; const item=p.inventory[invIdx]; if(item.type==='scroll'){ item.fn(p); p.inventory.splice(invIdx,1); } else { const slot=item.slot; const cur=p.equipment[slot]; if(cur){p.stats[Object.keys(cur.bonus)[0]]-=Object.values(cur.bonus)[0]; p.inventory[invIdx]=cur;} else{p.inventory.splice(invIdx,1);} p.equipment[slot]=item; p.stats[Object.keys(item.bonus)[0]]+=Object.values(item.bonus)[0]; } updateHUD(); }
function useEquipped(slot) { 
    const p = players[0]; 
    const it = p.equipment[slot]; 
    if (it && it.ability && it.ability.type === 'active') { 
        if (!it.isDepleted) { 
            // FIX: Check return value
            const success = it.ability.fn(p); 
            if (success === true) {
                it.isDepleted = true; 
                updateHUD(); 
            }
        } else { 
            addLog("Ability depleted! Pass Start to recharge.", "log-fail"); 
        } 
    } 
}

function useSkill(slotIndex) { 
    const p = players[0]; 
    if (turnIndex !== 0) { addLog("Not your turn!", "log-fail"); return; } 
    
    // Class Skill (Slot 1)
    if(slotIndex === 0) { 
        if(p.classSkillDepleted) { addLog("Skill depleted! Visit Inn to recharge.", "log-fail"); return; } 
        const skill = ABILITY_LIBRARY[p.activeSkillId]; 
        if(skill && skill.fn) { 
            // FIX: Check return value
            const success = skill.fn(p); 
            if (success === true) {
                p.classSkillDepleted = true; 
                updateHUD(); 
            }
        } 
        return; 
    } 
    
    // Equipped Skills (Slots 2-5)
    if(slotIndex >= 1 && slotIndex <= 4) { 
        const equipSlot = EQUIP_ORDER[slotIndex - 1]; 
        const item = p.equipment[equipSlot]; 
        if (item && item.ability && item.ability.type === 'active') { 
            if (!item.isDepleted) { 
                // FIX: Check return value
                const success = item.ability.fn(p); 
                if (success === true) {
                    item.isDepleted = true; 
                    updateHUD(); 
                }
            } else { 
                addLog("Ability depleted! Visit Inn to recharge.", "log-fail"); 
            } 
        } else { 
            addLog("Passive or Empty.", "log-fail"); 
        } 
        return; 
    } 
    
    // Quick Slots (Slots 6-7)
    if(slotIndex >= 5) { 
        const qIdx = slotIndex - 5; 
        const item = p.quickSlots[qIdx]; 
        if(item && item.type === 'scroll' && item.fn) { 
            // Scrolls always consume on click, logic inside fn usually handles validation or is generic
            const success = item.fn(p); 
            // If scroll returns false (cancelled), don't consume? 
            // For now assuming scrolls are generic, but let's add safety:
            if (success !== false) {
                const invIdx = p.inventory.indexOf(item); 
                if(invIdx > -1) p.inventory.splice(invIdx, 1); 
                p.quickSlots[qIdx] = null; 
                updateHUD(); 
            }
        } 
    } 
}
function sellItem(identifier, source='inv'){ 
    const p = players[0]; 
    let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier]; 
    if(item){ 
        let multiplier = 0.5;
        if (p.passiveSkillId === 'fence') multiplier = 0.8;
        if (p.passiveSkillId === 'heal') multiplier = 3.0;

        let v = Math.floor((item.cost || 0) * multiplier); 
        p.gold += v; 
        
        if(source === 'equip') { 
            if(item.bonus) p.stats[Object.keys(item.bonus)[0]] -= Object.values(item.bonus)[0]; 
            p.equipment[identifier] = null; 
        } else { 
            p.inventory.splice(identifier, 1); 
        } 
        
        // --- AUDIO ---
        AUDIO.playSound('sfx_gold');
        
        let msg = `Sold for ${v}G`;
        if (multiplier === 3.0) msg += " (Well Made!)";
        else if (multiplier === 0.8) msg += " (Fence)";
        
        addLog(msg, "log-gold"); 
        updateHUD(); 
    } 
}
document.addEventListener('keydown', (e) => { if (["1","2","3","4","5","6","7"].includes(e.key)) useSkill(parseInt(e.key) - 1); });

// --- REGION 7: CREATION SCREEN ---
function enterCreation() { 
    // 1. Disable Start Music Flag immediately
    AUDIO.allowStartMusic = false;
    
    // 2. Audio Transitions
    AUDIO.stopStartMusic();   // Fade out Intro
    AUDIO.playMusic(false);   // Start Day Music

    // 3. Visual Transition
    const splash = document.getElementById('splash-screen');
    const create = document.getElementById('create-screen');

    // STEP A: Turn on the Create Screen immediately
    // It sits at z-index 200, so it appears BEHIND the Splash Screen (z-index 300)
    create.style.display = 'flex';
    
    // STEP B: Ensure Create Screen is fully opaque so we see it when Splash fades
    // We use a tiny timeout to ensure the browser registers 'display:flex' first
    setTimeout(() => {
        create.style.opacity = '1';
        
        // STEP C: Fade out the Splash Screen
        // This effectively "Crossfades" or reveals the Create Screen underneath
        splash.style.opacity = '0';
    }, 50);

    // STEP D: Cleanup Splash Screen after animation finishes
    setTimeout(() => {
        splash.style.display = 'none';
    }, 1500); // Matches CSS transition time
}
function setupCreationUI() {
    const cg=document.getElementById('color-grid'); PLAYER_COLORS.forEach(c=>{let d=document.createElement('div');d.className='color-opt';d.style.backgroundColor=c;d.onclick=()=>{selColor=c;document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));d.classList.add('selected');};cg.appendChild(d);});
    const rg=document.getElementById('race-grid'); RACES.forEach(r=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${r.name}</b><small>S:${r.stats.str} D:${r.stats.dex} I:${r.stats.int}</small>`;d.onclick=()=>{selRace=r;hl(d);up();};rg.appendChild(d);});
    const clg=document.getElementById('class-grid'); CLASSES.forEach(c=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${c.name}</b>`;d.onclick=()=>{selClass=c;hl(d);showClassOptions(c);up();};clg.appendChild(d);});
}
function showClassOptions(c) {
    document.getElementById('active-section').style.display='flex'; 
    const ag = document.getElementById('active-grid'); ag.innerHTML='';
    c.actives.forEach(id => { 
        const skill = ABILITY_LIBRARY[id]; 
        let d=document.createElement('div'); 
        d.className='skill-card'; 
        // Inject Image if it exists
        d.innerHTML=`<img src="${skill.img || ''}" style="${!skill.img ? 'display:none' : ''}"><b>${skill.name}</b><small>${skill.desc}</small>`; 
        d.onclick=()=>{ selActiveId=id; document.querySelectorAll('#active-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); }; 
        ag.appendChild(d); 
    });
    
    document.getElementById('passive-section').style.display='flex'; 
    const pg = document.getElementById('passive-grid'); pg.innerHTML='';
    c.passives.forEach(id => { 
        const skill = ABILITY_LIBRARY[id]; 
        let d=document.createElement('div'); 
        d.className='skill-card'; 
        // Inject Image if it exists
        d.innerHTML=`<img src="${skill.img || ''}" style="${!skill.img ? 'display:none' : ''}"><b>${skill.name}</b><small>${skill.desc}</small>`; 
        d.onclick=()=>{ selPassiveId=id; document.querySelectorAll('#passive-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); }; 
        pg.appendChild(d); 
    });
}
function hl(el){el.parentElement.childNodes.forEach(c=>c.classList&&c.classList.remove('selected'));el.classList.add('selected');}
function up() { 
    const btn = document.getElementById('btn-start-game');
    const isReady = (selRace && selClass && selActiveId && selPassiveId);
    
    // Enable/Disable button
    btn.disabled = !isReady;
    
    // Toggle Alpha (Opacity)
    btn.style.opacity = isReady ? "1" : "0.5"; 
    btn.style.cursor = isReady ? "pointer" : "not-allowed";

    // Update Portrait if ready
    if(selRace && selClass) { 
        const key = `${selRace.id}_${selClass.id}`; 
        const url = CHAR_PORTRAITS[key]; 
        if(url) { 
            const frame = document.getElementById('creator-portrait-frame'); 
            frame.style.backgroundImage = `url('${url}')`; 
            frame.style.display = 'block'; 
        } 
    } 
}
function startGame() {
    document.getElementById('create-screen').style.display='none'; 
    const name = document.getElementById('char-name-input').value || "Hero";
    spawnPlayer(0, name, selRace, selClass, selActiveId, selPassiveId, false, selColor);
    
    let aiColors = PLAYER_COLORS.filter(c => c !== selColor); let availableNames = [...NPC_NAMES];
    for(let i=1; i<4; i++) { const r = RACES[Math.floor(Math.random()*RACES.length)]; const c = CLASSES[Math.floor(Math.random()*CLASSES.length)]; const aiName = availableNames.splice(Math.floor(Math.random() * availableNames.length), 1)[0]; const aiCol = aiColors.splice(Math.floor(Math.random()*aiColors.length), 1)[0]; const act = c.actives[Math.floor(Math.random()*3)]; const pas = c.passives[Math.floor(Math.random()*3)]; spawnPlayer(i, aiName, r, c, act, pas, true, aiCol); }
    
    gameState='ROLL'; 
    updateHUD(); 
    addLog("Welcome to Questopoly!");

    // --- START GAME MUSIC ---
    AUDIO.playMusic(false); // Start Day Music
    // ------------------------
}
function forcePortrait() {
    // Check if the Screen Orientation API is supported
    if (screen.orientation && screen.orientation.lock) {
        // Attempt to lock to portrait-primary
        screen.orientation.lock('portrait-primary').catch(function(error) {
            // Locking failed (common on iOS or if not fullscreen), but the CSS overlay will handle it visually.
            console.log("Orientation lock not supported/allowed: " + error);
        });
    }
}

// Attempt to lock when the game starts
document.getElementById('btn-start-game').addEventListener('click', forcePortrait);

function toggleGraph() {
    const gc = document.getElementById('graph-container');
    if (gc.style.display === 'none' || gc.style.display === '') {
        gc.style.display = 'block';
        setTimeout(drawGraph, 100); 
    } else {
        gc.style.display = 'none';
    }
}

function drawGraph() {
    const canvas = document.getElementById('game-chart');
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width; canvas.height = rect.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const showGold = document.getElementById('chk-gold').checked;
    const showProps = document.getElementById('chk-props').checked;
    const pad = 40; const gw = canvas.width - pad * 2; const gh = canvas.height - pad * 2;
    
    let maxGold = 100; let maxProps = 1; let maxTurns = 1;
    players.forEach(p => {
        if(p.history.length > maxTurns) maxTurns = p.history.length;
        p.history.forEach(h => {
            if(h.gold > maxGold) maxGold = h.gold;
            if(h.props > maxProps) maxProps = h.props;
        });
    });
    
    ctx.strokeStyle = '#666'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, canvas.height - pad); ctx.lineTo(canvas.width - pad, canvas.height - pad); ctx.stroke();
    
    players.forEach(p => {
        if(showGold) drawLine(ctx, p, 'gold', maxGold, pad, gw, gh, maxTurns, p.color, false);
        if(showProps) drawLine(ctx, p, 'props', maxProps, pad, gw, gh, maxTurns, p.color, true);
    });
}

function drawLine(ctx, p, key, maxVal, pad, gw, gh, maxTurns, color, dashed) {
    if(p.history.length < 2) return;
    ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2;
    if(dashed) ctx.setLineDash([5, 5]); else ctx.setLineDash([]);
    p.history.forEach((h, i) => {
        const x = pad + (i / (maxTurns - 1)) * gw;
        const y = (canvas.height - pad) - (h[key] / maxVal) * gh;
        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.setLineDash([]);
}

function togglePanelVisibility(id) {
    const el = document.getElementById(id);
    if (!el) return;
    
    // Check if it is currently hidden
    // We check for 'none' OR if the class 'active' is missing on mobile
    const isHidden = (getComputedStyle(el).display === 'none');
    
    if (isHidden) {
        // OPEN IT
        el.style.display = 'flex'; // Force flex display
        el.classList.add('active'); // For mobile popup styling
        if(typeof AUDIO !== 'undefined') AUDIO.playSound('sfx_click');
    } else {
        // CLOSE IT
        el.style.display = 'none'; // Force hide
        el.classList.remove('active');
        if(typeof AUDIO !== 'undefined') AUDIO.playSound('sfx_click');
    }
}

// Start Engine
init();
</script>
</body>
</html>
