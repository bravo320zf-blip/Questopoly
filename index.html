<!DOCTYPE html>
<html lang="en">
<!-- 
================================================================
   QUESTOPOLY: LEGENDS - MOBILE RTS VIEW
================================================================
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Questopoly: Legends</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

<style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Roboto+Condensed:wght@400;700&display=swap');

/* ================================================================
   [01] GLOBAL VARIABLES
   ================================================================ */
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(20, 25, 35, 0.95);
            --gold: #fbbf24;
            --accent: #ef4444;
            --text-main: #e2e8f0;
            --success: #22c55e;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legend: #f59e0b;
        }

        * { box-sizing: border-box; } 
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
        body { font-family: 'Roboto Condensed', sans-serif; color: var(--text-main); user-select: none; }
        h1, h2, h3, button, input { font-family: 'Cinzel', serif; }

/* ================================================================
   [02] LAYERS & BOARD ANCHOR
   ================================================================ */
        #game-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1; display: block; pointer-events: none; 
        }
        #game-layer canvas { display: block; width: 100%; height: 100%; outline: none; }
        
        /* THE MAGIC CONTAINER (Desktop Anchor) */
        #board-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 98vmin;
            height: 98vmin;
            z-index: 10;
            pointer-events: none;
        }

/* ================================================================
   [03] UI POSITIONS (DESKTOP DEFAULT)
   ================================================================ */
        
   .panel { 
        background: var(--panel-bg); 
        border: 2px solid #444; 
        box-shadow: 0 5px 20px rgba(0,0,0,0.8); 
        border-radius: 8px; 
        padding: 1vmin; 
        pointer-events: auto; 
        transition: all 0.3s ease;
        position: absolute;
        display: flex;
        flex-direction: column;
    }
        .minimize-btn { background: transparent; border: 1px solid #666; color: #aaa; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; float: right; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .panel.minimized > *:not(.char-header):not(h3) { display: none !important; }
        .panel.minimized { width: auto !important; height: auto !important; min-width: 150px; }

        /* Desktop Positions (Relative to Board) */
        #p1-sheet { top: 10%; left: 10%; width: 35%; border-color: var(--gold); max-height: 40%; }
        #leaderboard { top: 10%; right: 10%; width: 30%; border-color: #665c3b; }

        /* Center Top: Turn Info */
        #turn-info-container {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none; width: 100%;
        }
        #turn-banner { font-size: 5vmin; color: white; text-shadow: 0 0 10px var(--gold); margin-bottom: 5px; }
        #day-night-indicator { display: inline-block; font-size: 2.5vmin; padding: 5px 20px; background: rgba(0,0,0,0.6); border: 1px solid #555; border-radius: 20px; color: #87ceeb; }

        /* Bottom Center: Log & Skills */
        #hud-bottom {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            width: 45%; pointer-events: auto;
        }
        #game-log { 
            width: 100%; height: 15vmin; font-size: 1.8vmin;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.5));
            border: 1px solid #444; border-radius: 8px; padding: 10px;
            overflow-y: auto; text-align: left; margin-bottom: 5px;
            -webkit-mask-image: linear-gradient(to bottom, transparent 5%, black 20%);
            mask-image: linear-gradient(to bottom, transparent 5%, black 20%);
        }
        #skill-bar {
            width: 100%; padding: 5px; gap: 5px; display: flex; justify-content: center;
            background: rgba(20, 25, 35, 0.9); border: 2px solid #444; border-radius: 8px;
        }

        /* Bottom Right: Controls */
        #controls { position: absolute; bottom: 10%; right: 10%; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; width: 12%; }
        #controls button { width: 100%; }

        /* Bottom Left: Help */
        #btn-help { 
            position: absolute; bottom: 10%; left: 10%; width: 6vmin; height: 6vmin; 
            background: var(--gold); color: #000; border: 2px solid #fff; border-radius: 50%; 
            font-size: 3vmin; font-weight: 900; cursor: pointer; box-shadow: 0 0 15px #000; 
            display: flex; align-items: center; justify-content: center; pointer-events: auto; 
            transition: transform 0.2s;
        }
        #btn-help:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--gold); }


/* ================================================================
   [04] INTERNAL ELEMENTS
   ================================================================ */
        button { background: #2a2a2a; color: #fff; border: 1px solid #555; padding: 1.5vmin 3vmin; font-size: 2.5vmin; cursor: pointer; transition: 0.2s; text-transform: uppercase; box-shadow: 0 4px 0 #111; border-radius: 6px; width: auto; }
        button:hover { background: #333; transform: translateY(-2px); }
        button.primary { background: var(--gold); color: #000; border: none; font-weight: bold; box-shadow: 0 4px 0 #b45309; }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); transform: none; box-shadow: none; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-bottom: 5px; }
        .stat-box { background: #222; padding: 2px; text-align: center; border: 1px solid #444; border-radius:4px; }
        .stat-val { font-size: 2.5vmin; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 1.2vmin; color: #888; font-weight: bold; }
        .paper-doll { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 5px; border-top: 1px solid #444; padding-top: 5px; }
        .equip-slot { background: #1a1a1a; border: 1px solid #333; height: 3.5vmin; display: flex; align-items: center; justify-content: center; font-size: 1.5vmin; text-align: center; color: #666; cursor: pointer; }
        .equip-slot.filled { border-color: var(--success); color: #fff; background: #052e16; font-weight: bold;}
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; }
        .inv-slot { width: 100%; height: 3.5vmin; background: #111; border: 1px solid #333; cursor: pointer; display:flex; align-items:center; justify-content:center; font-size: 1.2vmin; text-align:center; color:#fff; position: relative; }
        .rarity-common { color: #fff; } .rarity-rare { color: var(--rare); border-color: var(--rare); } .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); } .rarity-legendary { color: var(--legend); border-color: var(--legend); box-shadow: 0 0 8px var(--legend); }
        .char-portrait { width: 6vmin; height: 6vmin; border: 2px solid #444; border-radius: 50%; background-size: cover; background-position: top center; background-color: #000; margin-right: 10px; flex-shrink: 0; }
        .char-header { font-size: 2vmin; }
        .gold-large { font-size: 2.5rem; color: var(--gold); font-weight: 900; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }

        .leader-row { display: flex; justify-content: space-between; margin-bottom: 2px; padding: 6px; background: #222; border-radius: 4px; font-size: 1.8vmin; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .leader-row:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(-2px) scale(1.02); border-color: #555; }
        .leader-name { font-weight: bold; text-decoration: none; }
        
        .skill-slot { width: 5vmin; height: 5vmin; border: 2px solid #444; border-radius: 4px; position: relative; background: #1a1a1a; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1vmin; text-align: center; color: #666; flex-shrink: 0; }
        .skill-slot:hover { border-color: var(--gold); } .skill-slot.filled { border-color: var(--rare); color: #fff; background: #0f172a; } .skill-slot.consumable { border-color: var(--success); }
        .skill-key { position: absolute; top: -3px; left: -3px; width: 1.5vmin; height: 1.5vmin; background: #000; border: 1px solid #666; border-radius: 50%; color: #fff; font-size: 1vmin; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1px; }
        .log-gold { color: var(--gold); } .log-fail { color: var(--accent); } .log-success { color: var(--success); }

/* ================================================================
   [05] MODALS (Standard)
   ================================================================ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-content { background: #1a1a1a; border: 4px solid var(--gold); padding: 40px; text-align: center; max-width: 500px; width: 90%; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .card-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; background: #1a1a1a; border: 4px solid #fff; border-radius: 15px; z-index: 100; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.9); transition: 0.3s; pointer-events: auto; }
        .card-modal.active { transform: translate(-50%, -50%) scale(1); }
        .card-header { background: var(--gold); padding: 15px; text-align: center; color: #000; font-weight: bold; font-size: 1.5rem; border-bottom: 2px solid #000; }
        .card-header.skirmish { background: #b91c1c; color: #fff; } .card-header.loot { background: #10b981; color: #fff; } .card-header.market { background: #78350f; color: #fff; }
        .card-body { padding: 20px; text-align: center; color: #ddd; } 
        .card-desc { font-style: italic; font-size: 1.1rem; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        .choice-btn { background: #333; color: white; border: 1px solid #555; padding: 12px; margin-bottom: 8px; font-size: 1rem; text-align: left; display: flex; justify-content: space-between; cursor: pointer; transition: 0.2s; border-radius: 4px; } .choice-btn:hover { background: #000; border-color: var(--gold); }
        .dice-result { height: 40px; display: flex; gap: 8px; justify-content: center; margin-top: 15px; } 
        .mini-die { width: 35px; height: 35px; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 1.2rem; } .mini-die.win { background: var(--success); } .mini-die.lose { background: var(--accent); }
        .close-x { position: absolute; top: -15px; right: -15px; width: 40px; height: 40px; background: #ef4444; color: white; border: 2px solid #fff; border-radius: 50%; font-weight: bold; font-size: 1.5rem; cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center; padding: 0; }
        #arrival-image, #flavor-image { width: 100%; height: auto; max-height: 40vh; display: block; border-bottom: 2px solid #000; object-fit: contain; background-color: #000; }

        /* Help Modal */
        .help-window { width: 95%; max-width: 700px; height: 80vh; display: flex; flex-direction: column; padding: 0; background: #111; border: 4px double var(--gold); overflow: hidden; }
        .help-header-title { background: var(--gold); color: #000; font-family: 'Cinzel', serif; font-weight: 900; font-size: 2rem; text-align: center; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0; }
        .help-tabs { display: flex; background: #222; border-bottom: 2px solid #444; flex-shrink: 0; overflow-x: auto; }
        .help-tab { flex: 1; background: transparent; border: none; color: #888; padding: 15px 5px; font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; border-bottom: 4px solid transparent; white-space: nowrap; }
        .help-tab:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .help-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(251, 191, 36, 0.1); }
        .help-section { display: none; padding: 20px 30px; overflow-y: auto; flex-grow: 1; text-align: left; color: #ccc; font-size: 1.1rem; line-height: 1.6; }
        .help-section.active { display: block; animation: fadeIn 0.3s ease; }
        .help-section h3 { color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 20px; font-size: 1.4rem; }
        .help-section ul, .help-section ol { margin-bottom: 15px; padding-left: 20px; }
        .help-section li { margin-bottom: 8px; }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://static.wixstatic.com/media/b16479_0ce055a502234368915b49af52e0b18d~mv2.jpg'); background-size: cover; background-position: center; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #create-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://static.wixstatic.com/media/b16479_564e3eade6b7410785d835af2f340665~mv2.jpg'); background-size: cover; background-position: center; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 80px 20px 40px 20px; overflow-y: auto; pointer-events: auto; }
        #splash-screen h1, #create-screen h1 { color: #000; margin-bottom: 20px; text-shadow: 2px 2px 0px #FFF; text-align: center; font-size: 8rem; }
        @media (max-width: 800px) { #splash-screen h1, #create-screen h1 { font-size: 4rem; } }
        #create-screen h3 { color: #000 !important; font-size: 1.5rem; font-weight: 900; margin-top: 15px; margin-bottom: 10px; text-shadow: .5px .5px .5px #FFF; }
        .input-group label { display: block; color: #000; margin-bottom: 8px; font-size: 2rem; font-weight: 900; font-family: 'Cinzel', serif; text-shadow: .5px .5px .5px #FFF; }
        .input-group input { padding: 15px; font-size: 1.5rem; border-radius: 5px; border: 3px solid #000; background: #1e293b; color: white; text-align: center; width: 300px; font-weight: bold; }
        .color-grid { display: flex; gap: 15px; justify-content: center; margin-top: 10px; }
        .color-opt { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #000; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); } .color-opt:hover, .color-opt.selected { transform: scale(1.2); border-color: white; box-shadow: 0 0 15px var(--gold); }
        .sel-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0 20px 0; max-width: 800px; width: 100%; }
        .sel-opt { background: #1e293b; padding: 20px; cursor: pointer; border: 2px solid transparent; text-align: center; transition: 0.2s; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); } .sel-opt:hover { transform: translateY(-3px); background: #334155; } .sel-opt.selected { border-color: var(--gold); background: #334155; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); } .sel-opt b { color: #fff; display: block; margin-bottom: 5px; font-size: 1.2rem; } .sel-opt small { color: #94a3b8; display: block; line-height: 1.2; font-size: 0.9rem; }
        .skill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .skill-card { background: #1e293b; border: 1px solid #475569; padding: 20px; cursor: pointer; border-radius: 6px; width: 200px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); } .skill-card:hover { border-color: var(--success); } .skill-card.selected { background: #064e3b; border-color: var(--success); box-shadow: 0 0 15px var(--success); } .skill-card b { color: #fff; display: block; margin-bottom: 5px; font-size: 1.1rem; } .skill-card small { color: #ccc; font-size: 0.9rem; }
        #creator-portrait-frame { position: fixed; right: 5%; top: 50%; transform: translateY(-50%); width: 400px; height: 500px; border: 4px solid var(--gold); border-radius: 10px; box-shadow: 0 0 30px #000; background-color: #000; background-size: cover; background-position: top center; background-repeat: no-repeat; display: none; z-index: 201; pointer-events: auto; transition: all 0.3s ease; }
        #creator-portrait-frame.minimized { width: 80px !important; height: 80px !important; right: 20px !important; top: 20px !important; transform: none !important; border-width: 2px !important; background-position: top center !important; }
        
        #tooltip { position: absolute; display: none; background: rgba(10,10,15,0.98); border: 2px solid var(--gold); padding: 15px; color: #fff; font-size: 1rem; pointer-events: none; z-index: 200; border-radius: 6px; width: 250px; box-shadow: 0 5px 20px #000; } .tt-header { border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content: space-between;} .tt-name { font-weight: bold; color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem; } .tt-rarity { font-size: 0.9rem; text-transform: uppercase; } .tt-stat { color: #ccc; display: block; } .tt-abil { color: var(--success); margin-top: 5px; font-style: italic; display:block; border-top: 1px solid #333; padding-top: 3px;}
        #context-menu { position: absolute; display: none; flex-direction: column; background: #1a1a1a; border: 2px solid var(--gold); z-index: 1000; min-width: 200px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); border-radius: 6px; } .ctx-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #333; font-size: 1.1rem; color: #fff; background: #222; } .ctx-item:hover { background: #333; color: var(--gold); } .ctx-item:last-child { border-bottom: none; } .ctx-item.disabled { color: #555; cursor: not-allowed; background: #151515; }

/* ================================================================
   [07] MOBILE SCALING CORRECTION
   Paste this at the very bottom of your <style> section
   ================================================================ */
@media only screen and (max-width: 768px) {

    /* --- [A] CHARACTER CREATION FIXES --- */
    .sel-grid, .skill-grid { grid-template-columns: 1fr 1fr !important; width: 100% !important; gap: 5px !important; }
    .sel-opt, .skill-card { width: auto !important; min-width: 0 !important; padding: 10px !important; }
    .input-group input { width: 90vw !important; max-width: 300px; }
    .input-group label { font-size: 1.5rem !important; }
    #create-screen { padding: 40px 10px !important; }
    #splash-screen h1 { font-size: 12vmin !important; }
    #splash-screen button, #create-screen button { font-size: 1.2rem !important; padding: 15px 30px !important; width: auto !important; max-width: 80%; }
    #btn-start-game { width: 90% !important; font-size: 1.5rem !important; padding: 20px !important; margin-top: 20px !important; }

    /* --- [B] MAIN UI CONTAINER --- */
    #board-overlay {
        width: 100vw !important; height: 100vh !important;
        top: 0 !important; left: 0 !important;
        transform: none !important; position: fixed !important;
    }

    /* --- [C] TOP ELEMENTS (Tracker & Log) --- */
    
    /* 1. Turn Tracker (Moved Down) */
    #turn-info-container { 
        top: 10% !important; /* Moved down to avoid edge/buttons */
        width: 100% !important; 
        transform: translateX(-50%) !important; 
        pointer-events: none !important;
        z-index: 50 !important;
    }

    /* 2. Game Log (Moved to Top, under Tracker) */
    #game-log {
        position: fixed !important;
        top: 18% !important; /* Sits directly under the Turn Tracker */
        left: 50% !important;
        transform: translateX(-50%) !important; /* Center Horizontally */
        width: 90% !important;
        height: 60px !important; /* Short height to see board */
        background: rgba(0,0,0,0.5) !important;
        border: 1px solid #444 !important;
        border-radius: 8px !important;
        margin: 0 !important;
        font-size: 12px !important;
        pointer-events: none !important;
        bottom: auto !important; /* Detach from bottom */
        z-index: 50 !important;
        /* Make text fade out at bottom of log */
        -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%) !important;
        mask-image: linear-gradient(to bottom, black 70%, transparent 100%) !important;
    }

    /* --- [D] THE BOTTOM UTILITY BAR --- */
    #hud-bottom {
        position: absolute !important;
        bottom: 0 !important; left: 0 !important;
        width: 100% !important;
        height: 140px !important;
        background: #0f172a !important;
        border-top: 3px solid #fbbf24 !important;
        transform: none !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-end !important;
        padding-bottom: 5px !important;
        z-index: 100 !important;
    }

    /* Skill Bar (Bottom of HUD) */
    #skill-bar {
        width: 98% !important;
        margin: 0 auto !important;
        border: none !important;
        background: transparent !important;
        display: flex !important;
        justify-content: space-between !important;
        padding: 0 !important;
        height: 70px !important;
        align-items: center !important;
    }

    /* Skill Slots */
    .skill-slot { 
        width: 13vw !important; max-width: 65px !important;
        height: 13vw !important; max-height: 65px !important;
        font-size: 9px !important;
        color: #fff !important;
        text-shadow: 0 1px 2px #000, 0 0 4px #000 !important;
        border: 1px solid #555 !important;
        border-radius: 6px !important;
        background-color: #1e293b !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        display: flex !important; align-items: flex-end !important; justify-content: center !important;
        padding-bottom: 2px !important; line-height: 1 !important;
    }
    .skill-key { 
        display: block !important; 
        font-size: 10px !important; width: 14px !important; height: 14px !important;
        top: -4px !important; left: -4px !important;
        background: #000 !important; border: 1px solid #999 !important;
    }

    /* --- [E] INTEGRATED BUTTONS (Above Skills) --- */

    /* Help Button (Top Left of Bar) */
    #btn-help {
        position: absolute !important;
        top: 10px !important;
        left: 10px !important;
        bottom: auto !important;
        width: 45px !important;
        height: 45px !important;
        font-size: 24px !important;
        z-index: 105 !important;
        background: #333 !important;
        border: 2px solid #fff !important;
        box-shadow: none !important;
    }

    /* Controls: Roll/End (Top Right of Bar) */
    #controls {
        position: absolute !important;
        top: 15px !important;
        right: 10px !important;
        bottom: auto !important;
        width: auto !important;
        display: flex !important;
        flex-direction: row !important;
        gap: 10px !important;
        z-index: 105 !important;
    }
    
    #controls button {
        height: 40px !important;
        font-size: 12px !important;
        width: 80px !important;
        border-radius: 6px !important;
        margin: 0 !important;
        padding: 0 5px !important;
    }

    /* --- [F] PANELS (Sheet / Leaderboard) --- */
    
    #p1-sheet, #leaderboard {
        position: absolute !important;
        bottom: 140px !important;
        top: auto !important;
        height: auto !important;
        z-index: 90 !important;
        background: rgba(20, 25, 35, 0.98) !important;
        border-bottom: none !important;
        border-radius: 8px 8px 0 0 !important;
        display: flex !important;
        flex-direction: column !important;
        transition: max-height 0.3s ease-out !important;
    }

    #p1-sheet { left: 0 !important; width: 60% !important; border-left: none !important; }
    #leaderboard { right: 0 !important; width: 38% !important; border-right: none !important; }

    .panel.minimized { max-height: 35px !important; overflow: hidden !important; border-top: 2px solid #444 !important; }
    .panel:not(.minimized) { max-height: 50vh !important; overflow-y: auto !important; box-shadow: 0 -5px 15px rgba(0,0,0,0.8) !important; }

    .char-header, #leaderboard h3 { 
        font-size: 14px !important; 
        padding: 5px !important; margin: 0 !important;
        height: 35px !important;
        display: flex !important; align-items: center !important; justify-content: space-between !important;
    }
    .minimize-btn { width: 22px !important; height: 22px !important; font-size: 16px !important; display: flex !important; align-items:center !important; justify-content:center !important; }

    /* --- [G] MISC --- */
    .gold-large { font-size: 1.1rem !important; white-space: nowrap !important; }
    #p1-class { font-size: 10px !important; }
    
    /* Modal Button Sizes */
    .choice-btn, .card-modal button.primary { font-size: 1rem !important; padding: 12px 10px !important; min-height: 40px !important; }
    .close-x { width: 40px !important; height: 40px !important; font-size: 1.5rem !important; }
}

    </style>
</head>

<body>

<div id="game-layer"></div>
<div id="mobile-hud-bg"></div> <!-- The physical background panel -->

<div id="tooltip"></div>
<div id="context-menu"></div>

<!-- UI LAYER: Overlays -->
<div id="ui-layer">
    
    <!-- BANNER TEXT (Visual) -->
    <div id="questopoly-banner-text" style="display:none">Questopoly</div>
	

    <!-- THIS CONTAINER IS THE SQUARE THAT STICKS TO THE BOARD -->
    <div id="board-overlay">
        
        <!-- TOP CENTER: TURN INFO -->
        <div id="turn-info-container">
            <div id="turn-banner">SETUP PHASE</div>
            <div id="day-night-indicator">☀ DAY</div>
        </div>

        <!-- TOP LEFT: PLAYER SHEET -->
        <div id="p1-sheet" class="panel minimized">
            <div class="char-header">
                <div style="display:flex; align-items:center; width:100%; justify-content:space-between;">
                    <div style="display:flex; align-items:center;">
                        <div id="p1-portrait" class="char-portrait"></div>
                        <div>
                            <div id="p1-name" style="font-weight:bold; color:#fff; font-size:1.2rem;">Hero</div>
                            <div id="p1-class" style="font-size:0.8rem; color:#aaa; line-height:1.2;">Class</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="gold-large" style="margin-right:10px;"><span id="p1-gold">0</span> G</div>
                        <button class="minimize-btn" onclick="togglePanel('p1-sheet')">+</button>
                    </div>
                </div>
            </div>
            <div class="stat-grid">
                <div class="stat-box"><div class="stat-val" id="p1-str">0</div><div class="stat-lbl">STR</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-dex">0</div><div class="stat-lbl">DEX</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-int">0</div><div class="stat-lbl">INT</div></div>
            </div>
            <div class="paper-doll">
                <div id="slot-head" class="equip-slot" onpointerup="handleEquipTouch('head')">Head</div>
                <div id="slot-body" class="equip-slot" onpointerup="handleEquipTouch('body')">Body</div>
                <div id="slot-main" class="equip-slot" onpointerup="handleEquipTouch('main')">Main</div>
                <div id="slot-off" class="equip-slot" onpointerup="handleEquipTouch('off')">Off</div>
            </div>
            <div id="p1-inv" class="inv-grid"></div>
        </div>

        <!-- TOP RIGHT: LEADERBOARD -->
        <div id="leaderboard" class="panel minimized"> 
            <h3 style="margin:0 0 10px 0; text-align:center; color:#ccc; border-bottom:1px solid #444; padding-bottom:5px; position: relative;">
                Leaderboard
                <button class="minimize-btn" onclick="togglePanel('leaderboard')" style="position: absolute; right: 0; top: 0;">+</button>
            </h3>
            <div id="leader-list" style="flex-grow:1; overflow-y:auto; max-height:150px;"></div>
            <div id="treasury-box"><h4 style="margin:0; color:#888;">Treasury</h4><div id="treasury-val">0</div><small style="color:#555;">Capital City Hoard</small></div>
        </div>

        <!-- BOTTOM LEFT: HELP -->
        <div id="btn-help" onclick="toggleHelpModal()">?</div>

        <!-- BOTTOM CENTER: LOG & SKILLS -->
        <div id="hud-bottom">
            <div id="game-log"></div>
            <div id="skill-bar">
                <div class="skill-slot" id="skill-0" onclick="useSkill(0)"><div class="skill-key">1</div><span id="txt-skill-0">Class</span></div>
                <div class="skill-slot" id="skill-1" onclick="useSkill(1)"><div class="skill-key">2</div><span id="txt-skill-1">Empty</span></div>
                <div class="skill-slot" id="skill-2" onclick="useSkill(2)"><div class="skill-key">3</div><span id="txt-skill-2">Empty</span></div>
                <div class="skill-slot" id="skill-3" onclick="useSkill(3)"><div class="skill-key">4</div><span id="txt-skill-3">Empty</span></div>
                <div class="skill-slot" id="skill-4" onclick="useSkill(4)"><div class="skill-key">5</div><span id="txt-skill-4">Empty</span></div>
                <div class="skill-slot" id="skill-5" onclick="useSkill(5)" ondragover="allowDrop(event)" ondrop="handleSkillDrop(event, 0)"><div class="skill-key">6</div><span id="txt-skill-5">Drag Item</span></div>
                <div class="skill-slot" id="skill-6" onclick="useSkill(6)" ondragover="allowDrop(event)" ondrop="handleSkillDrop(event, 1)"><div class="skill-key">7</div><span id="txt-skill-6">Drag Item</span></div>
            </div>
        </div>

        <!-- BOTTOM RIGHT: CONTROLS -->
        <div id="controls">
            <button id="btn-roll" class="primary" onclick="rollMove()">ROLL</button>
            <button id="btn-end" onclick="endTurn()" disabled>END</button>
        </div>

    </div> <!-- END BOARD OVERLAY -->

</div>

<!-- MODALS -->
<div id="splash-screen">
    <h1 style="font-size: 8rem; color: #fff; text-shadow: 0 0 30px var(--gold); margin-bottom: 20px;">QUESTOPOLY</h1>
    <h2 style="color: #ddd; font-size: 2rem; margin-top: 0; margin-bottom: 50px; text-shadow: 2px 2px 5px #000;">LEGENDS</h2>
    <button class="primary" style="font-size: 2.5rem; padding: 20px 80px; box-shadow: 0 0 20px #000;" onclick="enterCreation()">PLAY</button>
</div>

<div id="create-screen" style="display:none;">
    <div class="input-group"><label>Name Your Hero</label><input type="text" id="char-name-input" value="Hero" maxlength="12"></div>
    <div class="input-group"><label>Choose Color</label><div class="color-grid" id="color-grid"></div></div>
    <h3 style="color:#888;">Select Race (Base Stats)</h3><div class="sel-grid" id="race-grid"></div>
    <h3 style="color:#888;">Select Class</h3><div class="sel-grid" id="class-grid"></div>
    <div id="active-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
        <h3 style="color:#888;">Choose Active Skill</h3><div class="skill-grid" id="active-grid"></div>
    </div>
    <div id="passive-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
        <h3 style="color:#888;">Choose Passive Trait</h3><div class="skill-grid" id="passive-grid"></div>
    </div>
    <button id="btn-start-game" class="primary" style="padding:15px 50px; font-size:1.5rem;" onclick="startGame()" disabled>Start Adventure</button>
    <div style="height:50px;"></div>
    <div id="creator-portrait-frame"><button id="btn-min-portrait" class="minimize-btn" onclick="toggleCreatorPortrait()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); color: var(--gold); z-index: 205; width: 30px; height: 30px; line-height: 28px; padding: 0;">-</button></div>
</div>

<div id="arrival-modal" class="card-modal" style="padding: 0; overflow: hidden;">
    <button class="close-x" onclick="continueFromArrival()" style="top: 10px; right: 10px;">×</button>
    <div class="card-border">
        <img id="arrival-image" src="" alt="Location Image" style="display:none;">
        <div class="card-body" style="padding: 20px;">
            <div id="arrival-flavor" class="flavor-text" style="min-height:60px; font-style: italic; color: #fff;">...</div>
            <button class="primary" onclick="continueFromArrival()" style="width:100%; margin-top:20px;">Continue</button>
        </div>
    </div>
</div>

<div id="card-modal" class="card-modal" ondragover="allowDrop(event)" ondrop="handleSellDrop(event)">
    <button class="close-x" onclick="closeEnc()">×</button>
    <div class="card-header" id="enc-header">Encounter</div>
    <div class="card-body">
        <h2 id="enc-title" style="margin:0 0 10px 0; color:#fff;">Title</h2>
        <p id="enc-desc" class="card-desc">...</p>
        <div id="market-sell-area" class="market-sell-area" style="display:none;">Drag items here to SELL</div>
        <div id="choice-list"></div>
        <div id="dice-result" class="dice-result"></div>
    </div>
</div>

<div id="flavor-modal" class="card-modal" style="z-index: 110;">
    <div class="card-border">
        <div class="card-header" id="flavor-header">Location</div>
        <img id="flavor-image" src="" alt="Flavor Image">
        <div class="card-body">
            <p id="flavor-text" class="card-desc" style="margin-top:20px;">...</p>
            <button class="primary" onclick="closeFlavor()" style="width:100%; margin-top:10px;">Continue</button>
        </div>
    </div>
</div>

<div id="char-detail-modal" class="card-modal" style="width: 350px; background: var(--panel-bg); border: 2px solid #444;">
    <div style="display:flex; align-items:center; justify-content:center; padding:15px; border-bottom:1px solid #444;">
        <div id="cd-portrait" class="char-portrait"></div>
        <div style="text-align:left; margin-left:15px;">
            <div id="cd-header" style="color:#fff; font-weight:bold; font-size:1.4rem;">Hero Name</div>
            <div id="cd-sub" style="color:#aaa; font-size:0.9rem;">Race Class</div>
        </div>
    </div>
    <button class="close-x" onclick="closeCharDetail()">×</button>
    <div class="card-body" style="text-align: left; padding: 15px;">
        <div style="display:flex; justify-content:space-around; background:#222; padding:8px; border-radius:4px; margin-bottom:10px; border:1px solid #444;">
            <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-str">0</span><small style="color:#888;">STR</small></div>
            <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-dex">0</span><small style="color:#888;">DEX</small></div>
            <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-int">0</span><small style="color:#888;">INT</small></div>
        </div>
        <div style="margin-bottom:15px; border-top:1px solid #444; padding-top:10px;">
            <div style="margin-bottom:5px;">
                <span style="color:var(--gold); font-weight:bold;">Active:</span> <span id="cd-active" style="color:#fff;">-</span>
                <div id="cd-active-desc" style="font-size:0.8rem; color:#888; font-style:italic;"></div>
            </div>
            <div>
                <span style="color:var(--epic); font-weight:bold;">Passive:</span> <span id="cd-passive" style="color:#fff;">-</span>
                <div id="cd-passive-desc" style="font-size:0.8rem; color:#888; font-style:italic;"></div>
            </div>
        </div>
        <div id="cd-inventory-section" style="display:none; border-top:1px solid #444; padding-top:10px;">
            <div style="color:#aaa; text-align:center; margin-bottom:5px;">Equipment</div>
            <div class="paper-doll" style="border:none; padding:0; margin-bottom:10px;">
                <div id="cd-slot-head" class="equip-slot">Head</div>
                <div id="cd-slot-body" class="equip-slot">Body</div>
                <div id="cd-slot-main" class="equip-slot">Main</div>
                <div id="cd-slot-off" class="equip-slot">Off</div>
            </div>
            <div style="color:#aaa; text-align:center; margin-bottom:5px;">Backpack</div>
            <div id="cd-inv-grid" class="inv-grid"></div>
        </div>
        <div id="cd-hidden-msg" style="display:none; text-align:center; color:#555; font-style:italic; margin-top:20px;">Inventory Hidden</div>
    </div>
</div>

<div id="game-over-modal" class="modal-overlay">
    <div class="modal-content">
        <h1 id="go-title" class="modal-title">GAME OVER</h1>
        <p id="go-msg" class="modal-text">Your journey ends here.</p>
        <button class="primary" onclick="resetGame()">PLAY AGAIN</button>
    </div>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content help-window">
        <button class="close-x" onclick="toggleHelpModal()">×</button>
        
        <div class="help-header-title">ADVENTURER'S GUIDE</div>

        <!-- TABS NAVIGATION -->
        <div class="help-tabs">
            <button class="help-tab active" onclick="switchHelpTab('tab-basics')">Basics</button>
            <button class="help-tab" onclick="switchHelpTab('tab-combat')">Conquest</button>
            <button class="help-tab" onclick="switchHelpTab('tab-upgrades')">Upgrades</button>
            <button class="help-tab" onclick="switchHelpTab('tab-loot')">Loot & Glory</button>
        </div>

        <!-- TAB 1: BASICS -->
        <div id="tab-basics" class="help-section active">
            <h3><span style="color:var(--gold)">✦</span> The Objective</h3>
            <p>Be the last Hero standing! Bankrupt your rivals by capturing locations and hoarding Gold. When a player runs out of money and property, they are forgotten by history.</p>
            
            <h3><span style="color:var(--gold)">✦</span> Movement & The Inn</h3>
            <p>Every journey begins at <b>Old Crooks Inn</b>. Roll <b>2d6</b> to move.</p>
            <ul>
                <li><b>Passing Start:</b> Gain <span style="color:var(--success)">+200 Gold</span> and recharge all abilities.</li>
                <li><b>Landing on Start:</b> Visit the Merchant to buy supplies.</li>
            </ul>

            <h3><span style="color:var(--gold)">✦</span> The Dungeon</h3>
            <p>If you land on "Go to Dungeon," you are arrested! You must <b>Skip your next turn</b>. If you land on the Dungeon space itself (Just Visiting), you are safe to mock the prisoners.</p>
        </div>

        <!-- TAB 2: CONQUEST (Combat & Rent) -->
        <div id="tab-combat" class="help-section">
            <h3><span style="color:var(--gold)">✦</span> Empty Lands</h3>
            <p>When you discover a new location, you draw an <b>Encounter Card</b>. You must pass a Stat Check (Str, Dex, or Int) to save the town.</p>
            <ul>
                <li><b>Success:</b> You capture the location and set up Camp. You must then assign a <b>Defending Stat</b> (STR, DEX, or INT) to protect the land.</li>
                <li><b>Failure:</b> You pay a fine to the Treasury (Capital City) to repair damages.</li>
            </ul>

            <h3><span style="color:var(--gold)">✦</span> Enemy Lands</h3>
            <p>If you land on a space owned by a rival, you have two choices:</p>
            <ol>
                <li><b>Pay Rent:</b> Pay the fee directly to the owner.</li>
                <li><b>Siege (Attack):</b> Attempt to steal the land! You must roll against the location's assigned <b>Defending Stat</b>.
                    <ul>
                        <li><b>Win Siege:</b> You take the land (or kill a guard).</li>
                        <li><b>Lose Siege:</b> You pay <b>DOUBLE</b> the rent to the owner.</li>
                    </ul>
                </li>
            </ol>
        </div>

        <!-- TAB 3: UPGRADES & DEFENSE -->
        <div id="tab-upgrades" class="help-section">
            <h3><span style="color:var(--gold)">✦</span> Building Taverns</h3>
            <p>If you land on a location you already own, you can upgrade your Camp into a <b>Tavern</b>.</p>
            <p>Taverns force enemies to draw harder <b>Skirmish Cards</b> when attacking.</p>

            <h3><span style="color:var(--gold)">✦</span> Guards</h3>
            <p>Owners of a Tavern can hire <b>Bodyguards</b> for <span style="color:var(--gold)">50G</span> each.</p>
            <p>If an enemy successfully Sieges your land, a Guard dies to protect the property. You only lose the property if there are no Guards left.</p>
        </div>

        <!-- TAB 4: LOOT & TREASURY -->
        <div id="tab-loot" class="help-section">
            <h3><span style="color:var(--gold)">✦</span> Treasure</h3>
            <p>Items range from <span style="color:#fff">Common</span>, <span style="color:var(--rare)">Magic</span>, <span style="color:var(--epic)">Rare</span>, to <span style="color:var(--legend)">Legendary</span>.</p>
            <p>Some items grant passive stat bonuses, while others provide active skills. <b>Scrolls</b> (like Town Portals) are one-time use.</p>

            <h3><span style="color:var(--gold)">✦</span> Capital City</h3>
            <p>Taxes collected from the Tax spaces and fines from failed captures are stored in the Kingdom's Treasury.</p>
            <p><b>Landing on Capital City</b> awards you the entire contents of the Treasury!</p>
        </div>

        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
            <button class="primary" onclick="toggleHelpModal()">Start Adventure</button>
        </div>
    </div>
</div>

<div id="bankruptcy-modal" class="modal-overlay">
    <div class="modal-content" style="border-color: var(--accent);">
        <h1 class="modal-title" style="color: var(--accent);">DEBT!</h1>
        <p class="modal-text">You owe <span id="debt-amount" class="debt-val">0</span> G</p>
        <p style="color:#aaa; font-size:0.9rem;">Select properties to sell (50% value):</p>
        <div id="debt-prop-list" class="prop-list"></div>
        <button id="btn-debt-done" class="primary" onclick="checkDebtCleared()" disabled>Pay & Continue</button>
    </div>
</div>

<!-- ================================================================
   [06] JAVASCRIPT
   ================================================================ -->
<script>
// --- REGION 1: GLOBALS & INIT ---
let scene, camera, renderer;
let tiles=[], players=[], turnIndex=0, gameState='SETUP', treasuryGold=0;
let normalDeck, skirmishDeck, treasureDeck;
let turnCount = 0, isNight = false;
let selRace=null, selClass=null, selColor="#ef4444", selActiveId=null, selPassiveId=null;

const PLAYER_COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#FFFFFF"];
const EQUIP_ORDER = ['head', 'body', 'main', 'off'];

// --- REGION 2: DATA (Names, Races, Classes) ---
const NPC_NAMES = [
    "Aaelin", "Adran", "Aelar", "Aeron", "Alaric", "Aldric", "Amara", "Arin", "Asher", "Astrid", 
    "Balthazar", "Bard", "Bran", "Caelum", "Caius", "Caspian", "Cedric", "Corin", "Cyrus", "Darian", 
    "Eamon", "Elander", "Elara", "Eldrin", "Elric", "Emrys", "Faen", "Fenris", "Finn", "Galen", 
    "Gideon", "Gorim", "Griffin", "Hadrian", "Haldor", "Ignis", "Imara", "Ion", "Jareth", "Jax", 
    "Kael", "Kaiden", "Kian", "Kyra", "Leander", "Leo", "Lucian", "Magnus", "Marek", "Mathis",
    "Nael", "Nyx", "Orion", "Orin", "Osric", "Perrin", "Quinn", "Raen", "Ragnar", "Ravyn", 
    "Remus", "Rian", "Roan", "Rurik", "Ryker", "Silas", "Soren", "Stig", "Storm", "Talis", 
    "Thorne", "Torin", "Tristan", "Tybalt", "Uric", "Valen", "Varis", "Vesper", "Xander", "Zane"
];

const RACES = [ 
    {id:'human', name:'Human', stats:{str:2, dex:2, int:2}}, 
    {id:'elf', name:'Elf', stats:{str:1, dex:3, int:2}}, 
    {id:'dwarf', name:'Dwarf', stats:{str:3, dex:1, int:2}}, 
    {id:'orc', name:'Orc', stats:{str:4, dex:1, int:1}}, 
    {id:'gnome', name:'Gnome', stats:{str:1, dex:2, int:3}}, 
    {id:'tiefling', name:'Tiefling', stats:{str:1, dex:1, int:4}}, 
    {id:'dragonborn', name:'Dragonborn', stats:{str:3, dex:2, int:1}}, 
    {id:'halfling', name:'Halfling', stats:{str:1, dex:4, int:1}} 
];

const CLASSES = [
    { id: 'fighter', name: 'Fighter', color: 0x8B0000, 
      actives: ['second_wind', 'power_strike', 'intimidate'], 
      passives: ['veteran', 'iron_skin', 'executioner'] },
    { id: 'wizard', name: 'Wizard', color: 0x4B0082, 
      actives: ['fireball', 'transmute_gold', 'blink'], 
      passives: ['scholar', 'court_mage', 'alchemist_pas'] }, 
    { id: 'rogue', name: 'Rogue', color: 0x2F4F4F, 
      actives: ['pickpocket', 'sprint_act', 'smoke_bomb'], 
      passives: ['shadow_step', 'greedy', 'fence'] },
    { id: 'cleric', name: 'Cleric', color: 0xFFD700, 
      actives: ['heal_light', 'smite', 'bless'], 
      passives: ['devotion', 'medic', 'holy_aura'] }
];

const CHAR_PORTRAITS = {
    human_fighter: "https://static.wixstatic.com/media/b16479_85518cf9c4d646c2994697b826b54bff~mv2.jpg",
    human_wizard: "https://static.wixstatic.com/media/b16479_67634ea082d04f388af02accc2e0a2bc~mv2.jpg",
    human_rogue: "https://static.wixstatic.com/media/b16479_7f27982f60994088b1740631284815b3~mv2.jpg",
    human_cleric: "https://static.wixstatic.com/media/b16479_0293976216c3443187ebcc00fcb1e071~mv2.jpg",
    elf_fighter: "https://static.wixstatic.com/media/b16479_97dd792642d444f59cb3b21842131c6a~mv2.jpg",
    elf_wizard: "https://static.wixstatic.com/media/b16479_19a126df94694355b2381756b2ad35da~mv2.jpg",
    elf_rogue: "https://static.wixstatic.com/media/b16479_ffdbe8eb72214036a2f95e2f5a9e6f48~mv2.jpg",
    elf_cleric: "https://static.wixstatic.com/media/b16479_82514ff810324b4ca9c6218b6d4e2da6~mv2.jpg",
    dwarf_fighter: "https://static.wixstatic.com/media/b16479_15e678031c824dfaa6ff4b851c470c39~mv2.jpg",
    dwarf_wizard: "https://static.wixstatic.com/media/b16479_f84ec5deac214cd3b570517773edd83e~mv2.jpg",
    dwarf_rogue: "https://static.wixstatic.com/media/b16479_81d5ee7fd64c4d1a911252797b8b34bd~mv2.jpg",
    dwarf_cleric: "https://static.wixstatic.com/media/b16479_67a5b13eb3654884b520fcff34f7af0e~mv2.jpg",
    orc_fighter: "https://static.wixstatic.com/media/b16479_733a0e4ffb554734a58229af907bb5e5~mv2.jpg",
    orc_wizard: "https://static.wixstatic.com/media/b16479_a99213a85fa74dc7925dc1fb2d26987f~mv2.jpg",
    orc_rogue: "https://static.wixstatic.com/media/b16479_a0df2ed1b7b3412ba4694f474bf0846b~mv2.jpg",
    orc_cleric: "https://static.wixstatic.com/media/b16479_881698035b3b41c6932393d2b0975359~mv2.jpg",
    gnome_fighter: "https://static.wixstatic.com/media/b16479_7d856dc2c71e4b60aff24ef59172897b~mv2.jpg",
    gnome_wizard: "https://static.wixstatic.com/media/b16479_7466d1b684c04c459bb588da3225158d~mv2.jpg",
    gnome_rogue: "https://static.wixstatic.com/media/b16479_3c67ae62970347d5a96a83248d7680f2~mv2.jpg",
    gnome_cleric: "https://static.wixstatic.com/media/b16479_36767d44051346c49f9e4c0995ece904~mv2.jpg",
    tiefling_fighter: "https://static.wixstatic.com/media/b16479_a5e3e133b61f463a8bcc0ce93b582d25~mv2.jpg",
    tiefling_wizard: "https://static.wixstatic.com/media/b16479_afd36e1dcbc2485cac93ae49155eae58~mv2.jpg",
    tiefling_rogue: "https://static.wixstatic.com/media/b16479_9168e6f8da2e48659f4ced1d8c7aad8c~mv2.jpg",
    tiefling_cleric: "https://static.wixstatic.com/media/b16479_689c4a94dbb6418681634d65878c8022~mv2.jpg",
    dragonborn_fighter: "https://static.wixstatic.com/media/b16479_d5e785f4d11e4d8288a3e963c6902b2c~mv2.jpg",
    dragonborn_wizard: "https://static.wixstatic.com/media/b16479_8e63663f55f142fa81a3958b3a2b0d7b~mv2.jpg",
    dragonborn_rogue: "https://static.wixstatic.com/media/b16479_d4f401dc822b421ca753799e82879c99~mv2.jpg",
    dragonborn_cleric: "https://static.wixstatic.com/media/b16479_dab195d558d94074a19bb86b45972311~mv2.jpg",
    halfling_fighter: "https://static.wixstatic.com/media/b16479_1692c0cb049249a1b5d49ac4f8901b97~mv2.jpg",
    halfling_wizard: "https://static.wixstatic.com/media/b16479_0dcf3d49ab0b4dd7b0ca03d0ed6c09f8~mv2.jpg",
    halfling_rogue: "https://static.wixstatic.com/media/b16479_b031efc88dfe49899f2e2b4f619c788e~mv2.jpg",
    halfling_cleric: "https://static.wixstatic.com/media/b16479_ffa702bd84c141fca8fa7cbfd86f581d~mv2.jpg"
};

const ABILITY_LIBRARY = {
    dash: { name: "Dash", desc: "Move 3 spaces immediately.", fn: (p) => { addLog("Dashed forward!", "log-success"); animateMove(p, 3); } },
    ghost_hand: { name: "Ghost Hand", desc: "Steal 100G from a random player.", fn: (p) => { const targets = players.filter(t => t.id !== p.id && !t.isDead && t.gold >= 1); if(targets.length > 0) { const t = targets[Math.floor(Math.random() * targets.length)]; addLog(`${p.name} uses Ghost Hand on ${t.name}!`, "log-accent"); pay(t, 100, p); } else { addLog("No valid targets to steal from.", "log-fail"); }}},
    midas: { name: "Midas Touch", desc: "Gain 150 Gold immediately.", fn: (p) => { p.gold += 150; addLog("Midas Touch: +150G", "log-gold"); updateHUD(); } },
    heal: { name: "Field Medic", desc: "Remove 'Skipping Turn' status.", fn: (p) => { p.isSkipping = false; addLog("Cured status ailments!", "log-success"); updateHUD(); } },
    gamble: { name: "High Stakes", desc: "Roll d6. 1-3: Lose 50G. 4-6: Gain 200G.", fn: (p) => { const r = Math.floor(Math.random()*6)+1; if(r>3){ p.gold+=200; addLog(`Rolled ${r}: Won 200G!`, "log-gold"); } else { pay(p, 50); addLog(`Rolled ${r}: Lost 50G.`, "log-fail"); } updateHUD(); }},
    teleport: { name: "Town Portal", desc: "Teleport to Old Crooks Inn.", fn: (p) => { p.pos=0; p.mesh.position.copy(tiles[0].position); resolveLanding(p); addLog("Teleported to Inn.", "log-rare"); } },
    backtrack: { name: "Recall", desc: "Move backwards 3 spaces.", fn: (p) => { p.pos = (p.pos - 3 + 40) % 40; const t = tiles[p.pos]; new TWEEN.Tween(p.mesh.position).to({x:t.position.x, z:t.position.z}, 500).onComplete(()=>resolveLanding(p)).start(); addLog("Rewound time.", "log-epic"); }},
    sprint: { name: "Adrenaline", desc: "Add +2 to your next movement roll (Passive).", type:'passive' },
    bribe: { name: "Silver Tongue", desc: "Steal ownership of a tile (TN 6 INT). Only usable when prompted during capture.", fn: (p) => { addLog("You cannot activate this skill at this time.", "log-fail"); } },
    freeze: { name: "Ice Blast", desc: "Next player skips their turn.", fn: (p) => { const nextP = players[(p.id + 1) % players.length]; nextP.isSkipping = true; addLog(`Froze ${nextP.name}!`, "log-epic"); }},
    scavenge: { name: "Scavenge", desc: "Gain 50G for every Item you hold.", fn: (p) => { const amt = p.inventory.length * 50; p.gold += amt; addLog(`Scavenged ${amt}G.`, "log-gold"); updateHUD(); }},
    swap: { name: "Chaos Swap", desc: "Swap positions with random player.", fn: (p) => { const targets = players.filter(t => t.id !== p.id && !t.isDead); if(targets.length > 0) { const t = targets[Math.floor(Math.random() * targets.length)]; const tempPos = p.pos; p.pos = t.pos; t.pos = tempPos; p.mesh.position.copy(tiles[p.pos].position); t.mesh.position.copy(tiles[t.pos].position); addLog(`Swapped with ${t.name}!`, "log-epic"); }}},
    might: { name: "Giant's Str", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str += 5; addLog("Strength surged!", "log-success"); updateHUD(); }},
    focus: { name: "Mind's Eye", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int += 5; addLog("Focus sharpened!", "log-success"); updateHUD(); }},
    agility: { name: "Cat's Grace", desc: "Gain +5 DEX until end of turn.", fn: (p) => { p.stats.dex += 5; addLog("Reflexes heightened!", "log-success"); updateHUD(); }},
    transmute: { name: "Alchemy", desc: "Destroy a random inventory item for 300G.", fn: (p) => { if(p.inventory.length > 0) { const idx = Math.floor(Math.random()*p.inventory.length); const it = p.inventory.splice(idx, 1)[0]; p.gold += 300; addLog(`Transmuted ${it.name} to 300G.`, "log-gold"); updateHUD(); } else { addLog("No items to transmute.", "log-fail"); }}},
    tax_evade: { name: "Tax Dodge", desc: "Gain immunity to Tax tiles (Passive).", type:'passive' },
    bounty: { name: "Bounty Hunter", desc: "Gain 50G when winning a fight.", type: 'passive', onCombatVictory: (p) => { p.gold += 50; addLog("Bounty Hunter Reward: +50G", "log-gold"); updateHUD(); } },
    lucky: { name: "Lucky Charm", desc: "Reroll movement dice once.", fn: (p) => { rollMove(); addLog("Rerolled dice!", "log-success"); } },
    anchor: { name: "Iron Anchor", desc: "You cannot be moved by enemy effects (Passive).", type:'passive' },
    second_wind: { name: "Second Wind", desc: "Gain 100 Gold immediately.", fn: (p) => { p.gold+=100; addLog("Second Wind: +100G", "log-gold"); updateHUD(); } },
    power_strike: { name: "Power Strike", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str+=5; addLog("Power Strike prepared!", "log-success"); updateHUD(); } },
    intimidate: { name: "Intimidate", desc: "Force a target to pay you 50G.", fn: (p) => { let target = null; for(let i=1; i<players.length; i++) { const t = players[(p.id + i) % players.length]; if(!t.isDead) { target = t; break; } } if(target) { addLog(`${p.name} intimidates ${target.name}!`, "log-accent"); pay(target, 50, p); } else { addLog("No valid targets to intimidate.", "log-fail"); } } },
    veteran: { name: "Veteran", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1 },
    iron_skin: { name: "Iron Skin", desc: "Reduce all fail penalties by 20G.", type:'passive' },
    executioner: { name: "Executioner", desc: "Rolling a 6 in combat counts as 2 Successes.", type:'passive' },
    fireball: { 
        name: "Fireball", 
        desc: "Pay 100G. Nuke an enemy tile (Removes control/buildings).", 
        fn: (p) => {
            if (p.gold < 100) { addLog("Need 100G to cast Fireball.", "log-fail"); return; }
            
            // Find all enemy owned tiles
            const targets = tiles.filter(t => t.userData.owner !== null && t.userData.owner !== p.id);
            
            if (targets.length === 0) { addLog("No valid targets.", "log-fail"); return; }

            // Build selection list
            let opts = targets.map(t => ({
                txt: `${t.userData.info.name} (${players[t.userData.owner].name})`,
                act: () => {
                    p.gold -= 100;
                    t.userData.owner = null;
                    t.userData.buildingLevel = 0;
                    t.userData.guardCount = 0;
                    t.userData.defendingStat = null;
                    if (t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; }
                    
                    addLog(`Fireball incinerated ${t.userData.info.name}!`, "log-epic");
                    updateHUD();
                }
            }));
            
            opts.push({txt: "Cancel", act: () => {}}); // Cancel button
            showModal("Cast Fireball", "Select a location to burn to the ground.", opts);
        } 
    },
        transmute_gold: { 
        name: "Transmute", // Renamed from Midas Touch
        desc: "Pay 50G. Destroy 1 Item -> Draw Treasure.", 
        fn: (p) => {
            if (p.gold < 50) { addLog("Need 50G to Transmute.", "log-fail"); return; }
            if (p.inventory.length === 0) { addLog("Inventory empty.", "log-fail"); return; }

            let opts = p.inventory.map((item, idx) => ({
                txt: `Destroy ${item.name}`,
                act: () => {
                    p.gold -= 50;
                    p.inventory.splice(idx, 1);
                    addLog(`Transmuted ${item.name}!`, "log-gold");
                    // Draw new treasure
                    drawCardAnim('treasure', () => { 
                        const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
                        p.inventory.push({...card}); 
                        addLog("Gained " + card.name, "log-success"); 
                        updateHUD(); 
                        closeEnc();
                    });
                }
            }));
            
            opts.push({txt: "Cancel", act: () => {}});
            showModal("Transmute", "Select an item to sacrifice.", opts);
        } 
    },
        blink: { 
        name: "Blink", 
        desc: "Move 1-6 spaces immediately.", 
        fn: (p) => { 
            const dist = Math.floor(Math.random()*6)+1;
            addLog(`Blinked ${dist} spaces!`, "log-rare");
            animateMove(p, dist); 
        } 
    },
    scholar: { name: "Scholar", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1 },
        court_mage: { 
        name: "Court Mage", 
        desc: "Immune to Tax. Gain 10G whenever others pay Tax.", 
        type:'passive' 
    },
        alchemist_pas: { 
        name: "Alchemist", 
        desc: "Drawing 'Pouch of Gold' triggers an extra Treasure draw.", 
        type:'passive' 
    },
     pickpocket: { 
        name: "Pickpocket", 
        desc: "Steal 10G per property from a random player.", 
        fn: (p) => { 
            const targets = players.filter(x => x.id !== p.id && !x.isDead); 
            if(targets.length > 0){ 
                const t = targets[Math.floor(Math.random()*targets.length)];
                // Count target properties
                const propCount = tiles.filter(tile => tile.userData.owner === t.id).length;
                const stealAmt = Math.max(10, propCount * 10); // Minimum 10g
                
                addLog(`${p.name} pickpockets ${t.name}!`, "log-accent"); 
                pay(t, stealAmt, p); 
            } else { 
                addLog("No one to pickpocket.", "log-fail"); 
            }
        }
    },
    sprint_act: { name: "Sprint", desc: "Move 3 spaces.", fn: (p) => { animateMove(p, 3); } },
        smoke_bomb: { // ID kept as smoke_bomb to maintain Rogue class link, but Name changed
        name: "Skeleton Key", 
        desc: "Passive: Immunity to Dungeon. Trap: Enemies landing on Dungeon while you are there go to jail.", 
        type: 'passive',
        // New Hook for Trap Logic
        onEnemyLanding: (victim, owner) => {
            // If the Rogue (Owner) is in the Dungeon (Pos 10)
            if (owner.pos === 10) {
                addLog(`${victim.name} stumbled into ${owner.name}'s trap!`, "log-fail");
                // Send victim to jail (Pos 10 logic but effectively treated as pos 30 outcome)
                victim.isSkipping = true; 
                addLog(`${victim.name} locked in Dungeon!`, "log-fail");
                updateHUD();
            }
        }
    },
    shadow_step: { name: "Shadow Step", desc: "Permanent +1 DEX.", type:'passive', effect:(s)=>s.dex+=1 },
    greedy: { name: "Greedy", desc: "Start with +200G.", type:'passive', effect:(s)=>s.gold+=200 },
    fence: { name: "Fence", desc: "Sell items for 80% value (usually 50%).", type:'passive' },
    heal_light: { 
        name: "Spirit Tithe", 
        desc: "Passive: +5G on enemy land, +10G on owned land.", 
        type: 'active', // Kept as 'active' so it fits the slot color/logic
        // The automatic trigger
        onLanding: (p) => {
            const t = tiles[p.pos];
            if (t.userData.owner !== null) {
                if (t.userData.owner === p.id) {
                    p.gold += 10;
                    addLog("Spirit Tithe: +10G (Home)", "log-gold");
                } else {
                    p.gold += 5;
                    addLog("Spirit Tithe: +5G (Enemy)", "log-gold");
                }
                updateHUD();
            }
        },
        // The manual click trigger (Just acts as a status check)
        fn: (p) => {
            addLog("Spirit Tithe is always active.", "log-success");
        }
    },
smite: { 
        name: "Smite", 
        desc: "Instant Capture/Upgrade/Guard. Movement 1d6 until Recharge.", 
        type: 'active',
        
        // 1. Activation Logic
        fn: (p) => { 
            const t = tiles[p.pos];
            let actionText = "";

            if (t.userData.owner === null || t.userData.owner !== p.id) {
                t.userData.owner = p.id; 
                t.userData.buildingLevel = 1; 
                t.userData.guardCount = 0; 
                if (t.userData.prop) t.remove(t.userData.prop);
                const g = new THREE.Group();
                const m = new THREE.Mesh(new THREE.ConeGeometry(1, 1.5, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); 
                m.position.set(0, 0.5, 0); g.add(m);
                t.add(g); t.userData.prop = g;
                t.userData.defendingStat = 'str'; 
                actionText = "Smite: Captured Location!";
            } 
            else if (t.userData.owner === p.id && t.userData.buildingLevel === 1) {
                t.userData.buildingLevel = 2;
                if (t.userData.prop) t.remove(t.userData.prop);
                const g = new THREE.Group();
                const b = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0x5c4033 })); b.position.set(0, 0.5, 0); 
                const r = new THREE.Mesh(new THREE.ConeGeometry(1.5, 1, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); r.position.set(0, 1.5, 0); r.rotation.y = Math.PI / 4; 
                g.add(b); g.add(r);
                t.add(g); t.userData.prop = g;
                actionText = "Smite: Upgraded to Tavern!";
            }
            else if (t.userData.owner === p.id && t.userData.buildingLevel === 2) {
                t.userData.guardCount = (t.userData.guardCount || 0) + 1;
                actionText = "Smite: Added 1 Guard!";
            }

            // Set Custom Flag on Player
            p.smiteExhaustion = true; 
            
            addLog(actionText, "log-epic");
            addLog("Exhausted: Movement 1d6 until Inn.", "log-fail");
            updateHUD();
        },

        // 2. Roll Override Hook
        onRoll: (p) => {
            if (p.smiteExhaustion) {
                const r = Math.floor(Math.random() * 6) + 1;
                addLog(`${p.name} (Exhausted) rolled ${r}.`, "log-fail");
                return r;
            }
            return null; // Return null to use default roll
        },

        // 3. Recharge Hook
        onRecharge: (p) => {
            if (p.smiteExhaustion) {
                p.smiteExhaustion = false;
                addLog("Smite Exhaustion Cleared!", "log-success");
                return true; // Tell game we performed a recharge
            }
            return false;
        }
    },
    bless: { name: "Bless", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int+=5; addLog("Blessed!", "log-success"); updateHUD(); } },
    devotion: { name: "Devotion", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1 },
    medic: { name: "Medic", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1 },
    holy_aura: { 
    name: "Holy Aura", 
    desc: "Gain 20G when landing on a space with another hero.", 
    type: 'passive',
    onLanding: (p) => {
        const isShared = players.some(other => other.id !== p.id && !other.isDead && other.pos === p.pos);
        if (isShared) {
            p.gold += 20;
            addLog("Holy Aura: +20G (Hero nearby)", "log-gold");
            updateHUD();
        }
    }
},
};

function generateTreasureDeck() {
    const deck = [];
    const itemNames = ["Sword", "Shield", "Helm", "Armor", "Wand", "Staff", "Bow", "Dagger", "Boots", "Gloves", "Ring", "Amulet", "Cloak", "Belt"];
    const slots = ['main', 'off', 'head', 'body', 'main', 'main', 'main', 'main', 'body', 'body', 'off', 'head', 'body', 'body'];
    const stats = ['str', 'str', 'str', 'str', 'int', 'int', 'dex', 'dex', 'dex', 'dex', 'int', 'int', 'dex', 'str'];
    const abilities = Object.keys(ABILITY_LIBRARY);
    for(let i=0; i<20; i++) deck.push({ id: `g${i}`, name: "Pouch of Gold", type: 'scroll', rarity: 'common', cost: 0, desc: "Gain 50 Gold", fn: (p) => { p.gold += 50; addLog("+50 Gold", "log-gold"); updateHUD(); } });
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; deck.push({ id: `c${i}`, name: `Old ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: {}, rarity: 'common', cost: 50 }); }
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=1; deck.push({ id: `m${i}`, name: `Magic ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'rare', cost: 200 }); }
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=2; const abil = ABILITY_LIBRARY[abilities[i % abilities.length]]; deck.push({ id: `r${i}`, name: `Ancient ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'epic', cost: 500, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } }); }
    for(let i=0; i<10; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=3; const abil = ABILITY_LIBRARY[abilities[(i+10) % abilities.length]]; deck.push({ id: `l${i}`, name: `Legendary ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'legendary', cost: 1200, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } }); }
    deck.push({ id: 's1', name: "Town Portal", type: 'scroll', rarity: 'rare', cost: 100, desc: "Teleport to Inn", fn: ABILITY_LIBRARY.teleport.fn });
    deck.push({ id: 's2', name: "Potion of Healing", type: 'scroll', rarity: 'common', cost: 50, desc: "Cure status", fn: ABILITY_LIBRARY.heal.fn });
    deck.push({ id: 's3', name: "Sprint Scroll", type: 'scroll', rarity: 'common', cost: 50, desc: "Dash 3 spaces", fn: ABILITY_LIBRARY.dash.fn });
    deck.push({ id: 's4', name: "Transmute Scroll", type: 'scroll', rarity: 'epic', cost: 300, desc: "Item to Gold", fn: ABILITY_LIBRARY.transmute.fn });
    for(let i=4; i<10; i++) deck.push({ id: `s${i}`, name: "Lucky Coin", type: 'scroll', rarity: 'common', cost: 50, desc: "Gain 20-100G", fn: ABILITY_LIBRARY.gamble.fn });
    return deck;
}

const DECK_TREASURE = generateTreasureDeck();
const DECK_ENCOUNTER = [
    // STR/DEX
    {name:"Goblin Ambush", type:'combat', desc:"Goblins jump from the trees!", choices:[{txt:"Power Through (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Dodge & Counter (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bar Fight", type:'combat', desc:"A drunk patron swings a stool at you.", choices:[{txt:"Punch Back (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Weave Away (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Wolf Pack", type:'combat', desc:"Hungry wolves circle you.", choices:[{txt:"Intimidate (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:20}, {txt:"Quick Strikes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Rogue Duelist", type:'combat', desc:"He challenges you to a duel.", choices:[{txt:"Overpower (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80}, {txt:"Parry (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Rocks", type:'check', desc:"A landslide! React fast!", choices:[{txt:"Hold it up (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Dive (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40}]},
    {name:"Mud Pit", type:'check', desc:"You are stuck in thick mud.", choices:[{txt:"Pull Out (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture', val:30},{txt:"Balance Out (DEX 5+)", stat:'dex', tn:5, fail:40, mode:'capture', val:80}]},
    {name:"Giant Spider", type:'combat', desc:"It descends on a silk thread.", choices:[{txt:"Smash It (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture'},{txt:"Roll Away (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bear Trap", type:'check', desc:"SNAP! Your leg is caught.", choices:[{txt:"Pry Open (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:50},{txt:"Pick Lock (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Wild Boar", type:'combat', desc:"It charges from the brush.", choices:[{txt:"Wrestle (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Matador Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Chandelier", type:'check', desc:"The chain snaps above you!", choices:[{txt:"Catch It (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Jump Away (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20}]},
    {name:"Runaway Cart", type:'check', desc:"It's rolling down the hill towards town.", choices:[{txt:"Stop it (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Jump on & Steer (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Training Dummy", type:'combat', desc:"A magically animated sparring partner.", choices:[{txt:"Heavy Hit (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture'},{txt:"Precision (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture'}]},
    {name:"Bee Swarm", type:'combat', desc:"Not the bees! They are everywhere!", choices:[{txt:"Swat Wildly (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Outrun (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:30}]},
    {name:"Arm Wrestling", type:'check', desc:"A dwarf challenges you.", choices:[{txt:"Brute Force (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Technique (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Bandit Toll", type:'check', desc:"They block the bridge.", choices:[{txt:"Shove Aside (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Slip Past (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Greased Pig", type:'check', desc:"Catch the prize pig at the fair.", choices:[{txt:"Tackle (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:60},{txt:"Snatch (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:90}]},
    {name:"Crumbling Floor", type:'check', desc:"The wood gives way beneath you.", choices:[{txt:"Hang on (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture', val:20},{txt:"Leap (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50}]},

    // DEX/INT
    {name:"Arcane Trap", type:'check', desc:"Runes glow on the floor.", choices:[{txt:"Disarm (DEX 5+)", stat:'dex', tn:5, fail:60, mode:'capture', val:100},{txt:"Dispel (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:50}]},
    {name:"Pickpocket", type:'check', desc:"A thief bumps into you.", choices:[{txt:"Grab Him (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Predict Path (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Locked Gate", type:'check', desc:"An ancient mechanism blocks the way.", choices:[{txt:"Climb Over (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Solve Puzzle (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Illusionist", type:'combat', desc:"Copies of the wizard surround you.", choices:[{txt:"Strike True (DEX 5+)", stat:'dex', tn:5, fail:50, mode:'capture', val:80},{txt:"See Truth (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Arrow Storm", type:'combat', desc:"Arrows fly from the bushes.", choices:[{txt:"Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'},{txt:"Shield Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Card Game", type:'check', desc:"A high stakes game at a tavern.", choices:[{txt:"Sleight of Hand (DEX 5+)", stat:'dex', tn:5, fail:100, mode:'capture', val:200},{txt:"Count Cards (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:100}]},
    {name:"Poison Gas", type:'check', desc:"Green mist fills the room.", choices:[{txt:"Hold Breath & Run (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Identify Antidote (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:120}]},
    {name:"Sphinx", type:'combat', desc:"It demands an answer or your life.", choices:[{txt:"Run Past (DEX 5+)", stat:'dex', tn:5, fail:80, mode:'capture'},{txt:"Answer Riddle (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Shell Game", type:'check', desc:"A street scammer challenges you.", choices:[{txt:"Fast Eyes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80},{txt:"Calculate (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Mimic", type:'combat', desc:"The chest has teeth!", choices:[{txt:"Reflex Stab (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Identify (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Singing Contest", type:'check', desc:"Perform for the crowd.", choices:[{txt:"Dance (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture', val:60},{txt:"Compose Lyrics (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Flying Book", type:'check', desc:"A spellbook flutters away.", choices:[{txt:"Catch It (DEX 4+)", stat:'dex', tn:4, fail:20, mode:'capture', val:50},{txt:"Summon It (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:50}]},
    {name:"Tripwire", type:'check', desc:"A thin wire spans the path.", choices:[{txt:"Cut Carefully (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:30},{txt:"Analyze Mechanism (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:30}]},
    {name:"Fey Prank", type:'combat', desc:"A pixie steals your boots.", choices:[{txt:"Chase (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:40},{txt:"Trick It Back (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Lost in Woods", type:'check', desc:"The path has vanished.", choices:[{txt:"Climb Tree (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20},{txt:"Navigate Stars (INT 4+)", stat:'int', tn:4, fail:20, mode:'capture', val:40}]},
    {name:"Clockwork Toy", type:'combat', desc:"A mechanical soldier malfunctions.", choices:[{txt:"Disable (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture'},{txt:"Reprogram (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},
    {name:"Alchemy Accident", type:'check', desc:"A potion is about to explode.", choices:[{txt:"Throw it (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:40},{txt:"Neutralize (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:100}]},

    // STR/INT
    {name:"Stone Golem", type:'combat', desc:"Slow but incredibly tough.", choices:[{txt:"Shatter (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Find Weakness (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Cursed Armor", type:'combat', desc:"An animated suit of armor attacks.", choices:[{txt:"Bash (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Banish Spirit (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Rusted Portcullis", type:'check', desc:"The gate is heavy and stuck.", choices:[{txt:"Lift (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:50},{txt:"Leverage (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:40}]},
    {name:"Orc Shaman", type:'combat', desc:"He channels lightning.", choices:[{txt:"Rush Him (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:30},{txt:"Counterspell (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:80}]},
    {name:"Magic Sword", type:'check', desc:"A sword stuck in a stone.", choices:[{txt:"Pull (STR 6+)", stat:'str', tn:6, fail:50, mode:'capture', val:200},{txt:"Arcane Release (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:150}]},
    {name:"Drunken Giant", type:'combat', desc:"He creates a mess in the tavern.", choices:[{txt:"Wrestle (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Outsmart (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Haunted House", type:'combat', desc:"Furniture is flying everywhere.", choices:[{txt:"Smash Furniture (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Exorcise (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Collapsed Mine", type:'check', desc:"Rubble blocks the gold vein.", choices:[{txt:"Dig (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:60},{txt:"Engineer Support (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:60}]},
    {name:"Crystal Guardian", type:'combat', desc:"Made of resonating crystal.", choices:[{txt:"Smash (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Sonic Resonance (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Frozen Door", type:'check', desc:"Ice seals the vault.", choices:[{txt:"Kick Open (STR 5+)", stat:'str', tn:5, fail:40, mode:'capture', val:60},{txt:"Melt Spell (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:30}]},
    {name:"Possessed Bear", type:'combat', desc:"Glowing purple eyes stare at you.", choices:[{txt:"Subdue (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture'},{txt:"Cleansing Ritual (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Sinking Boat", type:'check', desc:"Taking on water fast!", choices:[{txt:"Bail Water (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:30},{txt:"Repair Hull (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:50}]},
    {name:"Statue Puzzle", type:'check', desc:"Heavy statues must be arranged.", choices:[{txt:"Push Them (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:60},{txt:"Solve Order (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Magical Barrier", type:'check', desc:"A forcefield blocks the loot.", choices:[{txt:"Hit Hard (STR 6+)", stat:'str', tn:6, fail:80, mode:'capture', val:150},{txt:"Counter-Frequency (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:80}]},
    {name:"Entangled Roots", type:'combat', desc:"Vines grab your legs.", choices:[{txt:"Rip Free (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture'},{txt:"Wither Spell (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Library Fire", type:'check', desc:"Save the ancient scrolls!", choices:[{txt:"Carry Water (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:70},{txt:"Frost Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Gargoyle", type:'combat', desc:"Stone turns to flesh.", choices:[{txt:"Break Wings (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture'},{txt:"Command Word (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},

    // SHOPS/PAY
    {name:"Merchant", type:'shop', desc:"A traveling merchant appears."},
    {name:"Tax Collector", type:'pay', cost:50, desc:"Pay your taxes."},
    {name:"Toll Bridge", type:'pay', cost:30, desc:"Pay the toll."},
    {name:"Peddler", type:'shop', desc:"Cheap wares for sale."},
    {name:"Pickpocket", type:'pay', cost:60, desc:"Your purse is lighter."},
    {name:"Charity", type:'pay', cost:20, desc:"Alms for the poor."}
];

const DECK_SKIRMISH = [
    // STR/DEX (Bosses)
    {name:"Assassin Lord", type:'combat', desc:"Fast and deadly.", choices:[{txt:"Crush Him (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Match Speed (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Hydra", type:'combat', desc:"Heads regrow as you cut them.", choices:[{txt:"Sever Heads (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Dance Around (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Blade Gauntlet", type:'check', desc:"A hallway of swinging scythes.", choices:[{txt:"Block & Move (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:150},{txt:"Acrobatics (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:150}]},
    {name:"Dragon Turtle", type:'combat', desc:"An armored beast of the deep.", choices:[{txt:"Crack Shell (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:100},{txt:"Aim for Eyes (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Chimera", type:'combat', desc:"Lion, Goat, and Snake heads attack.", choices:[{txt:"Hold Heads (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Dodge Breath (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Collapsing Temple", type:'check', desc:"The roof is coming down!", choices:[{txt:"Hold Pillar (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Parkour Out (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Dragon Rider", type:'combat', desc:"An elite knight on a drake.", choices:[{txt:"Knock Off (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Aerial Battle (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Sandworm", type:'combat', desc:"It bursts from the ground.", choices:[{txt:"Wrestle Maw (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Ride It (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:300}]},
    {name:"Blade Master", type:'combat', desc:"He wields six swords.", choices:[{txt:"Parry All (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Riposte (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Tsunami", type:'check', desc:"A massive wave approaches.", choices:[{txt:"Anchor Self (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Climb High (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Juggernaut", type:'combat', desc:"An unstoppable armored charger.", choices:[{txt:"Stop Momentum (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Trip Him (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Invisible Stalker", type:'combat', desc:"You can hear it breathing.", choices:[{txt:"Flail Wildly (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture'},{txt:"React to Sound (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Gladiator Pit", type:'combat', desc:"You are thrown into the arena.", choices:[{txt:"Survive (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flourish (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:250}]},

    // DEX/INT (Bosses)
    {name:"Lich King", type:'combat', desc:"Master of death magic.", choices:[{txt:"Dodge Spells (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Duel Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Mirror Maze", type:'check', desc:"Reflections confuse you.", choices:[{txt:"Wall Jump (DEX 6+)", stat:'dex', tn:6, req:1, fail:100, mode:'capture', val:200},{txt:"Deduce Path (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Void Stalker", type:'combat', desc:"It phases out of reality.", choices:[{txt:"Reaction Shot (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Predict Phase (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:80}]},
    {name:"Ancient Vault", type:'check', desc:"The lock of the gods.", choices:[{txt:"Legendary Pick (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:300},{txt:"Dispel Ward (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Time Loop", type:'check', desc:"You are reliving this moment.", choices:[{txt:"Break Cycle (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:200},{txt:"Unravel Spell (INT 6+)", stat:'int', tn:6, req:2, fail:100, mode:'capture', val:300}]},
    {name:"Lich's Phylactery", type:'check', desc:"The source of his power.", choices:[{txt:"Steal It (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Disenchant (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Psychic Storm", type:'check', desc:"Bolts of mental energy rain down.", choices:[{txt:"Dodge Bolts (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Mental Shield (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:100}]},
    {name:"Laser Grid", type:'check', desc:"Deadly beams block the treasure.", choices:[{txt:"Gymnastics (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Hack Terminal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Doppelganger", type:'combat', desc:"It knows your every move.", choices:[{txt:"Reflex Duel (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Logic Paradox (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Clockwork Dragon", type:'combat', desc:"A masterpiece of destruction.", choices:[{txt:"Jam Gears (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:120},{txt:"Override Code (INT 6+)", stat:'int', tn:6, req:2, fail:120, mode:'capture', val:220}]},
    {name:"Poisoned Banquet", type:'check', desc:"The King is dying!", choices:[{txt:"Sleight of Hand (DEX 6+)", stat:'dex', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Mix Antidote (INT 5+)", stat:'int', tn:5, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Floating Island", type:'check', desc:"The bridge has crumbled away.", choices:[{txt:"Parkour Gaps (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flight Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Shadow Master", type:'combat', desc:"He attacks from the dark.", choices:[{txt:"Counter-Strike (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Light Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:120}]},

    // STR/INT (Bosses)
    {name:"Demon Gate", type:'check', desc:"Demons pour from the portal.", choices:[{txt:"Bar the Gate (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Close Portal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Iron Golem", type:'combat', desc:"Impervious to normal weapons.", choices:[{txt:"Topple (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Rust Spell (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Vampire Lord", type:'combat', desc:"Ancient and powerful.", choices:[{txt:"Drive Stake (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Holy Light (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Obelisk", type:'check', desc:"A fallen monument blocks the road.", choices:[{txt:"Heave (STR 6+)", stat:'str', tn:6, req:1, fail:100, mode:'capture', val:150},{txt:"Levitate (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Volcano Eruption", type:'check', desc:"Lava flows towards the village.", choices:[{txt:"Divert Flow (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Freeze Magma (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"Titan", type:'combat', desc:"A giant as tall as a mountain.", choices:[{txt:"Leg Sweep (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Banishment (INT 6+)", stat:'int', tn:6, req:2, fail:200, mode:'capture', val:300}]},
    {name:"Necropolis Gate", type:'check', desc:"Sealed by blood magic.", choices:[{txt:"Break It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Holy Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Living Wall", type:'combat', desc:"The bricks try to crush you.", choices:[{txt:"Smash Bricks (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Command Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Storm Giant", type:'combat', desc:"He throws lightning bolts.", choices:[{txt:"Arm Wrestle (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Lightning Rod (INT 5+)", stat:'int', tn:5, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Void Rift", type:'check', desc:"Reality is tearing apart.", choices:[{txt:"Force Closed (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Seal Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:300}]},
    {name:"Cursed Tree", type:'combat', desc:"It drains life from the land.", choices:[{txt:"Uproot (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Purify Root (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Meat Grinder", type:'check', desc:"A room of spinning blades.", choices:[{txt:"Jam Gears (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Shutdown (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Abyssal Horror", type:'combat', desc:"Madness given form.", choices:[{txt:"Crush It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Mind Blast (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"King of the Hill", type:'combat', desc:"An Orc Warlord challenges you.", choices:[{txt:"Throw Off (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Tactics (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},

    // Rare Shops
    {name:"Black Market", type:'shop', rare:true, desc:"Forbidden goods."},
    {name:"Void Trader", type:'shop', rare:true, desc:"Items from beyond."},
    {name:"Dragon Hoard", type:'shop', rare:true, desc:"Ancient treasures."}
];

const LOCATIONS = [
    {name:"Old Crooks Inn",type:"start",cost:0,color:"#4ade80",img:"https://static.wixstatic.com/media/b16479_b4d35a4270574b5380497c6eb27146bd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a353cedcf17c4b618027f64190b6be73~mv2.jpg",flavor:"A warm hearth greets you, smelling of roasted meat and ale. Rough laughter fills the air as adventurers swap stories of their latest conquests."},
    {name:"Rat Cellar",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_7981e4bf2a9f42fca2ba9335a79b6315~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1f9645c758e8451c90e7d733f2bc5057~mv2.jpg",flavor:"Squeaking echoes from the damp shadows of this musty basement. Red eyes watch you from the cracks."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_2a0e4f70b29e4611927b65c33fce86f4~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"The dirt here has been recently disturbed. You spot the corner of a wooden box protruding from the mud."},
    {name:"Wolf Den",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_4318c9bb74dd48ddbe8702ec17a059dd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e2baedb53b944da923cc49f6dcce0ff~mv2.jpg",flavor:"Gnawed bones litter the entrance to this dark cave. A low growl reverberates from the shadows."},
    {name:"Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_b2ff79acb9db40c1b8e230e2b43f2a53~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3671f830191345c1b8a315017da72a5b~mv2.jpg",flavor:"The King's tax collectors block the road with their armored carriage. Pay up or face the dungeon."},
    {name:"Stable",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_63e31ea7ac144c2c8086342125a30877~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_f660a75ab6284f56b2c90f4f221f53a3~mv2.jpg",flavor:"The smell of hay and horses is strong here. A merchant offers fresh mounts to speed your journey."},
    {name:"Goblin Camp",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_1d0dc90e90e04783a2cd04823ccf9255~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c48e6fdf163d4dd68b411d5674de6b4b~mv2.jpg",flavor:"Crude tents made of animal skins dot the clearing. You hear the chaotic chatter of goblins."},
    {name:"Fairy Ring",type:"check",tn:4,req:1,reward:100,cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_1437cc54895e4595a43f461ed959c5ce~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_65c314c4ef784a58b9b162d4d30b1698~mv2.jpg",flavor:"A circle of mushrooms glows with a soft, unnatural light. Stepping inside feels like leaving the world behind."},
    {name:"Bandit Road",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_5101a6720f074efcb628b70b85bcdac6~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_6364e428d9504a139a2c56e1e168eb3d~mv2.jpg",flavor:"This stretch of road is suspiciously quiet. Broken wagon wheels suggest travelers often meet a grim fate here."},
    {name:"Ogre Cave",type:"combat",cost:120,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_778f6cf396474b47835aa4e8c103bffd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d5dcf031b6c24893b00b8fa6d0145eca~mv2.jpg",flavor:"A massive boulder blocks the wind, but not the smell of rotting meat. Something very large calls this home."},
    {name:"Dungeon",type:"jail",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_a259ef3e7d8c4c09a88aea824537e57b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_117e17f3d5b84577beb01fcca1cddad9~mv2.jpg",flavor:"Cold iron bars and damp stone walls surround you. It is a place of despair and lost time."},
    {name:"Crypt",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_c230f43aefe64d898b4d2dfe91ad0ba0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_eb64132a865f440c97f6652e340cbb05~mv2.jpg",flavor:"The air is stale and smells of dust and decay. Ancient sarcophagi line the walls. The dead do not sleep easily here."},
    {name:"Mana Well",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_e2c1dbc5f8f64a988893a00b0cd6f066~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_90031776e646488c93f69cc6461d9333~mv2.jpg",flavor:"Pure arcane energy bubbles up from the earth in a glowing blue spring. Wizards travel miles just to glimpse it."},
    {name:"Witch Hut",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_6d223ad95ed04eea8a963cf5b3596e35~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b095b71e60ff4619833aa4b45bc7795d~mv2.jpg",flavor:"A crooked shack stands on chicken legs in the swamp. Green smoke billows from the chimney."},
    {name:"Graveyard",type:"combat",cost:160,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_d7da23aa207b4549b9cd245959d69e6e~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8ae524f80b344def99ec6833ea717083~mv2.jpg",flavor:"Fog clings to the tilted headstones of this forgotten cemetery. The ground feels soft, as if something is trying to claw its way out."},
    {name:"Port",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_bc4d708aeb394233b697b148d0d33dc7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7403c140a66345be8cb9a8eb5b0ebc99~mv2.jpg",flavor:"The cry of seagulls and the crash of waves welcome you. Ships from distant lands unload exotic cargo on the docks."},
    {name:"Orc Fort",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_c529b3b0e6c7410989ac654ae3f8cac7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_dc2c9a5dfd124ef6b8320451e5359218~mv2.jpg",flavor:"Jagged wooden spikes surround a fortified encampment. War drums beat a steady rhythm that shakes the ground."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_9bfca911c8764f158b066493eae2bc81~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"An ornate iron-bound chest sits half-buried in the dirt. The lock looks rusty but the wood is sound."},
    {name:"Troll Bridge",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_249a86b0e4f4415ba0a9be35119eb43a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e9e3392a6a44f8291b357aacf04aef8~mv2.jpg",flavor:"A massive stone bridge spans the rushing river below. A hulking figure demands a toll from anyone wishing to cross."},
    {name:"Wyvern Peak",type:"combat",cost:200,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_f91826c1558c493ba71c3a2c0a05ff71~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d3f9c5b8ba2c4ef2998dd9bd6d2ac062~mv2.jpg",flavor:"The air is thin and cold up on this jagged mountain spire. Screeches echo from the clouds as winged shadows circle above."},
    {name:"Capital City",type:"park",cost:0,color:"#e2e8f0",img:"https://static.wixstatic.com/media/b16479_e5d51e21d1d84a009b8845a522bb5d23~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_909eefa9a23646b2825e2f3819031b90~mv2.jpg",flavor:"The white walls of the capital gleam in the sunlight. Guards in polished armor patrol the streets. Here, the King's law is absolute."},
    {name:"Lava Pits",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_799f54f3baaf47d3a6917ae7c8efb12a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7672054ca2e14a6c95d9151543aaba1d~mv2.jpg",flavor:"The heat is unbearable as magma bubbles to the surface. Sulfurous fumes burn your lungs and obscure your vision."},
    {name:"Dark Altar",type:"combat",cost:200,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_3616e7911ae547e8aaf64dd76e7610b8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_333c76fdd88842199ab18801646ddbbe~mv2.jpg",flavor:"Bloodstains mar the surface of this obsidian slab. Whispers in an unknown tongue fill your mind with dread."},
    {name:"Demon Gate",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_0738c43cfb574de79bdf4dd84c0a663b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_cf022d5d1c264836aade5ffa21a5e77c~mv2.jpg",flavor:"A tear in reality reveals a landscape of fire and torment. Horrors try to claw their way through the barrier."},
    {name:"Dragon Tooth",type:"combat",cost:240,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_aadde8877c854d8fa78d286c00699f7c~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_e373bec825124ac98094938d17fcf71b~mv2.jpg",flavor:"This jagged rock formation looks like the maw of a beast. Legends say an ancient dragon died here, cursing the land."},
    {name:"Airship",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_be49c909366540c8a0b017661cc63e51~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b79ed0dec9104e64a3180a7683ea3fce~mv2.jpg",flavor:"A massive vessel floats tethered to a high tower. The crew shouts orders as they prepare for departure. The sky is the limit."},
    {name:"Lich Tower",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_7bf555b6dc624c4f9523e3faab71a7c8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e1c7a754fa84bfd8523c85fd1d415f8~mv2.jpg",flavor:"A spire of black stone pierces the sky, radiating necromantic energy. The master of this tower conquered death long ago."},
    {name:"Vampire Manor",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_20a15d19b6424e22bc444a5e1ee7a994~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c3cc7bb80938445bb99b8f38f2c91ca1~mv2.jpg",flavor:"An elegant gothic mansion sits atop a lonely hill. The windows are dark, but you feel eyes watching you."},
    {name:"Shrine",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_b4682e4fcd6f4dc0b127326528fe97a8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c90b252d420f4e84ac0340d4555fbdc8~mv2.jpg",flavor:"A humble statue stands covered in vines and offerings. A sense of peace washes over you, healing your spirit."},
    {name:"Giant's Keep",type:"combat",cost:280,tn:6,req:2,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_eb69b5762c8043cc827fd2c0bad0e45a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1e0fcc1de9b844359e778231ea7cc1a3~mv2.jpg",flavor:"Massive stone blocks form a fortress that reaches the clouds. You feel like an ant in this place."},
    {name:"Go To Dungeon",type:"goto",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_33036f2decd74835b1a323a8bfd08ef3~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a212ee172c0c4df5a2cb3ccc22653f50~mv2.jpg",flavor:"The city guards have caught you red-handed! You are shackled and dragged away without trial."},
    {name:"Cloud Castle",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_1d74349092e741eda4d34f735125ce72~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_ddb8d1cc6af442348847805aaf261ae5~mv2.jpg",flavor:"A fortress floats effortlessly among the clouds. Harps play soft music, and the air tastes sweet."},
    {name:"Titan's Grip",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_0b5cf76a120a45c8b5da8d2d6da2fa62~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a091ec8e8f164723b44457bc878dedeb~mv2.jpg",flavor:"Two massive stone hands rise from the earth, clutching a valley. The pressure here is immense."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_5624f6d69ac6404e9aede7d4dd5f4d47~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"A grand chest reinforced with steel bands sits in the open. The latch is broken, inviting you to look inside."},
    {name:"Void Edge",type:"combat",cost:320,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_9eb9e98ea6084dccbe4e57fdcc525324~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3e59b7d985d84b9688c33ea51322875c~mv2.jpg",flavor:"The world seems to end here, dropping off into nothingness. Stars shine brightly below you in the abyss."},
    {name:"Portal",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_062be0c2c7a3459b87645b4f86c8bfd0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_aa482a0a26e94d6a9754eee718278aa1~mv2.jpg",flavor:"A swirling vortex of purple energy stands before you. It promises travel to distant lands in the blink of an eye."},
    {name:"Smuggler Cove",type:"shop",cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_70c52b2f88864f7ca3f568cf44a3ad70~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_401a126718a64763924ed8ad5314899d~mv2.jpg",flavor:"A hidden cave by the sea hides illicit goods. Pirates and thieves trade secrets in hushed tones."},
    {name:"Royal Palace",type:"combat",cost:350,tn:6,req:3,color:"#fbbf24",img:"https://static.wixstatic.com/media/b16479_6434230067414f34a341a95383fe7896~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8d01f5e2e59a4244a4101efb92c77487~mv2.jpg",flavor:"The seat of power in the realm, draped in gold and velvet. Nobles scheme in the corridors while the King sits upon his throne."},
    {name:"Luxury Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_9b58c85963434fb3abe9ecfb4b114c67~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2513d4cb760246f69570e8f7eb040a39~mv2.jpg",flavor:"The Crown demands a tribute for your continued prosperity. Jewelry and fine clothes make you a target for the taxman."},
    {name:"Ancient Vault",type:"combat",cost:400,tn:6,req:3,color:"#000000",img:"https://static.wixstatic.com/media/b16479_b8a71205363745b7ad11f72ca6ca30b2~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e78493512ad4e559cd6392a9341ddad~mv2.jpg",flavor:"Massive steel doors guard the greatest treasure in the realm. Traps and guardians wait for the foolish."}
];

// --- REGION 3: THREE.JS ENGINE ---
function init() {
    scene = new THREE.Scene(); 
    const fogColor = 0xcccccc; 
    scene.background = new THREE.Color(fogColor); 
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000); 
    
    renderer = new THREE.WebGLRenderer({antialias:true}); 
    renderer.setSize(window.innerWidth, window.innerHeight); 
    renderer.shadowMap.enabled = true;
    document.getElementById('game-layer').appendChild(renderer.domElement);
    
    const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffd700, 0.8); dir.position.set(30,40,20); dir.castShadow = true; scene.add(dir);
    
    updateCamera(); // Initial Camera Setup based on size

    window.addEventListener('resize', onWindowResize, false);
    createEnvironment(); createBoard(); createDecks(); setupCreationUI(); setupEquipDragDrop();
    animate();
}

function updateCamera() {
    const width = window.innerWidth;

    // --- DESKTOP VIEW (Original Fixed Position) ---
    if (width > 768) {
        camera.position.set(0, 55, 0.1);
        camera.lookAt(0, 0, 0);
        return;
    }

    // --- MOBILE VIEW (Dynamic Zoom / Starcraft Style) ---
    // We need to fit a board size of ~55 units into the top 82% of the screen
    const boardSize = 55; 
    const fovRad = (45 * Math.PI) / 360; // Convert vertical FOV to radians
    
    // Effective height is only 82% because of the bottom panel
    const height = window.innerHeight * 0.82; 
    const aspect = width / height;

    let dist;
    if (aspect > 1) {
        // Landscape Mobile: Height is the limiting factor
        dist = (boardSize / 2) / Math.tan(fovRad);
    } else {
        // Portrait Mobile: Width is the limiting factor
        dist = ((boardSize / aspect) / 2) / Math.tan(fovRad);
    }

    camera.position.set(0, dist, 0.1); 
    camera.lookAt(0, 0, 0);
}

function animate(){ requestAnimationFrame(animate); TWEEN.update(); renderer.render(scene,camera); }

function onWindowResize() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    camera.aspect = width / height; 
    camera.updateProjectionMatrix();
    renderer.setSize(width, height); 
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
    
    updateCamera(); // Recalculate zoom on resize
}

function createTileTexture(name, cStr, cost) {
    const c = document.createElement('canvas'); c.width = 256; c.height = 256; const ctx = c.getContext('2d');
    ctx.fillStyle = cStr; ctx.fillRect(0, 0, 256, 256);
    ctx.fillStyle = "rgba(0,0,0,0.1)"; for(let i=0; i<50; i++) ctx.fillRect(Math.random()*256, Math.random()*256, 10, 10);
    ctx.fillStyle = "#fff"; ctx.fillRect(10, 10, 236, 40); ctx.strokeRect(10, 10, 236, 40);
    ctx.fillStyle = "#000"; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(name, 128, 30);
    if(cost > 0) { ctx.fillStyle = "#fbbf24"; ctx.fillRect(80, 210, 96, 30); ctx.strokeRect(80, 210, 96, 30); ctx.fillStyle = "#000"; ctx.fillText(cost + " G", 128, 225); }
    return new THREE.CanvasTexture(c);
}
function createGrassTexture() { const c=document.createElement('canvas'); c.width=512; c.height=512; const ctx=c.getContext('2d'); ctx.fillStyle="#14532d"; ctx.fillRect(0,0,512,512); for(let i=0;i<2000;i++){ctx.fillStyle=Math.random()>0.5?"#166534":"#15803d";ctx.fillRect(Math.random()*512,Math.random()*512,3,3);} const t=new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(8,8); return t; }
function createEnvironment() { const g = new THREE.Mesh(new THREE.PlaneGeometry(600, 600), new THREE.MeshStandardMaterial({map:createGrassTexture()})); g.rotation.x = -Math.PI/2; g.position.y = -0.6; g.receiveShadow = true; scene.add(g); for(let i=0; i<400; i++) { const rad = 45 + Math.random() * 250; const ang = Math.random() * Math.PI * 2; const x = Math.cos(ang) * rad; const z = Math.sin(ang) * rad; if(z > 30 && x > -20 && x < 20) continue; const t = new THREE.Group(); const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.8, 2), new THREE.MeshStandardMaterial({color:0x3e2723})); tr.position.y = 1; const lv = new THREE.Mesh(new THREE.ConeGeometry(3, 6, 8), new THREE.MeshStandardMaterial({color:0x15803d})); lv.position.y = 4; t.add(tr); t.add(lv); t.position.set(x, -0.6, z); t.scale.setScalar(0.8 + Math.random()); scene.add(t); } }
function createBoard() {
    const loader = new THREE.TextureLoader(); const boardTex = loader.load('https://static.wixstatic.com/media/b16479_5caac3525f59406d8ff175695ef11cb1~mv2.jpg');
    const board = new THREE.Mesh(new THREE.PlaneGeometry(45, 45), new THREE.MeshStandardMaterial({ map: boardTex }));
    board.rotation.x = -Math.PI / 2; board.position.y = -0.55; board.receiveShadow = true; scene.add(board);
    for(let i=0; i<40; i++) {
        const info = LOCATIONS[i]; let mapTex = (info.img && info.img.length > 0) ? loader.load(info.img) : createTileTexture(info.name, info.color, info.cost);
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(3.8, 0.5, 3.8), new THREE.MeshStandardMaterial({ map: mapTex }));
        const side = Math.floor(i/10); const pos = i%10; let x=0, z=0, rot=0; const off = 20; const spa = 4;
        if(side===0) { x = off - (pos*spa); z = off; rot=0; } else if(side===1) { x = -off; z = off - (pos*spa); rot=-Math.PI/2; } else if(side===2) { x = -off + (pos*spa); z = -off; rot=Math.PI; } else { x = off; z = -off + (pos*spa); rot=Math.PI/2; }
        if(i===0){x=off;z=off;} mesh.position.set(x, 0, z); mesh.rotation.y = rot; mesh.receiveShadow = true; mesh.userData = {id:i, info:info, owner:null, buildingLevel:0}; scene.add(mesh); tiles.push(mesh);
    }
}
function createDecks() {
    const geo = new THREE.BoxGeometry(7.5, 0.15, 10.5); const loader = new THREE.TextureLoader(); const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff});
    function createMaterials(texture) { return [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: texture}), whiteMat, whiteMat, whiteMat]; }
    normalDeck = new THREE.Group(); const nMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, nMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; normalDeck.add(c); } normalDeck.position.set(-10, 0, -2); scene.add(normalDeck);
    skirmishDeck = new THREE.Group(); const sMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, sMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; skirmishDeck.add(c); } skirmishDeck.position.set(10, 0, -2); scene.add(skirmishDeck);
    treasureDeck = new THREE.Group(); const tMats = createMaterials(loader.load('https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg')); for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, tMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; treasureDeck.add(c); } treasureDeck.position.set(0, 0, -2); scene.add(treasureDeck);
}

// --- REGION 4: PLAYER & AI (WAS MISSING) ---
function spawnPlayer(id, n, r, c, actId, pasId, ai, col) {
    const stats = { str: r.stats.str, dex: r.stats.dex, int: r.stats.int, gold: 1000 };
    const passiveDef = ABILITY_LIBRARY[pasId];
    if (passiveDef && passiveDef.effect) passiveDef.effect(stats);
    let archetype = 'str';
    if(c.id === 'wizard' || c.id === 'cleric' || r.stats.int > r.stats.str) archetype = 'int';
    else if(c.id === 'rogue' || r.stats.dex > r.stats.str) archetype = 'dex';
    const g = new THREE.Group();
    const m = new THREE.MeshStandardMaterial({ color: col });
    const cone = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.5, 16), m); cone.position.y = 0.75;
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), m); head.position.y = 1.6;
    g.add(cone); g.add(head);
    g.position.copy(tiles[0].position);
    if (id > 0) { g.position.x += Math.random() - 0.5; g.position.z += Math.random() - 0.5; }
    scene.add(g);
    const portraitUrl = CHAR_PORTRAITS[`${r.id}_${c.id}`] || "";
    players.push({
        id: id, name: n, race: r, class: c, portrait: portraitUrl,
        activeSkillId: actId, passiveSkillId: pasId,
        stats: stats, gold: stats.gold, pos: 0, mesh: g, color: col, isAi: ai,
        archetype: archetype, equipment: { main: null, off: null, head: null, body: null },
        inventory: [], quickSlots: [null, null], isSkipping: false, abilityUsed: false
    });
}

function recalcStats(p) {
    p.stats.str = p.race.stats.str; p.stats.dex = p.race.stats.dex; p.stats.int = p.race.stats.int;
    const pas = ABILITY_LIBRARY[p.passiveSkillId]; if(pas && pas.effect) pas.effect(p.stats);
    ['head', 'body', 'main', 'off'].forEach(slot => { const item = p.equipment[slot]; if(item && item.bonus) { const k = Object.keys(item.bonus)[0]; p.stats[k] += item.bonus[k]; } });
}

function processTax(victim, amount) {
    // 1. Check Immunity (Self)
    if (victim.passiveSkillId === 'court_mage' || victim.activeSkillId === 'court_mage') {
        addLog(`${victim.name} (Court Mage) is Tax Exempt!`, "log-rare");
        return; // Pay nothing
    }

    // 2. Check for Court Mage to siphon gold (Other players)
    // Find a living player who has Court Mage and isn't the victim
    const mage = players.find(p => 
        !p.isDead && 
        p.id !== victim.id && 
        (p.passiveSkillId === 'court_mage' || p.activeSkillId === 'court_mage')
    );

    let taxAmount = amount;

    if (mage) {
        // Divert 10G to the Mage
        const siphon = Math.min(10, taxAmount); // Can't take more than the tax itself
        taxAmount -= siphon;
        mage.gold += siphon;
        addLog(`Court Mage (${mage.name}) took ${siphon}G tax cut.`, "log-epic");
    }

    // 3. Pay the rest to Treasury
    if (taxAmount > 0) {
        pay(victim, taxAmount); // This sends money to Treasury automatically
    }
}

function manageAiInventory(p) {
    for (let i = p.inventory.length - 1; i >= 0; i--) {
        const item = p.inventory[i];
        if (item.type === 'equip') {
            const current = p.equipment[item.slot]; let shouldEquip = false;
            if (!current) shouldEquip = true;
            else {
                const currentVal = (current.bonus[p.archetype] || 0) + (Object.values(current.bonus)[0] || 0);
                const newVal = (item.bonus[p.archetype] || 0) + (Object.values(item.bonus)[0] || 0);
                if (newVal > currentVal) shouldEquip = true;
            }
            if (shouldEquip) { addLog(`${p.name} equips ${item.name}.`, "log-rare"); equipItem(p.id, i); }
        }
    }
}

function attemptAiAbilities(p, phase) {
    if (phase === 'pre-roll') {
        if (p.isSkipping) { if (p.activeSkillId === 'heal_light' && !p.classSkillDepleted) useSkillAi(p, 0); checkItemSkills(p, ['heal', 'teleport']); }
        if (!p.classSkillDepleted && Math.random() > 0.6) useSkillAi(p, 0); 
    }
    if (phase === 'combat') { checkItemSkills(p, ['might', 'focus', 'agility', 'fireball', 'smite']); }
}

function checkItemSkills(p, skillKeys) {
    ['head', 'body', 'main', 'off'].forEach(slot => {
        const item = p.equipment[slot];
        if (item && item.ability && !item.isDepleted) {
            const key = Object.keys(ABILITY_LIBRARY).find(k => ABILITY_LIBRARY[k].name === item.ability.name);
            if (skillKeys.includes(key) || Math.random() > 0.7) { item.ability.fn(p); item.isDepleted = true; updateHUD(); }
        }
    });
}

function useSkillAi(p, slotIdx) {
    if(slotIdx === 0 && !p.classSkillDepleted) { const skill = ABILITY_LIBRARY[p.activeSkillId]; if(skill && skill.fn) { skill.fn(p); p.classSkillDepleted = true; updateHUD(); } }
}

// --- REGION 5: LOGIC (Turns, Move, Combat) ---
function rollMove() { 
    if(gameState!=='ROLL') return; 
    
    const p=players[turnIndex]; 
    if(p.isDead) { endTurn(); return; }

    if(turnIndex === 0) {
        turnCount++;
        if(turnCount % 10 === 0) { 
            isNight = !isNight; addLog(isNight ? "Night falls..." : "Sunrise.", isNight ? "log-fail":"log-success");
            const targetColor = isNight ? 0x050510 : 0xcccccc; scene.background = new THREE.Color(targetColor);
        }
    }
    
    p.abilityUsed=false; 
    if(p.isSkipping){ p.isSkipping=false; addLog(p.name+" skips turn.","log-fail"); endStep(); return; } 
    
    // --- MODULAR ROLL LOGIC ---
    let r = null;

    // 1. Check Active Skill for Roll Override
    const active = ABILITY_LIBRARY[p.activeSkillId];
    if (active && active.onRoll) r = active.onRoll(p);

    // 2. Check Passive Skill for Roll Override (if active didn't override)
    if (r === null) {
        const passive = ABILITY_LIBRARY[p.passiveSkillId];
        if (passive && passive.onRoll) r = passive.onRoll(p);
    }

    // 3. Default Roll (2d6)
    if (r === null) {
        r = Math.floor(Math.random() * 11) + 2;
        addLog(`${p.name} rolled ${r}.`);
    }
    // --------------------------

    gameState='MOVING'; 
    animateMove(p,r); 
}

function animateMove(p, s) { 
    if (s <= 0) { resolveLanding(p); return; } 
    p.pos = (p.pos + 1) % 40; 
    
    // --- PASSING START / RECHARGE ---
    if (p.pos === 0) {
        p.gold += 200; addLog("Passed Inn (+200G)", "log-success");
        let recharged = false;
        
        // 1. Standard Class Skill Recharge
        if(p.classSkillDepleted) { p.classSkillDepleted = false; recharged = true; }
        
        // 2. Item Recharge
        ['head', 'body', 'main', 'off'].forEach(slot => { 
            const item = p.equipment[slot]; 
            if (item && item.isDepleted) { item.isDepleted = false; recharged = true; } 
        });

        // 3. MODULAR SKILL RECHARGE HOOKS
        // Ask Active Skill if it needs to reset anything
        const active = ABILITY_LIBRARY[p.activeSkillId];
        if (active && active.onRecharge) {
            if (active.onRecharge(p)) recharged = true;
        }

        // Ask Passive Skill
        const passive = ABILITY_LIBRARY[p.passiveSkillId];
        if (passive && passive.onRecharge) {
            if (passive.onRecharge(p)) recharged = true;
        }

        if(recharged) addLog("All Abilities Recharged!", "log-epic");
        updateHUD();
    } 
    // --------------------------------

    const t = tiles[p.pos].position.clone(); if (p.id > 0) { t.x += Math.random() - 0.5; t.z += Math.random() - 0.5; } 
    new TWEEN.Tween(p.mesh.position).to({x: t.x, z: t.z}, 250).start(); 
    new TWEEN.Tween(p.mesh.position).to({y: 1.5}, 125).yoyo(true).repeat(1).onComplete(() => animateMove(p, s - 1)).start(); 
}

function endStep(){ 
    gameState='END'; updateHUD(); 
    if(players[turnIndex].isAi) { setTimeout(endTurn, 2000); }
}

function endTurn(){
    const prevP = players[turnIndex]; 
    recalcStats(prevP);
    if(prevP.isAi) manageAiInventory(prevP); 
    
    let nextIndex = (turnIndex + 1) % players.length;
    let safetyCount = 0;
    
    while(players[nextIndex].isDead && safetyCount < players.length) {
        nextIndex = (nextIndex + 1) % players.length;
        safetyCount++;
    }
    
    turnIndex = nextIndex;
    // ------------------------------------------------

    gameState='ROLL'; 
    updateHUD();
    
    const curP = players[turnIndex];
    
    // Safety check: If the game is somehow broken and everyone is dead, stop.
    if(curP.isDead) return;

    if(curP.isAi) { 
        attemptAiAbilities(curP, 'pre-roll'); 
        setTimeout(rollMove, 1500); 
    }
}

function resolveLanding(p) {
    // 1. SELF PASSIVE TRIGGER (e.g., Holy Aura)
    const passive = ABILITY_LIBRARY[p.passiveSkillId];
    if (passive && passive.onLanding) passive.onLanding(p);

    // 2. SELF ACTIVE TRIGGER (e.g., Spirit Tithe)
    const active = ABILITY_LIBRARY[p.activeSkillId];
    if (active && active.onLanding) active.onLanding(p);

    // 3. TRAP TRIGGER (New for Skeleton Key)
    // Check if any OTHER player is here and has a trap ability
    players.forEach(other => {
        if (other.id !== p.id && !other.isDead && other.pos === p.pos) {
            const trapPassive = ABILITY_LIBRARY[other.passiveSkillId];
            if (trapPassive && trapPassive.onEnemyLanding) {
                trapPassive.onEnemyLanding(p, other); // Pass victim (p) and owner (other)
            }
        }
    });

    const t = tiles[p.pos]; const i = t.userData.info;
    if(p.isAi) { processAiTurn(p, t, i); return; }
    
    const m = document.getElementById('arrival-modal');
    if(m) {
        const imgEl = document.getElementById('arrival-image');
        if(imgEl) { if(i.cardImg) { imgEl.src = i.cardImg; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; } }
        const flavorEl = document.getElementById('arrival-flavor');
        if(flavorEl) flavorEl.innerText = i.flavor || "You arrive at " + i.name + ".";
        m.classList.add('active');
    }
}

function continueFromArrival() {
    document.getElementById('arrival-modal').classList.remove('active');
    const p = players[turnIndex]; const t = tiles[p.pos]; const i = t.userData.info;
    
    if(i.type === 'start') { if(p.id === 0) showEncounter(p, i, t, 'shop'); else endStep(); return; }
    
    if(i.type === 'park') { 
        if(treasuryGold > 0){ 
            p.gold += treasuryGold; 
            addLog(`Won ${treasuryGold}G!`, "log-success"); 
            treasuryGold = 0; 
            updateHUD(); 
        } else { 
            addLog("Treasury empty."); 
        } 
        endStep(); 
        return; 
    }
    
    // --- UPDATED TAX LOGIC (Court Mage Support) ---
    if(i.type === 'tax') { 
        processTax(p, 50); // Changed from pay(p, 50) to processTax
        endStep(); 
        return; 
    } 
    // ----------------------------------------------
    
    // --- DUNGEON LOGIC (Skeleton Key) ---
    if(i.type === 'goto') { 
        // Check for Immunity
        if (p.passiveSkillId === 'smoke_bomb' || p.activeSkillId === 'smoke_bomb') { 
            addLog("Skeleton Key: Evaded Dungeon!", "log-epic");
            endStep();
        } else {
            p.pos = 10; 
            p.mesh.position.copy(tiles[10].position); 
            addLog("Jailed!", "log-fail"); 
            p.isSkipping = true; 
            endStep(); 
        }
        return; 
    } 
    // ------------------------------------

    if(i.type === 'jail') { endStep(); return; }
    if(i.type === 'chest') { drawCardAnim('treasure', () => showEncounter(p, i, t, "loot")); return; }

    const deckType = isNight ? 'skirmish' : 'normal'; const modeType = isNight ? 'wild_skirmish' : 'wild'; const owner = t.userData.owner;
    if(owner === p.id) { 
        if(t.userData.buildingLevel === 1) { 
            showModal("Upgrade?", `Build Tavern ${i.cost*2}G? (Skirmish)`, [ 
                { txt: "Upgrade", act: () => { 
                    if(p.gold >= i.cost*2) { 
                        p.gold -= i.cost*2; 
                        drawCardAnim('skirmish', () => showEncounter(p, i, t, "skirmish")); 
                    } else { 
                        addLog("No Gold"); 
                        endStep(); 
                    } 
                }}, 
                { txt: "Skip", act: endStep } 
            ]); 
        } else { 
            let guards = t.userData.guardCount || 0; 
            showModal("Manage Tavern", `Current Guards: ${guards}. Hire Bodyguard for 50G?`, [ 
                { txt: "Hire Guard (50G)", act: () => { 
                    if(p.gold >= 50) { 
                        p.gold -= 50; 
                        t.userData.guardCount = (t.userData.guardCount || 0) + 1; 
                        addLog("Guard Hired!", "log-gold"); 
                        updateHUD(); 
                        endStep(); 
                    } else { 
                        addLog("Not enough Gold"); 
                        endStep(); 
                    } 
                }}, 
                { txt: "Rest (Skip)", act: endStep } 
            ]); 
        } 
    } else if(owner !== null) { 
        drawCardAnim('normal', () => showEncounter(p, i, t, "enemy")); 
    } else { 
        drawCardAnim(deckType, () => showEncounter(p, i, t, modeType)); 
    }
}

function processAiTurn(p, t, i) {
    // 1. Handle Tax (Using new Court Mage logic)
    if(i.type==='tax') { 
        processTax(p, 50); 
        endStep(); 
        return; 
    } 

    // 2. Handle Park (Capital City)
    if(i.type==='park'){ 
        if(treasuryGold>0){
            p.gold+=treasuryGold; 
            addLog(`${p.name} wins the Treasury!`, "log-gold"); 
            treasuryGold=0;
        } 
        endStep(); 
        return; 
    } 

    // 3. Handle Dungeon
    if(i.type==='goto'){ 
        // Check for Skeleton Key Immunity (AI)
        if (p.passiveSkillId === 'smoke_bomb' || p.activeSkillId === 'smoke_bomb') {
            addLog(`${p.name} uses Skeleton Key to evade Dungeon!`, "log-epic");
        } else {
            p.pos=10; 
            p.mesh.position.copy(tiles[10].position); 
            addLog(`${p.name} jailed.`, "log-fail"); 
            p.isSkipping = true; 
        }
        endStep(); 
        return; 
    } 

    // 4. Handle Chests (FIXED: Instant Loot + Alchemist Check)
    if(i.type==='chest'){ 
        // Draw 1
        const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
        p.inventory.push({...card});
        addLog(`${p.name} found ${card.name}.`, "log-success");
        
        // Alchemist Logic (AI)
        if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') {
            const extra = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
            p.inventory.push({...extra});
            addLog(`${p.name} (Alchemist) found bonus: ${extra.name}!`, "log-epic");
        }
        
        endStep(); 
        return; 
    }

    // 5. Handle Unowned Property (Purchase)
    if(i.cost > 0 && t.userData.owner === null) { 
        const safetyRatio = (p.class.id === 'rogue' || p.race.id === 'dragonborn') ? 1.2 : 2.0; 
        if (p.gold >= i.cost * safetyRatio) { 
            // AI buys/captures instant
            capture(t, p, 1, () => {
                // Callback for bonus loot check (AI)
                checkForBonusLoot(p);
                endStep();
            }); 
            return; // Capture function handles the rest
        } else { 
            addLog(`${p.name} passes on ${i.name}.`); 
        } 
        endStep(); 
        return; 
    } 

    // 6. Handle Enemy Property (Siege or Pay)
    if(t.userData.owner !== null && t.userData.owner !== p.id) {
        const enemyDefStat = t.userData.defendingStat || 'str'; 
        const tn = i.tn || 3; 
        const aiDicePool = p.stats[enemyDefStat] || 1; 
        const chancePerDie = (7 - tn) / 6; 
        const expectedWins = aiDicePool * chancePerDie; 
        const requiredWins = (i.req || 1) + (t.userData.guardCount || 0);
        
        let willSiege = false; 
        const failCost = (i.cost * 2) + ((t.userData.guardCount || 0) * 10);
        
        if (expectedWins >= requiredWins) willSiege = true; 
        if (p.gold < i.cost) willSiege = true; 
        if (failCost > p.gold && expectedWins < requiredWins + 0.5) willSiege = false;

        if (willSiege) { 
            attemptAiAbilities(p, 'combat'); 
            addLog(`${p.name} attacks ${players[t.userData.owner].name}'s tile!`, "log-accent"); 
            setTimeout(() => { 
                rollCombat(p, enemyDefStat, tn, requiredWins, t, 'capture', false, 0, failCost, true); 
            }, 500); 
            return; 
        } else { 
            pay(p, i.cost, players[t.userData.owner]); 
            endStep(); 
            return; 
        }
    }

    // 7. Handle Own Property (Upgrade)
    if (t.userData.owner === p.id) { 
        if (t.userData.buildingLevel === 1 && p.gold > i.cost * 3) { 
            addLog(`${p.name} attempts to upgrade...`); 
            
            // AI draws a skirmish card to upgrade
            const card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)]; 
            const bestChoice = card.choices[0].tn < card.choices[1].tn ? card.choices[0] : card.choices[1]; 
            
            rollCombat(p, bestChoice.stat, bestChoice.tn, bestChoice.req, t, 'upgrade', false, 0, 50, false); 
            return; 
        } else if (t.userData.buildingLevel > 1 && p.gold > 200 && (t.userData.guardCount || 0) < 2) { 
            p.gold -= 50; 
            t.userData.guardCount = (t.userData.guardCount || 0) + 1; 
            addLog(`${p.name} hired a guard.`, "log-gold"); 
            updateHUD(); 
        } 
    }
    
    endStep();
}

function showEncounter(p, i, t, mode) {
    // 1. Capture the Original Intent (e.g., 'skirmish' for Upgrade)
    const originalMode = mode;

    const m = document.getElementById('card-modal'); 
    const l = document.getElementById('choice-list'); 
    l.innerHTML = ''; 
    document.getElementById('dice-result').innerHTML = ''; 
    document.getElementById('market-sell-area').style.display = 'none';
    
    // 2. Draw Card based on Mode
    let card;
    if (mode === 'loot') card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
    else if (mode === 'skirmish' || mode === 'wild_skirmish') card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)]; 
    else card = DECK_ENCOUNTER[Math.floor(Math.random() * DECK_ENCOUNTER.length)];
    
    // 3. Handle Card Types Overriding Mode
    if (card.type === 'shop') mode = 'shop'; 
    if (card.type === 'loot') { 
        mode = 'loot'; 
        if(!card.cost) card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; 
    }
    
    // 4. Set Visual Header
    let title = card.name; 
    let cls = 'card-header'; 
    if (mode.includes('skirmish')) { cls += ' skirmish'; title += " (SKIRMISH)"; } 
    else if (mode === 'loot') { cls += ' loot'; } 
    else if (mode === 'shop') { cls += ' market'; }
    
    setT('enc-title', title); 
    document.getElementById('enc-header').className = cls;
    
    let desc = card.desc || "Event occurs."; 
    let opts = [];

    // --- LOGIC BLOCKS ---

    // A. LOOT
    if (mode === 'loot') { 
        desc = `You found: ${card.name} (${card.rarity || 'Common'})`; 
        opts = [{ txt: "Keep", act: () => { 
            p.inventory.push({...card}); 
            addLog("Gained " + card.name, "log-success"); 
            
            // Alchemist Logic
            if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') {
                addLog("Alchemist: Transmuting extra loot...", "log-epic");
                updateHUD(); 
                setTimeout(() => {
                    drawCardAnim('treasure', () => showEncounter(p, null, null, 'loot'));
                }, 500);
                return; 
            }

            updateHUD(); 
            closeEnc(); 
        }}]; 
    } 
    // B. SHOP (MERCHANT) - WITH FIX
    else if (mode === 'shop' || i.type === 'start') { 
        desc = card.desc || "The merchant displays their wares."; 
        document.getElementById('market-sell-area').style.display = 'flex'; 
        
        // Generate Shop Items
        let pool = DECK_TREASURE.filter(item => item.name !== "Pouch of Gold"); 
        if(card.rare) pool = pool.filter(x => x.rarity === 'legendary'); 
        let items = []; 
        if(pool.length > 0) { for(let k=0; k<3; k++) items.push(pool[Math.floor(Math.random() * pool.length)]); } 
        
        items.forEach(it => opts.push({ txt: `Buy ${it.name} (${it.cost}G)`, act: (btn) => { 
            if (p.gold >= it.cost) { 
                if(p.inventory.length >= 12) { addLog("Inventory Full", "log-fail"); return; } 
                p.gold -= it.cost; 
                p.inventory.push({...it}); 
                addLog(`Bought ${it.name}`, "log-success"); 
                updateHUD(); 
                if(btn) btn.remove(); 
            } else { addLog("No Gold", "log-fail"); } 
        } })); 
        
        // --- FIX START: Retry Logic on Leave ---
        opts.push({ txt: "Leave", act: () => { 
            // If we were trying to capture/upgrade (Combat Modes) and got a Shop:
            const isCombatMode = (originalMode === 'wild' || originalMode === 'wild_skirmish' || originalMode === 'skirmish');
            
            if (isCombatMode) {
                // Don't end turn. Draw another card to resolve the combat.
                addLog("Merchant departs. The challenge approaches...", "log-rare");
                let deckName = originalMode.includes('skirmish') ? 'skirmish' : 'normal';
                drawCardAnim(deckName, () => showEncounter(p, i, t, originalMode));
            } else {
                // Just visiting shop (or Start tile), so end turn normally.
                closeEnc(); 
            }
        }}); 
        // --- FIX END ---
    } 
    // C. COMBAT / EVENTS
    else if (mode === 'wild' || mode === 'wild_skirmish' || mode === 'skirmish') { 
        if (card.choices) { 
            card.choices.forEach(c => { 
                let btnTxt = c.txt; 
                if(c.fail) btnTxt += ` | Fail: -${c.fail}G`; 
                opts.push({ txt: btnTxt, stat: c.stat, tn: c.tn, req: c.req || 1, mode: c.mode, val: c.val || 0, failCost: c.fail || 50 }); 
            }); 
            opts.push({ txt: "Leave / Flee", act: closeEnc }); 
        } 
        else if (card.type === 'pay') { 
            opts = [{ txt: `Pay ${card.cost}G`, act: () => { 
                processTax(p, card.cost); // Uses Court Mage logic
                closeEnc(); 
            }}]; 
        } 
    } 
    // D. ENEMY LAND
    else if (mode === 'enemy') { 
        let guards = t.userData.guardCount || 0; 
        let defStat = t.userData.defendingStat || 'str'; 
        let tn = i.tn || 3; 
        let req = i.req || 1; 
        let failCost = (i.cost * 2) + (guards * 10); 
        desc = `Owned by ${players[t.userData.owner].name}. Defending Stat: ${defStat.toUpperCase()}. Guards: ${guards}.`; 
        opts = [ 
            { txt: `Pay Rent ${i.cost}G`, act: () => { pay(p, i.cost, players[t.userData.owner]); closeEnc(); } }, 
            { txt: `Siege (${defStat.toUpperCase()} ${tn}+) | Risk: -${failCost}G`, stat: defStat, tn: tn, req: req, mode: 'capture', penalty: false, failCost: failCost, isSiege: true } 
        ]; 
    } else { 
        opts = [{ txt: "Continue", act: closeEnc }]; 
    }
    
    // E. SILVER TONGUE BUTTON
    const silverTongueItem = ['head','body','main','off'].map(s => p.equipment[s]).find(i => i && i.ability && i.ability.name === "Silver Tongue" && !i.isDepleted);
    if (silverTongueItem && (mode === 'wild' || mode === 'wild_skirmish' || mode === 'enemy')) { 
        opts.unshift({ txt: `★ Use Silver Tongue (INT 6+)`, act: () => { 
            silverTongueItem.isDepleted = true; 
            updateHUD(); 
            addLog("Used Silver Tongue!", "log-epic"); 
            rollCombat(p, 'int', 6, 1, t, 'capture', false, 0, 50, false); 
        } }); 
    }
    
    // RENDER CHOICES
    const descEl = document.getElementById('enc-desc'); if(descEl) descEl.innerText = desc;
    opts.forEach(o => { 
        let b = document.createElement('div'); 
        b.className = 'choice-btn'; 
        b.innerText = o.txt; 
        b.onclick = () => { 
            if (o.act) o.act(b); 
            else rollCombat(p, o.stat, o.tn, o.req, t, o.mode, o.penalty, o.val, o.failCost, o.isSiege); 
        }; 
        l.appendChild(b); 
    }); 
    m.classList.add('active');
}
function closeEnc(){document.getElementById('card-modal').classList.remove('active');endStep();}
function closeFlavor() { document.getElementById('flavor-modal').classList.remove('active'); continueFromArrival(); }
function drawCardAnim(type, cb) {
    let deck, texUrl; if(type === 'treasure') { deck = treasureDeck; texUrl = 'https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg'; } else if(type === 'skirmish') { deck = skirmishDeck; texUrl = 'https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg'; } else { deck = normalDeck; texUrl = 'https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg'; }
    const loader = new THREE.TextureLoader(); const tex = loader.load(texUrl); const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff}); const mats = [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: tex}), whiteMat, whiteMat, whiteMat];
    const c = new THREE.Mesh(new THREE.BoxGeometry(7.5, 0.15, 10.5), mats); c.position.copy(deck.position); c.position.y += 2; scene.add(c);
    new TWEEN.Tween(c.position).to({x: camera.position.x * 0.8, y: camera.position.y - 20, z: camera.position.z * 0.8}, 600).start();
    new TWEEN.Tween(c.rotation).to({x: Math.PI / 2, y: Math.PI, z: 0}, 600).onComplete(() => { scene.remove(c); if(cb) cb(); }).start();
    setTimeout(()=>{ if(document.getElementById('card-modal').style.transform.indexOf('scale(1)')===-1 && cb) cb(); }, 800);
}

function rollCombat(p, stat, tn, req, t, mode, penalty, rewardVal, failCost, isSiege) {
    const d = document.getElementById('dice-result'); d.innerHTML = ''; 
    let wins = 0; 
    let pool = p.stats[stat] || 1; 
    if (penalty) pool = Math.floor(pool / 2); if (pool < 1) pool = 1;
    
    // Roll Dice Visuals
    for(let i=0; i<pool; i++){ 
        let r = null;
        // Check hooks for roll manipulation (e.g. Smite debuff)
        const active = ABILITY_LIBRARY[p.activeSkillId];
        if (active && active.onRoll) r = active.onRoll(p);
        if (r === null) r = Math.floor(Math.random()*6)+1;

        let b = document.createElement('div'); 
        b.className = 'mini-die ' + (r >= tn ? 'win' : 'lose'); 
        b.innerText = r; 
        d.appendChild(b); 
        
        if(r >= tn) { 
            wins++; 
            if (r === 6 && p.passiveSkillId === 'executioner') { 
                wins++; b.style.boxShadow = "0 0 10px #ef4444"; b.style.borderColor = "#ef4444"; 
            } 
        } 
    }

    setTimeout(() => {
        let autoClose = true;
        if(wins >= req) { 
            addLog(`Success! (${wins} wins)`, "log-success"); 
            
            // Trigger Passives (Bounty Hunter etc)
            if (mode === 'capture' || mode === 'upgrade' || isSiege) { 
                const passive = ABILITY_LIBRARY[p.passiveSkillId]; 
                if (passive && passive.onCombatVictory) passive.onCombatVictory(p); 
            }

            // Define what happens AFTER capture/upgrade
            const lootCallback = () => checkForBonusLoot(p);

            if(isSiege) { 
                let guards = t.userData.guardCount || 0; 
                if (guards > 0) { 
                    t.userData.guardCount--; 
                    addLog(`Guard Defeated! (${t.userData.guardCount} remaining)`, "log-success"); 
                } else { 
                    // SIEGE SUCCESS: Capture -> Then Loot
                    capture(t, p, 1, lootCallback); 
                    if(p.id === 0) autoClose = false; // Don't close, wait for Defense Picker
                } 
            } 
            else if(mode === 'capture') { 
                // STANDARD CAPTURE: Capture -> Then Loot
                capture(t, p, 1, lootCallback); 
                if(rewardVal > 0) { p.gold += rewardVal; addLog(`Bonus: +${rewardVal}G`, "log-gold"); } 
                if(p.id === 0) autoClose = false; 
            }
            else if(mode === 'upgrade') { 
                // UPGRADE: Upgrade -> Then Loot
                capture(t, p, 2, lootCallback); 
                if(p.id === 0) autoClose = false; 
            }
        } else { 
            addLog("Failure!", "log-fail"); 
            if(isSiege) { pay(p, failCost, players[t.userData.owner]); } else { pay(p, failCost); } 
        }
        
        updateHUD(); 
        if(autoClose) setTimeout(closeEnc, 1000);
    }, 600);
}
function checkForBonusLoot(p) { 
    const roll = Math.floor(Math.random() * 6) + 1; 
    
    if (roll === 6) { 
        addLog(`Bonus Loot Roll: ${roll} (TREASURE!)`, "log-gold"); 
        
        // --- AI LOGIC: Instant Get ---
        if (p.isAi) {
            const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
            p.inventory.push({...card});
            addLog(`${p.name} found ${card.name}`, "log-success");
            // Check Alchemist for AI
            if (card.name === "Pouch of Gold" && p.passiveSkillId === 'alchemist_pas') {
                const extra = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
                p.inventory.push({...extra});
                addLog(`Alchemist Bonus: Found ${extra.name}!`, "log-epic");
            }
            return; // AI doesn't need to close windows or end turns here usually
        }
        // -----------------------------

        // Human Logic: Animation
        setTimeout(() => { 
            drawCardAnim('treasure', () => showEncounter(p, null, null, 'loot')); 
        }, 500); 
    } else { 
        addLog(`Bonus Loot Roll: ${roll} (No Item)`, "log-fail"); 
        
        // End the turn if it's the human player
        if (p.id === 0) endStep(); 
    } 
}
function capture(t, p, lvl, callback) {
    t.userData.owner = p.id; 
    t.userData.buildingLevel = lvl; 
    t.userData.guardCount = 0; 
    if (t.userData.prop) t.remove(t.userData.prop);
    
    // Visuals
    const g = new THREE.Group();
    if (lvl === 1) { 
        const m = new THREE.Mesh(new THREE.ConeGeometry(1, 1.5, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); 
        m.position.set(0, 0.5, 0); g.add(m); 
    } else { 
        const b = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0x5c4033 })); b.position.set(0, 0.5, 0); 
        const r = new THREE.Mesh(new THREE.ConeGeometry(1.5, 1, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); r.position.set(0, 1.5, 0); r.rotation.y = Math.PI / 4; 
        g.add(b); g.add(r); 
    }
    t.add(g); t.userData.prop = g;
    
    addLog(lvl === 1 ? "Captured!" : "Upgraded!", "log-success");

    // --- NEW FLOW LOGIC ---
    if (p.id === 0) {
        if (lvl === 1) {
            // If Human capturing new land -> Pick Defense -> Then Callback
            setTimeout(() => chooseDefense(t, callback), 500);
        } else {
            // If Human upgrading -> Skip Defense pick -> Run Callback directly
            if (callback) setTimeout(callback, 500);
        }
    } else {
        // AI Logic
        const s = p.stats; 
        if (s.str >= s.dex && s.str >= s.int) t.userData.defendingStat = 'str'; 
        else if (s.dex >= s.str && s.dex >= s.int) t.userData.defendingStat = 'dex'; 
        else t.userData.defendingStat = 'int';
        
        // AI runs callback immediately
        if (callback) callback();
    }
}
function chooseDefense(t, callback) { 
    const next = () => { if (callback) callback(); else endStep(); };
    
    showModal("Tactics", "Choose a stat to defend this location.", [ 
        { txt: "Strength (STR)", act: () => { t.userData.defendingStat = 'str'; addLog("Defense set to STR", "log-success"); next(); } }, 
        { txt: "Dexterity (DEX)", act: () => { t.userData.defendingStat = 'dex'; addLog("Defense set to DEX", "log-success"); next(); } }, 
        { txt: "Intelligence (INT)", act: () => { t.userData.defendingStat = 'int'; addLog("Defense set to INT", "log-success"); next(); } } 
    ]); 
}
function pay(p, amount, recipient) {
    let finalAmount = amount; if (p.passiveSkillId === 'iron_skin' && finalAmount > 0) { const oldAmt = finalAmount; finalAmount = Math.max(0, finalAmount - 20); addLog(`Iron Skin reduced loss by ${oldAmt - finalAmount}G`, "log-rare"); }
    p.gold -= finalAmount;
    if (p.gold < 0) { handleDebt(p, Math.abs(p.gold), recipient); } else { if (recipient) recipient.gold += finalAmount; else treasuryGold += finalAmount; if(finalAmount > 0) addLog(`Paid ${finalAmount}G`, "log-fail"); updateHUD(); }
}
function handleDebt(p, debt, recipient) {
    const ownedTiles = tiles.filter(t => t.userData.owner === p.id);
    if (p.isAi) {
        while (p.gold < 0 && ownedTiles.length > 0) { const t = ownedTiles.splice(Math.floor(Math.random() * ownedTiles.length), 1)[0]; const val = Math.floor(t.userData.info.cost / 2); sellPropertyLogic(t, p, val); }
        if (p.gold < 0) { eliminatePlayer(p); } else { addLog(`${p.name} sold properties to pay debt.`, "log-fail"); if (recipient && debt > 0) recipient.gold += Math.min(debt, debt + p.gold); updateHUD(); }
    } else { if (ownedTiles.length === 0) { eliminatePlayer(p); } else { showBankruptcyModal(p, debt, recipient, ownedTiles); } }
}
function sellPropertyLogic(t, p, val) { p.gold += val; t.userData.owner = null; t.userData.buildingLevel = 0; t.userData.guardCount = 0; t.userData.defendingStat = null; if (t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; } }
function showBankruptcyModal(p, debt, recipient, ownedTiles) {
    const m = document.getElementById('bankruptcy-modal'); const list = document.getElementById('debt-prop-list'); const debtLabel = document.getElementById('debt-amount'); const btn = document.getElementById('btn-debt-done'); m.style.display = 'flex';
    const refreshList = () => {
        debtLabel.innerText = Math.abs(p.gold); list.innerHTML = ''; const currentOwned = tiles.filter(t => t.userData.owner === p.id);
        if (p.gold >= 0) { btn.disabled = false; btn.innerText = "Debt Cleared - Continue"; btn.onclick = () => { m.style.display = 'none'; if(recipient) recipient.gold += debt; else treasuryGold += debt; updateHUD(); }; } else if (currentOwned.length === 0) { btn.disabled = false; btn.innerText = "Accept Fate (Game Over)"; btn.onclick = () => { m.style.display = 'none'; eliminatePlayer(p); }; } else { btn.disabled = true; btn.innerText = `Sell more! (${Math.abs(p.gold)}G needed)`; }
        currentOwned.forEach(t => { const val = Math.floor(t.userData.info.cost / 2); const row = document.createElement('div'); row.className = 'choice-btn'; row.innerHTML = `<span>${t.userData.info.name}</span> <span style="color:var(--gold)">+${val}G</span>`; row.onclick = () => { sellPropertyLogic(t, p, val); refreshList(); updateHUD(); }; list.appendChild(row); });
    }; refreshList();
}
function eliminatePlayer(p) { p.isDead = true; p.gold = 0; scene.remove(p.mesh); tiles.forEach(t => { if(t.userData.owner === p.id) { t.userData.owner = null; t.userData.buildingLevel = 0; if(t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; } } }); addLog(`${p.name} has been ELIMINATED!`, "log-fail"); updateHUD(); if (!p.isAi) { showGameOver(false); } else { checkWinCondition(); } }
function checkWinCondition() { const livingAi = players.filter(pl => pl.isAi && !pl.isDead); const human = players[0]; if (livingAi.length === 0 && !human.isDead) { showGameOver(true); } }
function showGameOver(victory) { const m = document.getElementById('game-over-modal'); const t = document.getElementById('go-title'); const msg = document.getElementById('go-msg'); m.style.display = 'flex'; if(victory) { t.innerText = "VICTORY!"; t.style.color = "var(--gold)"; msg.innerText = "You have defeated all rivals and conquered the realm!"; } else { t.innerText = "DEFEAT"; t.style.color = "var(--accent)"; msg.innerText = "You have lost everything. Your legend ends here."; } }
function resetGame() {
    // Hide Modals
    document.getElementById('game-over-modal').style.display = 'none';
    document.getElementById('bankruptcy-modal').style.display = 'none';

    // Remove Player Meshes
    players.forEach(p => scene.remove(p.mesh));
    players = [];

    // Reset Board Tiles
    tiles.forEach(t => {
        t.userData.owner = null;
        t.userData.buildingLevel = 0;
        t.userData.guardCount = 0;
        t.userData.defendingStat = null; // Clear defense stat
        if (t.userData.prop) {
            t.remove(t.userData.prop);
            t.userData.prop = null;
        }
    });

    // Reset Global Variables
    turnIndex = 0;
    turnCount = 0;
    isNight = false;
    treasuryGold = 0;
    gameState = 'SETUP';

    // Reset Environment
    const fogColor = 0xcccccc;
    scene.background = new THREE.Color(fogColor);

    // --- FIX: Clear Game Log ---
    const log = document.getElementById('game-log');
    if (log) log.innerHTML = '';
    // ---------------------------

    // Show Character Creation
    document.getElementById('create-screen').style.display = 'flex';
}

// --- REGION 6: UI UPDATES & INTERACTION ---
// SAFE UPDATE FUNCTION (CRASH FIX)

// Add this to your script section
function switchHelpTab(tabId) {
    // Hide all sections
    document.querySelectorAll('.help-section').forEach(s => s.classList.remove('active'));
    // Show target section
    document.getElementById(tabId).classList.add('active');
    
    // Update Button States
    document.querySelectorAll('.help-tab').forEach(b => {
        b.classList.remove('active');
        if(b.getAttribute('onclick').includes(tabId)) {
            b.classList.add('active');
        }
    });
}

function addLog(m, c) {
    const l = document.getElementById('game-log');
    if (!l) return;
    let d = document.createElement('div');
    d.className = 'log-entry ' + (c || '');
    d.innerText = '> ' + m;
    l.insertBefore(d, l.firstChild);
}
function updateHUD() {
    if(players.length===0) return;
    const p = players[0];
    setT('p1-name', p.name); setT('p1-gold', p.gold); setT('p1-str', p.stats.str); setT('p1-dex', p.stats.dex); setT('p1-int', p.stats.int); setT('treasury-val', treasuryGold);
    const elPortrait = document.getElementById('p1-portrait'); if(elPortrait) elPortrait.style.backgroundImage = `url('${p.portrait}')`;
    
    // SAFE Day/Night Update
    setT('day-night-indicator', isNight ? "☾ NIGHT" : "☀ DAY");
    const elDayNight = document.getElementById('day-night-indicator'); if(elDayNight) { elDayNight.style.color = isNight ? "#a855f7" : "#87ceeb"; }
    
    const cur = players[turnIndex]; setT('turn-banner', cur.id === 0 ? "YOUR TURN" : `${cur.name}'S TURN`);
    const btnRoll = document.getElementById('btn-roll'); const btnEnd = document.getElementById('btn-end'); if(btnRoll && btnEnd){ btnRoll.disabled = (gameState !== 'ROLL' || cur.id !== 0); btnEnd.disabled = (gameState !== 'END' || cur.id !== 0); }
    
    const invDiv = document.getElementById('p1-inv'); if(invDiv){ invDiv.innerHTML = ''; for(let i=0; i<12; i++){ let d = document.createElement('div'); d.className = 'inv-slot'; d.dataset.idx = i; d.draggable = true; d.ondragstart = (e) => { if(document.getElementById('context-menu').style.display === 'flex') { e.preventDefault(); return; } dragStart(e, i); }; d.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, i, 'inv'); }; d.onclick = () => { if(document.getElementById('context-menu').style.display !== 'flex') equipItem(0, i); }; if(p.inventory[i]){ d.innerText = p.inventory[i].name; d.classList.add('rarity-' + p.inventory[i].rarity); d.onmouseenter = () => showTooltip(p.inventory[i]); d.onmouseleave = hideTooltip; } invDiv.appendChild(d); } }
    
    const lb = document.getElementById('leader-list'); if(lb){ lb.innerHTML = ''; players.forEach(pl => { let d = document.createElement('div'); d.className = 'leader-row' + (pl.isDead ? ' dead' : ''); let nameSpan = document.createElement('span'); nameSpan.className = "leader-name"; nameSpan.style.color = pl.color; nameSpan.innerText = pl.name; if(!pl.isDead) { nameSpan.addEventListener('click', function() { openCharDetail(pl.id); }); } let goldSpan = document.createElement('span'); goldSpan.innerText = pl.isDead ? "DEAD" : `${pl.gold}G`; d.appendChild(nameSpan); d.appendChild(goldSpan); lb.appendChild(d); }); }
    
    const s0 = document.getElementById('skill-0'); const txt0 = document.getElementById('txt-skill-0'); const actSkill = ABILITY_LIBRARY[p.activeSkillId]; if(actSkill && s0 && txt0) { if(p.classSkillDepleted) { s0.className="skill-slot"; s0.style.opacity="0.5"; txt0.innerText="Recharge"; } else { s0.className="skill-slot filled"; s0.style.opacity="1"; txt0.innerText=actSkill.name; } s0.onmouseenter = () => showTooltip(p.activeSkillId, true); s0.onmouseleave = hideTooltip; }
    EQUIP_ORDER.forEach((slotName, i) => { const idx = i + 1; const el = document.getElementById(`skill-${idx}`); const txt = document.getElementById(`txt-skill-${idx}`); const item = p.equipment[slotName]; const dollEl = document.getElementById('slot-'+slotName); if(dollEl) { dollEl.innerHTML = item ? item.name : slotName.toUpperCase(); dollEl.className = 'equip-slot' + (item ? ' filled' : ''); dollEl.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, slotName, 'equip'); }; if(item) { dollEl.onmouseenter = () => showTooltip(item); dollEl.onmouseleave = hideTooltip; } else { dollEl.onmouseenter = null; dollEl.onmouseleave = null; } } if(el && txt) { if (item && item.ability && item.ability.type === 'active') { if(item.isDepleted) { el.className = "skill-slot"; el.style.opacity="0.5"; txt.innerText = "Recharge"; } else { el.className = "skill-slot filled"; el.style.opacity="1"; txt.innerText = item.ability.name; } el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { el.className = "skill-slot"; el.style.opacity="1"; txt.innerText = item ? "(Passive)" : "Empty"; if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { el.onmouseenter = null; el.onmouseleave = null; } } } });
    p.quickSlots.forEach((item, i) => { const idx = i + 5; const el = document.getElementById(`skill-${idx}`); const txt = document.getElementById(`txt-skill-${idx}`); if(el && txt) { if (item && p.inventory.includes(item)) { el.className = "skill-slot consumable"; txt.innerText = item.name; el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { p.quickSlots[i] = null; el.className = "skill-slot"; txt.innerText = "Drag Item"; el.onmouseenter = null; el.onmouseleave = null; } } });
}

function setT(id,t){ let e=document.getElementById(id); if(e) e.innerText=t; }
function handleContextOpen(e, identifier, source='inv') {
    const p = players[0]; let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier]; if (!item) return; 
    const menu = document.getElementById('context-menu'); menu.style.pointerEvents = 'auto'; menu.innerHTML = ''; 
    const sellArea = document.getElementById('market-sell-area'); const canSell = document.getElementById('card-modal').classList.contains('active') && sellArea && sellArea.style.display !== 'none'; const sellPrice = Math.floor((item.cost || 0) / 2);
    const createItem = (text, onClick, disabled=false) => { const div = document.createElement('div'); div.className = 'ctx-item' + (disabled ? ' disabled' : ''); div.innerText = text; if(!disabled) { div.onclick = (ev) => { ev.stopPropagation(); onClick(); closeCtx(); }; } menu.appendChild(div); };
    if (source === 'equip') createItem('Unequip Item', () => unequipItem(identifier)); else createItem(item.type === 'scroll' ? 'Use Scroll' : 'Equip Item', () => equipItem(0, identifier));
    createItem(`Sell (${sellPrice}G)`, () => sellItem(identifier, source), !canSell); createItem('Cancel', () => {});
    let x = e.touches ? e.touches[0].clientX : e.clientX; let y = e.touches ? e.touches[0].clientY : e.clientY; if (x + 150 > window.innerWidth) x = window.innerWidth - 160; if (y + 150 > window.innerHeight) y = window.innerHeight - 160; menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex';
}
function closeCtx() { document.getElementById('context-menu').style.display = 'none'; }
function togglePanel(id) { const panel = document.getElementById(id); if(!panel) return; panel.classList.toggle('minimized'); const btn = panel.querySelector('.minimize-btn'); if(btn) btn.innerText = panel.classList.contains('minimized') ? "+" : "-"; }
function toggleCreatorPortrait() { const el = document.getElementById('creator-portrait-frame'); const btn = document.getElementById('btn-min-portrait'); if(!el || !btn) return; el.classList.toggle('minimized'); btn.innerText = el.classList.contains('minimized') ? "+" : "-"; }
function showModal(t,d,o){ const m=document.getElementById('card-modal'); setT('enc-title',t); setT('card-desc',d); const l=document.getElementById('choice-list'); l.innerHTML=''; document.getElementById('dice-result').innerHTML=''; o.forEach(x=>{ let b=document.createElement('div'); b.className='choice-btn'; b.innerText=x.txt; b.onclick=()=>{m.classList.remove('active');x.act();}; l.appendChild(b); }); m.classList.add('active'); }
function openCharDetail(id) { const p = players[id]; if(!p) return; setT('cd-header', p.name); setT('cd-sub', p.race.name + " " + p.class.name); setT('cd-str', p.stats.str); setT('cd-dex', p.stats.dex); setT('cd-int', p.stats.int); const portraitEl = document.getElementById('cd-portrait'); if(portraitEl) portraitEl.style.backgroundImage = `url('${p.portrait}')`; const act = ABILITY_LIBRARY[p.activeSkillId]; const pas = ABILITY_LIBRARY[p.passiveSkillId]; setT('cd-active', act ? act.name : '-'); setT('cd-active-desc', act ? act.desc : ''); setT('cd-passive', pas ? pas.name : '-'); setT('cd-passive-desc', pas ? pas.desc : ''); const invSection = document.getElementById('cd-inventory-section'); const hiddenMsg = document.getElementById('cd-hidden-msg'); if (id === 0) { if(invSection) invSection.style.display = 'block'; if(hiddenMsg) hiddenMsg.style.display = 'none'; ['head','body','main','off'].forEach(slot => { const item = p.equipment[slot]; const el = document.getElementById('cd-slot-'+slot); if(el) { el.innerHTML = item ? item.name : slot.toUpperCase(); el.className = 'equip-slot' + (item ? ' filled' : ''); if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } else { el.onmouseenter = null; } } }); const grid = document.getElementById('cd-inv-grid'); if(grid) { grid.innerHTML = ''; p.inventory.forEach(item => { let d = document.createElement('div'); d.className = 'inv-slot'; d.innerText = item.name; d.classList.add('rarity-' + item.rarity); d.onmouseenter = () => showTooltip(item); d.onmouseleave = hideTooltip; grid.appendChild(d); }); for(let i=p.inventory.length; i<12; i++) { let d = document.createElement('div'); d.className = 'inv-slot'; grid.appendChild(d); } } } else { if(invSection) invSection.style.display = 'none'; if(hiddenMsg) hiddenMsg.style.display = 'block'; } const modal = document.getElementById('char-detail-modal'); if(modal) modal.classList.add('active'); }
function closeCharDetail() { document.getElementById('char-detail-modal').classList.remove('active'); hideTooltip(); }
function getRarityColor(r) { if(r==='common')return '#fff'; if(r==='rare')return '#3b82f6'; if(r==='epic')return '#a855f7'; return '#f59e0b'; }
function showTooltip(data, isSkillId = false) { if (!data) return; const tt = document.getElementById('tooltip'); let html = ''; if (isSkillId) { const s = ABILITY_LIBRARY[data]; if(!s) return; html = `<div class="tt-header"><span class="tt-name">${s.name}</span><span class="tt-rarity">${s.type || 'Active'}</span></div><div class="tt-abil" style="border:none;">${s.desc}</div>`; } else { const col = getRarityColor(data.rarity || 'common'); html = `<div class="tt-header"><span class="tt-name" style="color:${col}">${data.name}</span><span class="tt-rarity">${data.rarity || 'Common'}</span></div>`; if (data.bonus) Object.keys(data.bonus).forEach(k => { html += `<span class="tt-stat">+${data.bonus[k]} ${k.toUpperCase()}</span>`; }); if(data.desc) html += `<span class="tt-stat" style="color:#aaa; font-style:italic; margin-bottom:5px;">${data.desc}</span>`; if(data.ability) html += `<div class="tt-abil">${data.ability.name}: ${data.ability.desc}</div>`; } tt.innerHTML = html; tt.style.display = 'block'; }
function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
document.addEventListener('mousemove', (e) => { const tt = document.getElementById('tooltip'); if (tt && tt.style.display === 'block') { const pad = 15; let left = e.pageX + pad; let top = e.pageY + pad; if (left + tt.offsetWidth > window.innerWidth) left = e.pageX - tt.offsetWidth - pad; if (top + tt.offsetHeight > window.innerHeight) top = e.pageY - tt.offsetHeight - pad; tt.style.left = left + 'px'; tt.style.top = top + 'px'; } });
document.addEventListener('click', (e) => { const menu = document.getElementById('context-menu'); if (menu && !e.target.classList.contains('inv-slot') && !e.target.classList.contains('ctx-item')) menu.style.display = 'none'; });
let lastTouchTime = 0; let lastTouchSlot = "";
function toggleHelpModal() { const m = document.getElementById('help-modal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
function handleEquipTouch(slot) { const currentTime = new Date().getTime(); const tapLength = currentTime - lastTouchTime; if (lastTouchSlot === slot && tapLength < 500 && tapLength > 0) { unequipItem(slot); lastTouchTime = 0; } else { useEquipped(slot); lastTouchTime = currentTime; lastTouchSlot = slot; } }
function allowDrop(ev){ev.preventDefault();}
function dragStart(ev, i){ev.dataTransfer.setData("idx",i);}
function handleSellDrop(ev){ ev.preventDefault(); if(document.getElementById('market-sell-area').style.display!=='none'){const idx=ev.dataTransfer.getData("idx"); if(idx!==null) sellItem(idx); }}
function handleSkillDrop(ev, slotIdx) { ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0]; if (invIdx !== null && p.inventory[invIdx]) { const item = p.inventory[invIdx]; if (item.type === 'scroll' || (item.ability && item.ability.type === 'active')) { p.quickSlots[slotIdx] = item; updateHUD(); } else { addLog("Cannot assign passive item.", "log-fail"); } } }
function setupEquipDragDrop() { ['head', 'body', 'main', 'off'].forEach(slot => { const el = document.getElementById('slot-' + slot); if(el) { el.ondragover = allowDrop; el.ondrop = (e) => handleEquipDrop(e, slot); } }); }
function handleEquipDrop(ev, slotName) { ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0]; if (invIdx !== null && p.inventory[invIdx]) { const item = p.inventory[invIdx]; if(item.slot === slotName) equipItem(0, invIdx); else addLog(`Cannot equip ${item.name} to ${slotName.toUpperCase()}`, "log-fail"); } }
function unequipItem(slot) { const p=players[0]; if(p.equipment[slot] && p.inventory.length < 12) { const it = p.equipment[slot]; p.stats[Object.keys(it.bonus)[0]] -= Object.values(it.bonus)[0]; p.equipment[slot] = null; p.inventory.push(it); updateHUD(); } }
function equipItem(pId, invIdx) { const p=players[pId]; const item=p.inventory[invIdx]; if(item.type==='scroll'){ item.fn(p); p.inventory.splice(invIdx,1); } else { const slot=item.slot; const cur=p.equipment[slot]; if(cur){p.stats[Object.keys(cur.bonus)[0]]-=Object.values(cur.bonus)[0]; p.inventory[invIdx]=cur;} else{p.inventory.splice(invIdx,1);} p.equipment[slot]=item; p.stats[Object.keys(item.bonus)[0]]+=Object.values(item.bonus)[0]; } updateHUD(); }
function useEquipped(slot) { const p = players[0]; const it = p.equipment[slot]; if (it && it.ability && it.ability.type === 'active') { if (!it.isDepleted) { it.ability.fn(p); it.isDepleted = true; updateHUD(); } else { addLog("Ability depleted! Pass Start to recharge.", "log-fail"); } } }
function useSkill(slotIndex) { const p = players[0]; if (turnIndex !== 0) { addLog("Not your turn!", "log-fail"); return; } if(slotIndex === 0) { if(p.classSkillDepleted) { addLog("Skill depleted! Visit Inn to recharge.", "log-fail"); return; } const skill = ABILITY_LIBRARY[p.activeSkillId]; if(skill && skill.fn) { skill.fn(p); p.classSkillDepleted = true; updateHUD(); } return; } if(slotIndex >= 1 && slotIndex <= 4) { const equipSlot = EQUIP_ORDER[slotIndex - 1]; const item = p.equipment[equipSlot]; if (item && item.ability && item.ability.type === 'active') { if (!item.isDepleted) { item.ability.fn(p); item.isDepleted = true; updateHUD(); } else { addLog("Ability depleted! Visit Inn to recharge.", "log-fail"); } } else { addLog("Passive or Empty.", "log-fail"); } return; } if(slotIndex >= 5) { const qIdx = slotIndex - 5; const item = p.quickSlots[qIdx]; if(item && item.type === 'scroll' && item.fn) { item.fn(p); const invIdx = p.inventory.indexOf(item); if(invIdx > -1) p.inventory.splice(invIdx, 1); p.quickSlots[qIdx] = null; updateHUD(); } } }
function sellItem(identifier, source='inv'){ const p = players[0]; let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier]; if(item){ let multiplier = p.passiveSkillId === 'fence' ? 0.8 : 0.5; let v = Math.floor((item.cost || 0) * multiplier); p.gold += v; if(source === 'equip') { if(item.bonus) p.stats[Object.keys(item.bonus)[0]] -= Object.values(item.bonus)[0]; p.equipment[identifier] = null; } else { p.inventory.splice(identifier, 1); } addLog(`Sold for ${v}G` + (multiplier > 0.5 ? " (Fence)" : ""), "log-gold"); updateHUD(); } }
document.addEventListener('keydown', (e) => { if (["1","2","3","4","5","6","7"].includes(e.key)) useSkill(parseInt(e.key) - 1); });

// --- REGION 7: CREATION SCREEN ---
function enterCreation() { document.getElementById('splash-screen').style.display = 'none'; document.getElementById('create-screen').style.display = 'flex'; }
function setupCreationUI() {
    const cg=document.getElementById('color-grid'); PLAYER_COLORS.forEach(c=>{let d=document.createElement('div');d.className='color-opt';d.style.backgroundColor=c;d.onclick=()=>{selColor=c;document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));d.classList.add('selected');};cg.appendChild(d);});
    const rg=document.getElementById('race-grid'); RACES.forEach(r=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${r.name}</b><small>S:${r.stats.str} D:${r.stats.dex} I:${r.stats.int}</small>`;d.onclick=()=>{selRace=r;hl(d);up();};rg.appendChild(d);});
    const clg=document.getElementById('class-grid'); CLASSES.forEach(c=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${c.name}</b>`;d.onclick=()=>{selClass=c;hl(d);showClassOptions(c);up();};clg.appendChild(d);});
}
function showClassOptions(c) {
    document.getElementById('active-section').style.display='flex'; const ag = document.getElementById('active-grid'); ag.innerHTML='';
    c.actives.forEach(id => { const skill = ABILITY_LIBRARY[id]; let d=document.createElement('div'); d.className='skill-card'; d.innerHTML=`<b>${skill.name}</b><small>${skill.desc}</small>`; d.onclick=()=>{ selActiveId=id; document.querySelectorAll('#active-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); }; ag.appendChild(d); });
    document.getElementById('passive-section').style.display='flex'; const pg = document.getElementById('passive-grid'); pg.innerHTML='';
    c.passives.forEach(id => { const skill = ABILITY_LIBRARY[id]; let d=document.createElement('div'); d.className='skill-card'; d.innerHTML=`<b>${skill.name}</b><small>${skill.desc}</small>`; d.onclick=()=>{ selPassiveId=id; document.querySelectorAll('#passive-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); }; pg.appendChild(d); });
}
function hl(el){el.parentElement.childNodes.forEach(c=>c.classList&&c.classList.remove('selected'));el.classList.add('selected');}
function up(){ document.getElementById('btn-start-game').disabled = !(selRace && selClass && selActiveId && selPassiveId); if(selRace && selClass) { const key = `${selRace.id}_${selClass.id}`; const url = CHAR_PORTRAITS[key]; if(url) { const frame = document.getElementById('creator-portrait-frame'); frame.style.backgroundImage = `url('${url}')`; frame.style.display = 'block'; } } }
function startGame() {
    document.getElementById('create-screen').style.display='none'; const name = document.getElementById('char-name-input').value || "Hero";
    spawnPlayer(0, name, selRace, selClass, selActiveId, selPassiveId, false, selColor);
    let aiColors = PLAYER_COLORS.filter(c => c !== selColor); let availableNames = [...NPC_NAMES];
    for(let i=1; i<4; i++) { const r = RACES[Math.floor(Math.random()*RACES.length)]; const c = CLASSES[Math.floor(Math.random()*CLASSES.length)]; const aiName = availableNames.splice(Math.floor(Math.random() * availableNames.length), 1)[0]; const aiCol = aiColors.splice(Math.floor(Math.random()*aiColors.length), 1)[0]; const act = c.actives[Math.floor(Math.random()*3)]; const pas = c.passives[Math.floor(Math.random()*3)]; spawnPlayer(i, aiName, r, c, act, pas, true, aiCol); }
    gameState='ROLL'; updateHUD(); addLog("Welcome to Questopoly!");
}

// Start Engine
init();
</script>
</body>
</html>
