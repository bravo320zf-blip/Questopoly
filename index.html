<!DOCTYPE html>
<html lang="en">
<!-- 
================================================================
   QUESTOPOLY: LEGENDS - MASTER SCRIPT
================================================================
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Questopoly: Legends</title>
    
<!-- [01] CSS STYLES -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Roboto+Condensed:wght@400;700&display=swap');

        /* --- VARIABLES --- */
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(20, 25, 35, 0.98);
            --gold: #fbbf24;
            --accent: #ef4444;
            --text-main: #e2e8f0;
            --success: #22c55e;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legend: #f59e0b;
        }

/* --- GLOBAL & LAYOUT --- */
        * { box-sizing: border-box; } 

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* CRITICAL: Prevents scrollbars */
            background: #000;
        }

        body { 
            font-family: 'Roboto Condensed', sans-serif; 
            color: var(--text-main); 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        h1, h2, h3, button, input { font-family: 'Cinzel', serif; }

        /* GAME LAYER: 3D Canvas */
        #game-layer { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            display: block;
            pointer-events: auto; 
        }
        
        /* CRITICAL UPDATE: TOUCH CONTROLS */
        /* This prevents the mobile browser from scrolling the webpage when you try to rotate the camera */
        #game-layer canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none; 
            outline: none;
        }
        
        /* UI LAYER: Overlays */
        #ui-layer { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            pointer-events: none; /* Allows clicks to pass through to 3D world */
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            overflow: hidden; 
        }

        /* --- PANELS --- */
        .panel { background: var(--panel-bg); border: 2px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.8); border-radius: 8px; padding: 15px; pointer-events: auto; transition: all 0.2s ease; }
        .minimize-btn { background: transparent; border: 1px solid #666; color: #aaa; width: 35px; height: 35px; border-radius: 4px; cursor: pointer; font-size: 1.5rem; line-height: 1; padding: 0; margin-left: 10px; display: inline-flex; align-items: center; justify-content: center; float: right; }
        .minimize-btn:hover { border-color: var(--gold); color: #fff; }
        
        .panel.minimized > *:not(.char-header):not(h3) { display: none !important; }
        .panel.minimized { width: auto !important; min-width: 200px; height: auto !important; }

        /* --- DESKTOP SPECIFIC --- */
        #p1-sheet { position: absolute; top: 50px; left: 20px; width: 550px; border-color: var(--gold); max-height: 80vh; overflow-y: auto; }
        #leaderboard { position: absolute; top: 20px; right: 20px; width: 280px; border-color: #665c3b; }
        .mobile-tab { display: none; } 

        /* --- CHAR SHEET ELEMENTS --- */
        .char-header { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
        .gold-large { font-size: 2rem; color: var(--gold); font-weight: 900; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #222; padding: 10px; text-align: center; border: 1px solid #444; border-radius:4px; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 0.9rem; color: #888; font-weight: bold; }
        .paper-doll { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .equip-slot { background: #1a1a1a; border: 1px solid #333; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 1rem; text-align: center; color: #666; cursor: pointer; transition: 0.2s; touch-action: manipulation; }
        .equip-slot:hover { border-color: #fff; }
        .equip-slot.filled { border-color: var(--success); color: #fff; background: #052e16; font-weight: bold;}
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .inv-slot { width: 100%; height: 55px; background: #111; border: 1px solid #333; cursor: pointer; display:flex; align-items:center; justify-content:center; font-size: 0.85rem; text-align:center; color:#fff; position: relative; touch-action: manipulation; }
        .inv-slot:hover { border-color: #fff; }
        .rarity-common { color: #fff; } .rarity-rare { color: var(--rare); border-color: var(--rare); } .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); } .rarity-legendary { color: var(--legend); border-color: var(--legend); box-shadow: 0 0 8px var(--legend); }
        .char-portrait { width: 100px; height: 100px; border: 2px solid #444; border-radius: 50%; background-size: cover; background-position: top center; background-color: #000; margin: 0 15px; flex-shrink: 0; }

        /* --- LEADERBOARD & HUD --- */
        .leader-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 8px; background: #222; border-radius: 4px; font-size: 1rem; }
        .leader-name { font-weight: bold; cursor: pointer; transition: 0.2s; text-decoration: underline; text-decoration-color: transparent; pointer-events: auto; }
        .leader-name:hover { text-decoration-color: var(--gold); color: #fff !important; text-shadow: 0 0 5px var(--gold); }
        #treasury-box { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; text-align: center; }
        #treasury-val { font-size: 2.5rem; color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        #center-hud { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; pointer-events: none; }
        #turn-banner { position: absolute; top: 660px; left: 50%; transform: translateX(-50%); font-size: 3rem; color: white; text-shadow: 0 0 10px var(--gold); pointer-events: none; z-index: 15; width: 100%; text-align: center; }
        #day-night-indicator { position: absolute; top: 720px; left: 50%; transform: translateX(-50%); font-size: 1.2rem; font-weight: bold; padding: 5px 20px; background: rgba(0,0,0,0.5); border-radius: 20px; z-index: 15; pointer-events: none; }

        /* --- LOG --- */
        #game-log { position: absolute; bottom: 700px; left: 50%; transform: translateX(-50%); width: 500px; height: 150px; background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 8px; padding: 10px; pointer-events: auto; font-size: 1rem; z-index: 15; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gold) #333; text-align: left; -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%); mask-image: linear-gradient(to bottom, transparent, black 20%); }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
        .log-gold { color: var(--gold); } .log-fail { color: var(--accent); } .log-success { color: var(--success); }

        /* --- CONTROLS & SKILLS --- */
        #controls { position: absolute; bottom: 120px; right: 20px; display: flex; flex-direction: column; gap: 20px; align-items: flex-end; pointer-events: auto; }
        button { background: #2a2a2a; color: #fff; border: 1px solid #555; padding: 15px 40px; font-size: 1.3rem; cursor: pointer; transition: 0.2s; text-transform: uppercase; box-shadow: 0 4px 0 #111; border-radius: 6px; pointer-events: auto; touch-action: manipulation; }
        button:hover { background: #333; transform: translateY(-2px); }
        button.primary { background: var(--gold); color: #000; border: none; font-weight: bold; box-shadow: 0 4px 0 #b45309; }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); transform: none; box-shadow: none; }
        #skill-bar { position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 2px solid #444; border-radius: 8px; pointer-events: auto; width: auto; max-width: 95%; overflow-x: auto; }
        .skill-slot { width: 60px; height: 60px; border: 2px solid #444; border-radius: 4px; position: relative; background: #1a1a1a; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; text-align: center; color: #666; transition: 0.2s; touch-action: manipulation; flex-shrink: 0; }
        .skill-slot:hover { border-color: var(--gold); } .skill-slot.filled { border-color: var(--rare); color: #fff; background: #0f172a; } .skill-slot.consumable { border-color: var(--success); }
        .skill-key { position: absolute; top: -8px; left: -8px; width: 24px; height: 24px; background: #000; border: 1px solid #666; border-radius: 50%; color: #fff; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2; }

        /* --- MODALS --- */
        .card-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 90%; max-width: 500px; height: auto; max-height: 90vh; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; background: #1a1a1a; border: 4px solid #fff; border-radius: 15px; z-index: 100; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.9); transition: 0.3s; pointer-events: auto; }
        .card-modal.active { transform: translate(-50%, -50%) scale(1); }
        .card-header { background: var(--gold); padding: 20px; text-align: center; color: #000; font-weight: bold; font-size: 1.8rem; border-bottom: 2px solid #000; border-radius: 11px 11px 0 0; }
        .card-header.skirmish { background: #b91c1c; color: #fff; } .card-header.loot { background: #10b981; color: #fff; } .card-header.market { background: #78350f; color: #fff; }
        .card-body { padding: 20px; text-align: center; color: #ddd; } .card-desc { font-style: italic; font-size: 1.2rem; margin-bottom: 20px; color: #fff; line-height: 1.5; }
        .choice-btn { background: #333; color: white; border: 1px solid #555; padding: 15px; margin-bottom: 10px; font-size: 1rem; text-align: left; display: flex; justify-content: space-between; cursor: pointer; transition: 0.2s; border-radius: 4px; } .choice-btn:hover { background: #000; border-color: var(--gold); }
        .dice-result { height: 40px; display: flex; gap: 8px; justify-content: center; margin-top: 15px; } .mini-die { width: 35px; height: 35px; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 1.2rem; } .mini-die.win { background: var(--success); } .mini-die.lose { background: var(--accent); }
        .close-x { position: absolute; top: -15px; right: -15px; width: 45px; height: 45px; background: #ef4444; color: white; border: 2px solid #fff; border-radius: 50%; font-weight: bold; font-size: 1.5rem; cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: 0 2px 5px #000; }
        #arrival-image, #flavor-image { width: 100%; height: auto; max-height: 50vh; display: block; border-bottom: 2px solid #000; object-fit: contain; background-color: #000; }

        /* --- TOOLTIPS & MENUS --- */
        #tooltip { position: absolute; display: none; background: rgba(10,10,15,0.98); border: 2px solid var(--gold); padding: 15px; color: #fff; font-size: 1rem; pointer-events: none; z-index: 200; border-radius: 6px; width: 250px; box-shadow: 0 5px 20px #000; } .tt-header { border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content: space-between;} .tt-name { font-weight: bold; color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.2rem; } .tt-rarity { font-size: 0.9rem; text-transform: uppercase; } .tt-stat { color: #ccc; display: block; } .tt-abil { color: var(--success); margin-top: 5px; font-style: italic; display:block; border-top: 1px solid #333; padding-top: 3px;}
        #context-menu { position: absolute; display: none; flex-direction: column; background: #1a1a1a; border: 2px solid var(--gold); z-index: 1000; min-width: 200px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); border-radius: 6px; } .ctx-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #333; font-size: 1.1rem; color: #fff; background: #222; } .ctx-item:hover { background: #333; color: var(--gold); } .ctx-item:last-child { border-bottom: none; } .ctx-item.disabled { color: #555; cursor: not-allowed; background: #151515; }
        .market-sell-area { width: 100%; height: 80px; border: 2px dashed #666; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; color: #888; border-radius: 6px; transition: 0.2s; font-size: 1.1rem; } .market-sell-area.dragover { border-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.1); }

        /* --- SCREENS --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://static.wixstatic.com/media/b16479_0ce055a502234368915b49af52e0b18d~mv2.jpg'); background-size: cover; background-position: center; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #create-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://static.wixstatic.com/media/b16479_564e3eade6b7410785d835af2f340665~mv2.jpg'); background-size: cover; background-position: center; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 80px 20px 40px 20px; overflow-y: auto; pointer-events: auto; }
        
        #splash-screen h1, #create-screen h1 { 
            color: #000; margin-bottom: 20px; text-shadow: 2px 2px 0px #FFF; text-align: center; 
            font-size: 12vw; 
        }
        @media (min-width: 800px) { #splash-screen h1, #create-screen h1 { font-size: 5rem; } }

        #create-screen h3 { color: #000 !important; font-size: 1.5rem; font-weight: 900; margin-top: 15px; margin-bottom: 10px; text-shadow: .5px .5px .5px #FFF; }
        .input-group label { display: block; color: #000; margin-bottom: 8px; font-size: 2rem; font-weight: 900; font-family: 'Cinzel', serif; text-shadow: .5px .5px .5px #FFF; }
        .input-group input { padding: 15px; font-size: 1.5rem; border-radius: 5px; border: 3px solid #000; background: #1e293b; color: white; text-align: center; width: 300px; font-weight: bold; }
        .color-grid { display: flex; gap: 15px; justify-content: center; margin-top: 10px; }
        .color-opt { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #000; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); } .color-opt:hover, .color-opt.selected { transform: scale(1.2); border-color: white; box-shadow: 0 0 15px var(--gold); }
        .sel-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0 20px 0; max-width: 800px; width: 100%; }
        .sel-opt { background: #1e293b; padding: 20px; cursor: pointer; border: 2px solid transparent; text-align: center; transition: 0.2s; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); } .sel-opt:hover { transform: translateY(-3px); background: #334155; } .sel-opt.selected { border-color: var(--gold); background: #334155; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); } .sel-opt b { color: #fff; display: block; margin-bottom: 5px; font-size: 1.2rem; } .sel-opt small { color: #94a3b8; display: block; line-height: 1.2; font-size: 0.9rem; }
        .skill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .skill-card { background: #1e293b; border: 1px solid #475569; padding: 20px; cursor: pointer; border-radius: 6px; width: 200px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); } .skill-card:hover { border-color: var(--success); } .skill-card.selected { background: #064e3b; border-color: var(--success); box-shadow: 0 0 15px var(--success); } .skill-card b { color: #fff; display: block; margin-bottom: 5px; font-size: 1.1rem; } .skill-card small { color: #ccc; font-size: 0.9rem; }
        #creator-portrait-frame { position: fixed; right: 5%; top: 50%; transform: translateY(-50%); width: 400px; height: 500px; border: 4px solid var(--gold); border-radius: 10px; box-shadow: 0 0 30px #000; background-color: #000; background-size: cover; background-position: top center; background-repeat: no-repeat; display: none; z-index: 201; pointer-events: auto; transition: all 0.3s ease; }
        #creator-portrait-frame.minimized { width: 80px !important; height: 80px !important; right: 20px !important; top: 20px !important; transform: none !important; border-width: 2px !important; background-position: top center !important; }

        /* --- EXTRA MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-content { background: #1a1a1a; border: 4px solid var(--gold); padding: 40px; text-align: center; max-width: 500px; width: 90%; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .modal-title { font-size: 3rem; color: var(--gold); margin-bottom: 20px; text-shadow: 2px 2px 0 #000; } .modal-text { color: #fff; font-size: 1.2rem; margin-bottom: 30px; } .debt-val { color: var(--accent); font-weight: bold; font-size: 1.5rem; } .prop-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #444; padding: 10px; background: #111; }
        .leader-row.dead { opacity: 0.4; filter: grayscale(1); text-decoration: line-through; } .leader-row.dead .leader-name { color: #555 !important; cursor: default; }

        /* --- FULLSCREEN BUTTON --- */
        #btn-fullscreen { position: fixed; top: 10px; left: 10px; width: 30px; height: 30px; background: rgba(0, 0, 0, 0.6); border: 1px solid #444; border-radius: 4px; cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 0; transition: 0.2s; pointer-events: auto; }
        #btn-fullscreen::after { content: ''; width: 12px; height: 12px; border: 2px solid #e2e8f0; box-sizing: border-box; }
        #btn-fullscreen:hover { border-color: var(--gold); background: #222; } #btn-fullscreen:hover::after { border-color: var(--gold); }

        /* --- MOBILE MEDIA QUERY --- */
        @media only screen and (max-width: 768px) {
            .panel.minimized > *:not(.char-header):not(h3) { display: block !important; }

            #p1-sheet {
                position: fixed; top: 0; left: -100%; width: 85%; height: 100%; max-height: 100%; margin: 0;
                border-radius: 0; border-left: none; transition: left 0.3s ease; z-index: 50;
                background: rgba(15, 23, 42, 0.98);
            }
            #p1-sheet.active { left: 0; box-shadow: 10px 0 50px #000; }

            #leaderboard {
                position: fixed; top: 0; right: -100%; left: auto; width: 85%; height: 100%;
                border-radius: 0; border-right: none; transition: right 0.3s ease; z-index: 50;
                background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column;
            }
            #leaderboard.active { right: 0; box-shadow: -10px 0 50px #000; }
            #leader-list { flex-grow: 1; overflow-y: auto; }

            .mobile-tab { 
                display: flex; align-items: center; justify-content: center; 
                position: fixed; top: 50%; transform: translateY(-50%); 
                width: 50px; height: 60px; 
                background: var(--panel-bg); 
                color: var(--gold); 
                font-size: 1.5rem; 
                border: 2px solid var(--gold); 
                z-index: 60; 
                cursor: pointer; pointer-events: auto;
                box-shadow: 0 0 10px #000; transition: 0.3s ease; 
            }
            #tab-char { left: 0; border-radius: 0 10px 10px 0; border-left: none; }
            #tab-leader { right: 0; border-radius: 10px 0 0 10px; border-right: none; }
            
            #tab-char.active { left: 85%; border-radius: 50%; width: 50px; height: 50px; }
            #tab-leader.active { right: 85%; border-radius: 50%; width: 50px; height: 50px; }

            .minimize-btn { display: none; }

            #center-hud { top: 10px; width: 100%; pointer-events: none; }
            #turn-banner { font-size: 2rem; }
            #day-night-indicator { margin-top: 0; font-size: 1rem; }
            #controls { bottom: 90px; right: 10px; gap: 10px; z-index: 30; }
            #skill-bar { bottom: 10px; width: 98%; gap: 4px; z-index: 30; }
            .skill-slot { height: 50px; font-size: 0.65rem; }
            #game-log { display: block; bottom: 70px; width: 90%; height: 80px; background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0)); border: none; pointer-events: none; }
            .sel-grid { grid-template-columns: repeat(2, 1fr); }
            .skill-grid { grid-template-columns: repeat(1, 1fr); }
            #create-screen h1 { font-size: 12vw; margin-top: 20px; }
            #creator-portrait-frame { right: 10px; bottom: 10px; top: auto; transform: none; width: 100px; height: 130px; }
        }
		
		/* --- DRAGGABLE UI & HELP BUTTON --- */
.draggable-ui {
    cursor: move; /* Fallback */
    cursor: grab;
    touch-action: none; /* Prevents scrolling while dragging UI */
}
.draggable-ui:active {
    cursor: grabbing;
    z-index: 1000 !important; /* Bring to front when dragging */
}

/* Help Button */
#btn-help {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: var(--gold);
    color: #000;
    border: 2px solid #fff;
    border-radius: 50%;
    font-size: 2rem;
    font-weight: 900;
    cursor: pointer;
    box-shadow: 0 0 15px #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200; /* Above normal UI */
    font-family: 'Cinzel', serif;
    transition: transform 0.2s;
	pointer-events: auto; 
}
#btn-help:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--gold); }

/* Help Modal Content Styling */
.help-section { text-align: left; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
.help-section h3 { color: var(--gold); margin-bottom: 5px; }
.help-section ul { list-style-type: none; padding-left: 10px; }
.help-section li { margin-bottom: 5px; color: #ccc; }
.help-section b { color: #fff; }
    </style>

    <!-- [02] LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>

<!-- FULLSCREEN BUTTON -->
<button id="btn-fullscreen" onclick="toggleFullScreen()"></button>

<div id="game-layer"></div>
    <div id="tooltip"></div>
    <div id="context-menu"></div>

<!-- UI Layer -->
    <div id="ui-layer">
	
	<!-- NEW HELP BUTTON -->
    <div id="btn-help" onclick="toggleHelpModal()">?</div>
        
        <!-- MOBILE TABS -->
        <div id="tab-char" class="mobile-tab" onclick="toggleDrawer('p1-sheet')">üë§</div>
        <div id="tab-leader" class="mobile-tab" onclick="toggleDrawer('leaderboard')">üèÜ</div>

        <!-- START: PLAYER SHEET -->
        <div id="p1-sheet" class="panel minimized">
            <div class="char-header">
                <div style="display:flex; align-items:center; width:100%; justify-content:space-between;">
                    <div style="display:flex; align-items:center;">
                        <div id="p1-portrait" class="char-portrait"></div>
                        <div>
                            <div id="p1-name" style="font-weight:bold; color:#fff; font-size:1.2rem;">Hero</div>
                            <div id="p1-class" style="font-size:0.8rem; color:#aaa; line-height:1.2;">Class</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="gold-large" style="margin-right:10px;"><span id="p1-gold">0</span> G</div>
                        <button class="minimize-btn" onclick="togglePanel('p1-sheet')">+</button>
                    </div>
                </div>
            </div>
            <!-- ... rest of stats/inv ... -->
            <div class="stat-grid">
                <div class="stat-box"><div class="stat-val" id="p1-str">0</div><div class="stat-lbl">STR</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-dex">0</div><div class="stat-lbl">DEX</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-int">0</div><div class="stat-lbl">INT</div></div>
            </div>
            <div class="paper-doll">
                <div id="slot-head" class="equip-slot" onpointerup="handleEquipTouch('head')">Head</div>
                <div id="slot-body" class="equip-slot" onpointerup="handleEquipTouch('body')">Body</div>
                <div id="slot-main" class="equip-slot" onpointerup="handleEquipTouch('main')">Main</div>
                <div id="slot-off" class="equip-slot" onpointerup="handleEquipTouch('off')">Off</div>
            </div>
            <div id="p1-inv" class="inv-grid"></div>
        </div>

        <!-- START: LEADERBOARD -->
        <div id="leaderboard" class="panel minimized">
            <h3 style="margin:0 0 10px 0; text-align:center; color:#ccc; border-bottom:1px solid #444; padding-bottom:5px; position: relative;">
                Leaderboard
                <button class="minimize-btn" onclick="togglePanel('leaderboard')" style="position: absolute; right: 0; top: 0;">+</button>
            </h3>
            <div id="leader-list" style="flex-grow:1; overflow-y:auto;"></div>
            <div id="treasury-box"><h4 style="margin:0; color:#888;">Treasury</h4><div id="treasury-val">0</div><small style="color:#555;">Capital City Hoard</small></div>
        </div>

        <div id="center-hud">
            <div id="turn-banner">SETUP PHASE</div>
            <div id="day-night-indicator" style="color:#87ceeb;">‚òÄ DAY</div>
        </div>
        <div id="game-log"></div>
        <div id="controls">
            <button id="btn-roll" class="primary" onclick="rollMove()">Roll Dice</button>
            <button id="btn-end" onclick="endTurn()" disabled>End Turn</button>
        </div>
        <div id="skill-bar">
            <!-- ... skill slots ... -->
            <div class="skill-slot" id="skill-0" onclick="useSkill(0)"><div class="skill-key">1</div><span id="txt-skill-0">Class</span></div>
            <div class="skill-slot" id="skill-1" onclick="useSkill(1)"><div class="skill-key">2</div><span id="txt-skill-1">Empty</span></div>
            <div class="skill-slot" id="skill-2" onclick="useSkill(2)"><div class="skill-key">3</div><span id="txt-skill-2">Empty</span></div>
            <div class="skill-slot" id="skill-3" onclick="useSkill(3)"><div class="skill-key">4</div><span id="txt-skill-3">Empty</span></div>
            <div class="skill-slot" id="skill-4" onclick="useSkill(4)"><div class="skill-key">5</div><span id="txt-skill-4">Empty</span></div>
            <div class="skill-slot" id="skill-5" onclick="useSkill(5)" ondragover="allowDrop(event)" ondrop="handleSkillDrop(event, 0)"><div class="skill-key">6</div><span id="txt-skill-5">Drag Item</span></div>
            <div class="skill-slot" id="skill-6" onclick="useSkill(6)" ondragover="allowDrop(event)" ondrop="handleSkillDrop(event, 1)"><div class="skill-key">7</div><span id="txt-skill-6">Drag Item</span></div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Splash Screen -->
    <div id="splash-screen">
        <h1 style="font-size: 8rem; color: #fff; text-shadow: 0 0 30px var(--gold); margin-bottom: 20px;">QUESTOPOLY</h1>
        <h2 style="color: #ddd; font-size: 2rem; margin-top: 0; margin-bottom: 50px; text-shadow: 2px 2px 5px #000;">LEGENDS</h2>
        <button class="primary" style="font-size: 2.5rem; padding: 20px 80px; box-shadow: 0 0 20px #000;" onclick="enterCreation()">PLAY</button>
    </div>

    <!-- Creation Screen -->
    <div id="create-screen" style="display:none;">
        <div class="input-group"><label>Name Your Hero</label><input type="text" id="char-name-input" value="Hero" maxlength="12"></div>
        <div class="input-group"><label>Choose Color</label><div class="color-grid" id="color-grid"></div></div>
        
        <h3 style="color:#888;">Select Race (Base Stats)</h3>
        <div class="sel-grid" id="race-grid"></div>
        
        <h3 style="color:#888;">Select Class</h3>
        <div class="sel-grid" id="class-grid"></div>
        
        <div id="active-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <h3 style="color:#888;">Choose Active Skill</h3>
            <div class="skill-grid" id="active-grid"></div>
        </div>
        <div id="passive-section" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <h3 style="color:#888;">Choose Passive Trait</h3>
            <div class="skill-grid" id="passive-grid"></div>
        </div>

        <button id="btn-start-game" class="primary" style="padding:15px 50px; font-size:1.5rem;" onclick="startGame()" disabled>Start Adventure</button>
        <div style="height:50px;"></div>
        
        <div id="creator-portrait-frame">
            <button id="btn-min-portrait" class="minimize-btn" onclick="toggleCreatorPortrait()" 
                    style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); color: var(--gold); z-index: 205; width: 30px; height: 30px; line-height: 28px; padding: 0;">-</button>
        </div>
    </div>

    <div id="arrival-modal" class="card-modal" style="padding: 0; overflow: hidden;">
        <button class="close-x" onclick="continueFromArrival()" style="top: 10px; right: 10px;">√ó</button>
        <div class="card-border">
            <img id="arrival-image" src="" alt="Location Image" style="display:none;">
            <div class="card-body" style="padding: 20px;">
                <div id="arrival-flavor" class="flavor-text" style="min-height:60px; font-style: italic; color: #fff;">...</div>
                <button class="primary" onclick="continueFromArrival()" style="width:100%; margin-top:20px;">Continue</button>
            </div>
        </div>
    </div>

    <div id="card-modal" class="card-modal" ondragover="allowDrop(event)" ondrop="handleSellDrop(event)">
        <button class="close-x" onclick="closeEnc()">√ó</button>
        <div class="card-header" id="enc-header">Encounter</div>
        <div class="card-body">
            <h2 id="enc-title" style="margin:0 0 10px 0; color:#fff;">Title</h2>
            <p id="enc-desc" class="card-desc">...</p>
            <div id="market-sell-area" class="market-sell-area" style="display:none;">Drag items here to SELL</div>
            <div id="choice-list"></div>
            <div id="dice-result" class="dice-result"></div>
        </div>
    </div>

    <div id="flavor-modal" class="card-modal" style="z-index: 110;">
        <div class="card-border">
            <div class="card-header" id="flavor-header">Location</div>
            <img id="flavor-image" src="" alt="Flavor Image">
            <div class="card-body">
                <p id="flavor-text" class="card-desc" style="margin-top:20px;">...</p>
                <button class="primary" onclick="closeFlavor()" style="width:100%; margin-top:10px;">Continue</button>
            </div>
        </div>
    </div>

    <div id="char-detail-modal" class="card-modal" style="width: 350px; background: var(--panel-bg); border: 2px solid #444;">
        <div style="display:flex; align-items:center; justify-content:center; padding:15px; border-bottom:1px solid #444;">
            <div id="cd-portrait" class="char-portrait"></div>
            <div style="text-align:left; margin-left:15px;">
                <div id="cd-header" style="color:#fff; font-weight:bold; font-size:1.4rem;">Hero Name</div>
                <div id="cd-sub" style="color:#aaa; font-size:0.9rem;">Race Class</div>
            </div>
        </div>
        <button class="close-x" onclick="closeCharDetail()">√ó</button>
        <div class="card-body" style="text-align: left; padding: 15px;">
            <div style="display:flex; justify-content:space-around; background:#222; padding:8px; border-radius:4px; margin-bottom:10px; border:1px solid #444;">
                <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-str">0</span><small style="color:#888;">STR</small></div>
                <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-dex">0</span><small style="color:#888;">DEX</small></div>
                <div style="text-align:center;"><span style="display:block; font-size:1.2rem; font-weight:bold; color:#fff;" id="cd-int">0</span><small style="color:#888;">INT</small></div>
            </div>
            <div style="margin-bottom:15px; border-top:1px solid #444; padding-top:10px;">
                <div style="margin-bottom:5px;">
                    <span style="color:var(--gold); font-weight:bold;">Active:</span> <span id="cd-active" style="color:#fff;">-</span>
                    <div id="cd-active-desc" style="font-size:0.8rem; color:#888; font-style:italic;"></div>
                </div>
                <div>
                    <span style="color:var(--epic); font-weight:bold;">Passive:</span> <span id="cd-passive" style="color:#fff;">-</span>
                    <div id="cd-passive-desc" style="font-size:0.8rem; color:#888; font-style:italic;"></div>
                </div>
            </div>
            <div id="cd-inventory-section" style="display:none; border-top:1px solid #444; padding-top:10px;">
                <div style="color:#aaa; text-align:center; margin-bottom:5px;">Equipment</div>
                <div class="paper-doll" style="border:none; padding:0; margin-bottom:10px;">
                    <div id="cd-slot-head" class="equip-slot">Head</div>
                    <div id="cd-slot-body" class="equip-slot">Body</div>
                    <div id="cd-slot-main" class="equip-slot">Main</div>
                    <div id="cd-slot-off" class="equip-slot">Off</div>
                </div>
                <div style="color:#aaa; text-align:center; margin-bottom:5px;">Backpack</div>
                <div id="cd-inv-grid" class="inv-grid"></div>
            </div>
            <div id="cd-hidden-msg" style="display:none; text-align:center; color:#555; font-style:italic; margin-top:20px;">Inventory Hidden</div>
        </div>
    </div>

<div id="game-over-modal" class="modal-overlay">
    <div class="modal-content">
        <h1 id="go-title" class="modal-title">GAME OVER</h1>
        <p id="go-msg" class="modal-text">Your journey ends here.</p>
        <button class="primary" onclick="resetGame()">PLAY AGAIN</button>
    </div>
</div>

<!-- HOW TO PLAY MODAL -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow-y: auto; text-align: left;">
        <button class="close-x" onclick="toggleHelpModal()" style="top: 10px; right: 10px; position:absolute;">√ó</button>
        <h1 class="modal-title" style="font-size: 2.5rem; text-align: center;">HOW TO PLAY</h1>
        
        <div class="help-section">
            <h3>OBJECTIVE</h3>
            <p>Become the last hero standing! Bring villages and locations under your control.  Money is power and without power your rivals are nothing.</p>
        </div>

        <div class="help-section">
            <h3>MOVEMENT & TILES</h3>
            <ul>
                <li><b>Roll:</b> Roll dice to move. If you pass "Old Crooks Inn" (Start), you gain Gold, and recharge abilities.</li>
                <li><b>Empty Land:</b> Make a skill check to Capture the space. Enemy heroes who visit will either need to fight you for control or pay you gold to stay.</li>
                <li><b>Enemy Land:</b> Pay rent OR attempt a <b>Siege</b> (Combat) to steal the land!</li>
                <li><b>Shops:</b> Buy equipment to boost your stats and unlock new abilities.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>COMBAT & STATS</h3>
            <p>Dice checks determine success. Roll d6s equal to your stat vs. the target number for that skill check.</p>
            <ul>
                <li><b>STR (Strength):</b> Used for brute force and physical attacks.</li>
                <li><b>DEX (Dexterity):</b> Used for dodging, traps, and agility.</li>
                <li><b>INT (Intelligence):</b> Used for magic, puzzles, and silver tongue.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>DAY & NIGHT</h3>
            <p>Every 10 turns, the cycle changes. <b>Night</b> brings tougher monsters, "Skirmish" cards, and higher risks!</p>
        </div>
        
        <div style="text-align: center;">
            <button class="primary" onclick="toggleHelpModal()">GOT IT</button>
        </div>
    </div>
</div>

<div id="bankruptcy-modal" class="modal-overlay">
    <div class="modal-content" style="border-color: var(--accent);">
        <h1 class="modal-title" style="color: var(--accent);">DEBT!</h1>
        <p class="modal-text">You owe <span id="debt-amount" class="debt-val">0</span> G</p>
        <p style="color:#aaa; font-size:0.9rem;">Select properties to sell (50% value):</p>
        <div id="debt-prop-list" class="prop-list"></div>
        <button id="btn-debt-done" class="primary" onclick="checkDebtCleared()" disabled>Pay & Continue</button>
    </div>
</div>

<script>
// [03] GLOBAL VARIABLES
// =================================================================
let scene, camera, renderer, controls;
let tiles=[], players=[], turnIndex=0, gameState='SETUP', treasuryGold=0;
let normalDeck, skirmishDeck, treasureDeck;
let turnCount = 0, isNight = false;

// Selection placeholders
let selRace = null;
let selClass = null;
let selColor = "#ef4444"; 
let selActiveId = null;
let selPassiveId = null;


// [04] DATA: CONSTANTS
// =================================================================
const PLAYER_COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#FFFFFF"];
const EQUIP_ORDER = ['head', 'body', 'main', 'off'];

const NPC_NAMES = [
    "Aaelin", "Adran", "Aelar", "Aeron", "Aias", "Alaric", "Aldric", "Altair", "Amara", "Arannis",
    "Aria", "Arin", "Asher", "Astrid", "Balthazar", "Bard", "Bael", "Bran", "Caelum", "Caius",
    "Caspian", "Cassius", "Cedric", "Celeste", "Corin", "Cyrus", "Darian", "Darius", "Drakon", "Drusilla",
    "Eamon", "Elander", "Elara", "Eldrin", "Elian", "Elric", "Emrys", "Eoran", "Erevon", "Estrid",
    "Faen", "Faelar", "Fenris", "Finn", "Galen", "Garret", "Gideon", "Gimbar", "Gorim", "Griffin",
    "Hadrian", "Haldor", "Halvar", "Havlar", "Hazir", "Hestia", "Horus", "Icarus", "Idris", "Ignis",
    "Imara", "Ion", "Isolde", "Jareth", "Jax", "Jorian", "Kael", "Kaiden", "Kaelen", "Kas",
    "Kian", "Korin", "Kyra", "Leander", "Leo", "Lucian", "Lyss", "Magnus", "Marek", "Mathis",
    "Mirella", "Nael", "Nareen", "Neren", "Nyx", "Orion", "Orin", "Osric", "Paelen", "Perrin",
    "Phineas", "Quinn", "Raen", "Ragnar", "Ravyn", "Remus", "Rian", "Roan", "Rurik", "Ryker",
    "Saren", "Severin", "Silas", "Soren", "Stig", "Storm", "Talis", "Taron", "Thalis", "Theon",
    "Thorne", "Tian", "Torin", "Tristan", "Tybalt", "Uric", "Valen", "Varian", "Varis", "Vesper",
    "Vor", "Xander", "Xan", "Xylo", "Yarin", "Yorick", "Zael", "Zane", "Zephyr", "Zorion"
];

const RACES = [ 
    {id:'human', name:'Human', stats:{str:2, dex:2, int:2}}, 
    {id:'elf', name:'Elf', stats:{str:1, dex:3, int:2}}, 
    {id:'dwarf', name:'Dwarf', stats:{str:3, dex:1, int:2}}, 
    {id:'orc', name:'Orc', stats:{str:4, dex:1, int:1}}, 
    {id:'gnome', name:'Gnome', stats:{str:1, dex:2, int:3}}, 
    {id:'tiefling', name:'Tiefling', stats:{str:1, dex:1, int:4}}, 
    {id:'dragonborn', name:'Dragonborn', stats:{str:3, dex:2, int:1}}, 
    {id:'halfling', name:'Halfling', stats:{str:1, dex:4, int:1}} 
];

const CLASSES = [
    { id: 'fighter', name: 'Fighter', color: 0x8B0000, 
      actives: ['second_wind', 'power_strike', 'intimidate'], 
      passives: ['veteran', 'iron_skin', 'executioner'] },
    { id: 'wizard', name: 'Wizard', color: 0x4B0082, 
      actives: ['fireball', 'transmute_gold', 'blink'], 
      passives: ['scholar', 'mana_shield', 'alchemist_pas'] },
    { id: 'rogue', name: 'Rogue', color: 0x2F4F4F, 
      actives: ['pickpocket', 'sprint_act', 'smoke_bomb'], 
      passives: ['shadow_step', 'greedy', 'fence'] },
    { id: 'cleric', name: 'Cleric', color: 0xFFD700, 
      actives: ['heal_light', 'smite', 'bless'], 
      passives: ['devotion', 'medic', 'holy_aura'] }
];

const CHAR_PORTRAITS = {
    human_fighter: "https://static.wixstatic.com/media/b16479_85518cf9c4d646c2994697b826b54bff~mv2.jpg",
    human_wizard: "https://static.wixstatic.com/media/b16479_67634ea082d04f388af02accc2e0a2bc~mv2.jpg",
    human_rogue: "https://static.wixstatic.com/media/b16479_7f27982f60994088b1740631284815b3~mv2.jpg",
    human_cleric: "https://static.wixstatic.com/media/b16479_0293976216c3443187ebcc00fcb1e071~mv2.jpg",
    elf_fighter: "https://static.wixstatic.com/media/b16479_97dd792642d444f59cb3b21842131c6a~mv2.jpg",
    elf_wizard: "https://static.wixstatic.com/media/b16479_19a126df94694355b2381756b2ad35da~mv2.jpg",
    elf_rogue: "https://static.wixstatic.com/media/b16479_ffdbe8eb72214036a2f95e2f5a9e6f48~mv2.jpg",
    elf_cleric: "https://static.wixstatic.com/media/b16479_82514ff810324b4ca9c6218b6d4e2da6~mv2.jpg",
    dwarf_fighter: "https://static.wixstatic.com/media/b16479_15e678031c824dfaa6ff4b851c470c39~mv2.jpg",
    dwarf_wizard: "https://static.wixstatic.com/media/b16479_f84ec5deac214cd3b570517773edd83e~mv2.jpg",
    dwarf_rogue: "https://static.wixstatic.com/media/b16479_81d5ee7fd64c4d1a911252797b8b34bd~mv2.jpg",
    dwarf_cleric: "https://static.wixstatic.com/media/b16479_67a5b13eb3654884b520fcff34f7af0e~mv2.jpg",
    orc_fighter: "https://static.wixstatic.com/media/b16479_733a0e4ffb554734a58229af907bb5e5~mv2.jpg",
    orc_wizard: "https://static.wixstatic.com/media/b16479_a99213a85fa74dc7925dc1fb2d26987f~mv2.jpg",
    orc_rogue: "https://static.wixstatic.com/media/b16479_a0df2ed1b7b3412ba4694f474bf0846b~mv2.jpg",
    orc_cleric: "https://static.wixstatic.com/media/b16479_881698035b3b41c6932393d2b0975359~mv2.jpg",
    gnome_fighter: "https://static.wixstatic.com/media/b16479_7d856dc2c71e4b60aff24ef59172897b~mv2.jpg",
    gnome_wizard: "https://static.wixstatic.com/media/b16479_7466d1b684c04c459bb588da3225158d~mv2.jpg",
    gnome_rogue: "https://static.wixstatic.com/media/b16479_3c67ae62970347d5a96a83248d7680f2~mv2.jpg",
    gnome_cleric: "https://static.wixstatic.com/media/b16479_36767d44051346c49f9e4c0995ece904~mv2.jpg",
    tiefling_fighter: "https://static.wixstatic.com/media/b16479_a5e3e133b61f463a8bcc0ce93b582d25~mv2.jpg",
    tiefling_wizard: "https://static.wixstatic.com/media/b16479_afd36e1dcbc2485cac93ae49155eae58~mv2.jpg",
    tiefling_rogue: "https://static.wixstatic.com/media/b16479_9168e6f8da2e48659f4ced1d8c7aad8c~mv2.jpg",
    tiefling_cleric: "https://static.wixstatic.com/media/b16479_689c4a94dbb6418681634d65878c8022~mv2.jpg",
    dragonborn_fighter: "https://static.wixstatic.com/media/b16479_d5e785f4d11e4d8288a3e963c6902b2c~mv2.jpg",
    dragonborn_wizard: "https://static.wixstatic.com/media/b16479_8e63663f55f142fa81a3958b3a2b0d7b~mv2.jpg",
    dragonborn_rogue: "https://static.wixstatic.com/media/b16479_d4f401dc822b421ca753799e82879c99~mv2.jpg",
    dragonborn_cleric: "https://static.wixstatic.com/media/b16479_dab195d558d94074a19bb86b45972311~mv2.jpg",
    halfling_fighter: "https://static.wixstatic.com/media/b16479_1692c0cb049249a1b5d49ac4f8901b97~mv2.jpg",
    halfling_wizard: "https://static.wixstatic.com/media/b16479_0dcf3d49ab0b4dd7b0ca03d0ed6c09f8~mv2.jpg",
    halfling_rogue: "https://static.wixstatic.com/media/b16479_b031efc88dfe49899f2e2b4f619c788e~mv2.jpg",
    halfling_cleric: "https://static.wixstatic.com/media/b16479_ffa702bd84c141fca8fa7cbfd86f581d~mv2.jpg"
};

// [05] DATA: ABILITIES
// =================================================================
const ABILITY_LIBRARY = {
    // --- STANDARD ABILITIES ---
    dash: { name: "Dash", desc: "Move 3 spaces immediately.", fn: (p) => { addLog("Dashed forward!", "log-success"); animateMove(p, 3); } },
    
    ghost_hand: { name: "Ghost Hand", desc: "Steal 100G from a random player.", fn: (p) => { 
        // Find valid targets (not self, not dead)
        const targets = players.filter(t => t.id !== p.id && !t.isDead && t.gold >= 1);
        if(targets.length > 0) {
            const t = targets[Math.floor(Math.random() * targets.length)];
            addLog(`${p.name} uses Ghost Hand on ${t.name}!`, "log-accent");
            pay(t, 100, p); // Transfer 100 from Target (t) to User (p)
        } else { addLog("No valid targets to steal from.", "log-fail"); }
    }},
    
    midas: { name: "Midas Touch", desc: "Gain 150 Gold immediately.", fn: (p) => { p.gold += 150; addLog("Midas Touch: +150G", "log-gold"); updateHUD(); } },
    heal: { name: "Field Medic", desc: "Remove 'Skipping Turn' status.", fn: (p) => { p.isSkipping = false; addLog("Cured status ailments!", "log-success"); updateHUD(); } },
    
    gamble: { name: "High Stakes", desc: "Roll d6. 1-3: Lose 50G. 4-6: Gain 200G.", fn: (p) => { 
        const r = Math.floor(Math.random()*6)+1; 
        if(r>3){ p.gold+=200; addLog(`Rolled ${r}: Won 200G!`, "log-gold"); }
        else { pay(p, 50); addLog(`Rolled ${r}: Lost 50G.`, "log-fail"); }
        updateHUD();
    }},
    
    teleport: { name: "Town Portal", desc: "Teleport to Old Crooks Inn.", fn: (p) => { p.pos=0; p.mesh.position.copy(tiles[0].position); resolveLanding(p); addLog("Teleported to Inn.", "log-rare"); } },
    backtrack: { name: "Recall", desc: "Move backwards 3 spaces.", fn: (p) => { 
        p.pos = (p.pos - 3 + 40) % 40; const t = tiles[p.pos];
        new TWEEN.Tween(p.mesh.position).to({x:t.position.x, z:t.position.z}, 500).onComplete(()=>resolveLanding(p)).start();
        addLog("Rewound time.", "log-epic");
    }},
    
    sprint: { name: "Adrenaline", desc: "Add +2 to your next movement roll (Passive).", type:'passive' },
    bribe: { name: "Silver Tongue", desc: "Steal ownership of a tile (TN 6 INT). Only usable when prompted during capture.", fn: (p) => { addLog("You cannot activate this skill at this time.", "log-fail"); } },
    freeze: { name: "Ice Blast", desc: "Next player skips their turn.", fn: (p) => { 
        const nextP = players[(p.id + 1) % players.length];
        nextP.isSkipping = true; addLog(`Froze ${nextP.name}!`, "log-epic");
    }},
    scavenge: { name: "Scavenge", desc: "Gain 50G for every Item you hold.", fn: (p) => { 
        const amt = p.inventory.length * 50; p.gold += amt; addLog(`Scavenged ${amt}G.`, "log-gold"); updateHUD();
    }},
    swap: { name: "Chaos Swap", desc: "Swap positions with random player.", fn: (p) => {
        const targets = players.filter(t => t.id !== p.id && !t.isDead);
        if(targets.length > 0) {
            const t = targets[Math.floor(Math.random() * targets.length)];
            const tempPos = p.pos; p.pos = t.pos; t.pos = tempPos;
            p.mesh.position.copy(tiles[p.pos].position); t.mesh.position.copy(tiles[t.pos].position);
            addLog(`Swapped with ${t.name}!`, "log-epic");
        }
    }},
    
    might: { name: "Giant's Str", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str += 5; addLog("Strength surged!", "log-success"); updateHUD(); }},
    focus: { name: "Mind's Eye", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int += 5; addLog("Focus sharpened!", "log-success"); updateHUD(); }},
    agility: { name: "Cat's Grace", desc: "Gain +5 DEX until end of turn.", fn: (p) => { p.stats.dex += 5; addLog("Reflexes heightened!", "log-success"); updateHUD(); }},
    
    transmute: { name: "Alchemy", desc: "Destroy a random inventory item for 300G.", fn: (p) => {
        if(p.inventory.length > 0) {
            const idx = Math.floor(Math.random()*p.inventory.length);
            const it = p.inventory.splice(idx, 1)[0];
            p.gold += 300; addLog(`Transmuted ${it.name} to 300G.`, "log-gold"); updateHUD();
        } else { addLog("No items to transmute.", "log-fail"); }
    }},
    
    tax_evade: { name: "Tax Dodge", desc: "Gain immunity to Tax tiles (Passive).", type:'passive' },
    bounty: { name: "Bounty Hunter", desc: "Gain 50G when winning a fight.", type: 'passive', onCombatVictory: (p) => { p.gold += 50; addLog("Bounty Hunter Reward: +50G", "log-gold"); updateHUD(); } },
    lucky: { name: "Lucky Charm", desc: "Reroll movement dice once.", fn: (p) => { rollMove(); addLog("Rerolled dice!", "log-success"); } },
    anchor: { name: "Iron Anchor", desc: "You cannot be moved by enemy effects (Passive).", type:'passive' },

    // --- CLASS SPECIFIC SKILLS ---
    
    // FIGHTER
    second_wind: { name: "Second Wind", desc: "Gain 100 Gold immediately.", fn: (p) => { p.gold+=100; addLog("Second Wind: +100G", "log-gold"); updateHUD(); } },
    power_strike: { name: "Power Strike", desc: "Gain +5 STR until end of turn.", fn: (p) => { p.stats.str+=5; addLog("Power Strike prepared!", "log-success"); updateHUD(); } },
    
    intimidate: { 
        name: "Intimidate", 
        desc: "Force a target to pay you 50G.", 
        fn: (p) => { 
            // FIXED: Find next living player to target (skip self)
            let target = null;
            for(let i=1; i<players.length; i++) {
                const t = players[(p.id + i) % players.length];
                if(!t.isDead) { target = t; break; }
            }

            if(target) {
                addLog(`${p.name} intimidates ${target.name}!`, "log-accent");
                // Uses pay() to ensure debt logic runs and P actually receives the gold
                pay(target, 50, p); 
            } else {
                addLog("No valid targets to intimidate.", "log-fail");
            }
        } 
    },
    
    veteran: { name: "Veteran", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1 },
    iron_skin: { name: "Iron Skin", desc: "Reduce all fail penalties by 20G.", type:'passive' },
    executioner: { name: "Executioner", desc: "Rolling a 6 in combat counts as 2 Successes.", type:'passive' },

    // WIZARD
    fireball: { name: "Fireball", desc: "Capture Target (INT 5+).", fn: (p) => { const t = tiles[p.pos]; rollCombat(p, 'int', 5, 1, t, 'capture', false, 0, 50, false); }},
    transmute_gold: { name: "Midas Touch", desc: "Gain 100 Gold.", fn: (p) => { p.gold+=100; addLog("Transmuted Gold", "log-gold"); updateHUD(); } },
    blink: { name: "Blink", desc: "Move 1-4 spaces.", fn: (p) => { animateMove(p, Math.floor(Math.random()*4)+1); } },
    scholar: { name: "Scholar", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1 },
    mana_shield: { name: "Mana Shield", desc: "Immune to Tax Tiles.", type:'passive' },
    alchemist_pas: { name: "Alchemist", desc: "Start with +250 Gold.", type:'passive', effect:(s)=>s.gold+=250 },

    // ROGUE
    pickpocket: { 
        name: "Pickpocket", 
        desc: "Steal 80G from random player.", 
        fn: (p) => { 
            const targets = players.filter(x => x.id !== p.id && !x.isDead); 
            if(targets.length > 0){
                const t = targets[Math.floor(Math.random()*targets.length)];
                addLog(`${p.name} pickpockets ${t.name}!`, "log-accent");
                pay(t, 80, p); // Uses pay logic
            } else {
                addLog("No one to pickpocket.", "log-fail");
            }
        }
    },
    sprint_act: { name: "Sprint", desc: "Move 3 spaces.", fn: (p) => { animateMove(p, 3); } },
    smoke_bomb: { name: "Smoke Bomb", desc: "Escape any encounter (End Turn).", fn: (p) => { addLog("Vanished!"); endStep(); } },
    shadow_step: { name: "Shadow Step", desc: "Permanent +1 DEX.", type:'passive', effect:(s)=>s.dex+=1 },
    greedy: { name: "Greedy", desc: "Start with +200G.", type:'passive', effect:(s)=>s.gold+=200 },
    fence: { name: "Fence", desc: "Sell items for 80% value (usually 50%).", type:'passive' },

    // CLERIC
    heal_light: { name: "Heal", desc: "Remove all status effects.", fn: (p) => { p.isSkipping=false; addLog("Healed!"); updateHUD(); } },
    smite: { name: "Smite", desc: "Capture Target (STR 5+).", fn: (p) => { const t = tiles[p.pos]; rollCombat(p, 'str', 5, 1, t, 'capture', false, 0, 50, false); }},
    bless: { name: "Bless", desc: "Gain +5 INT until end of turn.", fn: (p) => { p.stats.int+=5; addLog("Blessed!", "log-success"); updateHUD(); } },
    devotion: { name: "Devotion", desc: "Permanent +1 INT.", type:'passive', effect:(s)=>s.int+=1 },
    medic: { name: "Medic", desc: "Permanent +1 STR.", type:'passive', effect:(s)=>s.str+=1 },
    holy_aura: { name: "Holy Aura", desc: "Gain 20G every turn.", type:'passive' }
};

// [06] DATA: ITEMS & DECKS
// =================================================================
function generateTreasureDeck() {
    const deck = [];
    const itemNames = ["Sword", "Shield", "Helm", "Armor", "Wand", "Staff", "Bow", "Dagger", "Boots", "Gloves", "Ring", "Amulet", "Cloak", "Belt"];
    const slots = ['main', 'off', 'head', 'body', 'main', 'main', 'main', 'main', 'body', 'body', 'off', 'head', 'body', 'body'];
    const stats = ['str', 'str', 'str', 'str', 'int', 'int', 'dex', 'dex', 'dex', 'dex', 'int', 'int', 'dex', 'str'];
    const abilities = Object.keys(ABILITY_LIBRARY);

    // Gold, Common, Magic, Rare, Legendary, Consumables
    for(let i=0; i<20; i++) deck.push({ id: `g${i}`, name: "Pouch of Gold", type: 'scroll', rarity: 'common', cost: 0, desc: "Gain 50 Gold", fn: (p) => { p.gold += 50; addLog("+50 Gold", "log-gold"); updateHUD(); } });
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; deck.push({ id: `c${i}`, name: `Old ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: {}, rarity: 'common', cost: 50 }); }
    for(let i=0; i<20; i++) { const idx = i % itemNames.length; const b={}; b[stats[idx]]=1; deck.push({ id: `m${i}`, name: `Magic ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'rare', cost: 200 }); }
    for(let i=0; i<20; i++) {
        const idx = i % itemNames.length; const b={}; b[stats[idx]]=2;
        const abil = ABILITY_LIBRARY[abilities[i % abilities.length]];
        deck.push({ id: `r${i}`, name: `Ancient ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'epic', cost: 500, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } });
    }
    for(let i=0; i<10; i++) {
        const idx = i % itemNames.length; const b={}; b[stats[idx]]=3;
        const abil = ABILITY_LIBRARY[abilities[(i+10) % abilities.length]];
        deck.push({ id: `l${i}`, name: `Legendary ${itemNames[idx]}`, type: 'equip', slot: slots[idx], bonus: b, rarity: 'legendary', cost: 1200, ability: { name: abil.name, type: abil.type || 'active', desc: abil.desc, fn: abil.fn } });
    }
    deck.push({ id: 's1', name: "Town Portal", type: 'scroll', rarity: 'rare', cost: 100, desc: "Teleport to Inn", fn: ABILITY_LIBRARY.teleport.fn });
    deck.push({ id: 's2', name: "Potion of Healing", type: 'scroll', rarity: 'common', cost: 50, desc: "Cure status", fn: ABILITY_LIBRARY.heal.fn });
    deck.push({ id: 's3', name: "Sprint Scroll", type: 'scroll', rarity: 'common', cost: 50, desc: "Dash 3 spaces", fn: ABILITY_LIBRARY.dash.fn });
    deck.push({ id: 's4', name: "Transmute Scroll", type: 'scroll', rarity: 'epic', cost: 300, desc: "Item to Gold", fn: ABILITY_LIBRARY.transmute.fn });
    for(let i=4; i<10; i++) deck.push({ id: `s${i}`, name: "Lucky Coin", type: 'scroll', rarity: 'common', cost: 50, desc: "Gain 20-100G", fn: ABILITY_LIBRARY.gamble.fn });

    return deck;
}

const DECK_TREASURE = generateTreasureDeck();
const DECK_ENCOUNTER = [
    // STR/DEX
    {name:"Goblin Ambush", type:'combat', desc:"Goblins jump from the trees!", choices:[{txt:"Power Through (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Dodge & Counter (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bar Fight", type:'combat', desc:"A drunk patron swings a stool at you.", choices:[{txt:"Punch Back (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Weave Away (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Wolf Pack", type:'combat', desc:"Hungry wolves circle you.", choices:[{txt:"Intimidate (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:20}, {txt:"Quick Strikes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Rogue Duelist", type:'combat', desc:"He challenges you to a duel.", choices:[{txt:"Overpower (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80}, {txt:"Parry (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Rocks", type:'check', desc:"A landslide! React fast!", choices:[{txt:"Hold it up (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Dive (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40}]},
    {name:"Mud Pit", type:'check', desc:"You are stuck in thick mud.", choices:[{txt:"Pull Out (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture', val:30},{txt:"Balance Out (DEX 5+)", stat:'dex', tn:5, fail:40, mode:'capture', val:80}]},
    {name:"Giant Spider", type:'combat', desc:"It descends on a silk thread.", choices:[{txt:"Smash It (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture'},{txt:"Roll Away (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture'}]},
    {name:"Bear Trap", type:'check', desc:"SNAP! Your leg is caught.", choices:[{txt:"Pry Open (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:50},{txt:"Pick Lock (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Wild Boar", type:'combat', desc:"It charges from the brush.", choices:[{txt:"Wrestle (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Matador Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:40}]},
    {name:"Falling Chandelier", type:'check', desc:"The chain snaps above you!", choices:[{txt:"Catch It (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Jump Away (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20}]},
    {name:"Runaway Cart", type:'check', desc:"It's rolling down the hill towards town.", choices:[{txt:"Stop it (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Jump on & Steer (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Training Dummy", type:'combat', desc:"A magically animated sparring partner.", choices:[{txt:"Heavy Hit (STR 3+)", stat:'str', tn:3, fail:20, mode:'capture'},{txt:"Precision (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture'}]},
    {name:"Bee Swarm", type:'combat', desc:"Not the bees! They are everywhere!", choices:[{txt:"Swat Wildly (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Outrun (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:30}]},
    {name:"Arm Wrestling", type:'check', desc:"A dwarf challenges you.", choices:[{txt:"Brute Force (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:100},{txt:"Technique (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Bandit Toll", type:'check', desc:"They block the bridge.", choices:[{txt:"Shove Aside (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Slip Past (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'}]},
    {name:"Greased Pig", type:'check', desc:"Catch the prize pig at the fair.", choices:[{txt:"Tackle (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:60},{txt:"Snatch (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:90}]},
    {name:"Crumbling Floor", type:'check', desc:"The wood gives way beneath you.", choices:[{txt:"Hang on (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture', val:20},{txt:"Leap (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50}]},

    // DEX/INT
    {name:"Arcane Trap", type:'check', desc:"Runes glow on the floor.", choices:[{txt:"Disarm (DEX 5+)", stat:'dex', tn:5, fail:60, mode:'capture', val:100},{txt:"Dispel (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:50}]},
    {name:"Pickpocket", type:'check', desc:"A thief bumps into you.", choices:[{txt:"Grab Him (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Predict Path (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Locked Gate", type:'check', desc:"An ancient mechanism blocks the way.", choices:[{txt:"Climb Over (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Solve Puzzle (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Illusionist", type:'combat', desc:"Copies of the wizard surround you.", choices:[{txt:"Strike True (DEX 5+)", stat:'dex', tn:5, fail:50, mode:'capture', val:80},{txt:"See Truth (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Arrow Storm", type:'combat', desc:"Arrows fly from the bushes.", choices:[{txt:"Dodge (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture'},{txt:"Shield Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Card Game", type:'check', desc:"A high stakes game at a tavern.", choices:[{txt:"Sleight of Hand (DEX 5+)", stat:'dex', tn:5, fail:100, mode:'capture', val:200},{txt:"Count Cards (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:100}]},
    {name:"Poison Gas", type:'check', desc:"Green mist fills the room.", choices:[{txt:"Hold Breath & Run (DEX 3+)", stat:'dex', tn:3, fail:30, mode:'capture', val:40},{txt:"Identify Antidote (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:120}]},
    {name:"Sphinx", type:'combat', desc:"It demands an answer or your life.", choices:[{txt:"Run Past (DEX 5+)", stat:'dex', tn:5, fail:80, mode:'capture'},{txt:"Answer Riddle (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:50}]},
    {name:"Shell Game", type:'check', desc:"A street scammer challenges you.", choices:[{txt:"Fast Eyes (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:80},{txt:"Calculate (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:80}]},
    {name:"Mimic", type:'combat', desc:"The chest has teeth!", choices:[{txt:"Reflex Stab (DEX 4+)", stat:'dex', tn:4, fail:40, mode:'capture', val:50},{txt:"Identify (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Singing Contest", type:'check', desc:"Perform for the crowd.", choices:[{txt:"Dance (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture', val:60},{txt:"Compose Lyrics (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Flying Book", type:'check', desc:"A spellbook flutters away.", choices:[{txt:"Catch It (DEX 4+)", stat:'dex', tn:4, fail:20, mode:'capture', val:50},{txt:"Summon It (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:50}]},
    {name:"Tripwire", type:'check', desc:"A thin wire spans the path.", choices:[{txt:"Cut Carefully (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:30},{txt:"Analyze Mechanism (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:30}]},
    {name:"Fey Prank", type:'combat', desc:"A pixie steals your boots.", choices:[{txt:"Chase (DEX 5+)", stat:'dex', tn:5, fail:30, mode:'capture', val:40},{txt:"Trick It Back (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:60}]},
    {name:"Lost in Woods", type:'check', desc:"The path has vanished.", choices:[{txt:"Climb Tree (DEX 3+)", stat:'dex', tn:3, fail:20, mode:'capture', val:20},{txt:"Navigate Stars (INT 4+)", stat:'int', tn:4, fail:20, mode:'capture', val:40}]},
    {name:"Clockwork Toy", type:'combat', desc:"A mechanical soldier malfunctions.", choices:[{txt:"Disable (DEX 4+)", stat:'dex', tn:4, fail:30, mode:'capture'},{txt:"Reprogram (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},
    {name:"Alchemy Accident", type:'check', desc:"A potion is about to explode.", choices:[{txt:"Throw it (DEX 4+)", stat:'dex', tn:4, fail:50, mode:'capture', val:40},{txt:"Neutralize (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:100}]},

    // STR/INT
    {name:"Stone Golem", type:'combat', desc:"Slow but incredibly tough.", choices:[{txt:"Shatter (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:80},{txt:"Find Weakness (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Cursed Armor", type:'combat', desc:"An animated suit of armor attacks.", choices:[{txt:"Bash (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture'},{txt:"Banish Spirit (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture'}]},
    {name:"Rusted Portcullis", type:'check', desc:"The gate is heavy and stuck.", choices:[{txt:"Lift (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:50},{txt:"Leverage (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:40}]},
    {name:"Orc Shaman", type:'combat', desc:"He channels lightning.", choices:[{txt:"Rush Him (STR 4+)", stat:'str', tn:4, fail:50, mode:'capture', val:30},{txt:"Counterspell (INT 5+)", stat:'int', tn:5, fail:60, mode:'capture', val:80}]},
    {name:"Magic Sword", type:'check', desc:"A sword stuck in a stone.", choices:[{txt:"Pull (STR 6+)", stat:'str', tn:6, fail:50, mode:'capture', val:200},{txt:"Arcane Release (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:150}]},
    {name:"Drunken Giant", type:'combat', desc:"He creates a mess in the tavern.", choices:[{txt:"Wrestle (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Outsmart (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture', val:30}]},
    {name:"Haunted House", type:'combat', desc:"Furniture is flying everywhere.", choices:[{txt:"Smash Furniture (STR 3+)", stat:'str', tn:3, fail:30, mode:'capture'},{txt:"Exorcise (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:50}]},
    {name:"Collapsed Mine", type:'check', desc:"Rubble blocks the gold vein.", choices:[{txt:"Dig (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:60},{txt:"Engineer Support (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:60}]},
    {name:"Crystal Guardian", type:'combat', desc:"Made of resonating crystal.", choices:[{txt:"Smash (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture', val:70},{txt:"Sonic Resonance (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Frozen Door", type:'check', desc:"Ice seals the vault.", choices:[{txt:"Kick Open (STR 5+)", stat:'str', tn:5, fail:40, mode:'capture', val:60},{txt:"Melt Spell (INT 3+)", stat:'int', tn:3, fail:20, mode:'capture', val:30}]},
    {name:"Possessed Bear", type:'combat', desc:"Glowing purple eyes stare at you.", choices:[{txt:"Subdue (STR 5+)", stat:'str', tn:5, fail:60, mode:'capture'},{txt:"Cleansing Ritual (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Sinking Boat", type:'check', desc:"Taking on water fast!", choices:[{txt:"Bail Water (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture', val:30},{txt:"Repair Hull (INT 4+)", stat:'int', tn:4, fail:30, mode:'capture', val:50}]},
    {name:"Statue Puzzle", type:'check', desc:"Heavy statues must be arranged.", choices:[{txt:"Push Them (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture', val:60},{txt:"Solve Order (INT 4+)", stat:'int', tn:4, fail:50, mode:'capture', val:60}]},
    {name:"Magical Barrier", type:'check', desc:"A forcefield blocks the loot.", choices:[{txt:"Hit Hard (STR 6+)", stat:'str', tn:6, fail:80, mode:'capture', val:150},{txt:"Counter-Frequency (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:80}]},
    {name:"Entangled Roots", type:'combat', desc:"Vines grab your legs.", choices:[{txt:"Rip Free (STR 4+)", stat:'str', tn:4, fail:30, mode:'capture'},{txt:"Wither Spell (INT 3+)", stat:'int', tn:3, fail:30, mode:'capture'}]},
    {name:"Library Fire", type:'check', desc:"Save the ancient scrolls!", choices:[{txt:"Carry Water (STR 4+)", stat:'str', tn:4, fail:40, mode:'capture', val:70},{txt:"Frost Spell (INT 4+)", stat:'int', tn:4, fail:40, mode:'capture', val:70}]},
    {name:"Gargoyle", type:'combat', desc:"Stone turns to flesh.", choices:[{txt:"Break Wings (STR 5+)", stat:'str', tn:5, fail:50, mode:'capture'},{txt:"Command Word (INT 5+)", stat:'int', tn:5, fail:50, mode:'capture', val:100}]},

    // SHOPS/PAY
    {name:"Merchant", type:'shop', desc:"A traveling merchant appears."},
    {name:"Tax Collector", type:'pay', cost:50, desc:"Pay your taxes."},
    {name:"Toll Bridge", type:'pay', cost:30, desc:"Pay the toll."},
    {name:"Peddler", type:'shop', desc:"Cheap wares for sale."},
    {name:"Pickpocket", type:'pay', cost:60, desc:"Your purse is lighter."},
    {name:"Charity", type:'pay', cost:20, desc:"Alms for the poor."}
];

const DECK_SKIRMISH = [
    // STR/DEX (Bosses)
    {name:"Assassin Lord", type:'combat', desc:"Fast and deadly.", choices:[{txt:"Crush Him (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Match Speed (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Hydra", type:'combat', desc:"Heads regrow as you cut them.", choices:[{txt:"Sever Heads (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Dance Around (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Blade Gauntlet", type:'check', desc:"A hallway of swinging scythes.", choices:[{txt:"Block & Move (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:150},{txt:"Acrobatics (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:150}]},
    {name:"Dragon Turtle", type:'combat', desc:"An armored beast of the deep.", choices:[{txt:"Crack Shell (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:100},{txt:"Aim for Eyes (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50}]},
    {name:"Chimera", type:'combat', desc:"Lion, Goat, and Snake heads attack.", choices:[{txt:"Hold Heads (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Dodge Breath (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Collapsing Temple", type:'check', desc:"The roof is coming down!", choices:[{txt:"Hold Pillar (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Parkour Out (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Dragon Rider", type:'combat', desc:"An elite knight on a drake.", choices:[{txt:"Knock Off (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Aerial Battle (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Sandworm", type:'combat', desc:"It bursts from the ground.", choices:[{txt:"Wrestle Maw (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Ride It (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:300}]},
    {name:"Blade Master", type:'combat', desc:"He wields six swords.", choices:[{txt:"Parry All (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Riposte (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Tsunami", type:'check', desc:"A massive wave approaches.", choices:[{txt:"Anchor Self (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Climb High (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Juggernaut", type:'combat', desc:"An unstoppable armored charger.", choices:[{txt:"Stop Momentum (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Trip Him (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Invisible Stalker", type:'combat', desc:"You can hear it breathing.", choices:[{txt:"Flail Wildly (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture'},{txt:"React to Sound (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Gladiator Pit", type:'combat', desc:"You are thrown into the arena.", choices:[{txt:"Survive (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flourish (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:250}]},

    // DEX/INT (Bosses)
    {name:"Lich King", type:'combat', desc:"Master of death magic.", choices:[{txt:"Dodge Spells (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Duel Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Mirror Maze", type:'check', desc:"Reflections confuse you.", choices:[{txt:"Wall Jump (DEX 6+)", stat:'dex', tn:6, req:1, fail:100, mode:'capture', val:200},{txt:"Deduce Path (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Void Stalker", type:'combat', desc:"It phases out of reality.", choices:[{txt:"Reaction Shot (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:80},{txt:"Predict Phase (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:80}]},
    {name:"Ancient Vault", type:'check', desc:"The lock of the gods.", choices:[{txt:"Legendary Pick (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:300},{txt:"Dispel Ward (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Time Loop", type:'check', desc:"You are reliving this moment.", choices:[{txt:"Break Cycle (DEX 6+)", stat:'dex', tn:6, req:2, fail:100, mode:'capture', val:200},{txt:"Unravel Spell (INT 6+)", stat:'int', tn:6, req:2, fail:100, mode:'capture', val:300}]},
    {name:"Lich's Phylactery", type:'check', desc:"The source of his power.", choices:[{txt:"Steal It (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Disenchant (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Psychic Storm", type:'check', desc:"Bolts of mental energy rain down.", choices:[{txt:"Dodge Bolts (DEX 5+)", stat:'dex', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Mental Shield (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:100}]},
    {name:"Laser Grid", type:'check', desc:"Deadly beams block the treasure.", choices:[{txt:"Gymnastics (DEX 6+)", stat:'dex', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Hack Terminal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Doppelganger", type:'combat', desc:"It knows your every move.", choices:[{txt:"Reflex Duel (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Logic Paradox (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Clockwork Dragon", type:'combat', desc:"A masterpiece of destruction.", choices:[{txt:"Jam Gears (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:120},{txt:"Override Code (INT 6+)", stat:'int', tn:6, req:2, fail:120, mode:'capture', val:220}]},
    {name:"Poisoned Banquet", type:'check', desc:"The King is dying!", choices:[{txt:"Sleight of Hand (DEX 6+)", stat:'dex', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Mix Antidote (INT 5+)", stat:'int', tn:5, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Floating Island", type:'check', desc:"The bridge has crumbled away.", choices:[{txt:"Parkour Gaps (DEX 5+)", stat:'dex', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Flight Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Shadow Master", type:'combat', desc:"He attacks from the dark.", choices:[{txt:"Counter-Strike (DEX 6+)", stat:'dex', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Light Spell (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:120}]},

    // STR/INT (Bosses)
    {name:"Demon Gate", type:'check', desc:"Demons pour from the portal.", choices:[{txt:"Bar the Gate (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:250},{txt:"Close Portal (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Iron Golem", type:'combat', desc:"Impervious to normal weapons.", choices:[{txt:"Topple (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:50},{txt:"Rust Spell (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:200}]},
    {name:"Vampire Lord", type:'combat', desc:"Ancient and powerful.", choices:[{txt:"Drive Stake (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Holy Light (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Obelisk", type:'check', desc:"A fallen monument blocks the road.", choices:[{txt:"Heave (STR 6+)", stat:'str', tn:6, req:1, fail:100, mode:'capture', val:150},{txt:"Levitate (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},
    {name:"Volcano Eruption", type:'check', desc:"Lava flows towards the village.", choices:[{txt:"Divert Flow (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Freeze Magma (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"Titan", type:'combat', desc:"A giant as tall as a mountain.", choices:[{txt:"Leg Sweep (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Banishment (INT 6+)", stat:'int', tn:6, req:2, fail:200, mode:'capture', val:300}]},
    {name:"Necropolis Gate", type:'check', desc:"Sealed by blood magic.", choices:[{txt:"Break It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Holy Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Living Wall", type:'combat', desc:"The bricks try to crush you.", choices:[{txt:"Smash Bricks (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:100},{txt:"Command Word (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:100}]},
    {name:"Storm Giant", type:'combat', desc:"He throws lightning bolts.", choices:[{txt:"Arm Wrestle (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Lightning Rod (INT 5+)", stat:'int', tn:5, req:2, fail:120, mode:'capture', val:150}]},
    {name:"Void Rift", type:'check', desc:"Reality is tearing apart.", choices:[{txt:"Force Closed (STR 6+)", stat:'str', tn:6, req:2, fail:200, mode:'capture', val:300},{txt:"Seal Magic (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:300}]},
    {name:"Cursed Tree", type:'combat', desc:"It drains life from the land.", choices:[{txt:"Uproot (STR 6+)", stat:'str', tn:6, req:2, fail:120, mode:'capture', val:150},{txt:"Purify Root (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Meat Grinder", type:'check', desc:"A room of spinning blades.", choices:[{txt:"Jam Gears (STR 5+)", stat:'str', tn:5, req:2, fail:100, mode:'capture', val:150},{txt:"Shutdown (INT 5+)", stat:'int', tn:5, req:2, fail:100, mode:'capture', val:150}]},
    {name:"Abyssal Horror", type:'combat', desc:"Madness given form.", choices:[{txt:"Crush It (STR 6+)", stat:'str', tn:6, req:2, fail:150, mode:'capture', val:200},{txt:"Mind Blast (INT 6+)", stat:'int', tn:6, req:2, fail:150, mode:'capture', val:250}]},
    {name:"King of the Hill", type:'combat', desc:"An Orc Warlord challenges you.", choices:[{txt:"Throw Off (STR 5+)", stat:'str', tn:5, req:2, fail:80, mode:'capture', val:100},{txt:"Tactics (INT 5+)", stat:'int', tn:5, req:2, fail:80, mode:'capture', val:120}]},

    // Rare Shops
    {name:"Black Market", type:'shop', rare:true, desc:"Forbidden goods."},
    {name:"Void Trader", type:'shop', rare:true, desc:"Items from beyond."},
    {name:"Dragon Hoard", type:'shop', rare:true, desc:"Ancient treasures."}
];

// [07] DATA: LOCATIONS (TILES)
// =================================================================
const LOCATIONS = [
    {name:"Old Crooks Inn",type:"start",cost:0,color:"#4ade80",img:"https://static.wixstatic.com/media/b16479_b4d35a4270574b5380497c6eb27146bd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a353cedcf17c4b618027f64190b6be73~mv2.jpg",flavor:"A warm hearth greets you, smelling of roasted meat and ale. Rough laughter fills the air as adventurers swap stories of their latest conquests."},
    {name:"Rat Cellar",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_7981e4bf2a9f42fca2ba9335a79b6315~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1f9645c758e8451c90e7d733f2bc5057~mv2.jpg",flavor:"Squeaking echoes from the damp shadows of this musty basement. Red eyes watch you from the cracks."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_2a0e4f70b29e4611927b65c33fce86f4~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"The dirt here has been recently disturbed. You spot the corner of a wooden box protruding from the mud."},
    {name:"Wolf Den",type:"combat",cost:60,tn:3,req:1,color:"#9ca3af",img:"https://static.wixstatic.com/media/b16479_4318c9bb74dd48ddbe8702ec17a059dd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e2baedb53b944da923cc49f6dcce0ff~mv2.jpg",flavor:"Gnawed bones litter the entrance to this dark cave. A low growl reverberates from the shadows."},
    {name:"Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_b2ff79acb9db40c1b8e230e2b43f2a53~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3671f830191345c1b8a315017da72a5b~mv2.jpg",flavor:"The King's tax collectors block the road with their armored carriage. Pay up or face the dungeon."},
    {name:"Stable",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_63e31ea7ac144c2c8086342125a30877~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_f660a75ab6284f56b2c90f4f221f53a3~mv2.jpg",flavor:"The smell of hay and horses is strong here. A merchant offers fresh mounts to speed your journey."},
    {name:"Goblin Camp",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_1d0dc90e90e04783a2cd04823ccf9255~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c48e6fdf163d4dd68b411d5674de6b4b~mv2.jpg",flavor:"Crude tents made of animal skins dot the clearing. You hear the chaotic chatter of goblins."},
    {name:"Fairy Ring",type:"check",tn:4,req:1,reward:100,cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_1437cc54895e4595a43f461ed959c5ce~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_65c314c4ef784a58b9b162d4d30b1698~mv2.jpg",flavor:"A circle of mushrooms glows with a soft, unnatural light. Stepping inside feels like leaving the world behind."},
    {name:"Bandit Road",type:"combat",cost:100,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_5101a6720f074efcb628b70b85bcdac6~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_6364e428d9504a139a2c56e1e168eb3d~mv2.jpg",flavor:"This stretch of road is suspiciously quiet. Broken wagon wheels suggest travelers often meet a grim fate here."},
    {name:"Ogre Cave",type:"combat",cost:120,tn:4,req:1,color:"#84cc16",img:"https://static.wixstatic.com/media/b16479_778f6cf396474b47835aa4e8c103bffd~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d5dcf031b6c24893b00b8fa6d0145eca~mv2.jpg",flavor:"A massive boulder blocks the wind, but not the smell of rotting meat. Something very large calls this home."},
    {name:"Dungeon",type:"jail",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_a259ef3e7d8c4c09a88aea824537e57b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_117e17f3d5b84577beb01fcca1cddad9~mv2.jpg",flavor:"Cold iron bars and damp stone walls surround you. It is a place of despair and lost time."},
    {name:"Crypt",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_c230f43aefe64d898b4d2dfe91ad0ba0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_eb64132a865f440c97f6652e340cbb05~mv2.jpg",flavor:"The air is stale and smells of dust and decay. Ancient sarcophagi line the walls. The dead do not sleep easily here."},
    {name:"Mana Well",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_e2c1dbc5f8f64a988893a00b0cd6f066~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_90031776e646488c93f69cc6461d9333~mv2.jpg",flavor:"Pure arcane energy bubbles up from the earth in a glowing blue spring. Wizards travel miles just to glimpse it."},
    {name:"Witch Hut",type:"combat",cost:140,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_6d223ad95ed04eea8a963cf5b3596e35~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b095b71e60ff4619833aa4b45bc7795d~mv2.jpg",flavor:"A crooked shack stands on chicken legs in the swamp. Green smoke billows from the chimney."},
    {name:"Graveyard",type:"combat",cost:160,tn:4,req:2,color:"#475569",img:"https://static.wixstatic.com/media/b16479_d7da23aa207b4549b9cd245959d69e6e~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8ae524f80b344def99ec6833ea717083~mv2.jpg",flavor:"Fog clings to the tilted headstones of this forgotten cemetery. The ground feels soft, as if something is trying to claw its way out."},
    {name:"Port",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_bc4d708aeb394233b697b148d0d33dc7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7403c140a66345be8cb9a8eb5b0ebc99~mv2.jpg",flavor:"The cry of seagulls and the crash of waves welcome you. Ships from distant lands unload exotic cargo on the docks."},
    {name:"Orc Fort",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_c529b3b0e6c7410989ac654ae3f8cac7~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_dc2c9a5dfd124ef6b8320451e5359218~mv2.jpg",flavor:"Jagged wooden spikes surround a fortified encampment. War drums beat a steady rhythm that shakes the ground."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_9bfca911c8764f158b066493eae2bc81~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"An ornate iron-bound chest sits half-buried in the dirt. The lock looks rusty but the wood is sound."},
    {name:"Troll Bridge",type:"combat",cost:180,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_249a86b0e4f4415ba0a9be35119eb43a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e9e3392a6a44f8291b357aacf04aef8~mv2.jpg",flavor:"A massive stone bridge spans the rushing river below. A hulking figure demands a toll from anyone wishing to cross."},
    {name:"Wyvern Peak",type:"combat",cost:200,tn:5,req:1,color:"#b91c1c",img:"https://static.wixstatic.com/media/b16479_f91826c1558c493ba71c3a2c0a05ff71~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_d3f9c5b8ba2c4ef2998dd9bd6d2ac062~mv2.jpg",flavor:"The air is thin and cold up on this jagged mountain spire. Screeches echo from the clouds as winged shadows circle above."},
    {name:"Capital City",type:"park",cost:0,color:"#e2e8f0",img:"https://static.wixstatic.com/media/b16479_e5d51e21d1d84a009b8845a522bb5d23~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_909eefa9a23646b2825e2f3819031b90~mv2.jpg",flavor:"The white walls of the capital gleam in the sunlight. Guards in polished armor patrol the streets. Here, the King's law is absolute."},
    {name:"Lava Pits",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_799f54f3baaf47d3a6917ae7c8efb12a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_7672054ca2e14a6c95d9151543aaba1d~mv2.jpg",flavor:"The heat is unbearable as magma bubbles to the surface. Sulfurous fumes burn your lungs and obscure your vision."},
    {name:"Dark Altar",type:"combat",cost:200,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_3616e7911ae547e8aaf64dd76e7610b8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_333c76fdd88842199ab18801646ddbbe~mv2.jpg",flavor:"Bloodstains mar the surface of this obsidian slab. Whispers in an unknown tongue fill your mind with dread."},
    {name:"Demon Gate",type:"combat",cost:220,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_0738c43cfb574de79bdf4dd84c0a663b~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_cf022d5d1c264836aade5ffa21a5e77c~mv2.jpg",flavor:"A tear in reality reveals a landscape of fire and torment. Horrors try to claw their way through the barrier."},
    {name:"Dragon Tooth",type:"combat",cost:240,tn:5,req:2,color:"#7f1d1d",img:"https://static.wixstatic.com/media/b16479_aadde8877c854d8fa78d286c00699f7c~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_e373bec825124ac98094938d17fcf71b~mv2.jpg",flavor:"This jagged rock formation looks like the maw of a beast. Legends say an ancient dragon died here, cursing the land."},
    {name:"Airship",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_be49c909366540c8a0b017661cc63e51~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_b79ed0dec9104e64a3180a7683ea3fce~mv2.jpg",flavor:"A massive vessel floats tethered to a high tower. The crew shouts orders as they prepare for departure. The sky is the limit."},
    {name:"Lich Tower",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_7bf555b6dc624c4f9523e3faab71a7c8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2e1c7a754fa84bfd8523c85fd1d415f8~mv2.jpg",flavor:"A spire of black stone pierces the sky, radiating necromantic energy. The master of this tower conquered death long ago."},
    {name:"Vampire Manor",type:"combat",cost:260,tn:6,req:1,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_20a15d19b6424e22bc444a5e1ee7a994~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c3cc7bb80938445bb99b8f38f2c91ca1~mv2.jpg",flavor:"An elegant gothic mansion sits atop a lonely hill. The windows are dark, but you feel eyes watching you."},
    {name:"Shrine",type:"util",cost:150,color:"#3b82f6",img:"https://static.wixstatic.com/media/b16479_b4682e4fcd6f4dc0b127326528fe97a8~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_c90b252d420f4e84ac0340d4555fbdc8~mv2.jpg",flavor:"A humble statue stands covered in vines and offerings. A sense of peace washes over you, healing your spirit."},
    {name:"Giant's Keep",type:"combat",cost:280,tn:6,req:2,color:"#581c87",img:"https://static.wixstatic.com/media/b16479_eb69b5762c8043cc827fd2c0bad0e45a~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_1e0fcc1de9b844359e778231ea7cc1a3~mv2.jpg",flavor:"Massive stone blocks form a fortress that reaches the clouds. You feel like an ant in this place."},
    {name:"Go To Dungeon",type:"goto",cost:0,color:"#fb923c",img:"https://static.wixstatic.com/media/b16479_33036f2decd74835b1a323a8bfd08ef3~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a212ee172c0c4df5a2cb3ccc22653f50~mv2.jpg",flavor:"The city guards have caught you red-handed! You are shackled and dragged away without trial."},
    {name:"Cloud Castle",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_1d74349092e741eda4d34f735125ce72~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_ddb8d1cc6af442348847805aaf261ae5~mv2.jpg",flavor:"A fortress floats effortlessly among the clouds. Harps play soft music, and the air tastes sweet."},
    {name:"Titan's Grip",type:"combat",cost:300,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_0b5cf76a120a45c8b5da8d2d6da2fa62~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_a091ec8e8f164723b44457bc878dedeb~mv2.jpg",flavor:"Two massive stone hands rise from the earth, clutching a valley. The pressure here is immense."},
    {name:"Chest",type:"chest",cost:0,color:"#fcd34d",img:"https://static.wixstatic.com/media/b16479_5624f6d69ac6404e9aede7d4dd5f4d47~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_87f60295a50d4881bc95f728314e37fb~mv2.jpg",flavor:"A grand chest reinforced with steel bands sits in the open. The latch is broken, inviting you to look inside."},
    {name:"Void Edge",type:"combat",cost:320,tn:6,req:2,color:"#0f172a",img:"https://static.wixstatic.com/media/b16479_9eb9e98ea6084dccbe4e57fdcc525324~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_3e59b7d985d84b9688c33ea51322875c~mv2.jpg",flavor:"The world seems to end here, dropping off into nothingness. Stars shine brightly below you in the abyss."},
    {name:"Portal",type:"shop",cost:200,color:"#78350f",img:"https://static.wixstatic.com/media/b16479_062be0c2c7a3459b87645b4f86c8bfd0~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_aa482a0a26e94d6a9754eee718278aa1~mv2.jpg",flavor:"A swirling vortex of purple energy stands before you. It promises travel to distant lands in the blink of an eye."},
    {name:"Smuggler Cove",type:"shop",cost:0,color:"#a855f7",img:"https://static.wixstatic.com/media/b16479_70c52b2f88864f7ca3f568cf44a3ad70~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_401a126718a64763924ed8ad5314899d~mv2.jpg",flavor:"A hidden cave by the sea hides illicit goods. Pirates and thieves trade secrets in hushed tones."},
    {name:"Royal Palace",type:"combat",cost:350,tn:6,req:3,color:"#fbbf24",img:"https://static.wixstatic.com/media/b16479_6434230067414f34a341a95383fe7896~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_8d01f5e2e59a4244a4101efb92c77487~mv2.jpg",flavor:"The seat of power in the realm, draped in gold and velvet. Nobles scheme in the corridors while the King sits upon his throne."},
    {name:"Luxury Tax",type:"tax",cost:0,color:"#f87171",img:"https://static.wixstatic.com/media/b16479_9b58c85963434fb3abe9ecfb4b114c67~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_2513d4cb760246f69570e8f7eb040a39~mv2.jpg",flavor:"The Crown demands a tribute for your continued prosperity. Jewelry and fine clothes make you a target for the taxman."},
    {name:"Ancient Vault",type:"combat",cost:400,tn:6,req:3,color:"#000000",img:"https://static.wixstatic.com/media/b16479_b8a71205363745b7ad11f72ca6ca30b2~mv2.jpg",cardImg:"https://static.wixstatic.com/media/b16479_0e78493512ad4e559cd6392a9341ddad~mv2.jpg",flavor:"Massive steel doors guard the greatest treasure in the realm. Traps and guardians wait for the foolish."}
];

// [08] ENGINE: INITIALIZATION
// =================================================================
function init() {
    scene = new THREE.Scene(); 
    
    // Day Color & Fog Settings
    const fogColor = 0xcccccc; 
    scene.background = new THREE.Color(fogColor); 
   // scene.fog = new THREE.Fog(fogColor, 90, 150);
    
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000); 
    
    // --- UPDATED: TOP-DOWN VIEW START ---
    // Position High up (Y=100), Centered (X=0), and a tiny offset on Z (0.1)
    // The tiny Z offset prevents "Gimbal Lock" where OrbitControls might get stuck.
    camera.position.set(0, 55, 0.1); 
    camera.lookAt(0,0,0);
    // --- UPDATED END ---
    
    renderer = new THREE.WebGLRenderer({antialias:true}); 
    renderer.setSize(window.innerWidth, window.innerHeight); 
    renderer.shadowMap.enabled = true;
    document.getElementById('game-layer').appendChild(renderer.domElement);
    
    const amb = new THREE.AmbientLight(0xffffff, 0.6); 
    scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffd700, 0.8); 
    dir.position.set(30,40,20); 
    dir.castShadow = true; 
    scene.add(dir);
    
    controls = new THREE.OrbitControls(camera, renderer.domElement); 
    controls.enableDamping = true; 
    controls.dampingFactor = 0.05;
    
    // --- UPDATED: PANNING START ---
    // screenSpacePanning: true makes the camera pan like a flat map (Left/Right/Up/Down)
    // instead of tilting the camera when you drag.
    controls.screenSpacePanning = true; 
    // --- UPDATED END ---

    controls.minDistance = 20; 
    controls.maxDistance = 150; 
    controls.maxPolarAngle = Math.PI/2 - 0.1; // Prevents going below ground

    window.addEventListener('resize', onWindowResize, false);

    createEnvironment(); 
    createBoard(); 
    createDecks(); 
    setupCreationUI(); 
    setupEquipDragDrop();
    animate();
}

function animate(){ 
    requestAnimationFrame(animate); 
    TWEEN.update(); 
    if(controls) controls.update(); 
    renderer.render(scene,camera); 
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

// [09] ENGINE: ASSETS & ENV
// =================================================================
function createTileTexture(name, cStr, cost) {
    const c = document.createElement('canvas'); 
    c.width = 256; c.height = 256; 
    const ctx = c.getContext('2d');
    
    // Background & Noise
    ctx.fillStyle = cStr; ctx.fillRect(0, 0, 256, 256);
    ctx.fillStyle = "rgba(0,0,0,0.1)"; 
    for(let i=0; i<50; i++) ctx.fillRect(Math.random()*256, Math.random()*256, 10, 10);
    
    // Name Box
    ctx.fillStyle = "#fff"; ctx.fillRect(10, 10, 236, 40); ctx.strokeRect(10, 10, 236, 40);
    ctx.fillStyle = "#000"; ctx.font = "bold 20px sans-serif"; 
    ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
    ctx.fillText(name, 128, 30);
    
    // Price Box
    if(cost > 0) {
        ctx.fillStyle = "#fbbf24"; ctx.fillRect(80, 210, 96, 30); ctx.strokeRect(80, 210, 96, 30);
        ctx.fillStyle = "#000"; ctx.fillText(cost + " G", 128, 225);
    }
    return new THREE.CanvasTexture(c);
}

function createGrassTexture() { 
    const c=document.createElement('canvas'); c.width=512; c.height=512; 
    const ctx=c.getContext('2d'); ctx.fillStyle="#14532d"; ctx.fillRect(0,0,512,512); 
    for(let i=0;i<2000;i++){ctx.fillStyle=Math.random()>0.5?"#166534":"#15803d";ctx.fillRect(Math.random()*512,Math.random()*512,3,3);} 
    const t=new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(8,8); return t; 
}

function createEnvironment() { 
    // Ground Plane
    const g = new THREE.Mesh(new THREE.PlaneGeometry(600, 600), new THREE.MeshStandardMaterial({map:createGrassTexture()})); 
    g.rotation.x = -Math.PI/2; g.position.y = -0.6; g.receiveShadow = true; 
    scene.add(g); 
    
    // Trees
    for(let i=0; i<400; i++) {
        const rad = 45 + Math.random() * 250;
        const ang = Math.random() * Math.PI * 2;
        const x = Math.cos(ang) * rad; 
        const z = Math.sin(ang) * rad;
        
        // Camera Safezone
        if(z > 30 && x > -20 && x < 20) continue; 

        const t = new THREE.Group();
        const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.8, 2), new THREE.MeshStandardMaterial({color:0x3e2723})); tr.position.y = 1;
        const lv = new THREE.Mesh(new THREE.ConeGeometry(3, 6, 8), new THREE.MeshStandardMaterial({color:0x15803d})); lv.position.y = 4;
        t.add(tr); t.add(lv); t.position.set(x, -0.6, z); t.scale.setScalar(0.8 + Math.random());
        scene.add(t);
    }
}

function createBoard() {
    const loader = new THREE.TextureLoader();
    const boardTex = loader.load('https://static.wixstatic.com/media/b16479_5caac3525f59406d8ff175695ef11cb1~mv2.jpg');
    const board = new THREE.Mesh(new THREE.PlaneGeometry(45, 45), new THREE.MeshStandardMaterial({ map: boardTex }));
    board.rotation.x = -Math.PI / 2; board.position.y = -0.55; board.receiveShadow = true;
    scene.add(board);

    for(let i=0; i<40; i++) {
        const info = LOCATIONS[i];
        let mapTex = (info.img && info.img.length > 0) ? loader.load(info.img) : createTileTexture(info.name, info.color, info.cost);
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(3.8, 0.5, 3.8), new THREE.MeshStandardMaterial({ map: mapTex }));
        
        const side = Math.floor(i/10); const pos = i%10;
        let x=0, z=0, rot=0; const off = 20; const spa = 4;
        
        if(side===0) { x = off - (pos*spa); z = off; rot=0; } 
        else if(side===1) { x = -off; z = off - (pos*spa); rot=-Math.PI/2; }
        else if(side===2) { x = -off + (pos*spa); z = -off; rot=Math.PI; } 
        else { x = off; z = -off + (pos*spa); rot=Math.PI/2; }
        
        if(i===0){x=off;z=off;} 
        mesh.position.set(x, 0, z); mesh.rotation.y = rot; mesh.receiveShadow = true;
        mesh.userData = {id:i, info:info, owner:null, buildingLevel:0}; 
        scene.add(mesh); tiles.push(mesh);
    }
}

function createDecks() {
    const geo = new THREE.BoxGeometry(7.5, 0.15, 10.5);
    const loader = new THREE.TextureLoader();
    const texTreasure = loader.load('https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg');
    const texEncounter = loader.load('https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg');
    const texSkirmish = loader.load('https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg');
    const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff});

    function createMaterials(texture) {
        return [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: texture}), whiteMat, whiteMat, whiteMat];
    }

    normalDeck = new THREE.Group(); 
    const nMats = createMaterials(texEncounter);
    for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, nMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; normalDeck.add(c); }
    normalDeck.position.set(-10, 0, -2); scene.add(normalDeck);
    
    skirmishDeck = new THREE.Group(); 
    const sMats = createMaterials(texSkirmish);
    for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, sMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; skirmishDeck.add(c); }
    skirmishDeck.position.set(10, 0, -2); scene.add(skirmishDeck);
    
    treasureDeck = new THREE.Group(); 
    const tMats = createMaterials(texTreasure);
    for(let i=0; i<5; i++){ let c = new THREE.Mesh(geo, tMats); c.position.y = i * 0.16; c.rotation.y = Math.random() * 0.05; treasureDeck.add(c); }
    treasureDeck.position.set(0, 0, -2); scene.add(treasureDeck);
}

// [10] ENGINE: PLAYER MANAGEMENT
// =================================================================
function spawnPlayer(id, n, r, c, actId, pasId, ai, col) {
    const stats = { str: r.stats.str, dex: r.stats.dex, int: r.stats.int, gold: 1000 };
    const passiveDef = ABILITY_LIBRARY[pasId];
    if (passiveDef && passiveDef.effect) passiveDef.effect(stats);

    // AI ARCHETYPE LOGIC
    // Determine which stat this class prefers (for AI decision making)
    let archetype = 'str';
    if(c.id === 'wizard' || c.id === 'cleric' || r.stats.int > r.stats.str) archetype = 'int';
    else if(c.id === 'rogue' || r.stats.dex > r.stats.str) archetype = 'dex';

    // Visual Model
    const g = new THREE.Group();
    const m = new THREE.MeshStandardMaterial({ color: col });
    const cone = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.5, 16), m); cone.position.y = 0.75;
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), m); head.position.y = 1.6;
    g.add(cone); g.add(head);
    
    g.position.copy(tiles[0].position);
    if (id > 0) { g.position.x += Math.random() - 0.5; g.position.z += Math.random() - 0.5; }
    scene.add(g);

    const portraitUrl = CHAR_PORTRAITS[`${r.id}_${c.id}`] || "";

    players.push({
        id: id, name: n, race: r, class: c, portrait: portraitUrl,
        activeSkillId: actId, passiveSkillId: pasId,
        stats: stats, gold: stats.gold, pos: 0, mesh: g, color: col, isAi: ai,
        archetype: archetype, // NEW: Helps AI decide gear/attacks
        equipment: { main: null, off: null, head: null, body: null },
        inventory: [], quickSlots: [null, null], 
        isSkipping: false, abilityUsed: false
    });
}

function recalcStats(p) {
    p.stats.str = p.race.stats.str;
    p.stats.dex = p.race.stats.dex;
    p.stats.int = p.race.stats.int;

    const pas = ABILITY_LIBRARY[p.passiveSkillId];
    if(pas && pas.effect) pas.effect(p.stats);

    ['head', 'body', 'main', 'off'].forEach(slot => {
        const item = p.equipment[slot];
        if(item && item.bonus) {
            const k = Object.keys(item.bonus)[0];
            p.stats[k] += item.bonus[k];
        }
    });
}

// [10.1] AI BRAIN (Logic Subsystem)
// =================================================================
function manageAiInventory(p) {
    // 1. Loop backwards through inventory to safely modify array
    for (let i = p.inventory.length - 1; i >= 0; i--) {
        const item = p.inventory[i];
        
        // A. EQUIPPING LOGIC
        if (item.type === 'equip') {
            const current = p.equipment[item.slot];
            let shouldEquip = false;

            // If slot is empty, equip it
            if (!current) shouldEquip = true;
            else {
                // Determine if new item is better for Archetype (Goal Stat)
                const currentVal = (current.bonus[p.archetype] || 0) + (Object.values(current.bonus)[0] || 0);
                const newVal = (item.bonus[p.archetype] || 0) + (Object.values(item.bonus)[0] || 0);
                
                // If new item provides more stats relevant to class, swap
                if (newVal > currentVal) shouldEquip = true;
            }

            if (shouldEquip) {
                addLog(`${p.name} equips ${item.name}.`, "log-rare");
                equipItem(p.id, i);
            }
        }
    }
}

function attemptAiAbilities(p, phase) {
    // Phase 1: Pre-Roll (Movement buffs, Healing)
    if (phase === 'pre-roll') {
        // Heal if skipping
        if (p.isSkipping) {
             // Check class skill
            if (p.activeSkillId === 'heal_light' && !p.classSkillDepleted) useSkillAi(p, 0);
            // Check items
            checkItemSkills(p, ['heal', 'teleport']);
        }
        
        // Use Movement/Buffs randomly to be aggressive
        if (!p.classSkillDepleted && Math.random() > 0.6) useSkillAi(p, 0); 
    }
    
    // Phase 2: Pre-Encounter (Combat Buffs)
    if (phase === 'combat') {
        checkItemSkills(p, ['might', 'focus', 'agility', 'fireball', 'smite']);
    }
}

function checkItemSkills(p, skillKeys) {
    // Check Equipment
    ['head', 'body', 'main', 'off'].forEach(slot => {
        const item = p.equipment[slot];
        if (item && item.ability && !item.isDepleted) {
            // See if this item's ability key matches one we want to use
            const key = Object.keys(ABILITY_LIBRARY).find(k => ABILITY_LIBRARY[k].name === item.ability.name);
            if (skillKeys.includes(key) || Math.random() > 0.7) { // 30% chance to just use random active items
                item.ability.fn(p);
                item.isDepleted = true;
                updateHUD(); // Only needed if observing AI, but good practice
            }
        }
    });
}

function useSkillAi(p, slotIdx) {
    // Wrapper to fire class skill
    if(slotIdx === 0 && !p.classSkillDepleted) {
        const skill = ABILITY_LIBRARY[p.activeSkillId];
        if(skill && skill.fn) { 
            skill.fn(p); 
            p.classSkillDepleted = true; 
            updateHUD(); 
        }
    }
}

// [11] UI: HUD & UPDATES
// =================================================================
function setT(id,t){let e=document.getElementById(id);if(e)e.innerText=t;}

function updateHUD() {
    if(players.length===0)return;
    const p=players[0];
    
    setT('p1-name',p.name); 
    document.getElementById('p1-portrait').style.backgroundImage = `url('${p.portrait}')`;
    // ... (stats update code stays same) ...
    setT('p1-gold',p.gold);
    setT('p1-str',p.stats.str); setT('p1-dex',p.stats.dex); setT('p1-int',p.stats.int);
    setT('treasury-val',treasuryGold);
    setT('day-night-indicator', isNight ? "‚òæ NIGHT" : "‚òÄ DAY");
    document.getElementById('day-night-indicator').style.color = isNight ? "#a855f7" : "#87ceeb";
    
    // Inventory
    const invDiv=document.getElementById('p1-inv'); 
    if(invDiv){ 
        invDiv.innerHTML=''; 
        for(let i=0;i<12;i++){ 
            let d=document.createElement('div'); d.className='inv-slot'; d.dataset.idx=i; 
            d.draggable = true;
            d.ondragstart = (e) => { if(document.getElementById('context-menu').style.display === 'flex') { e.preventDefault(); return; } dragStart(e, i); };
            d.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, i, 'inv'); };
            d.onclick = () => { if(document.getElementById('context-menu').style.display !== 'flex') equipItem(0, i); };
            if(p.inventory[i]){ 
                d.innerText=p.inventory[i].name; 
                d.classList.add('rarity-'+p.inventory[i].rarity); 
                d.onmouseenter = () => showTooltip(p.inventory[i]);
                d.onmouseleave = hideTooltip;
            } 
            invDiv.appendChild(d); 
        } 
    }
    
    // LEADERBOARD (FIXED CLICK)
    const lb=document.getElementById('leader-list'); 
    if(lb){ 
        lb.innerHTML=''; 
        players.forEach(pl=>{ 
            let d=document.createElement('div'); 
            d.className='leader-row' + (pl.isDead ? ' dead' : ''); 
            
            let nameSpan = document.createElement('span');
            nameSpan.className = "leader-name";
            nameSpan.style.color = pl.color;
            nameSpan.innerText = pl.name;
            
            if(!pl.isDead) {
                nameSpan.addEventListener('click', function() {
                    openCharDetail(pl.id);
                });
            }

            let goldSpan = document.createElement('span');
            goldSpan.innerText = pl.isDead ? "DEAD" : `${pl.gold}G`;

            d.appendChild(nameSpan);
            d.appendChild(goldSpan);
            lb.appendChild(d); 
        }); 
    }
    
    // ... (Rest of HUD logic stays same) ...
    const cur=players[turnIndex]; 
    setT('turn-banner',cur.id===0?"YOUR TURN":`${cur.name}'S TURN`);
    const btnRoll=document.getElementById('btn-roll'); const btnEnd=document.getElementById('btn-end');
    if(btnRoll && btnEnd){ btnRoll.disabled=(gameState!=='ROLL'||cur.id!==0); btnEnd.disabled=(gameState!=='END'||cur.id!==0); }
    
    // Skill Bar & Equipment (Copy existing logic)
    const s0 = document.getElementById('skill-0');
    const txt0 = document.getElementById('txt-skill-0');
    const actSkill = ABILITY_LIBRARY[p.activeSkillId];
    if(actSkill) { 
        if(p.classSkillDepleted) { s0.className="skill-slot"; s0.style.opacity="0.5"; txt0.innerText="Recharge"; } 
        else { s0.className="skill-slot filled"; s0.style.opacity="1"; txt0.innerText=actSkill.name; }
        s0.onmouseenter = () => showTooltip(p.activeSkillId, true); s0.onmouseleave = hideTooltip;
    }
    EQUIP_ORDER.forEach((slotName, i) => {
        const idx = i + 1; 
        const el = document.getElementById(`skill-${idx}`);
        const txt = document.getElementById(`txt-skill-${idx}`);
        const item = p.equipment[slotName];
        const dollEl = document.getElementById('slot-'+slotName);
        if(dollEl) { 
            dollEl.innerHTML=item?item.name:slotName.toUpperCase(); 
            dollEl.className='equip-slot'+(item?' filled':''); 
            dollEl.oncontextmenu = (e) => { e.preventDefault(); handleContextOpen(e, slotName, 'equip'); };
            if(item) { dollEl.onmouseenter = () => showTooltip(item); dollEl.onmouseleave = hideTooltip; } 
            else { dollEl.onmouseenter = null; dollEl.onmouseleave = null; }
        }
        if (item && item.ability && item.ability.type === 'active') { 
            if(item.isDepleted) { el.className = "skill-slot"; el.style.opacity="0.5"; txt.innerText = "Recharge"; } 
            else { el.className = "skill-slot filled"; el.style.opacity="1"; txt.innerText = item.ability.name; }
            el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip;
        } else {
            el.className = "skill-slot"; el.style.opacity="1"; txt.innerText = item ? "(Passive)" : "Empty";
            if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } 
            else { el.onmouseenter = null; el.onmouseleave = null; }
        }
    });
    p.quickSlots.forEach((item, i) => {
        const idx = i + 5; 
        const el = document.getElementById(`skill-${idx}`);
        const txt = document.getElementById(`txt-skill-${idx}`);
        if (item && p.inventory.includes(item)) {
            el.className = "skill-slot consumable"; txt.innerText = item.name;
            el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip;
        } else {
            p.quickSlots[i] = null; el.className = "skill-slot"; txt.innerText = "Drag Item";
            el.onmouseenter = null; el.onmouseleave = null;
        }
    });
}

function addLog(m,c){const l=document.getElementById('game-log');let d=document.createElement('div');d.className='log-entry '+(c||'');d.innerText='> '+m;l.insertBefore(d,l.firstChild);}

// [12] UI: PANELS & MODALS
// =================================================================
function togglePanel(id) {
    const panel = document.getElementById(id);
    if(!panel) return;
    panel.classList.toggle('minimized');
    const btn = panel.querySelector('.minimize-btn');
    if(btn) btn.innerText = panel.classList.contains('minimized') ? "+" : "-";
}

function toggleDrawer(id) {
    const el = document.getElementById(id);
    if(!el) return;
    
    // Tab references
    const tabChar = document.getElementById('tab-char');
    const tabLeader = document.getElementById('tab-leader');
    
    // Close other drawers first
    if(id === 'p1-sheet') {
        const other = document.getElementById('leaderboard');
        if(other) other.classList.remove('active');
        if(tabLeader) tabLeader.classList.remove('active'); // Reset other tab
        
        // Toggle Current
        el.classList.toggle('active');
        if(tabChar) tabChar.classList.toggle('active');
    }
    
    if(id === 'leaderboard') {
        const other = document.getElementById('p1-sheet');
        if(other) other.classList.remove('active');
        if(tabChar) tabChar.classList.remove('active'); // Reset other tab
        
        // Toggle Current
        el.classList.toggle('active');
        if(tabLeader) tabLeader.classList.toggle('active');
    }
}

function toggleCreatorPortrait() {
    const el = document.getElementById('creator-portrait-frame');
    const btn = document.getElementById('btn-min-portrait');
    if(!el || !btn) return;
    el.classList.toggle('minimized');
    btn.innerText = el.classList.contains('minimized') ? "+" : "-";
}

function showModal(t,d,o){ 
    const m=document.getElementById('card-modal');
    setT('enc-title',t); setT('card-desc',d);
    const l=document.getElementById('choice-list'); l.innerHTML=''; document.getElementById('dice-result').innerHTML='';
    o.forEach(x=>{
        let b=document.createElement('div'); b.className='choice-btn'; b.innerText=x.txt;
        b.onclick=()=>{m.classList.remove('active');x.act();};
        l.appendChild(b);
    });
    m.classList.add('active'); 
}

// FIXED: Robust Null Checks
function openCharDetail(id) {
    const p = players[id]; if(!p) return;
    
    // Safe Set Text
    setT('cd-header', p.name); 
    setT('cd-sub', p.race.name + " " + p.class.name);
    setT('cd-str', p.stats.str); 
    setT('cd-dex', p.stats.dex); 
    setT('cd-int', p.stats.int);
    
    // Safe Set Image
    const portraitEl = document.getElementById('cd-portrait');
    if(portraitEl) portraitEl.style.backgroundImage = `url('${p.portrait}')`;

    const act = ABILITY_LIBRARY[p.activeSkillId];
    const pas = ABILITY_LIBRARY[p.passiveSkillId];
    setT('cd-active', act ? act.name : '-'); 
    setT('cd-active-desc', act ? act.desc : '');
    setT('cd-passive', pas ? pas.name : '-'); 
    setT('cd-passive-desc', pas ? pas.desc : '');

    const invSection = document.getElementById('cd-inventory-section');
    const hiddenMsg = document.getElementById('cd-hidden-msg');

    if (id === 0) {
        if(invSection) invSection.style.display = 'block'; 
        if(hiddenMsg) hiddenMsg.style.display = 'none';
        
        ['head','body','main','off'].forEach(slot => {
            const item = p.equipment[slot]; 
            const el = document.getElementById('cd-slot-'+slot);
            if(el) {
                el.innerHTML = item ? item.name : slot.toUpperCase();
                el.className = 'equip-slot' + (item ? ' filled' : '');
                if(item) { el.onmouseenter = () => showTooltip(item); el.onmouseleave = hideTooltip; } 
                else { el.onmouseenter = null; }
            }
        });
        
        const grid = document.getElementById('cd-inv-grid'); 
        if(grid) {
            grid.innerHTML = '';
            p.inventory.forEach(item => {
                let d = document.createElement('div'); d.className = 'inv-slot'; d.innerText = item.name;
                d.classList.add('rarity-' + item.rarity); d.onmouseenter = () => showTooltip(item); d.onmouseleave = hideTooltip;
                grid.appendChild(d);
            });
            for(let i=p.inventory.length; i<12; i++) { let d = document.createElement('div'); d.className = 'inv-slot'; grid.appendChild(d); }
        }
    } else {
        if(invSection) invSection.style.display = 'none'; 
        if(hiddenMsg) hiddenMsg.style.display = 'block';
    }
    
    const modal = document.getElementById('char-detail-modal');
    if(modal) modal.classList.add('active');
}

function closeCharDetail() { 
    const modal = document.getElementById('char-detail-modal');
    if(modal) modal.classList.remove('active'); 
    hideTooltip(); 
}

function getRarityColor(r) { if(r==='common')return '#fff'; if(r==='rare')return '#3b82f6'; if(r==='epic')return '#a855f7'; return '#f59e0b'; }
function showTooltip(data, isSkillId = false) {
    if (!data) return;
    const tt = document.getElementById('tooltip'); let html = '';
    if (isSkillId) {
        const s = ABILITY_LIBRARY[data]; if(!s) return;
        html = `<div class="tt-header"><span class="tt-name">${s.name}</span><span class="tt-rarity">${s.type || 'Active'}</span></div><div class="tt-abil" style="border:none;">${s.desc}</div>`;
    } else {
        const col = getRarityColor(data.rarity || 'common');
        html = `<div class="tt-header"><span class="tt-name" style="color:${col}">${data.name}</span><span class="tt-rarity">${data.rarity || 'Common'}</span></div>`;
        if (data.bonus) Object.keys(data.bonus).forEach(k => { html += `<span class="tt-stat">+${data.bonus[k]} ${k.toUpperCase()}</span>`; });
        if(data.desc) html += `<span class="tt-stat" style="color:#aaa; font-style:italic; margin-bottom:5px;">${data.desc}</span>`;
        if(data.ability) html += `<div class="tt-abil">${data.ability.name}: ${data.ability.desc}</div>`;
    }
    tt.innerHTML = html; tt.style.display = 'block';
}
function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
document.addEventListener('mousemove', (e) => {
    const tt = document.getElementById('tooltip');
    if (tt && tt.style.display === 'block') {
        const pad = 15; let left = e.pageX + pad; let top = e.pageY + pad;
        if (left + tt.offsetWidth > window.innerWidth) left = e.pageX - tt.offsetWidth - pad;
        if (top + tt.offsetHeight > window.innerHeight) top = e.pageY - tt.offsetHeight - pad;
        tt.style.left = left + 'px'; tt.style.top = top + 'px';
    }
});
document.addEventListener('click', (e) => {
    const menu = document.getElementById('context-menu');
    if (menu && !e.target.classList.contains('inv-slot') && !e.target.classList.contains('ctx-item')) menu.style.display = 'none';
});

// [13] INPUT HANDLING
// =================================================================
let lastTouchTime = 0;
let lastTouchSlot = "";
let touchTimer = null;

function toggleHelpModal() {
    const m = document.getElementById('help-modal');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
}

function handleEquipTouch(slot) {
    const currentTime = new Date().getTime(); const tapLength = currentTime - lastTouchTime;
    if (lastTouchSlot === slot && tapLength < 500 && tapLength > 0) { unequipItem(slot); lastTouchTime = 0; } 
    else { useEquipped(slot); lastTouchTime = currentTime; lastTouchSlot = slot; }
}

function handleContextOpen(e, identifier, source='inv') {
    const p = players[0]; let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier];
    if (!item) return; 
    
    const menu = document.getElementById('context-menu'); menu.style.pointerEvents = 'auto'; menu.innerHTML = ''; 
    const sellArea = document.getElementById('market-sell-area');
    const canSell = document.getElementById('card-modal').classList.contains('active') && sellArea && sellArea.style.display !== 'none';
    const sellPrice = Math.floor((item.cost || 0) / 2);

    const createItem = (text, onClick, disabled=false) => {
        const div = document.createElement('div'); div.className = 'ctx-item' + (disabled ? ' disabled' : ''); div.innerText = text;
        if(!disabled) { div.onclick = (ev) => { ev.stopPropagation(); onClick(); closeCtx(); }; }
        menu.appendChild(div);
    };

    if (source === 'equip') createItem('Unequip Item', () => unequipItem(identifier));
    else createItem(item.type === 'scroll' ? 'Use Scroll' : 'Equip Item', () => equipItem(0, identifier));
    
    createItem(`Sell (${sellPrice}G)`, () => sellItem(identifier, source), !canSell);
    createItem('Cancel', () => {});

    let x = e.touches ? e.touches[0].clientX : e.clientX; let y = e.touches ? e.touches[0].clientY : e.clientY;
    if (x + 150 > window.innerWidth) x = window.innerWidth - 160;
    if (y + 150 > window.innerHeight) y = window.innerHeight - 160;
    menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex';
}
function closeCtx() { document.getElementById('context-menu').style.display = 'none'; }

// Drag & Drop
function allowDrop(ev){ev.preventDefault();}
function dragStart(ev, i){ev.dataTransfer.setData("idx",i);}
function handleSellDrop(ev){ ev.preventDefault(); if(document.getElementById('market-sell-area').style.display!=='none'){const idx=ev.dataTransfer.getData("idx"); if(idx!==null) sellItem(idx); }}
function handleSkillDrop(ev, slotIdx) {
    ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0];
    if (invIdx !== null && p.inventory[invIdx]) {
        const item = p.inventory[invIdx];
        if (item.type === 'scroll' || (item.ability && item.ability.type === 'active')) { p.quickSlots[slotIdx] = item; updateHUD(); } 
        else { addLog("Cannot assign passive item.", "log-fail"); }
    }
}
function setupEquipDragDrop() {
    ['head', 'body', 'main', 'off'].forEach(slot => {
        const el = document.getElementById('slot-' + slot);
        if(el) { el.ondragover = allowDrop; el.ondrop = (e) => handleEquipDrop(e, slot); }
    });
}
function handleEquipDrop(ev, slotName) {
    ev.preventDefault(); const invIdx = ev.dataTransfer.getData("idx"); const p = players[0];
    if (invIdx !== null && p.inventory[invIdx]) {
        const item = p.inventory[invIdx];
        if(item.slot === slotName) equipItem(0, invIdx);
        else addLog(`Cannot equip ${item.name} to ${slotName.toUpperCase()}`, "log-fail");
    }
}

// Keyboard
document.addEventListener('keydown', (e) => {
    if (["1","2","3","4","5","6","7"].includes(e.key)) useSkill(parseInt(e.key) - 1);
});

// [14] GAME LOOP: CORE
// =================================================================
function rollMove() { 
    if(gameState!=='ROLL') return; 
    
    // Day/Night Cycle
    if(turnIndex === 0) {
        turnCount++;
        if(turnCount % 10 === 0) { 
            isNight = !isNight; 
            addLog(isNight ? "Night falls..." : "Sunrise.", isNight ? "log-fail":"log-success");
            const targetColor = isNight ? 0x050510 : 0xcccccc;
            scene.background = new THREE.Color(targetColor);
            scene.fog = new THREE.Fog(targetColor, 90, 140);
        }
    }

    const p=players[turnIndex]; 
    p.abilityUsed=false; 
    
    if(p.isSkipping){
        p.isSkipping=false; addLog(p.name+" skips turn.","log-fail"); endStep(); return;
    } 
    
    const r=Math.floor(Math.random()*11)+2; 
    addLog(`${p.name} rolled ${r}.`); 
    gameState='MOVING'; 
    animateMove(p,r); 
}

function animateMove(p, s) { 
    if (s <= 0) { resolveLanding(p); return; } 
    
    p.pos = (p.pos + 1) % 40; 
    
    // Start Tile Pass Logic
    if (p.pos === 0) {
        p.gold += 200; addLog("Passed Inn (+200G)", "log-success");
        let recharged = false;
        if(p.classSkillDepleted) { p.classSkillDepleted = false; recharged = true; }
        ['head', 'body', 'main', 'off'].forEach(slot => {
            const item = p.equipment[slot];
            if (item && item.isDepleted) { item.isDepleted = false; recharged = true; }
        });
        if(recharged) addLog("All Abilities Recharged!", "log-epic");
        updateHUD();
    } 

    const t = tiles[p.pos].position.clone(); 
    if (p.id > 0) { t.x += Math.random() - 0.5; t.z += Math.random() - 0.5; } 
    
    new TWEEN.Tween(p.mesh.position).to({x: t.x, z: t.z}, 250).start(); 
    new TWEEN.Tween(p.mesh.position).to({y: 1.5}, 125).yoyo(true).repeat(1)
        .onComplete(() => animateMove(p, s - 1)).start(); 
}

function endStep(){ 
    gameState='END'; 
    updateHUD(); 
    
    // DELAY 1: After an AI finishes an action (buying/fighting), wait 2 seconds 
    // before handing the turn over. This lets you read the log.
    if(players[turnIndex].isAi) {
        setTimeout(endTurn, 2000); 
    }
}

function endTurn(){
    const prevP = players[turnIndex];
    recalcStats(prevP);
    
    // Manage AI gear at end of their turn
    if(prevP.isAi) manageAiInventory(prevP); 

    turnIndex=(turnIndex+1)%players.length;
    gameState='ROLL';
    updateHUD();

    const curP = players[turnIndex];

    // DELAY 2: If the NEW player is AI, wait 1.5 seconds before they roll.
    // This allows the "PLAYER X'S TURN" banner to be seen clearly.
    if(curP.isAi) {
        attemptAiAbilities(curP, 'pre-roll');
        setTimeout(rollMove, 1500);
    }
}

// [15] GAME LOOP: ENCOUNTERS
// =================================================================
function resolveLanding(p) {
    const t = tiles[p.pos]; const i = t.userData.info;
    
    // AI LOGIC
    if(p.isAi) { processAiTurn(p, t, i); return; }

    // PLAYER LOGIC
    const m = document.getElementById('arrival-modal');
    if(m) {
        const imgEl = document.getElementById('arrival-image');
        if(imgEl) {
            if(i.cardImg) { 
                // UPDATE: Set source instead of background-image
                imgEl.src = i.cardImg; 
                imgEl.style.display = 'block'; 
            } else { 
                imgEl.style.display = 'none'; 
            }
        }
        const flavorEl = document.getElementById('arrival-flavor');
        if(flavorEl) flavorEl.innerText = i.flavor || "You arrive at " + i.name + ".";
        m.classList.add('active');
    }
}

function processAiTurn(p, t, i) {
    // 1. Handle Automatic Tiles
    if(i.type==='tax') { pay(p,50); endStep(); return; } 
    if(i.type==='park'){ if(treasuryGold>0){p.gold+=treasuryGold; addLog(`${p.name} wins the Treasury!`, "log-gold"); treasuryGold=0;} endStep(); return; } 
    if(i.type==='goto'){ p.pos=10; p.mesh.position.copy(tiles[10].position); addLog(`${p.name} jailed.`, "log-fail"); endStep(); return; } 
    if(i.type==='chest'){ drawCardAnim('treasure', () => { 
        const card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
        p.inventory.push({...card});
        addLog(`${p.name} found ${card.name}.`, "log-success");
        endStep();
    }); return; }

    // 2. Handle Purchasing (Unowned Tiles)
    if(i.cost > 0 && t.userData.owner === null) {
        const safetyRatio = (p.class.id === 'rogue' || p.race.id === 'dragonborn') ? 1.2 : 2.0;
        if (p.gold >= i.cost * safetyRatio) { capture(t, p, 1); } 
        else { addLog(`${p.name} passes on ${i.name}.`); }
        endStep();
        return;
    } 

    // 3. Handle Opponent Tiles
    if(t.userData.owner !== null && t.userData.owner !== p.id) {
        // A. Calculate Win Probability
        const enemyDefStat = t.userData.defendingStat || 'str';
        const tn = i.tn || 3;
        const aiDicePool = p.stats[enemyDefStat] || 1;
        const chancePerDie = (7 - tn) / 6;
        const expectedWins = aiDicePool * chancePerDie;
        const requiredWins = (i.req || 1) + (t.userData.guardCount || 0);

        // B. Decide: Siege or Pay?
        let willSiege = false;

        // UPDATED: Calculate Fail Cost (Double Rent + Guard fees)
        const failCost = (i.cost * 2) + ((t.userData.guardCount || 0) * 10);

        // Logic: Only attack if we have good odds OR we are desperate (can't afford rent)
        if (expectedWins >= requiredWins) willSiege = true;
        if (p.gold < i.cost) willSiege = true; 
        
        // Logic: If the penalty is huge (double rent), be slightly more conservative unless desperate
        if (failCost > p.gold && expectedWins < requiredWins + 0.5) willSiege = false;

        if (willSiege) attemptAiAbilities(p, 'combat');

        // C. Execute
        if (willSiege) {
            addLog(`${p.name} attacks ${players[t.userData.owner].name}'s tile!`, "log-accent");
            setTimeout(() => {
                // Pass the new doubled failCost to the combat roller
                rollCombat(p, enemyDefStat, tn, requiredWins, t, 'capture', false, 0, failCost, true);
            }, 500);
            return; 
        } else {
            pay(p, i.cost, players[t.userData.owner]);
            endStep();
            return;
        }
    }

    // 4. Handle Own Tiles (Upgrading)
    if (t.userData.owner === p.id) {
        if (t.userData.buildingLevel === 1 && p.gold > i.cost * 3) {
            addLog(`${p.name} attempts to upgrade...`);
            drawCardAnim('skirmish', () => {
                const card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)];
                const bestChoice = card.choices[0].tn < card.choices[1].tn ? card.choices[0] : card.choices[1];
                rollCombat(p, bestChoice.stat, bestChoice.tn, bestChoice.req, t, 'upgrade', false, 0, 50, false);
            });
            return;
        } 
        else if (t.userData.buildingLevel > 1 && p.gold > 200 && (t.userData.guardCount || 0) < 2) {
             p.gold -= 50;
             t.userData.guardCount = (t.userData.guardCount || 0) + 1;
             addLog(`${p.name} hired a guard.`, "log-gold");
             updateHUD();
        }
    }
    
    endStep();
}

function continueFromArrival() {
    document.getElementById('arrival-modal').classList.remove('active');
    const p = players[turnIndex]; const t = tiles[p.pos]; const i = t.userData.info;

    if(i.type === 'start') { if(p.id === 0) showEncounter(p, i, t, 'shop'); else endStep(); return; }
    if(i.type === 'park') { if(treasuryGold > 0){ p.gold += treasuryGold; addLog(`Won ${treasuryGold}G!`, "log-success"); treasuryGold = 0; updateHUD(); } else { addLog("Treasury empty."); } endStep(); return; }
    if(i.type === 'tax') { pay(p, 50); endStep(); return; } 
    if(i.type === 'goto') { p.pos = 10; p.mesh.position.copy(tiles[10].position); addLog("Jailed!", "log-fail"); p.isSkipping = true; endStep(); return; } 
    if(i.type === 'jail') { endStep(); return; }
    if(i.type === 'chest') { drawCardAnim('treasure', () => showEncounter(p, i, t, "loot")); return; }

    const deckType = isNight ? 'skirmish' : 'normal';
    const modeType = isNight ? 'wild_skirmish' : 'wild';
    const owner = t.userData.owner;

    if(owner === p.id) { 
        if(t.userData.buildingLevel === 1) {
            showModal("Upgrade?", `Build Tavern ${i.cost*2}G? (Skirmish)`, [
                { txt: "Upgrade", act: () => { if(p.gold >= i.cost*2) { p.gold -= i.cost*2; drawCardAnim('skirmish', () => showEncounter(p, i, t, "skirmish")); } else { addLog("No Gold"); endStep(); } } },
                { txt: "Skip", act: endStep }
            ]); 
        } else {
            // Already Tavern -> Offer Bodyguards
            let guards = t.userData.guardCount || 0;
            showModal("Manage Tavern", `Current Guards: ${guards}. Hire Bodyguard for 50G?`, [
                { txt: "Hire Guard (50G)", act: () => { if(p.gold >= 50) { p.gold -= 50; t.userData.guardCount = (t.userData.guardCount || 0) + 1; addLog("Guard Hired!", "log-gold"); updateHUD(); endStep(); } else { addLog("Not enough Gold"); endStep(); } } },
                { txt: "Rest (Skip)", act: endStep }
            ]);
        } 
    }
    else if(owner !== null) { drawCardAnim('normal', () => showEncounter(p, i, t, "enemy")); }
    else { drawCardAnim(deckType, () => showEncounter(p, i, t, modeType)); }
}

function closeFlavor() { document.getElementById('flavor-modal').classList.remove('active'); continueFromArrival(); }

function drawCardAnim(type, cb) {
    let deck, texUrl;
    if(type === 'treasure') { deck = treasureDeck; texUrl = 'https://static.wixstatic.com/media/b16479_03570af932d9445ea8b35d26c915366d~mv2.jpg'; } 
    else if(type === 'skirmish') { deck = skirmishDeck; texUrl = 'https://static.wixstatic.com/media/b16479_cd6258f031004df4962a76830ae296f3~mv2.jpg'; } 
    else { deck = normalDeck; texUrl = 'https://static.wixstatic.com/media/b16479_b3d23c888e524e31a6ba70275de7f665~mv2.jpg'; }

    const loader = new THREE.TextureLoader(); const tex = loader.load(texUrl);
    const whiteMat = new THREE.MeshStandardMaterial({color: 0xffffff});
    const mats = [whiteMat, whiteMat, new THREE.MeshStandardMaterial({map: tex}), whiteMat, whiteMat, whiteMat];
    
    const c = new THREE.Mesh(new THREE.BoxGeometry(7.5, 0.15, 10.5), mats);
    c.position.copy(deck.position); c.position.y += 2; scene.add(c);
    
    new TWEEN.Tween(c.position).to({x: camera.position.x * 0.8, y: camera.position.y - 20, z: camera.position.z * 0.8}, 600).start();
    new TWEEN.Tween(c.rotation).to({x: Math.PI / 2, y: Math.PI, z: 0}, 600).onComplete(() => { scene.remove(c); if(cb) cb(); }).start();
    setTimeout(()=>{ if(document.getElementById('card-modal').style.transform.indexOf('scale(1)')===-1 && cb) cb(); }, 800);
}

function showEncounter(p, i, t, mode) {
    const m = document.getElementById('card-modal'); const l = document.getElementById('choice-list');
    l.innerHTML = ''; document.getElementById('dice-result').innerHTML = ''; document.getElementById('market-sell-area').style.display = 'none';

    let card;
    if (mode === 'loot') card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)];
    else if (mode === 'skirmish' || mode === 'wild_skirmish') card = DECK_SKIRMISH[Math.floor(Math.random() * DECK_SKIRMISH.length)];
    else card = DECK_ENCOUNTER[Math.floor(Math.random() * DECK_ENCOUNTER.length)];

    if (card.type === 'shop') mode = 'shop';
    if (card.type === 'loot') { mode = 'loot'; if(!card.cost) card = DECK_TREASURE[Math.floor(Math.random() * DECK_TREASURE.length)]; }

    let title = card.name; let cls = 'card-header';
    if (mode.includes('skirmish')) { cls += ' skirmish'; title += " (SKIRMISH)"; } else if (mode === 'loot') { cls += ' loot'; } else if (mode === 'shop') { cls += ' market'; }
    setT('enc-title', title); document.getElementById('enc-header').className = cls;

    let desc = card.desc || "Event occurs."; let opts = [];

    if (mode === 'loot') {
        desc = `You found: ${card.name} (${card.rarity || 'Common'})`;
        opts = [{ txt: "Keep", act: () => { p.inventory.push({...card}); addLog("Gained " + card.name, "log-success"); updateHUD(); closeEnc(); }}];
    } 
    else if (mode === 'shop' || i.type === 'start') {
        desc = card.desc || "The merchant displays their wares.";
        document.getElementById('market-sell-area').style.display = 'flex';
        let pool = DECK_TREASURE.filter(item => item.name !== "Pouch of Gold");
        if(card.rare) pool = pool.filter(x => x.rarity === 'legendary');
        let items = []; if(pool.length > 0) { for(let k=0; k<3; k++) items.push(pool[Math.floor(Math.random() * pool.length)]); }
        items.forEach(it => opts.push({
            txt: `Buy ${it.name} (${it.cost}G)`,
            act: (btn) => { 
                if (p.gold >= it.cost) { 
                    if(p.inventory.length >= 12) { addLog("Inventory Full", "log-fail"); return; }
                    p.gold -= it.cost; p.inventory.push({...it}); 
                    addLog(`Bought ${it.name}`, "log-success"); updateHUD(); 
                    if(btn) btn.remove();
                } else { addLog("No Gold", "log-fail"); } 
            }
        }));
        opts.push({ txt: "Leave", act: closeEnc });
    } 
    else if (mode === 'wild' || mode === 'wild_skirmish' || mode === 'skirmish') {
        if (card.choices) {
            card.choices.forEach(c => {
                let btnTxt = c.txt; if(c.fail) btnTxt += ` | Fail: -${c.fail}G`;
                opts.push({ txt: btnTxt, stat: c.stat, tn: c.tn, req: c.req || 1, mode: c.mode, val: c.val || 0, failCost: c.fail || 50 });
            });
            opts.push({ txt: "Leave / Flee", act: closeEnc });
        } else if (card.type === 'pay') { opts = [{ txt: `Pay ${card.cost}G`, act: () => { pay(p, card.cost); closeEnc(); } }]; }
    } 
    else if (mode === 'enemy') {
        let guards = t.userData.guardCount || 0; let defStat = t.userData.defendingStat || 'str'; let tn = i.tn || 3; let req = i.req || 1; 
        
        // UPDATED: Double Rent Penalty Calculation
        // Formula: (Rent * 2) + (Guards * 10)
        let failCost = (i.cost * 2) + (guards * 10);
        
        desc = `Owned by ${players[t.userData.owner].name}. Defending Stat: ${defStat.toUpperCase()}. Guards: ${guards}.`;
        opts = [
            { txt: `Pay Rent ${i.cost}G`, act: () => { pay(p, i.cost, players[t.userData.owner]); closeEnc(); } },
            // Button text now clearly indicates the Risk
            { txt: `Siege (${defStat.toUpperCase()} ${tn}+) | Risk: -${failCost}G`, stat: defStat, tn: tn, req: req, mode: 'capture', penalty: false, failCost: failCost, isSiege: true }
        ];
    } 
    else { opts = [{ txt: "Continue", act: closeEnc }]; }

    // Silver Tongue Hook
    const silverTongueItem = ['head','body','main','off'].map(s => p.equipment[s]).find(i => i && i.ability && i.ability.name === "Silver Tongue" && !i.isDepleted);
    if (silverTongueItem && (mode === 'wild' || mode === 'wild_skirmish' || mode === 'enemy')) {
        opts.unshift({ txt: `‚òÖ Use Silver Tongue (INT 6+)`, act: () => { silverTongueItem.isDepleted = true; updateHUD(); addLog("Used Silver Tongue!", "log-epic"); rollCombat(p, 'int', 6, 1, t, 'capture', false, 0, 50, false); } });
    }

    const descEl = document.getElementById('enc-desc'); if(descEl) descEl.innerText = desc;
    opts.forEach(o => {
        let b = document.createElement('div'); b.className = 'choice-btn'; b.innerText = o.txt;
        b.onclick = () => { if (o.act) o.act(b); else rollCombat(p, o.stat, o.tn, o.req, t, o.mode, o.penalty, o.val, o.failCost, o.isSiege); };
        l.appendChild(b);
    });
    m.classList.add('active');
}

function closeEnc(){document.getElementById('card-modal').classList.remove('active');endStep();}

// [16] GAME LOOP: COMBAT
// =================================================================
function rollCombat(p, stat, tn, req, t, mode, penalty, rewardVal, failCost, isSiege) {
    const d = document.getElementById('dice-result'); d.innerHTML = ''; let wins = 0;
    let targetNum = tn || 3; let required = req || 1; let punishment = failCost || 50; 
    let pool = p.stats[stat] || 1; if (penalty) pool = Math.floor(pool / 2); if (pool < 1) pool = 1;

    for(let i=0; i<pool; i++){ 
        let r = Math.floor(Math.random()*6)+1; 
        let b = document.createElement('div'); b.className = 'mini-die ' + (r >= targetNum ? 'win' : 'lose'); b.innerText = r; 
        d.appendChild(b); 
        if(r >= targetNum) { wins++; if (r === 6 && p.passiveSkillId === 'executioner') { wins++; b.style.boxShadow = "0 0 10px #ef4444"; b.style.borderColor = "#ef4444"; } }
    }
    
    setTimeout(() => {
        let autoClose = true;
        if(wins >= required) { 
            addLog(`Success! (${wins} wins)`, "log-success"); 
            if (mode === 'capture' || mode === 'upgrade' || isSiege) {
                const passive = ABILITY_LIBRARY[p.passiveSkillId];
                if (passive && passive.onCombatVictory) passive.onCombatVictory(p);
            }
            
            if(isSiege) {
                let guards = t.userData.guardCount || 0;
                if (guards > 0) { t.userData.guardCount--; addLog(`Guard Defeated! (${t.userData.guardCount} remaining)`, "log-success"); } 
                else { capture(t, p, 1); checkForBonusLoot(p); if(p.id === 0) autoClose = false; }
            } 
            else if(mode === 'capture') { capture(t, p, 1); if(rewardVal > 0) { p.gold += rewardVal; addLog(`Bonus Reward: +${rewardVal}G`, "log-gold"); } checkForBonusLoot(p); if(p.id === 0) autoClose = false; }
            else if(mode === 'upgrade') { capture(t, p, 2); checkForBonusLoot(p); if(p.id === 0) autoClose = false; if(p.id === 0) setTimeout(closeEnc, 1500); }
            else if(mode === 'reward') { let amt = rewardVal || 50; p.gold += amt; addLog(`Reward: ${amt}G`, "log-gold"); checkForBonusLoot(p); }
        }
        else { 
            addLog("Failure!", "log-fail"); 
            if(isSiege) { pay(p, punishment, players[t.userData.owner]); } else { pay(p, punishment); }
        }
        updateHUD();
        if(autoClose) setTimeout(closeEnc, 1000);
    }, 600);
}

function checkForBonusLoot(p) {
    const roll = Math.floor(Math.random() * 6) + 1;
    if (roll === 6) { addLog(`Bonus Loot Roll: ${roll} (TREASURE!)`, "log-gold"); setTimeout(() => { drawCardAnim('treasure', () => showEncounter(p, null, null, 'loot')); }, 500); } 
    else { addLog(`Bonus Loot Roll: ${roll} (No Item)`, "log-fail"); }
}

// [17] GAME LOOP: TILE LOGIC (Capture/Pay)
// =================================================================
function capture(t, p, lvl) {
    t.userData.owner = p.id; t.userData.buildingLevel = lvl; t.userData.guardCount = 0;
    if (t.userData.prop) t.remove(t.userData.prop);
    
    const g = new THREE.Group();
    if (lvl === 1) {
        const m = new THREE.Mesh(new THREE.ConeGeometry(1, 1.5, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); m.position.set(0, 0.5, 0); g.add(m);
    } else {
        const b = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 1.5), new THREE.MeshStandardMaterial({ color: 0x5c4033 })); b.position.set(0, 0.5, 0);
        const r = new THREE.Mesh(new THREE.ConeGeometry(1.5, 1, 4), new THREE.MeshStandardMaterial({ color: p.mesh.children[0].material.color })); r.position.set(0, 1.5, 0); r.rotation.y = Math.PI / 4;
        g.add(b); g.add(r);
    }
    t.add(g); t.userData.prop = g;
    addLog(lvl === 1 ? "Captured!" : "Upgraded!", "log-success");

    if (p.id === 0) setTimeout(() => chooseDefense(t), 500);
    else {
        const s = p.stats;
        if (s.str >= s.dex && s.str >= s.int) t.userData.defendingStat = 'str';
        else if (s.dex >= s.str && s.dex >= s.int) t.userData.defendingStat = 'dex';
        else t.userData.defendingStat = 'int';
    }
}

function chooseDefense(t) {
    showModal("Tactics", "Choose a stat to defend this location.", [
        { txt: "Strength (STR)", act: () => { t.userData.defendingStat = 'str'; addLog("Defense set to STR", "log-success"); endStep(); } },
        { txt: "Dexterity (DEX)", act: () => { t.userData.defendingStat = 'dex'; addLog("Defense set to DEX", "log-success"); endStep(); } },
        { txt: "Intelligence (INT)", act: () => { t.userData.defendingStat = 'int'; addLog("Defense set to INT", "log-success"); endStep(); } }
    ]);
}

function pay(p, amount, recipient) {
    // Passive Check
    let finalAmount = amount;
    if (p.passiveSkillId === 'iron_skin' && finalAmount > 0) {
        const oldAmt = finalAmount; 
        finalAmount = Math.max(0, finalAmount - 20);
        addLog(`Iron Skin reduced loss by ${oldAmt - finalAmount}G`, "log-rare");
    }

    // Deduct Gold (Allow Negative temporarily)
    p.gold -= finalAmount;
    
    // Check if player is now in debt
    if (p.gold < 0) {
        handleDebt(p, Math.abs(p.gold), recipient);
    } else {
        // Normal Payment success
        if (recipient) recipient.gold += finalAmount; 
        else treasuryGold += finalAmount;
        if(finalAmount > 0) addLog(`Paid ${finalAmount}G`, "log-fail");
        updateHUD();
    }
}

// DEBT HANDLING LOGIC
function handleDebt(p, debt, recipient) {
    const ownedTiles = tiles.filter(t => t.userData.owner === p.id);
    
    // --- AI LOGIC: Auto-Sell ---
    if (p.isAi) {
        // While still in debt and has properties, sell them
        while (p.gold < 0 && ownedTiles.length > 0) {
            // Pick a random property to sell
            const t = ownedTiles.splice(Math.floor(Math.random() * ownedTiles.length), 1)[0];
            const val = Math.floor(t.userData.info.cost / 2);
            sellPropertyLogic(t, p, val);
        }

        // Final Check
        if (p.gold < 0) {
            // Transfer whatever leftover gold (if positive logic existed, but here it's 0) to recipient? 
            // Usually just eliminate.
            eliminatePlayer(p);
        } else {
            addLog(`${p.name} sold properties to pay debt.`, "log-fail");
            // Pay the recipient now that funds exist (or partial funds if they just hit 0)
            if (recipient && debt > 0) recipient.gold += Math.min(debt, debt + p.gold); // Logic simplification
            updateHUD();
        }
    } 
    // --- HUMAN LOGIC: Modal ---
    else {
        if (ownedTiles.length === 0) {
            eliminatePlayer(p);
        } else {
            showBankruptcyModal(p, debt, recipient, ownedTiles);
        }
    }
}

function sellPropertyLogic(t, p, val) {
    p.gold += val;
    t.userData.owner = null;
    t.userData.buildingLevel = 0;
    t.userData.guardCount = 0;
    t.userData.defendingStat = null;
    if (t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; }
    // Visual update
    if (t.userData.flagMat) t.userData.flagMat.color.setHex(0xffffff); // If flags exist
}

function showBankruptcyModal(p, debt, recipient, ownedTiles) {
    const m = document.getElementById('bankruptcy-modal');
    const list = document.getElementById('debt-prop-list');
    const debtLabel = document.getElementById('debt-amount');
    const btn = document.getElementById('btn-debt-done');
    
    m.style.display = 'flex';
    
    // Function to refresh the list
    const refreshList = () => {
        debtLabel.innerText = Math.abs(p.gold);
        list.innerHTML = '';
        
        // Filter tiles again to ensure current state
        const currentOwned = tiles.filter(t => t.userData.owner === p.id);
        
        if (p.gold >= 0) {
            btn.disabled = false;
            btn.innerText = "Debt Cleared - Continue";
            btn.onclick = () => {
                m.style.display = 'none';
                if(recipient) recipient.gold += debt; // Simplification
                else treasuryGold += debt;
                updateHUD();
            };
        } else if (currentOwned.length === 0) {
            btn.disabled = false;
            btn.innerText = "Accept Fate (Game Over)";
            btn.onclick = () => { m.style.display = 'none'; eliminatePlayer(p); };
        } else {
            btn.disabled = true;
            btn.innerText = `Sell more! (${Math.abs(p.gold)}G needed)`;
        }

        currentOwned.forEach(t => {
            const val = Math.floor(t.userData.info.cost / 2);
            const row = document.createElement('div');
            row.className = 'choice-btn';
            row.innerHTML = `<span>${t.userData.info.name}</span> <span style="color:var(--gold)">+${val}G</span>`;
            row.onclick = () => {
                sellPropertyLogic(t, p, val);
                refreshList();
                updateHUD();
            };
            list.appendChild(row);
        });
    };

    refreshList();
}

// ELIMINATION LOGIC
function eliminatePlayer(p) {
    p.isDead = true;
    p.gold = 0;
    
    // Remove Mesh
    scene.remove(p.mesh);
    
    // Return all properties to Bank
    tiles.forEach(t => {
        if(t.userData.owner === p.id) {
            t.userData.owner = null;
            t.userData.buildingLevel = 0;
            if(t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; }
        }
    });

    addLog(`${p.name} has been ELIMINATED!`, "log-fail");
    updateHUD();

    if (!p.isAi) {
        // Human Died
        showGameOver(false);
    } else {
        // AI Died - Check Win Condition
        checkWinCondition();
    }
}

// WIN CONDITION CHECK
function checkWinCondition() {
    const livingAi = players.filter(pl => pl.isAi && !pl.isDead);
    const human = players[0];

    if (livingAi.length === 0 && !human.isDead) {
        showGameOver(true);
    }
}

function showGameOver(victory) {
    const m = document.getElementById('game-over-modal');
    const t = document.getElementById('go-title');
    const msg = document.getElementById('go-msg');
    
    m.style.display = 'flex';
    if(victory) {
        t.innerText = "VICTORY!";
        t.style.color = "var(--gold)";
        msg.innerText = "You have defeated all rivals and conquered the realm!";
    } else {
        t.innerText = "DEFEAT";
        t.style.color = "var(--accent)";
        msg.innerText = "You have lost everything. Your legend ends here.";
    }
}

// RESET GAME LOGIC
function resetGame() {
    // Hide Modals
    document.getElementById('game-over-modal').style.display = 'none';
    document.getElementById('bankruptcy-modal').style.display = 'none';
    
    // Clear Scene of Players
    players.forEach(p => scene.remove(p.mesh));
    players = [];
    
    // Reset Tiles
    tiles.forEach(t => {
        t.userData.owner = null;
        t.userData.buildingLevel = 0;
        t.userData.guardCount = 0;
        if (t.userData.prop) { t.remove(t.userData.prop); t.userData.prop = null; }
    });

    // Reset State
    turnIndex = 0;
    turnCount = 0;
    isNight = false;
    treasuryGold = 0;
    gameState = 'SETUP';
    
    // Reset Environment (Lights/Fog)
    const fogColor = 0xcccccc; 
    scene.background = new THREE.Color(fogColor); 
    scene.fog = new THREE.Fog(fogColor, 90, 150);

    // Show Creation Screen
    document.getElementById('create-screen').style.display = 'flex';
}

function unequipItem(slot) {
    const p=players[0];
    if(p.equipment[slot] && p.inventory.length < 12) {
        const it = p.equipment[slot];
        p.stats[Object.keys(it.bonus)[0]] -= Object.values(it.bonus)[0];
        p.equipment[slot] = null; p.inventory.push(it);
        updateHUD();
    }
}

function equipItem(pId, invIdx) {
    const p=players[pId]; const item=p.inventory[invIdx];
    if(item.type==='scroll'){ item.fn(p); p.inventory.splice(invIdx,1); }
    else { 
        const slot=item.slot; const cur=p.equipment[slot]; 
        if(cur){p.stats[Object.keys(cur.bonus)[0]]-=Object.values(cur.bonus)[0]; p.inventory[invIdx]=cur;} 
        else{p.inventory.splice(invIdx,1);} 
        p.equipment[slot]=item; p.stats[Object.keys(item.bonus)[0]]+=Object.values(item.bonus)[0]; 
    }
    updateHUD();
}

function useEquipped(slot) { 
    const p = players[0]; const it = p.equipment[slot]; 
    if (it && it.ability && it.ability.type === 'active') {
        if (!it.isDepleted) { it.ability.fn(p); it.isDepleted = true; updateHUD(); } 
        else { addLog("Ability depleted! Pass Start to recharge.", "log-fail"); }
    } 
}

function useSkill(slotIndex) {
    const p = players[0];
    if (turnIndex !== 0) { addLog("Not your turn!", "log-fail"); return; }

    // Class Skill
    if(slotIndex === 0) {
        if(p.classSkillDepleted) { addLog("Skill depleted! Visit Inn to recharge.", "log-fail"); return; }
        const skill = ABILITY_LIBRARY[p.activeSkillId];
        if(skill && skill.fn) { skill.fn(p); p.classSkillDepleted = true; updateHUD(); }
        return;
    }
    // Equip Skills
    if(slotIndex >= 1 && slotIndex <= 4) {
        const equipSlot = EQUIP_ORDER[slotIndex - 1]; const item = p.equipment[equipSlot];
        if (item && item.ability && item.ability.type === 'active') {
            if (!item.isDepleted) { item.ability.fn(p); item.isDepleted = true; updateHUD(); } 
            else { addLog("Ability depleted! Visit Inn to recharge.", "log-fail"); }
        } else { addLog("Passive or Empty.", "log-fail"); }
        return;
    }
    // Quick Items
    if(slotIndex >= 5) {
        const qIdx = slotIndex - 5; const item = p.quickSlots[qIdx];
        if(item && item.type === 'scroll' && item.fn) {
            item.fn(p); const invIdx = p.inventory.indexOf(item); if(invIdx > -1) p.inventory.splice(invIdx, 1);
            p.quickSlots[qIdx] = null; updateHUD();
        }
    }
}

function sellItem(identifier, source='inv'){ 
    const p = players[0]; let item = (source === 'equip') ? p.equipment[identifier] : p.inventory[identifier];
    if(item){
        let multiplier = p.passiveSkillId === 'fence' ? 0.8 : 0.5;
        let v = Math.floor((item.cost || 0) * multiplier); p.gold += v; 
        
        if(source === 'equip') {
            if(item.bonus) p.stats[Object.keys(item.bonus)[0]] -= Object.values(item.bonus)[0];
            p.equipment[identifier] = null;
        } else { p.inventory.splice(identifier, 1); }

        addLog(`Sold for ${v}G` + (multiplier > 0.5 ? " (Fence)" : ""), "log-gold"); updateHUD();
    } 
}

// [18] CHARACTER CREATION
// =================================================================
function enterCreation() {
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('create-screen').style.display = 'flex';
}

function setupCreationUI() {
    // 1. Colors
    const cg=document.getElementById('color-grid'); 
    PLAYER_COLORS.forEach(c=>{let d=document.createElement('div');d.className='color-opt';d.style.backgroundColor=c;d.onclick=()=>{selColor=c;document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));d.classList.add('selected');};cg.appendChild(d);});
    
    // 2. Race
    const rg=document.getElementById('race-grid'); 
    RACES.forEach(r=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${r.name}</b><small>S:${r.stats.str} D:${r.stats.dex} I:${r.stats.int}</small>`;d.onclick=()=>{selRace=r;hl(d);up();};rg.appendChild(d);});
    
    // 3. Class
    const clg=document.getElementById('class-grid'); 
    CLASSES.forEach(c=>{let d=document.createElement('div');d.className='sel-opt';d.innerHTML=`<b>${c.name}</b>`;d.onclick=()=>{selClass=c;hl(d);showClassOptions(c);up();};clg.appendChild(d);});
}

function showClassOptions(c) {
    document.getElementById('active-section').style.display='flex';
    const ag = document.getElementById('active-grid'); ag.innerHTML='';
    c.actives.forEach(id => {
        const skill = ABILITY_LIBRARY[id];
        let d=document.createElement('div'); d.className='skill-card'; d.innerHTML=`<b>${skill.name}</b><small>${skill.desc}</small>`;
        d.onclick=()=>{ selActiveId=id; document.querySelectorAll('#active-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); };
        ag.appendChild(d);
    });

    document.getElementById('passive-section').style.display='flex';
    const pg = document.getElementById('passive-grid'); pg.innerHTML='';
    c.passives.forEach(id => {
        const skill = ABILITY_LIBRARY[id];
        let d=document.createElement('div'); d.className='skill-card'; d.innerHTML=`<b>${skill.name}</b><small>${skill.desc}</small>`;
        d.onclick=()=>{ selPassiveId=id; document.querySelectorAll('#passive-grid .skill-card').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); up(); };
        pg.appendChild(d);
    });
}

function hl(el){el.parentElement.childNodes.forEach(c=>c.classList&&c.classList.remove('selected'));el.classList.add('selected');}

function up(){ 
    document.getElementById('btn-start-game').disabled = !(selRace && selClass && selActiveId && selPassiveId);
    if(selRace && selClass) {
        const key = `${selRace.id}_${selClass.id}`;
        const url = CHAR_PORTRAITS[key];
        if(url) {
            const frame = document.getElementById('creator-portrait-frame');
            frame.style.backgroundImage = `url('${url}')`;
            frame.style.display = 'block';
        }
    }
}

function startGame() {
    document.getElementById('create-screen').style.display='none';
    const name = document.getElementById('char-name-input').value || "Hero";
    
    spawnPlayer(0, name, selRace, selClass, selActiveId, selPassiveId, false, selColor);
    
    let aiColors = PLAYER_COLORS.filter(c => c !== selColor);
    let availableNames = [...NPC_NAMES];

    for(let i=1; i<4; i++) { 
        const r = RACES[Math.floor(Math.random()*RACES.length)]; 
        const c = CLASSES[Math.floor(Math.random()*CLASSES.length)];
        const aiName = availableNames.splice(Math.floor(Math.random() * availableNames.length), 1)[0];
        const aiCol = aiColors.splice(Math.floor(Math.random()*aiColors.length), 1)[0];
        const act = c.actives[Math.floor(Math.random()*3)];
        const pas = c.passives[Math.floor(Math.random()*3)];
        spawnPlayer(i, aiName, r, c, act, pas, true, aiCol);
    }
    gameState='ROLL'; updateHUD(); addLog("Welcome to Questopoly!");
}

function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
            setTimeout(onWindowResize, 200);
        }).catch(err => {
            console.log(`Error attempting to enable full-screen mode: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen().then(() => {
                setTimeout(onWindowResize, 200);
            });
        }
    }
}

function onWindowResize() {
    const width = window.visualViewport ? window.visualViewport.width : window.innerWidth;
    const height = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
    renderer.domElement.style.width = "100%";
    renderer.domElement.style.height = "100%";
}

// Add listeners
window.addEventListener('resize', onWindowResize, false);
window.addEventListener('orientationchange', () => { setTimeout(onWindowResize, 300); });
if (window.visualViewport) { window.visualViewport.addEventListener('resize', onWindowResize); }

// Start Engine
init();
</script>
</body>
</html>
